var CVS_VERSION="$Date: 2005/04/26 01:50:32 $";var ENGINE_DESCRIPTION="Gnusto's interactive fiction engine";var default_unicode_translation_table={155:228,156:246,157:252,158:196,159:214,160:220,161:223,162:187,163:171,164:235,165:239,166:255,167:203,168:207,169:225,170:233,171:237,172:243,173:250,174:253,175:193,176:201,177:205,178:211,179:218,180:221,181:224,182:232,183:236,184:242,185:249,186:192,187:200,188:204,189:210,190:217,191:226,192:234,193:238,194:244,195:251,196:194,197:202,198:206,199:212,200:219,201:229,202:197,203:248,204:216,205:227,206:241,207:245,208:195,209:209,210:213,211:230,212:198,213:231,214:199,215:254,216:240,217:222,218:208,219:163,220:339,221:338,222:161,223:191};var reverse_unicode_table={};var isNotConst=/\D/;var temp_var=0;var PARENT_REC=0;var SIBLING_REC=1;var CHILD_REC=2;var CALLED_FROM_INTERRUPT=0;var GNUSTO_EFFECT_INPUT='"RS"';var GNUSTO_EFFECT_INPUT_CHAR='"RC"';var GNUSTO_EFFECT_SAVE='"DS"';var GNUSTO_EFFECT_RESTORE='"DR"';var GNUSTO_EFFECT_QUIT='"QU"';var GNUSTO_EFFECT_RESTART='"NU"';var GNUSTO_EFFECT_WIMP_OUT='"WO"';var GNUSTO_EFFECT_BREAKPOINT='"BP"';var GNUSTO_EFFECT_FLAGS_CHANGED='"XC"';var GNUSTO_EFFECT_PIRACY='"CP"';var GNUSTO_EFFECT_STYLE='"SS"';var GNUSTO_EFFECT_SOUND='"FX"';var GNUSTO_EFFECT_SPLITWINDOW='"TW"';var GNUSTO_EFFECT_SETWINDOW='"SW"';var GNUSTO_EFFECT_ERASEWINDOW='"YW"';var GNUSTO_EFFECT_ERASELINE='"YL"';var GNUSTO_EFFECT_SETCURSOR='"SC"';var GNUSTO_EFFECT_SETBUFFERMODE='"SB"';var GNUSTO_EFFECT_SETINPUTSTREAM='"SI"';var GNUSTO_EFFECT_GETCURSOR='"GC"';var GNUSTO_EFFECT_PRINTTABLE='"PT"';function handleZ_je(c,b){if(b.length<2){return""}else{if(b.length==2){return c._brancher(b[0]+"=="+b[1])}else{var e="";for(var d=1;d<b.length;d++){if(d!=1){e=e+"||"}e=e+"t=="+b[d]}return"t="+b[0]+";"+c._brancher(e)}}}function handleZ_jl(c,b){return c._brancher(b[0]+"<"+b[1])}function handleZ_jg(c,b){return c._brancher(b[0]+">"+b[1])}function handleZ_inc_chk(c,b){return handleZ_incdec(c,b[0],"+",1)+c._brancher("tmp_"+temp_var+" > "+b[1])}function handleZ_dec_chk(c,b){return handleZ_incdec(c,b[0],"-",1)+c._brancher("tmp_"+temp_var+" < "+b[1])}function handleZ_jin(c,b){return c._brancher("_obj_in("+b[0]+","+b[1]+")")}function handleZ_test(c,b){return"t="+b[1]+";"+c._brancher("("+b[0]+"&t)==t")}function handleZ_or(c,b){return c._storer("("+b[0]+"|"+b[1]+")&0xffff")}function handleZ_and(c,b){return c._storer(b[0]+"&"+b[1]+"&0xffff")}function handleZ_test_attr(c,b){return c._brancher("_test_attr("+b[0]+","+b[1]+")")}function handleZ_set_attr(c,b){return"_set_attr("+b[0]+","+b[1]+")"}function handleZ_clear_attr(c,b){return"_clear_attr("+b[0]+","+b[1]+")"}function handleZ_store(d,c){if(isNotConst.test(c[0])){d.logger("Z_store",c[0])}if(c[0]==0){return"m_gamestack.push("+c[1]+")"}else{if(c[0]<16){return"m_locals["+c[0]+" - 1] = "+c[1]}else{if(isNotConst.test(c[0])){var f="var high = m_vars_start + ("+c[0]+" - 16) * 2, low = high + 1;",h="high",b="low"}else{var f="",h=d.m_vars_start+(c[0]-16)*2,b=h+1}if(!isNotConst.test(c[1])){var g=(c[1]&32768?~65535:0)|c[1];return f+"m_memory["+h+"] = "+((g>>8)&255)+";m_memory["+b+"] = "+(g&255)}else{var e="tmp_"+(++temp_var);return f+"var "+e+" = "+c[1]+";"+e+" = ("+e+" & 0x8000 ? ~0xFFFF : 0) | "+e+";m_memory["+h+"] = ("+e+" >> 8) & 0xFF;m_memory["+b+"] = "+e+" & 0xFF;"}}}}function handleZ_insert_obj(c,b){return"_insert_obj("+b[0]+","+b[1]+")"}function handleZ_loadw(c,b){if(isNotConst.test(b[0])||isNotConst.test(b[1])){var e="var tmp_"+(++temp_var)+" = ("+b[0]+" + 2 * "+b[1]+") & 0xFFFF, ",f="tmp_"+temp_var}else{var e="var ",f=(b[0]+2*b[1])&65535}var d="tmp_"+(++temp_var);return e+d+" = (m_memory["+f+"] << 8) | m_memory["+f+" + 1];"+d+" = (("+d+" & 0x8000 ? ~0xFFFF : 0) | "+d+");"+c._storer(d)}function handleZ_loadb(c,b){return c._storer("m_memory[0xFFFF&(1*"+b[0]+"+1*"+b[1]+")]")}function handleZ_get_prop(c,b){return c._storer("_get_prop("+b[0]+","+b[1]+")")}function handleZ_get_prop_addr(c,b){return c._storer("_get_prop_addr("+b[0]+","+b[1]+")")}function handleZ_get_next_prop(c,b){return c._storer("_get_next_prop("+b[0]+","+b[1]+")")}function handleZ_add(c,b){return c._storer(b[0]+"*1+"+b[1]+"*1")}function handleZ_sub(c,b){return c._storer(b[0]+" - 1 * "+b[1])}function handleZ_mul(c,b){return c._storer(b[0]+"*"+b[1])}function handleZ_div(c,b){return c._storer("_trunc_divide("+b[0]+","+b[1]+")")}function handleZ_mod(c,b){return c._storer(b[0]+"%"+b[1])}function handleZ_set_colour(c,b){return"m_pc="+c.m_pc+";m_effects=["+GNUSTO_EFFECT_STYLE+",-1,"+b[0]+","+b[1]+"];return"}function handleZ_throw(c,b){c.m_compilation_running=0;return"_throw_stack_frame("+b[0]+");return"}function handleZ_jz(c,b){return c._brancher(b[0]+"==0")}function handleZ_get_sibling(c,b){return"t=_get_sibling("+b[0]+");"+c._storer("t")+";"+c._brancher("t")}function handleZ_get_child(c,b){return"t=_get_child("+b[0]+");"+c._storer("t")+";"+c._brancher("t")}function handleZ_get_parent(c,b){return c._storer("_get_parent("+b[0]+")")}function handleZ_get_prop_len(c,b){return c._storer("_get_prop_len("+b[0]+")")}function handleZ_inc(c,b){return handleZ_incdec(c,b[0],"+")}function handleZ_dec(c,b){return handleZ_incdec(c,b[0],"-")}function handleZ_incdec(b,d,a,g){if(isNotConst.test(d)){b.logger("Z_incdec",d)}var c="tmp_"+(++temp_var);if(d==0){return(g?"var "+c+" = ":"")+a+a+"m_gamestack[m_gamestack.length - 1];"}else{if(d<16){return(g?"var "+c+" = ":"")+a+a+"m_locals["+d+" - 1];"}else{if(isNotConst.test(d)){var e="var add = m_vars_start + ("+d+" - 16) * 2, ",f="add"}else{var e="var ",f=b.m_vars_start+(d-16)*2}return e+c+" = (m_memory["+f+"] << 8) | m_memory["+f+" + 1];"+c+" = (("+c+" & 0x8000 ? ~0xFFFF : 0) | "+c+") "+a+" 1;m_memory["+f+"] = ("+c+" >> 8) & 0xFF;m_memory["+f+" + 1] = "+c+" & 0xFF;"}}}function handleZ_print_addr(c,b){return c._handler_zOut("_zscii_from("+b[0]+")",0)}function handleZ_remove_obj(c,b){return"_remove_obj("+b[0]+","+b[1]+")"}function handleZ_print_obj(c,b){return c._handler_zOut("_name_of_object("+b[0]+")",0)}function handleZ_ret(c,b){c.m_compilation_running=0;return"_func_return("+b[0]+");return"}function handleZ_jump(c,b){c.m_compilation_running=0;if(b[0]&32768){b[0]=(~65535)|b[0]}var d=(b[0]+c.m_pc)-2;return"m_pc="+d+";return"}function handleZ_print_paddr(c,b){return c._handler_zOut("_zscii_from("+c.m_pc_translate_for_string(b[0])+")",0)}function handleZ_load(c,b){return c._storer("_varcode_get("+b[0]+")")}function handleZ_rtrue(c,b){c.m_compilation_running=0;return"_func_return(1);return"}function handleZ_rfalse(c,b){c.m_compilation_running=0;return"_func_return(0);return"}function handleZ_print(c,b){return c._handler_print("",0)}function handleZ_print_ret(c,b){c.m_compilation_running=0;return c._handler_print("\n",1)+";_func_return(1);return"}function handleZ_nop(c,b){return""}function handleZ_restart(c,b){c.m_compilation_running=0;return"m_effects=["+GNUSTO_EFFECT_RESTART+"];return"}function handleZ_ret_popped(c,b){c.m_compilation_running=0;return"_func_return(m_gamestack.pop());return"}function handleZ_catch(c,b){return c._storer("call_stack.length")}function handleZ_pop(c,b){return"m_gamestack.pop()"}function handleZ_quit(c,b){c.m_compilation_running=0;return"m_effects=["+GNUSTO_EFFECT_QUIT+"];return"}function handleZ_new_line(c,b){return c._handler_zOut("'\\n'",0)}function handleZ_show_status(c,b){c._handler_zOut("");return""}function handleZ_verify(c,b){return c._brancher("_verify()")}function handleZ_illegal_extended(c,b){gnusto_error(199)}function handleZ_piracy(c,b){c.m_compilation_running=0;var d="m_rebound=function(){"+c._brancher("(!m_answers[0])")+"};";return"m_pc="+c.m_pc+";"+d+"m_effects=["+GNUSTO_EFFECT_PIRACY+"];return"}function handleZ_call_1n(c,b){return c._generate_gosub(b[0],"",0)}function handleZ_call_1s(c,b){return c._generate_gosub(b[0],"",1)}function handleZ_call_2n(c,b){return c._generate_gosub(b[0],b[1],0)}function handleZ_call_2s(c,b){return c._generate_gosub(b[0],b[1],1)}function handleZ_call_vn(c,b){return c._generate_gosub(b[0],b.slice(1),0)}function handleZ_call_vs(c,b){return c._generate_gosub(b[0],b.slice(1),1)}function handleZ_store_w(c,b){if(isNotConst.test(b[0])||isNotConst.test(b[1])){var e="var tmp_"+(++temp_var)+" = ("+b[0]+" + 2 * "+b[1]+") & 0xFFFF;",g="tmp_"+temp_var}else{var e="",g=(b[0]+2*b[1])&65535}if(!isNotConst.test(b[2])){var f=(b[2]&32768?~65535:0)|b[2];return e+"m_memory["+g+"] = "+((f>>8)&255)+";m_memory["+g+" + 1] = "+(f&255)}else{var d="tmp_"+(++temp_var);return e+"var "+d+" = "+b[2]+";"+d+" = ("+d+" & 0x8000 ? ~0xFFFF : 0) | "+d+";m_memory["+g+"] = ("+d+" >> 8) & 0xFF;m_memory["+g+" + 1] = "+d+" & 0xFF;"}}function handleZ_storeb(c,b){return"setByte("+b[2]+",1*"+b[0]+"+1*"+b[1]+")"}function handleZ_putprop(c,b){return"_put_prop("+b[0]+","+b[1]+","+b[2]+")"}function handleZ_read(j,f){var h;var c;j.m_compilation_running=0;var g="_aread(m_answers[0],m_rebound_args[1],m_rebound_args[2],m_answers[1])";var i;var e;if(j.m_version>=5){g=j._storer(g)}if(j.m_version>=5){i="m_memory[0xFFFF&a0+1]";e="m_memory[0xFFFF&a0]"}else{i="0";e="m_memory[0xFFFF&a0]+1"}if(f[2]&&f[3]&&(j.m_version>=4)){h=f[2];c=j.m_pc_translate_for_routine(f[3])}else{h="0";c="0"}var d="m_rebound=function(){var t=1*m_answers[0];if(t<0){_func_interrupt(m_rebound_args[0],onISRReturn_for_read);}else{"+g+";}};";var b="m_rebound_args=["+c+",a0,"+f[1]+",];";return"var a0=eval("+f[0]+");m_pc="+j.m_pc+";"+b+d+"m_effects=["+GNUSTO_EFFECT_INPUT+","+h+","+i+","+e+",_terminating_characters()];return"}function handleZ_print_char(c,b){return c._handler_zOut("_zscii_char_to_ascii("+b[0]+")",0)}function handleZ_print_num(c,b){return c._handler_zOut(b[0],0)}function handleZ_random(c,b){return c._storer("_random_number("+b[0]+")")}function handleZ_push(c,b){return"m_gamestack.push("+b[0]+")"}function handleZ_pull(c,b){return handleZ_store(c,[b[0],"m_gamestack.pop()"])}function handleZ_split_window(c,b){c.m_compilation_running=0;return"m_pc="+c.m_pc+";m_effects=["+GNUSTO_EFFECT_SPLITWINDOW+","+b[0]+"];return"}function handleZ_set_window(c,b){c.m_compilation_running=0;return"m_pc="+c.m_pc+";m_effects=["+GNUSTO_EFFECT_SETWINDOW+","+b[0]+"];return"}function handleZ_erase_window(c,b){c.m_compilation_running=0;return"m_pc="+c.m_pc+";m_effects=["+GNUSTO_EFFECT_ERASEWINDOW+","+b[0]+"];return"}function handleZ_erase_line(c,b){c.m_compilation_running=0;return"m_pc="+c.m_pc+";m_effects=["+GNUSTO_EFFECT_ERASELINE+","+b[0]+"];return"}function handleZ_set_cursor(c,b){c.m_compilation_running=0;return"m_pc="+c.m_pc+";m_effects=["+GNUSTO_EFFECT_SETCURSOR+","+b[0]+","+b[1]+"];return"}function handleZ_get_cursor(c,b){c.m_compilation_running=0;return"m_pc="+c.m_pc+";m_effects=["+GNUSTO_EFFECT_GETCURSOR+","+b[0]+"];return"}function handleZ_set_text_style(c,b){c.m_compilation_running=0;return"m_pc="+c.m_pc+";m_effects=["+GNUSTO_EFFECT_STYLE+","+b[0]+",0,0];return"}function handleZ_buffer_mode(c,b){c.m_compilation_running=0;return"m_pc="+c.m_pc+";m_effects=["+GNUSTO_EFFECT_SETBUFFERMODE+","+b[0]+"];return"}function handleZ_output_stream(c,b){return"_set_output_stream("+b[0]+","+b[1]+")"}function handleZ_input_stream(c,b){c.m_compilation_running=0;return"m_pc="+c.m_pc+";m_effects=["+GNUSTO_EFFECT_SETINPUTSTREAM+","+b[0]+"];return"}function handleZ_sound_effect(c,b){c.m_compilation_running=0;while(b.length<5){b.push(0)}return"m_pc="+c.m_pc+";m_effects=["+GNUSTO_EFFECT_SOUND+","+b[0]+","+b[1]+","+b[2]+","+b[3]+","+b[4]+"];return"}function handleZ_read_char(c,b){var f;var d;var e;c.m_compilation_running=0;if(b[1]&&b[2]&&(c.m_version>=4)){f=b[1];d="m_rebound_args=["+c.m_pc_translate_for_routine(b[2])+"];";e="m_rebound=function(){var t=1*m_answers[0];if(t<0){_func_interrupt(m_rebound_args[0],onISRReturn_for_read_char);}else{"+c._storer("_ascii_code_to_zscii_code(t)")+"}};"}else{f="0";d="";e="m_rebound=function(){"+c._storer("_ascii_code_to_zscii_code(1*m_answers[0])")+"};"}return"m_pc="+c.m_pc+";"+d+e+"m_effects=["+GNUSTO_EFFECT_INPUT_CHAR+","+f+"];return"}function handleZ_scan_table(c,b){if(b.length==4){return"t=_scan_table("+b[0]+","+b[1]+"&0xFFFF,"+b[2]+"&0xFFFF,"+b[3]+");"+c._storer("t")+";"+c._brancher("t")}else{return"t=_scan_table("+b[0]+","+b[1]+"&0xFFFF,"+b[2]+"&0xFFFF,"+130+");"+c._storer("t")+";"+c._brancher("t")}}function handleZ_not(c,b){return c._storer("~"+b[0]+"&0xffff")}function handleZ_tokenise(c,b){return"_tokenise(("+b[0]+")&0xFFFF,("+b[1]+")&0xFFFF,"+b[2]+","+b[3]+")"}function handleZ_encode_text(c,b){return"_encode_text("+b[0]+","+b[1]+","+b[2]+","+b[3]+")"}function handleZ_copy_table(c,b){return"_copy_table("+b[0]+","+b[1]+","+b[2]+")"}function handleZ_print_table(c,b){if(b.length<3){b.push(1)}if(b.length<4){b.push(0)}return"m_pc="+c.m_pc+";m_effects=_print_table("+b[0]+","+b[1]+","+b[2]+","+b[3]+");return"}function handleZ_check_arg_count(c,b){return c._brancher(b[0]+"<=_param_count()")}function handleZ_saveV123(c,b){c.m_compilation_running=0;var d="m_rebound=function(){"+c._brancher("m_answers[0]")+"};";return"m_state_to_save=_saveable_state(1);m_pc="+c.m_pc+";"+d+";m_effects=["+GNUSTO_EFFECT_SAVE+"];return"}function handleZ_saveV45678(c,b){c.m_compilation_running=0;var d="m_rebound=function() { "+c._storer("m_answers[0]")+"};";return"m_state_to_save=_saveable_state("+(c.m_version==4?"1":"3")+");m_pc="+c.m_pc+";"+d+";m_effects=["+GNUSTO_EFFECT_SAVE+"];return"}function handleZ_restoreV123(c,b){c.m_compilation_running=0;c._brancher("");return"m_pc="+c.m_pc+";m_effects=["+GNUSTO_EFFECT_RESTORE+"];return"}function handleZ_restoreV45678(c,b){c.m_compilation_running=0;var d="m_rebound=function() { var t=m_answers[0]; if (t==0){"+c._storer("t")+"}};";return"m_pc="+c.m_pc+";"+d+"m_effects=["+GNUSTO_EFFECT_RESTORE+"];return"}function handleZ_log_shift(c,b){return c._storer("_log_shift("+b[0]+","+b[1]+")")}function handleZ_art_shift(c,b){return c._storer("_art_shift("+b[0]+","+b[1]+")")}function handleZ_set_font(c,b){return c._storer("("+b[0]+"<2?1:0)")}function handleZ_save_undo(c,b){return c._storer("_save_undo(3)")}function handleZ_restore_undo(c,b){return"if(_restore_undo(3))return;"+c._storer("0")}function handleZ_print_unicode(c,b){return c._handler_zOut("String.fromCharCode("+b[0]+")",0)}function handleZ_check_unicode(c,b){return c._storer("3")}var handlers_v578={1:handleZ_je,2:handleZ_jl,3:handleZ_jg,4:handleZ_dec_chk,5:handleZ_inc_chk,6:handleZ_jin,7:handleZ_test,8:handleZ_or,9:handleZ_and,10:handleZ_test_attr,11:handleZ_set_attr,12:handleZ_clear_attr,13:handleZ_store,14:handleZ_insert_obj,15:handleZ_loadw,16:handleZ_loadb,17:handleZ_get_prop,18:handleZ_get_prop_addr,19:handleZ_get_next_prop,20:handleZ_add,21:handleZ_sub,22:handleZ_mul,23:handleZ_div,24:handleZ_mod,25:handleZ_call_2s,26:handleZ_call_2n,27:handleZ_set_colour,28:handleZ_throw,128:handleZ_jz,129:handleZ_get_sibling,130:handleZ_get_child,131:handleZ_get_parent,132:handleZ_get_prop_len,133:handleZ_inc,134:handleZ_dec,135:handleZ_print_addr,136:handleZ_call_1s,137:handleZ_remove_obj,138:handleZ_print_obj,139:handleZ_ret,140:handleZ_jump,141:handleZ_print_paddr,142:handleZ_load,143:handleZ_call_1n,176:handleZ_rtrue,177:handleZ_rfalse,178:handleZ_print,179:handleZ_print_ret,180:handleZ_nop,183:handleZ_restart,184:handleZ_ret_popped,185:handleZ_catch,186:handleZ_quit,187:handleZ_new_line,189:handleZ_verify,190:handleZ_illegal_extended,191:handleZ_piracy,224:handleZ_call_vs,225:handleZ_store_w,226:handleZ_storeb,227:handleZ_putprop,228:handleZ_read,229:handleZ_print_char,230:handleZ_print_num,231:handleZ_random,232:handleZ_push,233:handleZ_pull,234:handleZ_split_window,235:handleZ_set_window,236:handleZ_call_vs,237:handleZ_erase_window,238:handleZ_erase_line,239:handleZ_set_cursor,240:handleZ_get_cursor,241:handleZ_set_text_style,242:handleZ_buffer_mode,243:handleZ_output_stream,244:handleZ_input_stream,245:handleZ_sound_effect,246:handleZ_read_char,247:handleZ_scan_table,248:handleZ_not,249:handleZ_call_vn,250:handleZ_call_vn,251:handleZ_tokenise,252:handleZ_encode_text,253:handleZ_copy_table,254:handleZ_print_table,255:handleZ_check_arg_count,1000:handleZ_saveV45678,1001:handleZ_restoreV45678,1002:handleZ_log_shift,1003:handleZ_art_shift,1004:handleZ_set_font,1009:handleZ_save_undo,1010:handleZ_restore_undo,1011:handleZ_print_unicode,1012:handleZ_check_unicode};var handlers_fixups={1:{25:0,26:0,27:0,28:0,136:0,143:handleZ_not,181:handleZ_saveV123,182:handleZ_restoreV123,185:handleZ_pop,188:handleZ_show_status,190:0,191:0,236:0,237:0,238:0,239:0,240:0,241:0,242:0,246:0,247:0,248:0,249:0,250:0,251:0,252:0,253:0,254:0,255:0},2:{25:0,26:0,27:0,28:0,136:0,143:handleZ_not,181:handleZ_saveV123,182:handleZ_restoreV123,185:handleZ_pop,188:handleZ_show_status,190:0,191:0,236:0,237:0,238:0,239:0,240:0,241:0,242:0,246:0,247:0,248:0,249:0,250:0,251:0,252:0,253:0,254:0,255:0},3:{25:0,26:0,27:0,28:0,136:0,143:handleZ_not,181:handleZ_saveV123,182:handleZ_restoreV123,185:handleZ_pop,188:handleZ_show_status,190:0,191:0,236:0,237:0,238:0,239:0,240:0,241:0,242:0,246:0,247:0,248:0,249:0,250:0,251:0,252:0,253:0,254:0,255:0},4:{26:0,27:0,28:0,143:handleZ_not,181:handleZ_saveV45678,182:handleZ_restoreV45678,185:handleZ_pop,190:0,191:0,248:0,249:0,250:0,251:0,252:0,253:0,254:0,255:0},5:"",6:undefined,7:"",8:""};function pc_translate_v123(a){return"(("+a+")&0xFFFF)*2"}function pc_translate_v45(a){return"(("+a+")&0xFFFF)*4"}function pc_translate_v67R(a){return"(("+a+")&0xFFFF)*4+"+this.m_routine_start}function pc_translate_v67S(a){return"(("+a+")&0xFFFF)*4+"+this.m_string_start}function pc_translate_v8(a){return"(("+a+")&0xFFFF)*8"}function gnusto_error(a){message="Component: engine\n";for(var b=1;b<arguments.length;b++){if(arguments[b]&&arguments[b].toString){message+="\nDetail: "+arguments[b].toString()}}throw new FatalError(message)}function onISRReturn_for_read_char(a,b){if(b){a.engine.m_answers[0]=0;a.rebound()}else{a.engine.m_effects=a.effects;a.engine.m_rebound=a.rebound;a.engine.m_rebound_args=a.rebound_args}}function onISRReturn_for_read(b,c){var a=b.engine;if(c){a.m_answers[0]=0;a.m_answers[1]="";b.rebound()}else{a.m_effects=b.effects;a.m_rebound=b.rebound;a.m_rebound_args=b.rebound_args}}function GnustoEngine(a){if(a){this.logger=function(d,c){a("gnusto-engine: "+d+": "+c)}}else{this.logger=function(){}}}GnustoEngine.prototype={loadStory:function ge_loadStory(a){this.m_memory=a;this._initial_setup()},loadSavedGame:function ge_loadSavedGame(savefile){var quetzal=new Quetzal(savefile);var mem=quetzal.memory;var stacks=quetzal.stacks;var pc=quetzal.pc;function decodeStackInt(offset,length){var result=stacks[offset++];for(var i=1;i<length;i++){result=(result<<8)|stacks[offset++]}return result}if(quetzal.compressed){var temp=[];var cursor_compressed=0;var cursor_original=0;while(cursor_compressed<mem.length){if(cursor_original>=this.m_original_memory.length){gnusto_error(999,"overshoot in decompression")}var candidate=mem[cursor_compressed++];if(candidate==0){var run_length=mem[cursor_compressed++]+1;temp=temp.concat(this.m_original_memory.slice(cursor_original,cursor_original+run_length));cursor_original+=run_length}else{temp.push(candidate^this.m_original_memory[cursor_original++])}}mem=temp}this.m_call_stack=[];this.m_gamestack=[];this.m_locals_stack=[];this.m_locals=[];this.m_result_targets=[];var evals_count=0;evals_count=decodeStackInt(7,1);this.m_gamestack_callbreaks=[];var callbreaks_top=evals_count;var cursor=8;for(var m=0;m<evals_count;m++){this.m_gamestack.push(decodeStackInt(cursor,2));cursor+=2}while(cursor<stacks.length){this.m_call_stack.push(decodeStackInt(cursor,3));cursor+=3;var flags=stacks[cursor++];var varcode=stacks[cursor++];if(flags&16){varcode=-1}var locals_count=flags&15;this.m_locals_stack.unshift(locals_count);this.m_result_targets.push(varcode);var logArgs=stacks[cursor++]+1;var argCount=0;while(logArgs>1){logArgs>>=1;argCount++}this.m_param_counts.unshift(argCount);evals_count=decodeStackInt(cursor,2);cursor+=2;callbreaks_top+=evals_count;this.m_gamestack_callbreaks.push(callbreaks_top);var locals_temp=[];for(var k=0;k<locals_count;k++){locals_temp.push(decodeStackInt(cursor,2));cursor+=2}this.m_locals=locals_temp.concat(this.m_locals);for(var m=0;m<evals_count;m++){this.m_gamestack.push(decodeStackInt(cursor,2));cursor+=2}}for(var n=0;n<16;n++){this.m_locals.push(0)}this.m_memory=mem.concat(this.m_memory.slice(mem.length));if(this.m_version<=3){this.m_pc=pc;eval("var t=new Function('with(this){'+_brancher('1')+'}');t.call(this);")}else{this._varcode_set(2,this.m_memory[pc]);this.m_pc=pc+1}},resetStory:function ge_resetStory(){this.m_memory=this.m_original_memory.slice();this._initial_setup()},version:function ge_version(){gnusto_error(101,"'version' not implemented")},signature:function ge_signature(){gnusto_error(101,"'signature' not implemented")},cvsVersion:function ge_cvsVersion(){return CVS_VERSION.substring(7,26)},setGoldenTrail:function ge_setGoldenTrail(a){if(a){this.m_goldenTrail=1}else{this.m_goldenTrail=0}},setCopperTrail:function ge_setCopperTrail(a){if(a){this.m_copperTrail=1}else{this.m_copperTrail=0}},effect:function ge_effect(a){return this.m_effects[a]},answer:function ge_answer(b,a){this.m_answers[b]=a},run:function ge_run(){var start_pc=0;var turns=0;var jscode;var turns_limit=this.m_single_step?1:10000;if(this.m_rebound){this.m_rebound();this.m_rebound=0;this.m_rebound_args=[]}this.m_effects=[];while(this.m_effects.length==0){if(turns++>=turns_limit){this.m_effects=["WO"];return 1}start_pc=this.m_pc;if(this.m_jit[start_pc]){jscode=this.m_jit[start_pc]}else{jscode=eval("with (this) {dummy="+this._compile()+"}");if(start_pc>=this.m_stat_start){this.m_jit[start_pc]=jscode}}jscode()}},walk:function ge_walk(a){gnusto_error(101,"'walk' not implemented")},setRandomSeed:function ge_setRandomSeed(a){if(a>0){this._random_number(-a)}else{this._random_number(a)}},saveGame:function ge_saveGame(){function e(j,m){var s=[];for(var k=0;k<m;k++){s[(m-k)-1]=j&255;j>>=8}return s}var c=this.m_state_to_save,b=[],a=0,o=this.m_locals.length-16,h=0,p=[0,0,0,0,0,0],g=new Quetzal();g.release=c.m_memory.slice(2,4);g.serial=c.m_memory.slice(18,24);g.checksum=c.m_memory.slice(28,30);g.pc=c.m_pc;g.compressed=1;for(var v=0,l=this.m_stat_start;v<l;v++){if(c.m_memory[v]==this.m_original_memory[v]){a++;if(a==256){b.push(0);b.push(255);a=0}}else{if(a!=0){b.push(0);b.push(a-1);a=0}b.push(c.m_memory[v]^this.m_original_memory[v])}}if(a!=0){b.push(0);b.push(a-1)}g.memory=b;p=p.concat(e(this.m_gamestack_callbreaks[0],2));for(var r=0;r<this.m_gamestack_callbreaks[0];r++){p=p.concat(e(this.m_gamestack[h++],2))}for(var u=0;u<this.m_call_stack.length;u++){p=p.concat(e(this.m_call_stack[u],3));var q=this.m_locals_stack[this.m_locals_stack.length-(u+1)],d=q,n=this.m_result_targets[u],w=this.m_param_counts[this.m_param_counts.length-(u+1)],f=this.m_gamestack_callbreaks[u]-h;if(n==-1){n=0;d|=16}p=p.concat([d,n,(1<<w)-1,(f>>8)&255,f&255]);o-=q;for(var t=0;t<q;t++){p=p.concat(e(this.m_locals[o+t],2))}for(var r=0;r<f;r++){p=p.concat(e(this.m_gamestack[h++],2))}}g.stacks=p;this.m_quetzal_image=g.write();return this.m_quetzal_image.length},saveGameData:function ge_saveGameData(a,c){var b=this.m_quetzal_image;this.m_quetzal_image=0;return b},architecture:function ge_architecture(){return"none"},piracy:function ge_piracy(){return -1},tandy:function ge_tandy(){return -1},status:function ge_status(){return"this is the status, hurrah!"},getStatusLine:function ge_getStatusLine(f){var a=this.getUnsignedWord(this.m_vars_start);var c=this.getUnsignedWord(this.m_property_list_addr_start+(this.m_object_size*a));var e=this._zscii_from(c+1);if(e.length>f){e=e.substring(0,f-3);var g="...";var h=""}else{if((this.m_version>3)&&((this.getByte(1)&2)==2)){var b=this.getUnsignedWord(this.m_vars_start+2);var d=this.getUnsignedWord(this.m_vars_start+4);if(d<10){var g=b+":0"+d}else{var g=b+":"+d}}else{var g="Score: "+this.getUnsignedWord(this.m_vars_start+2)+"  Moves: "+this.getUnsignedWord(this.m_vars_start+4)}if((e.length+g.length+1)>f){g=" S:"+this.getUnsignedWord(this.m_vars_start+2)+" M:"+this.getUnsignedWord(this.m_vars_start+4);if((e.length+g.length+1)>f){g=" "+this.getUnsignedWord(this.m_vars_start+2)+"/"+this.getUnsignedWord(this.m_vars_start+4)}if((e.length+g.length+1)>f){g=""}}var h="";while((e.length+g.length+h.length)<f){h+=" "}}return e+h+g},_initial_setup:function ge_initial_setup(){this.m_jit=[];this.m_compilation_running=0;this.m_gamestack=[];this.m_gamestack_callbreaks=[];this.m_call_stack=[];this.m_locals=[];this.m_locals_stack=[];this.m_param_counts=[];this.m_result_targets=[];this.m_goldenTrail=0;this.m_copperTrail=0;this.m_version=this.m_memory[0];this.m_himem=this.getUnsignedWord(4);this.m_pc=this.getUnsignedWord(6);this.m_dict_start=this.getUnsignedWord(8);this.m_objs_start=this.getUnsignedWord(10);this.m_vars_start=this.getUnsignedWord(12);this.m_stat_start=this.getUnsignedWord(14);this.m_abbr_start=this.getUnsignedWord(24);if(this.m_version>=4){this.m_alpha_start=this.getUnsignedWord(52);this.m_object_tree_start=this.m_objs_start+112;this.m_property_list_addr_start=this.m_object_tree_start+12;this.m_object_size=14}else{this.m_alpha_start=0;this.m_object_tree_start=this.m_objs_start+53;this.m_property_list_addr_start=this.m_object_tree_start+7;this.m_object_size=9}this.m_hext_start=this.getUnsignedWord(54);this.m_original_memory=this.m_memory.slice();if(this.m_version<=3){this.m_pc_translate_for_routine=pc_translate_v123;this.m_pc_translate_for_string=pc_translate_v123}else{if(this.m_version<=5){this.m_pc_translate_for_routine=pc_translate_v45;this.m_pc_translate_for_string=pc_translate_v45}else{if(this.m_version<=7){this.m_routine_start=this.getUnsignedWord(40)*8;this.m_string_start=this.getUnsignedWord(42)*8;this.m_pc_translate_for_routine=pc_translate_v67R;this.m_pc_translate_for_string=pc_translate_v67S}else{if(this.m_version==8){this.m_pc_translate_for_routine=pc_translate_v8;this.m_pc_translate_for_string=pc_translate_v8}else{gnusto_error(170,"impossible: unknown z-version got this far")}}}}if(!(this.m_version in handlers_fixups)){gnusto_error(311,"unknown z-machine version")}var f=handlers_fixups[this.m_version];switch(typeof(f)){case"undefined":gnusto_error(101,"z-machine version not implemented");break;case"string":this.m_handlers=handlers_v578;break;case"object":this.m_handlers={};for(var c in handlers_v578){this.m_handlers[c]=handlers_v578[c]}for(var h in f){if((typeof f[h])=="function"){this.m_handlers[h]=f[h]}else{delete this.m_handlers[h]}}break;default:gnusto_error(170,"impossible: weird stuff in fixups table")}this.m_separator_count=this.m_memory[this.m_dict_start];for(var g=0;g<this.m_separator_count;g++){this.m_separators[g]=this._zscii_char_to_ascii(this.m_memory[this.m_dict_start+g+1])}if(this.m_hext_start>0){this.m_unicode_start=this.getUnsignedWord(this.m_hext_start+6);if(this.m_unicode_start>0){this.m_custom_unicode_charcount=this.m_memory[this.m_unicode_start];this.m_unicode_start+=1;for(var g=0;g<this.m_custom_unicode_charcount;g++){reverse_unicode_table[this.getUnsignedWord(this.m_unicode_start+(g*2))]=g+155}}}if(!(this.m_unicode_start>0)){for(var g in default_unicode_translation_table){reverse_unicode_table[default_unicode_translation_table[g]]=g}}this.m_rebound=0;this.m_rebound_args=[];this.m_output_to_console=1;this.m_streamthrees=[];this.m_output_to_script=0;this.m_console_buffer="";this.m_transcript_buffer="";this.m_zalphabet[0]="abcdefghijklmnopqrstuvwxyz";this.m_zalphabet[1]="ABCDEFGHIJKLMNOPQRSTUVWXYZ";if(this.m_version==1){this.m_zalphabet[2]="T0123456789.,!?_#'\"/\\<-:()"}else{this.m_zalphabet[2]="T\n0123456789.,!?_#'\"/\\-:()"}var e;var j;if(this.m_alpha_start>0){for(var b=0;b<3;b++){var a="";for(var d=0;d<26;d++){j=this.m_memory[this.m_alpha_start+(b*26)+d];if((j>=155)&&(j<=251)){if(this.m_unicode_start==0){a+=String.fromCharCode(default_unicode_translation_table[j])}else{if((j-154)<=this.m_custom_unicode_charcount){a+=String.fromCharCode(this.getUnsignedWord(this.m_unicode_start+((j-155)*2)))}else{a+=" "}}}else{e=String.fromCharCode(j);if(e=="^"){e="\n"}a+=e}}this.m_zalphabet[b]=a}}for(var g=0;g<16;g++){this.m_locals[g]=0}this.m_printing_header_bits=0;this.m_leftovers="";this.m_memory[50]=1;this.m_memory[51]=0},getByte:function ge_getbyte(a){if(a<0){a&=65535}return this.m_memory[a]},setByte:function ge_setByte(b,a){if(a<0){a&=65535}this.m_memory[a]=b},getWord:function ge_getWord(a){if(a<0){a&=65535}var b=(this.m_memory[a]<<8)|this.m_memory[a+1];return((b&32768)?~65535:0)|b},_unsigned2signed:function ge_unsigned2signed(a){return((a&32768)?~65535:0)|a},_signed2unsigned:function ge_signed2unsigned(a){return a&65535},getUnsignedWord:function ge_getUnsignedWord(a){if(a<0){a&=65535}return(this.m_memory[a]<<8)|this.m_memory[a+1]},setWord:function ge_setWord(b,a){if(a<0){a&=65535}this.m_memory[a]=(b>>8)&255;this.m_memory[a+1]=(b)&255},_handle_variable_parameters:function ge_handle_var_parameters(b,c,e){var a=0,f="",d;if(e==1){c=(c<<8)|255}while(1){var g=c&49152;if(g==49152){return f}else{if(g==0){b[a++]=this.getWord(this.m_pc);this.m_pc+=2}else{if(g==16384){b[a++]=this.m_memory[this.m_pc++]}else{if(g==32768){d=this._code_for_varcode(this.m_memory[this.m_pc++]);f+=d[0];b[a++]=d[1]}}}}c=(c<<2)|3}},_compile:function ge_compile(){this.m_compilation_running=1;var f="",b=this.m_pc,e;temp_var=0;do{var c=[];this_instr_pc=this.m_pc;var a=this.m_memory[this.m_pc++];if(a==0){gnusto_error(201)}else{if(a==190){a=1000+this.m_memory[this.m_pc++];f+=this._handle_variable_parameters(c,this.m_memory[this.m_pc++],1)}else{if(a&128){if(a&64){if(!(a&32)){a&=31}if(a==250||a==236){var d=this.getUnsignedWord(this.m_pc);this.m_pc+=2;f+=this._handle_variable_parameters(c,d,2)}else{f+=this._handle_variable_parameters(c,this.m_memory[this.m_pc++],1)}}else{switch(a&48){case 0:c[0]=this.getWord(this.m_pc);this.m_pc+=2;a=(a&15)|128;break;case 16:c[0]=this.m_memory[this.m_pc++];a=(a&15)|128;break;case 32:e=this._code_for_varcode(this.m_memory[this.m_pc++]);f+=e[0];c[0]=e[1];a=(a&15)|128;break;case 48:a=(a&15)|176;break}}}else{if(a&64){e=this._code_for_varcode(this.m_memory[this.m_pc++]);f+=e[0];c[0]=e[1]}else{c[0]=this.m_memory[this.m_pc++]}if(a&32){e=this._code_for_varcode(this.m_memory[this.m_pc++]);f+=e[0];c[1]=e[1]}else{c[1]=this.m_memory[this.m_pc++]}a&=31}}}if(this.m_handlers[a]){f=f+this.m_handlers[a](this,c)+";"}else{if(a>=1128&&a<=1255&&"special_instruction_EXT"+(a-1000) in this){f=f+this["special_instruction_EXT"+(a-1000)](c)+";"}else{gnusto_error(200,this.m_pc.toString(16))}}}while(this.m_compilation_running);if(this.m_single_step||this.m_debug_mode){f=f+"m_pc="+this.m_pc}f=f.replace(/m_gamestack\.push\(([^;]+)\);var tmp_(\d+) = m_gamestack\.pop\(\);/,"var tmp_$2 = $1;");return"function JIT_"+b.toString(16)+"_"+b+"(){"+f+"}"},_param_count:function ge_param_count(){return this.m_param_counts[0]},_set_output_stream:function ge_set_output_stream(c,b){if(c==0){}else{if(c==1){this.m_output_to_console=1}else{if(c==2){this.m_memory[17]|=1}else{if(c==3){if(this.m_streamthrees.length>15){gnusto_error(202)}this.m_streamthrees.unshift([b,b+2])}else{if(c==4){this.m_output_to_script=1}else{if(c==-1){this.m_output_to_console=0}else{if(c==-2){this.m_memory[17]&=~1}else{if(c==-3){if(this.m_streamthrees.length<1){gnusto_error(203)}var a=this.m_streamthrees.shift();this.setWord((a[1]-a[0])-2,a[0])}else{if(c==-4){this.m_output_to_script=0}else{gnusto_error(204,c)}}}}}}}}}},_trunc_divide:function ge_trunc_divide(c,a){var b;if(a==0){gnusto_error(701);return 0}b=c/a;if(b>0){return Math.floor(b)}else{return Math.ceil(b)}},_zscii_char_to_ascii:function ge_zscii_char_to_ascii(a){if(a<0){gnusto_error(702,a)}var b;if(a==13||a==10){b=10}else{if((a>=32&&a<=126)||a==0){b=a}else{if(a>=155&&a<=251){if(this.m_unicode_start==0){return String.fromCharCode(default_unicode_translation_table[a])}else{if((a-154)<=this.m_custom_unicode_charcount){return String.fromCharCode(this.getUnsignedWord(this.m_unicode_start+((a-155)*2)))}else{gnusto_error(703,a)}}}else{return"*"}}}return String.fromCharCode(b)},_ascii_code_to_zscii_code:function ge_ascii_char_to_zscii(a){if((a>=32&&a<=126)||a==0){return a}var b;if(a<0){gnusto_error(702,"Illegal unicode character:"+a)}else{if(a==13||a==10){b=10}else{b=reverse_unicode_table[a];if(!b){b="*".charCodeAt(0)}}}return b},_random_number:function ge_random_number(a){if(a==0){this.m_random_use_seed=this.m_random_use_sequence=0;return 0}else{if(a<-999){this.m_random_state=Math.abs(a);this.m_random_use_seed=1;this.m_random_use_sequence=0;return 0}else{if(a<0){this.m_random_sequence_max=Math.abs(a)-1;this.m_random_state=0;this.m_random_use_seed=0;this.m_random_use_sequence=1;return 0}else{if(this.m_random_use_seed){this.m_random_state--;return 1+(Math.round(Math.abs(Math.tan(this.m_random_state))*8.71*a)%a)}else{if(this.m_random_use_sequence){var b=this.m_random_state;this.m_random_state=this.m_random_state+1;if(this.m_random_state>this.m_random_sequence_max){this.m_random_state=0}return 1+(b%a)}else{return 1+Math.round((a-1)*Math.random())}}}}}gnusto_error(170,"random")},_func_gosub:function ge_gosub(g,e,h,c){this.m_call_stack.push(h);this.m_pc=g;var f=this.m_memory[this.m_pc++];if(this.m_version<5){var a=[];for(var d=0;d<f;d++){if(d<e.length){a.push(e[d])}else{a.push(this.getWord(this.m_pc))}this.m_pc+=2}this.m_locals=a.concat(this.m_locals)}else{for(var b=f;b>0;b--){if(b<=e.length){this.m_locals.unshift(e[b-1])}else{this.m_locals.unshift(0)}}}this.m_locals_stack.unshift(f);this.m_param_counts.unshift(e.length);this.m_result_targets.push(c);this.m_gamestack_callbreaks.push(this.m_gamestack.length);if(g==0){this._func_return(0)}},_func_interrupt:function ge_interrupt(b,a){this.m_interrupt_information.push({on_return:a,rebound:this.m_rebound,rebound_args:this.m_rebound_args,engine:this,pc:this.m_pc,effects:this.m_effects});this._func_gosub(b,[],CALLED_FROM_INTERRUPT,-1)},_tokenise:function ge_tokenise(q,h,j,g){var c=0;var e=h+2;var t=h+1;if(isNaN(j)){j=0}if(isNaN(g)){g=0}function l(J,u,B){function v(L,O,N){var M=0;var i,K;while(1){if(M==O.length){return 0}i=L.m_memory[N+M];K=O.charCodeAt(M);if(i==K){M++}else{if(i<K){return -1}else{return 1}}}}var A=J.m_memory[B+J.m_separator_count+1];var G=J.getWord(B+J.m_separator_count+2);var x=J.m_dict_start+J.m_separator_count+4;var F=1;if(G<0){F=0;G=-G}var I=u;u=J._into_zscii(u);if(F){var C=0,y=G-1;var E;var w;var D;while(1){E=C+Math.round((y-C)/2);w=x+E*A;D=v(J,u,w);if(D<0){if(C==y){return 0}C=E+1}else{if(D>0){if(C==y){return 0}y=E-1}else{return w}}if(C>y){return 0}}}else{for(var z=0;z<G;z++){var H=x+z*A;if(v(J,u,H)==0){return H}}}return 0}function o(i,x,w,v){var u=l(i,w,x);if(!(g&&u==0)){i.setWord(u,e);e+=2;i.setByte(w.length,e++);i.setByte(v,e++)}else{e+=4}c++;return 1}var d=this.m_memory[q];var s="";if(j==0){j=this.m_dict_start}if(this.m_version<=4){d++;var r=q+1;while(1){var k=this.m_memory[r++];if(k==0){break}s+=String.fromCharCode(k)}}else{for(var p=0;p<this.m_memory[q+1];p++){s+=String.fromCharCode(this.m_memory[q+2+p])}}var m=[];var n="";var f=0;var b;if(this.m_version<=4){b=1}else{b=2}for(var a=0;a<s.length;a++){if(s.charAt(a)==" "){if(n!=""){m[f]=n;o(this,j,m[f],(a-m[f].length)+b);f++;n=""}}else{if(this._is_separator(s.charAt(a))){if(n!=""){m[f]=n;o(this,j,m[f],(a-m[f].length)+b);f++}m[f]=s.charAt(a);o(this,j,m[f],a+b);f++;n=""}else{n+=s.charAt(a)}}}if(n!=""){m[f]=n;o(this,j,m[f],(a-m[f].length)+b)}this.setByte(c,t)},_aread:function ge_aread(g,b,d,a){b&=65535;d&=65535;var h;var e;var f;if(this.m_version<=4){h=this.m_memory[b]+1;e=a.substring(0,h).toLowerCase();f=b+1;this.setByte(0,b+1+e.length)}else{h=this.m_memory[b];e=a.substring(0,h).toLowerCase();f=b+2;this.setByte(e.length,b+1)}for(var c=0;c<e.length;c++){this.setByte(this._ascii_code_to_zscii_code(e.charCodeAt(c)),f+c)}if(d!=0||this.m_version<5){this._tokenise(b,d,0,0)}if(g==13){return 10}else{return g}},_terminating_characters:function ge_terminating_characters(){if(this.m_version<5){return"\r"}else{var a=this.getWord(46);var c="\r";while(1){var b=this.m_memory[a++];if(b==0){break}else{if((b>=129&&b<=154)||(b>=252)){c+=String.fromCharCode(b)}}}return c}},_func_return:function ge_func_return(b){this.m_locals=this.m_locals.slice(this.m_locals_stack.shift());this.m_param_counts.shift();this.m_pc=this.m_call_stack.pop();this.m_gamestack.length=this.m_gamestack_callbreaks.pop();var c=this.m_result_targets.pop();if(c!=-1&&b!=null){if(c==0){this.m_gamestack.push(b)}else{if(c<16){this.m_locals[c-1]=b}else{this.setWord(b,this.m_vars_start+(c-16)*2)}}}if(this.m_pc==CALLED_FROM_INTERRUPT){var a=this.m_interrupt_information.pop();this.m_pc=a.pc;a.on_return(a,b)}},_throw_stack_frame:function throw_stack_frame(a){if(a>this.m_call_stack.length||a<1){gnusto_error(207,a)}while(this.m_call_stack.length>a-1){this._func_return(null)}},_get_prop_addr:function ge_get_prop_addr(b,a){if(b==0){return 0}var c=this._property_search(b,a,-1);if(c[2]){return c[0]}else{return 0}},_get_prop_len:function ge_get_prop_len(a){a&=65535;if(this.m_version<4){return 1+(this.m_memory[a-1]>>5)}else{var b=this.m_memory[a-1];if(b&128){b=b&63;if(b==0){return 64}else{return b}}else{if(b&64){return 2}else{return 1}}}gnusto_error(170,"get_prop_len")},_get_next_prop:function ge_get_next_prop(b,a){if(b==0){return 0}var c=this._property_search(b,-1,a);if(c[2]){return c[3]}else{if(c[4]){return 0}else{gnusto_error(205,a)}}gnusto_error(173)},_get_prop:function ge_get_prop(c,a){if(c==0){return 0}var b=this._property_search(c,a,-1);if(b[0]<0){b[0]&=65535}if(b[1]==1){return this.m_memory[b[0]]}else{if(b[1]==2){var d=(this.m_memory[b[0]]<<8)|this.m_memory[b[0]+1];return((d&32768)?~65535:0)|d}else{return this.getWord(b[0])}}gnusto_error(174)},_property_search:function ge_property_search(d,c,e){var f=this.getUnsignedWord(this.m_property_list_addr_start+d*this.m_object_size);f=f+this.m_memory[f]*2+1;var b=0;while(1){var a=1;var g=this.m_memory[f++];if(this.m_version<4){a=(g>>5)+1;g=g&31}else{if(g&128){a=this.m_memory[f++]&63;if(a==0){a=64}}else{if(g&64){a=2}}g=g&63}if(g==c||b==e){return[f,a,1,g,0]}else{if(g<c){if(c>0){return[this.m_objs_start+(c-1)*2,2,0,c,0]}else{return[-1,-1,0,c,b==c]}}}f+=a;b=g}gnusto_error(175)},_set_attr:function ge_set_attr(a,d){if(a==0){return}var b=this.m_object_tree_start+a*this.m_object_size+(d>>3);var c=this.m_memory[b];this.setByte(c|(128>>(d%8)),b)},_clear_attr:function ge_clear_attr(a,d){if(a==0){return}var b=this.m_object_tree_start+a*this.m_object_size+(d>>3);var c=this.m_memory[b];this.setByte(c&~(128>>(d%8)),b)},_test_attr:function ge_test_attr(a,b){if(a==0){return 0}if((this.m_memory[this.m_object_tree_start+a*this.m_object_size+(b>>3)]&(128>>(b%8)))){return 1}else{return 0}},_put_prop:function put_prop(b,a,d){if(b==0){return}var c=this._property_search(b,a,-1);if(!c[2]){gnusto_error(704)}if(c[1]==1){this.setByte(d&255,c[0])}else{if(c[1]==2){this.setWord(d&65535,c[0])}else{gnusto_error(705)}}},_get_older_sibling:function ge_get_older_sibling(a){if(a==0){return 0}var b=this._get_child(this._get_parent(a));if(a==b){return 0}while(b){next_along=this._get_sibling(b);if(next_along==a){return b}b=next_along}return 0},_insert_obj:function ge_insert_obj(a,d){var e=this._get_parent(a);var b=this._get_older_sibling(a);var c=this._get_sibling(a);if(e&&this._get_child(e)==a){this._set_child(e,c)}if(b){this._set_sibling(b,c)}this._set_parent(a,d);if(d){this._set_sibling(a,this._get_child(d));this._set_child(d,a)}},_remove_obj:function ge_remove_obj(a,b){this._insert_obj(a,0)},_get_family:function ge_get_family(b,a){if(b==0){return 0}if(this.m_version<4){return this.m_memory[this.m_object_tree_start+4+a+b*this.m_object_size]}else{return this.getUnsignedWord(this.m_object_tree_start+6+a*2+b*this.m_object_size)}gnusto_error(170,"get_family")},_get_parent:function ge_get_parent(a){return this._get_family(a,PARENT_REC)},_get_child:function ge_get_child(a){return this._get_family(a,CHILD_REC)},_get_sibling:function ge_get_sibling(a){return this._get_family(a,SIBLING_REC)},_set_family:function ge_set_family(c,b,a){if(this.m_version<4){this.setByte(b,this.m_object_tree_start+4+a+c*this.m_object_size)}else{this.setWord(b,this.m_object_tree_start+6+a*2+c*this.m_object_size)}},_set_parent:function ge_set_parent(b,a){this._set_family(b,a,PARENT_REC)},_set_child:function ge_set_child(b,a){this._set_family(b,a,CHILD_REC)},_set_sibling:function ge_set_sibling(b,a){this._set_family(b,a,SIBLING_REC)},_obj_in:function ge_obj_in(b,a){return this._get_parent(b)==a},_copy_table:function ge_copy_table(e,c,b){if(c==0){for(var a=0;a<b;a++){this.setByte(0,a+e)}}else{var d=0;if(b<0){b=-b;d=1}else{if(e>c){d=1}else{d=0}}if(d){for(var a=0;a<b;a++){this.setByte(this.m_memory[e+a],c+a)}}else{for(var a=b-1;a>=0;a--){this.setByte(this.m_memory[e+a],c+a)}}}},_scan_table:function ge_scan_table(f,e,g,b){var a=b&127;var d=((b&128)==128);var c=e+(g*a);if(d){while(e<c){if(((this.m_memory[65535&e]&255)==((f>>8)&255))&&((this.m_memory[65535&e+1]&255)==(f&255))){return e}e+=a}}else{while(e<c){if((this.m_memory[65535&e]&255)==(f&65535)){return e}e+=a}}return 0},_print_table:function ge_print_table(g,a,e,f){var h=[];for(var c=0;c<e;c++){var i="";for(var d=0;d<a;d++){if(g<0){g&=65535}i=i+this._zscii_char_to_ascii(this.m_memory[g++])}h.push(i);g+=f}var b=["PT",h.length];b=b.concat(h);return b},_zscii_from:function ge_zscii_from(l,m,e){if(l in this.m_jit){if(e){return this.m_jit[l]}else{return this.m_jit[l][0]}}var k="";var g=1;var n=l;var f=0;var h=f;var i=-2;var o=0;if(!m){m=65535}var c=l+m;while(g){var a=this.getUnsignedWord(l);l+=2;g=((a&32768)==0)&&l<c;for(var d=2;d>=0;d--){var b=((a>>(d*5))&31);if(o){k=k+this._zscii_from(this.getUnsignedWord((32*(o-1)+b)*2+this.m_abbr_start)*2);o=0;h=f}else{if(i==-2){if(b>5){if(h==2&&b==6){i=-1}else{k=k+this.m_zalphabet[h].charAt(b-6);h=f}}else{if(b==0){k=k+" ";h=f}else{if(b<4){if(this.getByte(0)>2){o=b}else{if(b==2){h+=1;if(h>2){h=0}}else{if(b==3){h-=1;if(h<0){h=2}}else{if(this.getByte(0)==2){o=1}else{k=k+"\n";h=f}}}}}else{if(this.getByte(0)>2){h=b-3}else{if(b==4){f+=1;if(f>2){f=0}}else{f-=1;if(f<0){f=2}}h=f}}}}}else{if(i==-1){i=b}else{k=k+this._zscii_char_to_ascii((i<<5)+b);i=-2;h=f}}}}}if(n>=this.m_stat_start){this.m_jit[n]=[k,l]}if(e){return[k,l]}else{return k}},_encode_text:function ge_encode_text(j,d,k,l){j=(j+k)&65535;var f="";while(d>0){var g=this.m_memory[j];if(g==0){break}f=f+String.fromCharCode(g);j++;d--}var h=this._into_zscii(f);for(var a=0;a<h.length;a++){var e=h[a].charCodeAt(0);this.setByte(e,l++)}},_into_zscii:function ge_into_zscii(f){var g="";var b=[];var d;if(this.m_version<4){d=4}else{d=6}function i(l){b.push(l);if(b.length==3){var k=(b[0]<<10|b[1]<<5|b[2]);if(g.length==d-2){k|=32768}g=g+String.fromCharCode(k>>8)+String.fromCharCode(k&255);b=[]}}var a,j=0,c;while(j<f.length&&g.length<d){a=f.charCodeAt(j++);if(a>=65&&a<=90){a+=32}else{if(a>154){if(this.m_unicode_start==0){if((a>=158&&a<=160)||(a>=167&&a<=168)||(a>=208&&a<=210)){a-=3}else{if(a>=175&&a<=180){a-=6}else{if((a>=186&&a<=190)||(a>=196&&a<=200)){a-=5}else{if(a==217||a==218){a-=2}else{if(a==202||a==204||a==212||a==214||a==221){a-=1}}}}}}else{var h=this._ascii_code_to_zscii_code(this._zscii_char_to_ascii(a).toLowerCase().charCodeAt(0));if(h>0&&h<=251&&h!="*".charCodeAt(0)){a=h}}}}var e=String.fromCharCode(this._zscii_char_to_ascii(a).charCodeAt(0));c=this.m_zalphabet[0].indexOf(e);if(c!=-1){i(c+6)}else{c=this.m_zalphabet[1].indexOf(e);if(c!=-1){if(this.getByte(0)>2){i(4)}else{i(2)}i(c+6)}else{c=this.m_zalphabet[2].indexOf(e);if(c!=-1){if(this.getByte(0)>2){i(5)}else{i(3)}i(c+6)}else{if(this.getByte(0)>2){i(5)}else{i(3)}i(6);i(a>>5);i(a&31)}}}}while(g.length<d){i(5)}return g.substring(0,d)},_name_of_object:function ge_name_of_object(a){if(a==0){return"<void>"}else{var b=this.m_property_list_addr_start+a*this.m_object_size;return this._zscii_from(this.getUnsignedWord(b)+1)}},_print_leftovers:function ge_print_leftovers(){this._zOut(this.m_leftovers);this.m_leftovers=""},_zOut:function ge_zOut(f){if(this.m_streamthrees.length){var d=this.m_streamthrees[0];var b=this.m_streamthrees[0][1];for(var a=0;a<f.length;a++){this.setByte(this._ascii_code_to_zscii_code(f.charCodeAt(a)),b++)}this.m_streamthrees[0][1]=b}else{var c=this.m_memory[17]&3;var e=c!=this.m_printing_header_bits;effect_parameters=this.m_printing_header_bits;this.m_printing_header_bits=c;if(e){this.m_leftovers=f;this.m_rebound=this._print_leftovers;return 1}else{if(this.m_output_to_console){this.m_console_buffer=this.m_console_buffer+f}if(c&1){this.m_transcript_buffer=this.m_transcript_buffer+f}}}return 0},consoleText:function ge_console_text(){var a=this.m_console_buffer.replace("\x00","","g");this.m_console_buffer="";return a},_transcript_text:function ge_transcript_text(){var a=this.m_transcript_buffer.replace("\x00","","g");this.m_transcript_buffer="";return a},_is_separator:function ge_IsSeparator(b){for(var a=0;a<this.m_separator_count;a++){if(b==this.m_separators[a]){return 1}}return 0},_code_for_varcode:function ge_code_for_varcode(d){var e="",b;if(d==0){e="var tmp_"+(++temp_var)+" = m_gamestack.pop();";b="tmp_"+temp_var}else{if(d<16){b="m_locals["+(d-1)+"]"}else{var f=this.m_vars_start+(d-16)*2,a=f+1;var c="tmp_"+(++temp_var);e="var "+c+" = (m_memory["+f+"] << 8) | m_memory["+a+"];"+c+" = ("+c+" & 0x8000 ? ~0xFFFF : 0) | "+c+";";b=c}}return[e,b]},_varcode_get:function ge_varcode_get(a){if(a==0){return this.m_gamestack.pop()}else{if(a<16){return this.m_locals[(a-1)]}else{return this.getWord(this.m_vars_start+(a-16)*2)}}gnusto_error(170,"varcode_get")},_varcode_set:function ge_varcode_set(b,a){if(a==0){this.m_gamestack.push(b)}else{if(a<16){this.m_locals[a-1]=b}else{this.setWord(b,this.m_vars_start+(a-16)*2)}}},_brancher:function ge_brancher(d){var b=1;var a=this.m_memory[this.m_pc++];var c=a&63;if(a&128){b=0}if(!(a&64)){c=(c<<8)|this.m_memory[this.m_pc++];if(c&8192){c=(~8191)|(c&8191)}}var e=d;if(b){e="if(!("+e+"))"}else{e="if("+e+")"}if(c==0){return e+"{_func_return(0);return;}"}if(c==1){return e+"{_func_return(1);return;}"}c=(this.m_pc+c)-2;return e+"{m_pc="+(c)+";return;}"},_storer:function ge_storer(a){var b=this.m_memory[this.m_pc++];if(a.substring&&a.substring(0,11)=="_func_gosub"){this.m_compilation_running=0;if(a.substring(a.length-4)!=",-1)"){gnusto_error(100,a)}return a.substring(0,a.length-3)+b+")"}else{if(b==0){return"m_gamestack.push("+a+")"}else{if(b<16){return"m_locals["+(b-1)+"]="+a}else{return"setWord("+a+","+(this.m_vars_start+(b-16)*2)+")"}}}gnusto_error(170,"storer")},_generate_gosub:function call_vn(d,a,c){this.m_compilation_running=0;var b=-1;if(c){b=this.m_memory[this.m_pc++]}return"_func_gosub("+this.m_pc_translate_for_routine(d)+",["+a.toString()+"],"+this.m_pc+","+b+")"},_handler_zOut:function ge_handler_zOut(c,a){var b;if(a){b="_func_return(1)"}else{b="m_pc=0x"+this.m_pc.toString(16)}return"if(_zOut("+c+")){"+b+";m_effects=["+GNUSTO_EFFECT_FLAGS_CHANGED+"];return 1}"},_handler_print:function ge_handler_print(d,a){var c=this._zscii_from(this.m_pc,65535,1);var b=c[0];if(d){b=b+d}b=b.quote();this.m_pc=c[1];return this._handler_zOut(b,a)},_log_shift:function ge_log_shift(b,a){if(a<0){return(b>>>(-1*a))&32767}else{return(b<<a)&32767}},_art_shift:function ge_art_shift(b,a){if(a<0){return(b>>(-1*a))&32767}else{return(b<<a)&32767}},_touch:function ge_touch(a){if(this.m_goldenTrail){this.logger("pc",a.toString(16))}this.m_pc=a},_save_undo:function ge_save_undo(a){this.m_undo=this._saveable_state(a);return 1},_restore_undo:function ge_restore_undo(){if(typeof this.m_undo!="object"){return 0}this.m_call_stack=this.m_undo.m_call_stack;this.m_locals=this.m_undo.m_locals;this.m_locals_stack=this.m_undo.m_locals_stack;this.m_param_counts=this.m_undo.m_param_counts;this.m_result_targets=this.m_undo.m_result_targets;this.m_gamestack=this.m_undo.m_gamestack;this.m_gamestack_callbreaks=this.m_undo.m_gamestack_callbreaks;var a=this.m_undo.m_memory;this.m_memory=a.concat(this.m_memory.slice(a.length));this._varcode_set(2,this.m_memory[this.m_undo.m_pc]);this.m_pc=this.m_undo.m_pc+1;this.m_undo=0;return 1},_saveable_state:function ge_saveable_state(b){var a={m_memory:this.m_memory.slice(0,this.m_stat_start),m_pc:this.m_pc+b,m_call_stack:this.m_call_stack.slice(),m_locals:this.m_locals.slice(),m_locals_stack:this.m_locals_stack.slice(),m_param_counts:this.m_param_counts.slice(),m_result_targets:this.m_result_targets.slice(),m_gamestack:this.m_gamestack.slice(),m_gamestack_callbreaks:this.m_gamestack_callbreaks.slice()};return a},_verify:function ge_verify(){var c=0;var b=(this.m_original_memory[28]<<8|this.m_original_memory[29]);for(var a=64;a<this.m_original_memory.length;a++){c+=this.m_original_memory[a]}return(c&65535)==b},m_local_game_file:0,m_memory:[],m_handlers:0,m_jit:[],m_goldenTrail:0,m_copperTrail:0,m_compilation_running:0,m_gamestack:0,m_gamestack_callbreaks:[],m_himem:0,m_pc:0,m_this_instr_pc:0,m_dict_start:0,m_objs_start:0,m_vars_start:0,m_stat_start:0,m_abbr_start:0,m_hext_start:0,m_alpha_start:0,m_zalphabet:[],m_string_start:0,m_routine_start:0,m_unicode_start:0,m_custom_unicode_charcount:0,m_separator_count:0,m_separators:[],m_version:0,m_call_stack:[],m_locals:[],m_locals_stack:0,m_param_counts:0,m_result_targets:[],m_rebound:0,m_rebound_args:[],m_output_to_console:0,m_streamthrees:[],m_output_to_script:0,m_single_step:0,m_debug_mode:0,m_parser_debugging:0,m_breakpoints:{},m_console_buffer:"",m_transcript_buffer:"",m_effects:[],m_answers:[],m_random_state:0,m_random_use_seed:0,m_random_use_sequence:0,m_random_sequence_max:0,m_printing_header_bits:0,m_leftovers:"",m_pc_translate_for_routine:pc_translate_v45,m_pc_translate_for_string:pc_translate_v45,m_undo:0,m_state_to_save:0,m_quetzal_image:0,m_original_memory:[],m_object_tree_start:0,m_property_list_addr_start:0,m_object_size:14,m_interrupt_information:[]};
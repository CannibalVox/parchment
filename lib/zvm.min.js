/*

ZVM - the ifvms.js implementation of the Z-Machine
==================================================

Built: 2011-12-18

Copyright (c) 2011 The ifvms.js team
BSD licenced
http://github.com/curiousdannii/ifvms.js

*/
(function(B,l){if(![].indexOf){Array.prototype.indexOf=function(O,N){for(var M=N||0,L=this.length;M<L;M++){if(this[M]==O){return M}}return -1}}var k=function(L,N){for(var M in N){L[M]=N[M]}return L},s=B.console||{log:function(){},info:function(){},warn:function(){}},H=function(L){return L<<16>>16},f=function(L){return L&65535},t=function(O){var N=0,M=O.length,L=[];while(N<M){L[N/2]=O[N++]<<8|O[N++]}return L},c=function(L){return L.replace(/(e\.)?U2S\(([^(]+?)\)/g,"(($2)<<16>>16)").replace(/(e\.)?S2U\(([^(]+?)\)/g,"(($2)&65535)").replace(/([\w.]+)\.getUint8\(([^(]+?)\)/g,"$1[$2]").replace(/([\w.]+)\.getUint16\(([^(]+?)\)/g,"($1[$2]<<8|$1[$2+1])")},d=function(P,O){var L,N,M=[];for(L in P){if(O.indexOf(L)>=0){N=/function\s*\(([^(]*)\)\s*\{([\s\S]+)\}/.exec(""+P[L]);M.push(L+":function("+N[1]+"){"+c(N[2])+"}")}}k(P,B["eval"]("({"+M.join()+"})"))};var b=0,F=b?function(M){var L=new ArrayBuffer(M),M=new DataView(L);M.buffer=L;return M}:function(L){L=L.slice();return k(L,{data:L,getUint8:function(M){return L[M]},getUint16:function(M){return L[M]<<8|L[M+1]},getBuffer:function(N,M){return L.slice(N,N+M)},setUint8:function(M,N){return L[M]=N&255},setUint16:function(M,N){L[M]=(N>>8)&255;L[M+1]=N&255;return N&65535},setBuffer:function(O,N){var P=0,M=N.length;while(P<M){L[P+O]=N[P++]}}})};var J=Object.subClass({init:function(L,M){this.e=L;this.v=M},toString:function(){return this.v},U2S:function(){return H(this.v)}}),i=J.subClass({toString:function(){var L=this.v;if(this.indirect){return"e.indirect("+L+")"}if(L==0){return"s.pop()"}if(--L<15){return"l["+L+"]"}return"m.getUint16("+(this.e.globals+(L-15)*2)+")"},store:function(M){var L=this.v;if(this.indirect){return"e.indirect("+L+","+M+")"}if(this.returnval){return"e.variable("+L+","+M+")"}if(L==0){return"s.push("+M+")"}if(--L<15){return"l["+L+"]="+M}return"m.setUint16("+(this.e.globals+(L-15)*2)+","+M+")"},U2S:function(){return"e.U2S("+this+")"}}),h=Object.subClass({init:function(P,N,Q,M,O,L){this.e=P;this.context=N;this.code=Q;this.pc=M;this.labels=[this.pc+"/"+this.code];this.next=O;this.operands=L;if(this.post){this.post()}},toString:function(){return this.label()+(this.func?this.func.apply(this,this.operands):"")},args:function(L){return this.operands.join(L)},label:function(){return"/* "+this.labels.join()+" */ "}}),u=h.subClass({stopper:1}),n=u.subClass({storer:1,post:function(){this.storer=this.operands.pop();this.origfunc=this.func;this.func=this.newfunc},newfunc:function(){return"e.pc="+this.next+";"+this.origfunc.apply(this,arguments)}}),D=Object.subClass({init:function(L,M){this.ops=L||[];this.code=M||"||"},toString:function(){var L=0,M=[],N;while(L<this.ops.length){N=this.ops[L++];M.push(N.func?(N.iftrue?"":"!(")+N.func.apply(N,N.operands)+(N.iftrue?"":")"):N)}return(this.invert?"(!(":"(")+M.join(this.code)+(this.invert?"))":")")}}),E=h.subClass({brancher:1,keyword:"if",post:function(){var L,N,M=this.operands.pop(),O=M[1];this.iftrue=M[0];if(O==0||O==1){L="e.ret("+O+")"}else{O+=this.next-2;this.context.targets.push(O);L="e.pc="+O}this.result=L+"; return";this.offset=O;this.cond=new D([this]);if(this.context.ops.length){N=this.context.ops.pop();if(N.offset==O){this.cond.ops.unshift(N.cond);this.labels=N.labels;this.labels.push(this.pc+"/"+this.code)}else{this.context.ops.push(N)}}},toString:function(){var M=0,L=this.result;if(L instanceof G){L=L+(L.stopper?"; return":"");if(this.result.ops.length>1){L="\n"+L+"\n"}}return this.label()+this.keyword+this.cond+" {"+L+"}"}}),z=E.subClass({storer:1,post:function(){this._super();this.storer=this.operands.pop();this.storer.returnval=1;this.origfunc=this.func;this.func=this.newfunc},newfunc:function(){return this.storer.store(this.origfunc.apply(this,arguments))}}),o=h.subClass({storer:1,post:function(){this.storer=this.operands.pop()},toString:function(){var L=this._super();return this.storer?this.storer.store(L):L}}),y=u.subClass({result:{v:-1},toString:function(){return this.label()+"e.call("+this.operands.shift()+","+this.result.v+","+this.next+",["+this.args()+"])"}}),p=y.subClass({storer:1,post:function(){this.result=this.operands.pop()}}),G=Object.subClass({init:function(M,L){this.e=M;this.pc=L;this.pre=[];this.ops=[];this.post=[];this.targets=[]},toString:function(){return this.pre.join("")+this.ops.join(";")+this.post.join("")}}),A=G.subClass({toString:function(){this.pre.unshift("var l=e.l,m=e.m,s=e.s;\n");return this._super()}}),K=function(M,N,L){var L=L||{};if(N){L.func=N}return M.subClass(L)};var x=IFF.subClass({init:function(M){this._super(M);if(M){if(this.type!="IFZS"){throw new Error("Not a Quetzal savefile")}for(var N=0,L=this.chunks.length;N<L;N++){var O=this.chunks[N].type,P=this.chunks[N].data;if(O=="CMem"||O=="UMem"){this.memory=P;this.compressed=(O=="CMem")}else{if(O=="Stks"){this.stacks=P}else{if(O=="IFhd"){this.release=P.slice(0,2);this.serial=P.slice(2,8);this.checksum=P.slice(8,10);this.pc=P[10]<<16|P[11]<<8|P[12]}}}}}},write:function(){this.type="IFZS";var M=this.pc,L=this.release.concat(this.serial,this.checksum,(M>>16)&255,(M>>8)&255,M&255);this.chunks=[{type:"IFhd",data:L},{type:(this.compressed?"CMem":"UMem"),data:this.memory},{type:"Stks",data:this.stacks}];return this._super()}});var I=(function(){var M={8:8,13:13,27:27,37:131,38:129,39:132,40:130},L=96;while(L<106){M[L]=49+L++}L=112;while(L<124){M[L]=21+L++}return M})(),q=Object.subClass({init:function(T){var Q=T.m,N=Q.getUint16(52),P=T.extension_table(3),L=P&&Q.getUint8(P++),R,M=[],S=0,O=96;this.e=T;this.maxaddr=Q.getUint16(26)*T.addr_multipler;this.make_alphabet(N?Q.getBuffer(N,78):this.text_to_zscii("abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ \r0123456789.,!?_#'\"/\\-:()",1));this.make_unicode(P?t(Q.getBuffer(P,L*2)):this.text_to_zscii(unescape("%E4%F6%FC%C4%D6%DC%DF%BB%AB%EB%EF%FF%CB%CF%E1%E9%ED%F3%FA%FD%C1%C9%CD%D3%DA%DD%E0%E8%EC%F2%F9%C0%C8%CC%D2%D9%E2%EA%EE%F4%FB%C2%CA%CE%D4%DB%E5%C5%F8%D8%E3%F1%F5%C3%D1%D5%E6%C6%E7%C7%FE%F0%DE%D0%A3%u0153%u0152%A1%BF"),1));R=Q.getUint16(24);if(R){while(S<O){M.push(this.decode(Q.getUint16(R+2*S++)*2,0,1))}}this.abbr=M;this.dictionaries={};this.dict=Q.getUint16(8);this.parse_dict(this.dict)},make_alphabet:function(M){var N=[[],[],[]],L=0;while(L<78){N[parseInt(L/26)][L%26]=M[L++]}N[2][1]=13;this.alphabets=N},make_unicode:function(O){var N={13:"\n"},L={10:13},M=0;while(M<O.length){N[155+M]=String.fromCharCode(O[M]);L[O[M]]=155+M++}M=32;while(M<127){N[M]=String.fromCharCode(M);L[M]=M++}this.unicode_table=N;this.reverse_unicode_table=L},decode:function(T,M,U){var P=this.e.m,Y=T,L,O=[],Q=0,R,N=0,Z=[],X=[],W,V,S=0;if(this.e.jit[T]){return this.e.jit[T]}M=M?M+T:this.maxaddr;while(T<M){L=P.getUint16(T);T+=2;O.push(L>>10&31,L>>5&31,L&31);if(L&32768){break}}while(Q<O.length){R=O[Q++];if(R==0){Z.push(32)}else{if(R<4){Z.push(-1);X.push(this.abbr[32*(R-1)+O[Q++]])}else{if(R<6){N=R}else{if(N==2&&R==6){if(Q+1<O.length){W=O[Q++]<<5|O[Q++];if(W<768){Z.push(W)}else{W-=767;S+=W;V=Q;Q=(Q%3)+3;while(W--){Z.push(-1);X.push(String.fromCharCode(O[Q]<<10|O[Q+1]<<5|O[Q+2]));O[Q++]=O[Q++]=O[Q++]=32}Q=V}}}else{if(R<32){Z.push(this.alphabets[N][R-6])}}}}}N=N<4?0:N-3;if((Q%3)==0){Q+=S;S=0}}Z=new String(this.zscii_to_text(Z,X));Z.pc=T;this.e.jit[Y]=Z;if(!U&&Y<this.e.staticmem){s.warn("Caching a string in dynamic memory: "+Y)}return Z},encode:function(Q){var R=this.alphabets,P=[],O=0,N,M,L=[];while(P.length<9){N=Q[O++];if(N==32){P.push(0)}else{if((M=R[0].indexOf(N))>=0){P.push(M+6)}else{if((M=R[1].indexOf(N))>=0){P.push(4,M+6)}else{if((M=R[2].indexOf(N))>=0){P.push(5,M+6)}else{if(M=this.reverse_unicode_table[N]){P.push(5,6,M>>5,M&31)}else{if(N==l){P.push(5)}}}}}}}P.length=9;O=0;while(O<9){L.push(P[O++]<<2|P[O]>>3,(P[O++]&7)<<5|P[O++])}L[4]|=128;return L},zscii_to_text:function(R,Q){var O=0,M=R.length,P,N=0,L="";while(O<M){P=R[O++];if(P==-1){L+=Q[N++]}if(P=this.unicode_table[P]){L+=P}}return L},text_to_zscii:function(P,O){var Q=[],M=0,L=P.length,N;while(M<L){N=P.charCodeAt(M++);if(!O){N=this.reverse_unicode_table[N]||63}Q.push(N)}return Q},parse_dict:function(S){var R=this.e.m,L=S,Q={},P,O,N,M,P=R.getUint8(S++);Q.separators=R.getBuffer(S,P);S+=P;O=R.getUint8(S++);N=S+2+O*R.getUint16(S);S+=2;while(S<N){Q[""+R.getBuffer(S,6)]=S;S+=O}this.dictionaries[L]=Q;return Q},tokenise:function(Y,P,X,V){X=X||this.dict;X=this.dictionaries[X]||this.parse_dict(X);var Q=this.e.m,R=2,T=R+Q.getUint8(Y+1),N,O=X.separators,L=[],W=[],M=R,S,U=0;while(R<T){N=Q.getUint8(Y+R++);if(N==32||O.indexOf(N)>=0){if(L.length){W.push([L,M]);M+=L.length;L=[]}if(N!=32){W.push([[N],M])}M++}else{L.push(N)}}if(L.length){W.push([L,M])}S=Math.min(W.length,Q.getUint8(P));while(U<S){L=X[""+this.encode(W[U][0])];if(!V||L){Q.setUint16(P+2+U*4,L||0);Q.setUint8(P+4+U*4,W[U][0].length);Q.setUint8(P+5+U*4,W[U][1])}U++}Q.setUint8(P+1,U)},keyinput:function(M){var L=M.charCode,N=M.keyCode;if(I[N]){return I[N]}return this.reverse_unicode_table[L]||63}});var j=(function(N){var O=function(P,R){for(var Q in R){if(R[Q]!=N){P[Q]=R[Q]}}return P},M=[65534,65535,0,29,832,957,22944,31775,30624,32767,23254,17969,11627],L=function(P){var Q=Math.round((P&31)*8.226)<<16|Math.round(((P&992)>>5)*8.226)<<8|Math.round(((P&31744)>>10)*8.226);return"#"+("000000"+Q.toString(16)).slice(-6)};return Object.subClass({colours:M,init:function(P,Q){this.e=P;this.buffer="";this.styles={};this.mono=Q;this.currentwin=0;this.status=[];P.orders.push({code:"stream",name:"status"},{code:"stream",name:"main"},{code:"find",name:"main"})},clear_window:function(){this.e.orders.push({code:"clear",name:"main",css:O({},this.styles)})},convert_RGB:function(P){return Math.round(P[2]/8.226)<<10|Math.round(P[1]/8.226)<<5|Math.round(P[0]/8.226)},erase_line:function(P){if(P==1){this.flush();this.status.push({code:"eraseline"})}},erase_window:function(P){this.flush();if(P<1){this.clear_window()}if(P==-1){this.split_window(0)}if(P==-2||P==1){this.status.push({code:"clear"})}},flush:function(){var P;if(this.buffer!=""){P={code:"stream",css:O({},this.styles),text:this.buffer};if(this.mono){P.node="tt"}(this.currentwin?this.status:this.e.orders).push(P);this.buffer=""}},get_cursor:function(P){this.status.push({code:"get_cursor",addr:P});this.e.act()},set_colour:function(Q,P){this.set_true_colour(M[Q],M[P])},set_cursor:function(Q,P){this.flush();this.status.push({code:"cursor",to:[Q-1,P-1]})},set_font:function(P){if(P!=1&&P!=4){return 0}var Q=this.mono&4?4:1;if(P!=Q){this.flush();this.mono^=4}return Q},set_style:function(P){var Q=this.styles;this.flush();if(P==0){Q.reverse=Q["font-weight"]=Q["font-style"]=N;this.mono&=254}if(P&1){Q.reverse=1}if(P&2){Q["font-weight"]="bold"}if(P&4){Q["font-style"]="italic"}if(P&8){this.mono|=1}},set_true_colour:function(S,Q){var R=this.styles,T=R.color,P=R["background-color"];this.flush();if(S==65535){T=N}else{if(S<32768){T=L(S)}}if(Q==65535){P=N}else{if(Q<32768){P=L(Q)}}R.color=T;R["background-color"]=P},set_window:function(P){this.flush();this.currentwin=P;this.e.orders.push({code:"find",name:P?"status":"main"});if(P){this.status.push({code:"cursor",to:[0,0]})}},split_window:function(P){this.flush();this.status.push({code:"height",lines:P})}})})();var a=function(L){return""+L},m=K(E,function(){return 1}),r=o.subClass({storer:0,post:function(){var L=this.operands,N=L[0],M=N instanceof i;L[0]=new i(this.e,M?N:N.v);if(M||N.v==0){L[0].indirect=1}this.storer=this.code==142?L.pop():L.shift();if(L.length==0){L.push(new i(this.e,0))}},func:a}),w=h.subClass({func:function(M){var N=M.v-1,L=this.code%2?1:-1;if(M instanceof i||N>14){return"e.incdec("+M+","+L+")"}return(N<0?"e.s[e.s.length-1]=e.S2U(e.s[e.s.length-1]+":("e.l["+N+"]=e.S2U(e.l["+N+"]+"))+L+")"}}),C={1:K(E,function(){return arguments.length==2?this.args("=="):"e.jeq("+this.args()+")"}),2:K(E,function(M,L){return M.U2S()+"<"+L.U2S()}),3:K(E,function(M,L){return M.U2S()+">"+L.U2S()}),4:K(E,function(L,M){return"e.U2S(e.incdec("+L+",-1))<"+M.U2S()}),5:K(E,function(L,M){return"e.U2S(e.incdec("+L+",1))>"+M.U2S()}),6:K(E,function(){return"e.jin("+this.args()+")"}),7:K(E,function(){return"e.test("+this.args()+")"}),8:K(o,function(){return this.args("|")}),9:K(o,function(){return this.args("&")}),10:K(E,function(){return"e.test_attr("+this.args()+")"}),11:K(h,function(){return"e.set_attr("+this.args()+")"}),12:K(h,function(){return"e.clear_attr("+this.args()+")"}),13:r,14:K(h,function(){return"e.insert_obj("+this.args()+")"}),15:K(o,function(M,L){return"m.getUint16(e.S2U("+M+"+2*"+L.U2S()+"))"}),16:K(o,function(M,L){return"m.getUint8(e.S2U("+M+"+"+L.U2S()+"))"}),17:K(o,function(){return"e.get_prop("+this.args()+")"}),18:K(o,function(){return"e.find_prop("+this.args()+")"}),19:K(o,function(){return"e.find_prop("+this.args(",0,")+")"}),20:K(o,function(){return"e.S2U("+this.args("+")+")"}),21:K(o,function(){return"e.S2U("+this.args("-")+")"}),22:K(o,function(){return"e.S2U("+this.args("*")+")"}),23:K(o,function(M,L){return"e.S2U(parseInt("+M.U2S()+"/"+L.U2S()+"))"}),24:K(o,function(M,L){return"e.S2U("+M.U2S()+"%"+L.U2S()+")"}),25:p,26:y,27:K(h,function(){return"e.ui.set_colour("+this.args()+")"}),28:K(u,function(M,L){return"while(e.call_stack.length>"+L+"){e.call_stack.shift()}e.ret("+M+")"}),128:K(E,function(L){return L+"==0"}),129:K(z,function(L){return"e.get_sibling("+L+")"}),130:K(z,function(L){return"e.get_child("+L+")"}),131:K(o,function(L){return"e.get_parent("+L+")"}),132:K(o,function(L){return"e.get_prop_len("+L+")"}),133:w,134:w,135:K(h,function(L){return"e.print(e.text.decode("+L+"))"}),136:p,137:K(h,function(L){return"e.remove_obj("+L+")"}),138:K(h,function(L){return"e.print_obj("+L+")"}),139:K(u,function(L){return"e.ret("+L+")"}),140:K(u,function(L){return"e.pc="+L.U2S()+"+"+(this.next-2)},{jumper:1}),141:K(h,function(L){return"e.print(e.text.decode("+L+"*"+this.e.addr_multipler+"))"}),142:r.subClass({storer:1}),143:y,176:K(u,function(){return"e.ret(1)"}),177:K(u,function(){return"e.ret(0)"}),178:K(h,function(L){return'e.print("'+L+'")'},{printer:1}),179:K(u,function(L){return'e.print("'+L+'\\n");e.ret(1)'},{printer:1}),180:h,183:K(u,function(){return'e.act("restart")'}),184:K(u,function(L){return"e.ret("+L+")"},{post:function(){this.operands.push(new i(this.e,0))}}),185:K(o,function(){return"e.call_stack.length"}),186:K(u,function(){return'e.act("quit")'}),187:K(h,function(){return'e.print("\\n")'}),189:m,191:m,224:p,225:K(h,function(N,L,M){return"m.setUint16(e.S2U("+N+"+2*"+L.U2S()+"),"+M+")"}),226:K(h,function(N,L,M){return"m.setUint8(e.S2U("+N+"+"+L.U2S()+"),"+M+")"}),227:K(h,function(){return"e.put_prop("+this.args()+")"}),228:K(n,function(){return"e.read("+this.args()+","+this.storer.v+")"}),229:K(h,function(L){return"e.print(e.text.zscii_to_text(["+L+"]))"}),230:K(h,function(L){return"e.print("+L.U2S()+")"}),231:K(o,function(L){return"e.random("+L.U2S()+")"}),232:K(o,a,{post:function(){this.storer=new i(this.e,0)},storer:0}),233:r,234:K(h,function(L){return"e.ui.split_window("+L+")"}),235:K(h,function(L){return"e.ui.set_window("+L+")"}),236:p,237:K(h,function(L){return"e.ui.erase_window("+L.U2S()+")"}),238:K(h,function(L){return"e.ui.erase_line("+L+")"}),239:K(h,function(){return"e.ui.set_cursor("+this.args()+")"}),240:K(n,function(L){return"e.ui.get_cursor("+L+")"}),241:K(h,function(L){return"e.ui.set_style("+L+")"}),242:h,243:K(h,function(){return"e.output_stream("+this.args()+")"}),244:h,245:h,246:K(n,function(){return"e.read_char("+this.args()+","+this.storer.v+")"}),247:K(z,function(){return"e.scan_table("+this.args()+")"}),248:K(o,function(L){return"e.S2U(~"+L+")"}),249:y,250:y,251:K(h,function(){return"e.text.tokenise("+this.args()+")"}),252:K(h,function(){return"e.encode_text("+this.args()+")"}),253:K(h,function(){return"e.copy_table("+this.args()+")"}),254:K(h,function(){return"e.print_table("+this.args()+")"}),255:K(E,function(L){return L+"<=e.call_stack[0][4]"}),1000:K(n,function(){return"e.save("+(this.next-1)+","+this.storer.v+")"}),1001:K(n,function(){return'e.act("restore",{storer:'+this.storer.v+"})"}),1002:K(o,function(M,L){return"e.S2U(e.log_shift("+M+","+L.U2S()+"))"}),1003:K(o,function(M,L){return"e.S2U(e.art_shift("+M.U2S()+","+L.U2S()+"))"}),1004:K(o,function(L){return"e.ui.set_font("+L+")"}),1009:K(o,function(){return"e.save_undo("+this.next+","+this.storer.v+")"}),1010:K(h,function(){return"if(e.restore_undo())return"},{storer:1}),1011:K(h,function(L){return"e.print(String.fromCharCode("+L+"))"}),1012:K(o,function(){return 3}),1013:K(h,function(){return"e.ui.set_true_colour("+this.args()+")"}),1014:h.subClass({brancher:1}),1030:K(o,function(){return"e.gestalt("+this.args()+")"})};var v=function(P,N){var O=0,L,M,S,R,Q=P.ops;while(O<Q.length-1){if(Q[O].offset&&Q[O].offset==N){if(Q.length-O==2&&Q[O+1].offset){S=Q.pop();R=Q.pop();R.cond.invert=!R.cond.invert;S.cond=new D([R.cond,S.cond],"&&");S.labels=R.labels.concat(S.labels);Q.push(S);return 1}L=new G(P.e,Q[O+1].pc);L.ops=Q.slice(O+1);Q.length=O+1;M=Q[O];M.result=L;M.cond.invert=!M.cond.invert;S=L.ops[L.ops.length-1];if(S.jumper&&(H(S.operands[0].v)+S.next-2)==M.pc){M.keyword="while";L.ops.pop()}else{L.stopper=S.stopper}return 1}O++}};var e=function(Q){var R,N,O=Q.m,T,M,S,U,P,L=new A(Q,Q.pc);while(1){N=R=Q.pc;M=O.getUint8(R++);if(M==190){U=-1;M=O.getUint8(R++)+1000}else{if(M&128){if(M&64){U=-1;if(!(M&32)){M&=31}}else{U=[(M&48)>>4];if(U[0]<3){M&=207}}}else{U=[M&64?2:1,M&32?2:1];M&=31}}if(!C[M]){Q.stop=1;throw new Error("Unknown opcode #"+M+" at pc="+N)}S=C[M].prototype;if(U==-1){U=[];g(O.getUint8(R++),U);if(M==236||M==250){g(O.getUint8(R++),U)}}P=[];T=0;while(T<U.length){if(U[T]==0){P.push(new J(Q,O.getUint16(R)));R+=2}if(U[T]==1){P.push(new J(Q,O.getUint8(R++)))}if(U[T++]==2){P.push(new i(Q,O.getUint8(R++)))}}if(S.storer){P.push(new i(Q,O.getUint8(R++)))}if(S.brancher){T=O.getUint8(R++);P.push([T&128,T&64?T&63:(T<<8|O.getUint8(R++))<<18>>18])}if(S.printer){T=Q.text.decode(R);P.push(T.replace(/\n/g,"\\n").replace(/"/g,'\\"'));R=T.pc}Q.pc=R;L.ops.push(new C[M](Q,L,M,N,R,P));T=0;if(L.targets.indexOf(R)>=0){T=v(L,R)}if(S.stopper&&!T){break}}return L},g=function(M,N){for(var L=0;L<4;L++){N.push((M&192)>>6);M<<=2}};B.ZVM=Object.subClass({art_shift:function(M,L){return L>0?M<<L:M>>-L},call:function(S,L,P,N){var O,M,R=this.l.length,Q=N.length;this.pc=S*this.addr_multipler;M=this.m.getUint8(this.pc++);N=N.slice(0,M);for(O=N.length;O<M;O++){N.push(0)}this.l=N.concat(this.l);this.call_stack.unshift([P,L,M,this.s.length,Q,R])},clear_attr:function(L,M){var N=this.objects+14*L+parseInt(M/8);this.m.setUint8(N,this.m.getUint8(N)&~(128>>M%8))},copy_table:function(P,M,O){O=H(O);var R=this.m,N=0,Q=O<0,L;O=Math.abs(O);if(M==0){while(N<O){R.setUint8(P+N++,0)}return}if(Q){while(N<O){R.setUint8(M+N,R.getUint8(P+N++))}}else{L=R.getBuffer(P,O);R.setBuffer(M,L);R.setBuffer(P,L)}},encode_text:function(M,L,O,N){this.m.setBuffer(N,this.text.encode(this.m.getBuffer(M+O,L)))},extension_table:function(M,L){var N=this.extension;if(!N||M>this.extension_count){return 0}N+=2*M;if(L==l){return this.m.getUint16(N)}this.e.setUint16(N,L)},find_prop:function(L,P,O){var S=this.m,R,Q,N=0,M=S.getUint16(this.objects+14*L+12);M+=S.getUint8(M)*2+1;while(1){R=S.getUint8(M);Q=R&63;if(N==O){return Q}if(Q==P){return M+(R&128?2:1)}if(Q<P){return 0}N=Q;if(R&128){Q=S.getUint8(M+1)&63;M+=Q?Q+2:66}else{M+=R&64?3:2}}},gestalt:function(M,L){switch(M){case 1:return 258;case 8192:return 1;case 8193:case 8194:return 2}return 0},get_child:function(L){return this.m.getUint16(this.objects+14*L+10)},get_sibling:function(L){return this.m.getUint16(this.objects+14*L+8)},get_parent:function(L){return this.m.getUint16(this.objects+14*L+6)},get_prop:function(L,M){var O=this.m,N=this.find_prop(L,M);if(N){return(O.getUint8(N-1)&64?O.getUint16:O.getUint8)(N)}return O.getUint16(this.properties+2*(M-1))},get_prop_len:function(M){if(M==0){return 0}var L=this.m.getUint8(M-1);if(L&128){L&=63;return L==0?64:L}return L&64?2:1},incdec:function(M,O){var L,N;if(M==0){L=f(this.s.pop()+O);this.s.push(L);return L}if(M<16){return this.l[M-1]=f(this.l[M-1]+O)}else{N=this.globals+(M-16)*2;return this.m.setUint16(N,this.m.getUint16(N)+O)}},indirect:function(L,M){if(L==0){if(arguments.length>1){return this.s[this.s.length-1]=M}else{return this.s[this.s.length-1]}}return this.variable(L,M)},insert_obj:function(M,L){this.remove_obj(M);this.set_family(M,L,L,M,M,this.get_child(L))},jeq:function(){var L=1,M;while(L<arguments.length){if(arguments[L++]==arguments[0]){M=1}}return M},jin:function(M,L){return this.get_parent(M)==L},log_shift:function(M,L){return L>0?M<<L:M>>>-L},output_stream:function(N,O){N=H(N);if(N==1){this.streams[0]=1}if(N==-1){this.streams[0]=0}if(N==3){this.streams[2].unshift([O,""])}if(N==-3){var L=this.streams[2].shift(),M=this.text.text_to_zscii(L[1]);this.m.setUint16(L[0],M.length);this.m.setBuffer(L[0]+2,M)}},print:function(M){if(this.streams[2].length){this.streams[2][0][1]+=M}else{if(this.streams[0]){var L=this.m.getUint8(17)&2;if(L!=(this.ui.mono&2)){if(!(this.ui.mono&253)){this.ui.flush()}this.ui.mono^=2}this.ui.buffer+=M}}},print_obj:function(M){var L=this.m.getUint16(this.objects+14*M+12);this.print(this.text.decode(L+1,this.m.getUint8(L)*2))},print_table:function(P,N,L,O){L=L||1;O=O||0;var M=0;while(M<L){this.print("\n"+this.text.zscii_to_text(this.m.getBuffer(P,N)));P+=N+O;M++}},put_prop:function(L,N,M){var P=this.m,O=this.find_prop(L,N);(P.getUint8(O-1)&64?P.setUint16:P.setUint8)(O,M)},random:function(L){var M;if(L<1){this.random_state=Math.abs(L);this.random_seq=0;return 0}if(this.random_state==0){return parseInt(Math.random()*L)+1}else{this.random_seq++;if(this.random_seq>this.random_state){this.random_seq=1}return this.random_seq%L}},read:function(P,O,N,L,M){if(arguments.length==3){M=N;N=L=0}this.act("read",{buffer:P,parse:O,len:this.m.getUint8(P),initiallen:this.m.getUint8(P+1),time:N,routine:L,storer:M})},read_char:function(N,O,L,M){if(arguments.length==2){M=O;O=L=0}this.act("char",{time:O,routine:L,storer:M})},remove_obj:function(P){var O=this.get_parent(P),M,N,L;if(O==0){return}M=this.get_child(O);N=this.get_sibling(P);if(M==P){this.set_family(P,0,O,N)}else{while(1){L=this.get_sibling(M);if(L==P){break}M=L}this.set_family(P,0,0,0,M,N)}},restore:function(Q){var N=new x(Q),O=N.memory,S=N.stacks,U=N.pc,V=this.m.getUint8(17),W,R=0,P=0,T=[],M=[],L;this.m.setBuffer(0,this.data.slice(0,this.staticmem));if(N.compressed){while(R<O.length){W=O[R++];if(W==0){P+=1+O[R++]}else{this.m.setUint8(P,W^this.data[P++])}}}else{this.m.setBuffer(0,O)}this.m.setUint8(17,V);R=6;W=S[R++]<<8|S[R++];L=t(S.slice(R,W));while(R<S.length){T.unshift([S[R++]<<16|S[R++]<<8|S[R++],0,0,L.length,0,M.length]);T[0][1]=S[R]&16?-1:S[R+1];T[0][2]=S[R]&15;R+=2;W=S[R++];while(W){T[0][4]++;W>>=1}W=S[R++]<<8|S[R++];M=t(S.slice(R,R+T[0][2])).concat(M);R+=T[0][2]*2;L=L.concat(t(S.slice(R,W)))}this.call_stack=T;this.l=M;this.s=L;this.update_header();this.variable(this.m.getUint8(U++),2);this.pc=U},restore_undo:function(){if(this.undo.length==0){return 0}var L=this.undo.pop();this.pc=L[0];L[2][17]=this.m.getUint8(17);this.m.setBuffer(0,L[2]);this.l=L[3];this.s=L[4];this.call_stack=L[5];this.variable(L[1],2);return 1},ret:function(L){var N=this.call_stack.shift(),M=N[1];this.pc=N[0];this.l=this.l.slice(this.l.length-N[5]);this.s.length=N[3];if(M>=0){this.variable(M,L)}},save:function(W,Z){var S=this.m,X=this.s,N=this.l,P=new x(),R=[],T,Q,U,Y=0,V=this.call_stack.reverse(),M,O,L=[0,0,0,0,0,0];P.release=S.getBuffer(2,2);P.serial=S.getBuffer(18,6);P.checksum=S.getBuffer(28,2);P.pc=W;P.compressed=1;for(T=0;T<this.staticmem;T++){U=S.getUint8(T)^this.data[T];if(U==0){if(++Y==256){R.push(0,255);Y=0}}else{if(Y){R.push(0,Y-1);Y=0}R.push(U)}}P.memory=R;L.push(V[0][3]>>8,V[0][3]&255);for(Q=0;Q<V[0][3];Q++){L.push(X[Q]>>8,X[Q]&255)}for(T=0;T<V.length;T++){M=V[T];O=(V[T+1]?V[T+1][3]:X.length)-M[3];L.push(M[0]>>16,M[0]>>8&255,M[0]&255,M[2]|(M[1]<0?16:0),M[1]<0?0:M[1],(1<<M[4])-1,O>>8,O&255);for(Q=N.length-M[5]-M[2];Q<N.length-M[5];Q++){L.push(N[Q]>>8,N[Q]&255)}for(Q=M[3];Q<M[3]+O;Q++){L.push(X[Q]>>8,X[Q]&255)}}V.reverse();P.stacks=L;this.act("save",{data:P.write(),storer:Z})},save_undo:function(M,L){this.undo.push([M,L,this.m.getBuffer(0,this.staticmem),this.l.slice(),this.s.slice(),this.call_stack.slice()]);return 1},scan_table:function(L,P,N,M){M=M||130;var O=M&128?this.m.getUint16:this.m.getUint8;M&=127;N=P+N*M;while(P<N){if(O(P)==L){return P}P+=M}return 0},set_attr:function(L,M){var N=this.objects+14*L+parseInt(M/8);this.m.setUint8(N,this.m.getUint8(N)|128>>M%8)},set_family:function(N,O,M,Q,L,P){this.m.setUint16(this.objects+14*N+6,O);if(M){this.m.setUint16(this.objects+14*M+10,Q)}if(L){this.m.setUint16(this.objects+14*L+8,P)}},test:function(M,L){return M&L==L},test_attr:function(L,M){return(this.m.getUint8(this.objects+14*L+parseInt(M/8))<<M%8)&128},variable:function(M,N){var L=N!==l;if(M==0){if(L){this.s.push(N)}else{return this.s.pop()}}else{if(M<16){if(L){this.l[M-1]=N}else{return this.l[M-1]}}else{if(L){this.m.setUint16(this.globals+(M-16)*2,N)}else{this.m.getUint16(this.globals+(M-16)*2)}}}return N},U2S:H,S2U:f,init:function(){this.jit={};this.env={width:80};d(this,["find_prop"])},inputEvent:function(N){var O=this.m,M=N.code,L;if(N.env){k(this.env,N.env);if(!M){return}}this.orders=[];if(M=="load"){this.data=N.data;return}if(M=="restart"){this.restart()}if(M=="save"){this.variable(N.storer,N.result==l?1:N.result&255)}if(M=="restore"){if(!this.m){this.restart()}if(N.data){this.restore(N.data)}else{this.variable(N.storer,0)}}if(M=="read"){this.variable(N.storer,N.terminator);L=N.response;this.print(L+"\n");L=this.text.text_to_zscii(L.toLowerCase());if(L.length>N.len){L=L.slice(0,N.len)}O.setUint8(N.buffer+1,L.length);O.setBuffer(N.buffer+2,L);if(N.parse){this.text.tokenise(N.buffer,N.parse)}}if(M=="char"){this.variable(N.storer,this.text.keyinput(N.response))}if(M=="get_cursor"){O.setUint16(N.addr,N.pos[0]+1);O.setUint16(N.addr+2,N.pos[1]+1)}this.run()},restart:function(){var O=F(this.data),L=O.getUint8(0),M=O.getUint16(10),N=O.getUint16(54);if(L!=5&&L!=8){throw new Error("Unsupported Z-Machine version: "+L)}if(this.m){O.setUint8(17,this.m.getUint8(17))}k(this,{m:O,s:[],l:[],call_stack:[],undo:[],orders:[],streams:[1,0,[],0],version:L,pc:O.getUint16(6),properties:M,objects:M+112,globals:O.getUint16(12),staticmem:O.getUint16(14),extension:N,extension_count:N?O.getUint16(N):0,addr_multipler:L==5?4:8});k(this,{ui:new j(this,O.getUint8(17)&2),text:new q(this)});this.update_header()},update_header:function(){var N=this.m,L=this.env.fgcolour?this.ui.convert_RGB(this.env.fgcolour):65535,M=this.env.bgcolour?this.ui.convert_RGB(this.env.bgcolour):65535;this.random_state=0;N.setUint8(1,29|(this.env.timed?128:0));N.setUint8(17,N.getUint8(17)&87);N.setUint8(32,255);N.setUint8(33,this.env.width);N.setUint16(34,this.env.width);N.setUint16(36,255);N.setUint16(38,257);N.setUint8(44,Math.abs(this.ui.colours.indexOf(M)));N.setUint8(45,Math.abs(this.ui.colours.indexOf(L)));N.setUint16(50,258);this.extension_table(4,0);this.extension_table(5,L);this.extension_table(6,M)},run:function(){var M=Date.now(),L,N=0;this.stop=0;while(!this.stop){L=this.pc;if(!this.jit[L]){this.compile()}this.jit[L](this);if(++N%50000==0&&(Date.now()-M)>5000){this.act("tick");return}}},compile:function(){var L=e(this);this.jit[L.pc]=new Function("e",c(""+L));if(L.pc<this.staticmem){s.warn("Caching a JIT function in dynamic memory: "+L.pc)}},act:function(M,L){var L=L||{};this.ui.flush();if(this.ui.status.length){this.orders.push({code:"stream",to:"status",data:this.ui.status});this.ui.status=[]}L.code=M;this.orders.push(L);this.stop=1;this.outputEvent(this.orders)}})})(this);
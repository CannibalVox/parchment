/*

ZVM - the ifvms.js implementation of the Z-Machine
==================================================

Built: 2011-10-21

Copyright (c) 2011 The ifvms.js team
BSD licenced
http://github.com/curiousdannii/ifvms.js

*/
(function(B,k){if(![].indexOf){Array.prototype.indexOf=function(O,N){for(var M=N||0,L=array.length;M<L;M++){if(array[M]==O){return M}}return -1}}var i=function(L,N){for(var M in N){L[M]=N[M]}return L},e=B.console?function(){console.log.apply(console,arguments)}:function(){},I=function(L){return((L&32768)?~65535:0)|L},d=function(L){return L&65535},F=B.PARCHMENT_SECURITY_OVERRIDE;var b=B.DataView,E=b?function(M){var L=new ArrayBuffer(M),M=new DataView(L);M.buffer=L;return M}:function(L){L=L.slice();return{data:L,getUint8:function(M){return L[M]},getUint16:function(M){return L[M]<<8|L[M+1]},getBuffer:function(N,M){return L.slice(N,N+M)},getBuffer16:function(N,M){return s(L.slice(N,N+M*2))},setUint8:function(M,N){return L[M]=N&255},setUint16:function(M,N){L[M]=(N>>8)&255;L[M+1]=N&255;return N&65535},setBuffer:function(N,M){return L=L.slice(0,N).concat(M,L.slice(N+M.length))}}},s=function(O){var N=0,M=O.length,L=[];while(N<M){L[N/2]=O[N++]<<8|O[N++]}return L};var J=Object.subClass({init:function(L,M){this.e=L;this.v=M},write:function(){return this.v},U2S:function(){return I(this.v)}}),h=J.subClass({write:function(N){var M=this.v,L=arguments.length,N=N&&N.write?N.write():N,O=this.e.globals+(M-16)*2;if(this.returnval){return"e.variable("+M+","+N+")"}if(M==0){return L?"s.push("+N+")":"s.pop()"}else{if(M<16){M--;return"l["+M+"]"+(L?"="+N:"")}else{if(L){return"m.setUint16("+O+","+N+")"}else{return"m.getUint16("+O+")"}}}},U2S:function(){return"e.U2S("+this.write()+")"}}),g=Object.subClass({init:function(P,N,Q,M,O,L){this.e=P;this.context=N;this.code=Q;this.pc=M;this.next=O;this.operands=L;if(this.post){this.post()}},write:function(){return this.label()+(this.func?this.func.apply(this,this.operands):"")},args:function(M){var L=0,N=[];while(L<this.operands.length){N.push(this.operands[L++].write())}return N.join(M)},label:function(){return"/* "+this.pc+"/"+this.code+" */ "}}),t=g.subClass({stopper:1}),D=g.subClass({brancher:1,keyword:"if",post:function(){var L,N,M=this.operands.pop(),O=M[1];this.iftrue=M[0];if(O==0||O==1){L="e.ret("+O+")"}else{O+=this.next-2;this.context.targets.push(O);L="e.pc="+O}this.result=L+"; return";this.offset=O;this.ops=[];this.labels=[];if(this.context.ops.length){N=this.context.ops.pop();if(N.offset==O){this.ops=N.ops;this.labels=N.labels}else{this.context.ops.push(N)}}this.ops.push(this);this.labels.push(this.pc+"/"+this.code)},write:function(){var M=0,N,L=this.result;if(L instanceof G){L=L.write()+(L.stopper?"; return":"");if(this.result.ops.length>1){L="\n"+L+"\n"}}while(M<this.ops.length){N=this.ops[M];this.ops[M++]=(N.iftrue?"":"!(")+N.func.apply(N,N.operands)+(N.iftrue?"":")")}return"/* "+this.labels.join()+" */ "+this.keyword+(this.invert?"(!(":"(")+this.ops.join("||")+(this.invert?")) {":") {")+L+"}"}}),y=D.subClass({storer:1,post:function(){this._super();this.storer=this.operands.pop();this.storer.returnval=1}}),m=g.subClass({storer:1,post:function(){this.storer=this.operands.pop()},write:function(){var L=this._super();return this.storer?this.storer.write(L):L}}),x=t.subClass({post:function(){this.result={v:-1}},write:function(){var L=this.operands.shift();return this.label()+"e.call("+L.write()+","+this.result.v+","+this.next+",["+this.args()+"])"}}),n=x.subClass({storer:1,post:function(){this.result=this.operands.pop()}}),G=Object.subClass({init:function(M,L){this.e=M;this.pc=L;this.ops=[];this.targets=[]},write:function(){var N=this.ops,L=[],M=0;while(M<N.length){L.push(N[M++].write())}return L.join(";")}}),A=G.subClass({write:function(){return"var l=e.l,m=e.m,s=e.s;\n"+this._super()}}),K=function(M,N,L){var L=L||{};if(N){L.func=N}return M.subClass(L)};var w=IFF.subClass({init:function(M){this._super(M);if(M){if(this.type!="IFZS"){throw new Error("Not a Quetzal savefile")}for(var N=0,L=this.chunks.length;N<L;N++){var O=this.chunks[N].type,P=this.chunks[N].data;if(O=="CMem"||O=="UMem"){this.memory=P;this.compressed=(O=="CMem")}else{if(O=="Stks"){this.stacks=P}else{if(O=="IFhd"){this.release=P.slice(0,2);this.serial=P.slice(2,8);this.checksum=P.slice(8,10);this.pc=P[10]<<16|P[11]<<8|P[12]}}}}}},write:function(){this.type="IFZS";var M=this.pc,L=this.release.concat(this.serial,this.checksum,(M>>16)&255,(M>>8)&255,M&255);this.chunks=[{type:"IFhd",data:L},{type:(this.compressed?"CMem":"UMem"),data:this.memory},{type:"Stks",data:this.stacks}];return this._super()}});var H=function(L){return L.replace(/\n/g,"\\n").replace(/"/g,'\\"')},p=Object.subClass({init:function(T){var Q=T.m,N=Q.getUint16(52),P=T.extension_table(3),L=P&&Q.getUint8(P++),R,M=[],S=0,O=96;this.e=T;this.make_alphabet(N?Q.getBuffer(N,78):this.text_to_zscii("abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ*\r0123456789.,!?_#'\"/\\-:()"));this.make_unicode(P?Q.getBuffer16(P,L):this.text_to_zscii(unescape("%E4%F6%FC%C4%D6%DC%DF%BB%AB%EB%E2%EA%EE%F4%FB%C2%CA%CE%D4%DB%EF%FF%CB%CF%E1%E9%ED%F3%FA%FD%C1%C9%CD%D3%DA%DD%E0%E8%EC%F2%F9%C0%C8%CC%D2%D9%E5%C5%F8%D8%E3%F1%F5%C3%D1%D5%E6%C6%E7%C7%FE%F0%DE%D0%A3%u0153%u0152%A1%BF"),1));R=Q.getUint16(24);if(R){while(S<O){M.push(this.decode(Q.getUint16(R+2*S++)*2))}}this.abbr=M;this.dictionaries={};this.dict=Q.getUint16(8);this.parse_dict(this.dict)},make_alphabet:function(M){var N=[[],[],[]],L=0;while(L<78){N[parseInt(L/26)][L%26]=M[L++]}this.alphabets=N},make_unicode:function(O){var N={},L={10:13},M=0;while(M<O.length){N[M+155]=O[M];L[O[M]]=155+M++}this.unicode_table=N;this.reverse_unicode_table=L;this.unicode_callback=function(P){return String.fromCharCode(N[P.charCodeAt(0)]||63)}},decode:function(S,M){var P=this.e.m,T=S,L,O=[],Q=0,R,N=0,U=[];if(this.e.jit[S]){return this.e.jit[S]}M=M||P.getUint16(26)*this.e.packing_multipler;while(S<M){L=P.getUint16(S);S+=2;O.push(L>>10&31,L>>5&31,L&31);if(L&32768){break}}while(Q<O.length){R=O[Q++];if(R==0){U.push(32)}else{if(R<4){U=U.concat(this.abbr[32*(R-1)+O[Q++]])}else{if(R<6){N=R}else{if(N==2&&R==6){U.push(O[Q++]<<5|O[Q++])}else{U.push(this.alphabets[N][R-6])}}}}N=N<4?0:N-3}if(this.abbr){U=new String(this.zscii_to_text(U));U.pc=S;this.e.jit[T]=U;if(T<this.e.staticmem){console.warn("Caching a string in dynamic memory: "+T)}}return U},zscii_to_text:function(L){return String.fromCharCode.apply(this,L).replace(/[\x00-\x0C\x0E-\x1F\x7F-\x9A\xFC-\uFFFF]/g,"").replace(/\r/g,"\n").replace(/[\x9B-\xFB]/g,this.unicode_callback)},text_to_zscii:function(P,O){var Q=[],M=0,L=P.length,N;O=!O;while(M<L){N=P.charCodeAt(M++);if(O&&N!=13&&(N<32||N>126)){N=this.reverse_unicode_table[N]||63}Q.push(N)}return Q},parse_dict:function(T){var R=this.e.m,P=T,O={},N,L,S,M,N=R.getUint8(T++),Q=this.zscii_to_text(R.getBuffer(T,N));O.lexer_pattern=new RegExp("["+Q+"]|\\b\\S{1,9}(?=\\S*?(\\b|["+Q+"]))","g");T+=N;L=R.getUint8(T++);S=T+2+L*R.getUint16(T);T+=2;while(T<S){O[this.decode(T,T+6)]=T;T+=L}this.dictionaries[P]=O;return O},tokenise:function(Q,M,S){S=S||this.dict;S=this.dictionaries[S]||this.parse_dict(S);var R=this.e.m,N=0,L=R.getUint8(M),O=S.lexer_pattern,P;O.lastIndex=0;Q=Q.toLowerCase();while(N<L&&(P=O.exec(Q))){R.setUint16(M+2+N*4,S[P[0]]||0);R.setUint8(M+4+N*4,P[0].length);R.setUint8(M+5+N++*4,P.index)}R.setUint8(M+1,N)}});var v=[-2,65535,0,29,832,957,22944,31775,30624,32767,23254,17969,11627],o=function(L){var M=Math.round((L&31)*8.226)<<16|Math.round(((L&992)>>5)*8.226)<<8|Math.round(((L&31744)>>10)*8.226);M=M.toString(16);while(M.length<6){M="0"+M}return"#"+M},r=Object.subClass({init:function(L){this.e=L;this.buffer="";this.styles={};this.streams=[1,0,[],0];this.fontbit=L.m.getUint8(17)&2;this.e.orders.push({code:"addstruct",name:"status"},{code:"addstruct",name:"main"},{code:"find",name:"main"})},flush:function(){var L;if(this.buffer!=""){L=i({},this.styles);this.e.orders.push({code:"print",css:L,text:this.buffer});this.buffer=""}},print:function(M){if(this.streams[2].length){this.streams[2][0][1]+=M}else{if(this.streams[0]){var L=this.e.m.getUint8(17)&2;if(L!=this.fontbit){this.fontbit=L;this.flush();this.styles.node=this.fontbit?"tt":k}this.buffer+=M}}},set_colour:function(M,L){this.set_true_colour(v[M],v[L])},set_style:function(L){var M=this.styles;this.flush();if(L==0){M.reverse=M["font-weight"]=M["font-style"]=k;M.node=this.fontbit?"tt":k}if(L&1){M.reverse=1}if(L&2){M["font-weight"]="bold"}if(L&4){M["font-style"]="italic"}if(L&8){M.node="tt"}},set_true_colour:function(O,M){var N=this.styles,P=N.color,L=N["background-color"];this.flush();if(O==65535){P=k}else{if(O<32768){P=o(O)}}if(M==65535){L=k}else{if(M<32768){L=o(M)}}N.color=P;N["background-color"]=L},output_stream:function(N,O){N=this.e.U2S(N);if(N==1){this.streams[0]=1}if(N==-1){this.streams[0]=0}if(N==3){this.streams[2].unshift([O,""])}if(N==-3){var L=this.streams[2].shift(),M=this.e.text.text_to_zscii(L[1]);this.e.m.setUint16(L[0],M.length);this.e.m.setBuffer(L[0]+2,M)}}});var a=function(L){return L.write()},l=K(D,function(){return 1}),z=h.subClass({write:function(N){var L=arguments.length,M=this.v;if(M.write||M==0){N=N&&N.write?N.write():N;M=M.write?M.write():M;return"e.indirect("+M+(L?","+N:"")+")"}return this._super(N)}}),q=m.subClass({storer:0,post:function(){var L=this.operands;L[0]=new z(this.e,L[0] instanceof h?L[0]:L[0].v);this.storer=this.code==142?L.pop():L.shift();if(L.length==0){L.push(new h(this.e,0))}},func:a}),C={1:K(D,function(){return arguments.length==2?this.args("=="):"e.jeq("+this.args()+")"}),2:K(D,function(M,L){return M.U2S()+"<"+L.U2S()}),3:K(D,function(M,L){return M.U2S()+">"+L.U2S()}),4:K(D,function(L,M){return"e.U2S(e.incdec("+L.write()+",-1))<"+M.U2S()}),5:K(D,function(L,M){return"e.U2S(e.incdec("+L.write()+",1))>"+M.U2S()}),6:K(D,function(){return"e.jin("+this.args()+")"}),7:K(D,function(){return"e.test("+this.args()+")"}),8:K(m,function(){return this.args("|")}),9:K(m,function(){return this.args("&")}),10:K(D,function(){return"e.test_attr("+this.args()+")"}),11:K(g,function(){return"e.set_attr("+this.args()+")"}),12:K(g,function(){return"e.clear_attr("+this.args()+")"}),13:q,14:K(g,function(){return"e.insert_obj("+this.args()+")"}),15:K(m,function(M,L){return"m.getUint16("+M.write()+"+2*"+L.U2S()+")"}),16:K(m,function(M,L){return"m.getUint8("+M.write()+"+"+L.U2S()+")"}),17:K(m,function(){return"e.get_prop("+this.args()+")"}),18:K(m,function(){return"e.find_prop("+this.args()+")"}),19:K(m,function(){return"e.find_prop("+this.args(",0,")+")"}),20:K(m,function(){return"e.S2U("+this.args("+")+")"}),21:K(m,function(){return"e.S2U("+this.args("-")+")"}),22:K(m,function(){return"e.S2U("+this.args("*")+")"}),23:K(m,function(M,L){return"e.S2U(parseInt("+M.U2S()+"/"+L.U2S()+"))"}),24:K(m,function(M,L){return"e.S2U("+M.U2S()+"%"+L.U2S()+")"}),25:n,26:x,27:K(g,function(){return"e.ui.set_colour("+this.args()+")"}),128:K(D,function(L){return L.write()+"==0"}),129:K(y,function(L){return this.storer.write("e.get_lilsis("+L.write()+")")}),130:K(y,function(L){return this.storer.write("e.get_child("+L.write()+")")}),131:K(m,function(L){return"e.get_parent("+L.write()+")"}),132:K(m,function(L){return"e.get_prop_len("+L.write()+")"}),133:K(g,function(L){return"e.incdec("+L.write()+",1)"}),134:K(g,function(L){return"e.incdec("+L.write()+",-1)"}),135:K(g,function(L){return"e.print(e.text.decode("+L.write()+"))"}),136:n,137:K(g,function(L){return"e.remove_obj("+L.write()+")"}),138:K(g,function(L){return"e.print(e.text.decode(m.getUint16(e.objects+14*"+L.write()+"+13)))"}),139:K(t,function(L){return"e.ret("+L.write()+")"}),140:K(t,function(L){return"e.pc="+L.U2S()+"+"+(this.next-2)+""}),141:K(g,function(L){return"e.print(e.text.decode("+L.write()+"*"+this.e.packing_multipler+"))"}),142:q.subClass({storer:1}),143:x,176:K(t,function(){return"e.ret(1)"}),177:K(t,function(){return"e.ret(0)"}),178:K(g,function(L){return'e.print("'+L+'")'},{printer:1}),179:K(t,function(L){return'e.print("'+L+'");e.ret(1)'},{printer:1}),180:g,183:K(t,function(){return'e.act("restart")'}),184:K(t,function(L){return"e.ret("+L.write()+")"},{post:function(){this.operands.push(new h(this.e,0))}}),186:K(t,function(){return'e.act("quit")'}),187:K(g,function(){return'e.print("\\n")'}),189:l,191:l,224:n,225:K(g,function(N,L,M){return"m.setUint16("+N.write()+"+2*"+L.U2S()+","+M.write()+")"}),226:K(g,function(N,L,M){return"m.setUint8("+N.write()+"+"+L.U2S()+","+M.write()+")"}),227:K(g,function(){return"e.put_prop("+this.args()+")"}),228:K(t,function(){var L=this.operands.pop();return"e.read("+this.args()+","+L.v+");e.pc="+this.next},{storer:1}),229:K(g,function(L){return"e.print(e.text.zscii_to_text(["+L.write()+"]))"}),230:K(g,function(L){return"e.print("+L.U2S()+")"}),231:K(m,function(L){return"e.random("+L.U2S()+")"}),232:K(m,a,{post:function(){this.storer=new h(this.e,0)},storer:0}),233:q,236:n,241:K(g,function(L){return"e.ui.set_style("+L.write()+")"}),242:g,243:K(g,function(){return"e.ui.output_stream("+this.args()+")"}),245:g,248:K(m,function(L){return"e.S2U(~"+L.write()+")"}),249:x,250:x,255:K(D,function(L){return L.write()+"<=e.call_stack[0][4]"}),1002:K(m,function(M,L){return"e.S2U(e.log_shift("+M.write()+","+L.U2S()+"))"}),1003:K(m,function(M,L){return"e.S2U(e.art_shift("+M.U2S()+","+L.U2S()+"))"}),1009:K(m,function(){return"e.save_undo("+this.next+","+this.storer.v+")"}),1010:K(g,function(){return"if(e.restore_undo())return"},{storer:1}),1011:K(g,function(L){return"e.print(String.fromCharCode("+L.write()+"))"}),1012:K(m,function(){return 3}),};var u=function(P,N){var O=0,L,R,M,Q;while(O<P.ops.length-1){if(P.ops[O].offset==N){L=new G(P.e,P.ops[O+1].pc);L.ops=P.ops.slice(O+1);R=L.ops.length-1;P.ops.length=O+1;j(L.ops,L);M=P.ops[O];M.result=L;M.invert=!M.invert;Q=L.ops[R];if(Q.code==140&&(I(Q.operands[0].v)+Q.next-2)==M.pc){M.keyword="while";L.ops.pop()}else{L.stopper=Q.stopper}return 1}O++}},j=function(N,M){for(var L=0;L<N.length;L++){N[L].context=M}};var c=function(Q){var R,N,O=Q.m,T,M,S,U,P,L=new A(Q,Q.pc);while(1){R=Q.pc;N=R;M=O.getUint8(R++);if(M==190){U=-1;M=O.getUint8(R++)+1000}else{if(M&128){if(M&64){U=-1;if(!(M&32)){M&=31}}else{U=[(M&48)>>4];if(U[0]<3){M&=207}}}else{U=[M&64?2:1,M&32?2:1];M&=31}}if(!C[M]){e("Missing opcode #"+M+" at pc="+N);Q.stop=1;console.log(L.write());throw Error}S=C[M].prototype;if(U==-1){U=[];f(O.getUint8(R++),U);if(M==236||M==250){f(O.getUint8(R++),U)}}P=[];T=0;while(T<U.length){if(U[T]==0){P.push(new J(Q,O.getUint16(R)));R+=2}if(U[T]==1){P.push(new J(Q,O.getUint8(R++)))}if(U[T++]==2){P.push(new h(Q,O.getUint8(R++)))}}if(S.storer){P.push(new h(Q,O.getUint8(R++)))}if(S.brancher){T=O.getUint8(R++);P.push([T&128,T&64?T&63:((T=(T<<8)|O.getUint8(R++))&8192?~8191:0)|(T&8191)])}if(S.printer){T=Q.text.decode(R);P.push(H(T));R=T.pc}Q.pc=R;L.ops.push(new C[M](Q,L,M,N,R,P));T=0;if(L.targets.indexOf(R)>=0){T=u(L,R)}if(S.stopper&&T==0){break}}return L},f=function(M,N){for(var L=0;L<4;L++){N.push((M&192)>>6);M<<=2}};B.ZVM=Object.subClass({art_shift:function(M,L){return L>0?M<<L:M>>-L},call:function(R,L,P,N){var O,M,Q=N.length;this.pc=R*this.packing_multipler;M=this.m.getUint8(this.pc++);N=N.slice(0,M);for(O=N.length;O<M;O++){N.push(0)}this.l=N.concat(this.l);this.call_stack.unshift([P,L,M,this.s.length,Q])},clear_attr:function(L,M){var N=this.objects+14*L+parseInt(M/8);this.m.setUint8(N,this.m.getUint8(N)&~(128>>M%8))},extension_table:function(M,L){var N=this.extension;if(!N||M>this.extension_count){return 0}N+=2*M;if(L==k){return this.m.getUint16(N)}this.e.setUint16(N,L)},find_prop:function(L,P,O){var S=this.m,R,Q,N=0,M=S.getUint16(this.objects+14*L+12);M+=S.getUint8(M)*2+1;R=S.getUint8(M);Q=R&63;if(O==0){return Q}while(1){if(N==O){return Q}if(Q==P){return M+(R&128?2:1)}if(Q<P){return 0}N=Q;if(R&128){Q=S.getUint8(M+1)&63;M+=Q?Q+2:66}else{M+=R&64?3:2}R=S.getUint8(M);Q=R&63}},get_bigsis:function(N){var M=this.get_child(this.get_parent(N)),L;if(M==N){return 0}while(1){L=this.get_lilsis(M);if(L==N){return M}M=L}},get_child:function(L){return this.m.getUint16(this.objects+14*L+10)},get_family:function(M){var L=this.get_parent(M);return L?[L,this.get_child(L),this.get_lilsis(M),this.get_bigsis(M)]:[0]},get_lilsis:function(L){return this.m.getUint16(this.objects+14*L+8)},get_parent:function(L){return this.m.getUint16(this.objects+14*L+6)},get_prop:function(L,M){var O=this.m,N=this.find_prop(L,M);if(N){return(O.getUint8(N-1)&64?O.getUint16:O.getUint8)(N)}return O.getUint16(this.properties+2*(M-1))},get_prop_len:function(M){if(M==0){return 0}var L=this.m.getUint8(M-1);if(L&128){L&=63;return L==0?64:L}return L&64?2:1},incdec:function(M,O){var L,N;if(M==0){L=this.S2U(this.s.pop()+O);this.s.push(L);return L}if(M<16){return this.l[M-1]=this.S2U(this.l[M-1]+O)}else{N=this.globals+(M-16)*2;return this.m.setUint16(N,this.m.getUint16(N)+O)}},indirect:function(L,M){if(L==0){if(arguments.length>1){return this.s[this.s.length-1]=M}else{return this.s[this.s.length-1]}}return this.variable(L,M)},insert_obj:function(M,L){this.remove_obj(M);this.set_family(M,L,L,M,M,this.get_child(L))},jeq:function(){var L=1,M;while(L<arguments.length){if(arguments[L++]==arguments[0]){M=1}}return M},jin:function(M,L){return this.get_parent(M)==L},log_shift:function(M,L){return L>0?M<<L:M>>>-L},print:function(L){this.ui.print(L)},put_prop:function(L,N,M){var P=this.m,O=this.find_prop(L,N);(P.getUint8(O-1)&64?P.setUint16:P.setUint8)(O,M)},random:function(L){var M;if(L<1){this.random_state=Math.abs(L);this.random_seq=0;return 0}if(this.random_state==0){return parseInt(Math.random()*L)+1}else{this.random_seq++;if(this.random_seq>this.random_state){this.random_seq=1}return this.random_seq%L}},read:function(P,O,N,L,M){if(arguments.length==3){M=N;N=L=0}this.act("read",{text:P,parse:O,len:this.m.getUint8(P),initiallen:this.m.getUint8(P+1),time:N,routine:L,storer:M})},remove_obj:function(M){var L=this.get_family(M);if(L[0]==0){return}if(L[1]==M){this.set_family(M,0,L[0],L[2])}else{this.set_family(M,0,0,0,L[3],L[2])}},restore_undo:function(){if(this.undo.length==0){return 0}var L=this.undo.pop();this.pc=L[0];L[2][17]=this.m.getUint8(17);this.m.setBuffer(0,L[2]);this.l=L[3];this.s=L[4];this.call_stack=L[5];this.variable(L[1],2);return 1},ret:function(L){var N=this.call_stack.shift(),M=N[1];this.pc=N[0];this.l=this.l.slice(N[2]);this.s.length=N[3];if(M>=0){this.variable(M,L)}},save_undo:function(M,L){this.undo.push([M,L,this.m.getBuffer(0,this.staticmem),this.l.slice(),this.s.slice(),this.call_stack.slice()]);return 1},set_attr:function(L,M){var N=this.objects+14*L+parseInt(M/8);this.m.setUint8(N,this.m.getUint8(N)|128>>M%8)},set_family:function(N,O,M,Q,L,P){this.m.setUint16(this.objects+14*N+6,O);if(M){this.m.setUint16(this.objects+14*M+10,Q)}if(L){this.m.setUint16(this.objects+14*L+8,P)}},test:function(M,L){return M&L==L},test_attr:function(L,M){return(this.m.getUint8(this.objects+14*L+parseInt(M/8))<<M%8)&128},variable:function(M,N){var L=N!==k;if(M==0){if(L){this.s.push(N)}else{return this.s.pop()}}else{if(M<16){if(L){this.l[M-1]=N}else{return this.l[M-1]}}else{if(L){this.m.setUint16(this.globals+(M-16)*2,N)}else{this.m.getUint16(this.globals+(M-16)*2)}}}return N},U2S:I,S2U:d,init:function(){this.jit={}},inputEvent:function(M){var N=this.m,L;this.orders=[];if(M.code=="load"){this.data=M.data;this.restart()}if(M.code=="read"){this.variable(M.storer,M.terminator);L=M.response;if(L.length>M.len){L=L.slice(0,M.len)}N.setUint8(M.text+1,L.length);N.setBuffer(M.text+2,this.text.text_to_zscii(L));if(M.parse){this.text.tokenise(L,M.parse)}this.print(L+"\n")}this.run()},restart:function(){var O=E(this.data),L=O.getUint8(0),M=O.getUint16(10),N=O.getUint16(54);if(L!=5&&L!=8){throw new Error("Unsupported Z-Machine version: "+data[0])}if(this.m){O.setUint8(17,this.m.getUint8(17))}i(this,{m:O,s:[],l:[],call_stack:[],undo:[],random_state:0,orders:[],version:L,pc:O.getUint16(6),properties:M,objects:M+112,globals:O.getUint16(12),staticmem:O.getUint16(14),extension:N,extension_count:N?O.getUint16(N):0,packing_multipler:L==5?4:8});i(this,{ui:new r(this),text:new p(this)});O.setUint8(1,29);O.setUint8(17,O.getUint8(17)&87);O.setUint8(50,1);O.setUint8(51,F?2:0);this.extension_table(4,0)},run:function(){var M=Date.now(),L;this.stop=0;while(!this.stop){L=this.pc;if(!this.jit[L]){this.compile()}this.jit[L](this);if((Date.now()-M)>5000){this.act("tick");return}}},compile:function(){var L=c(this),M=L.write();this.jit[L.pc]=new Function("e",M);if(L.pc<this.staticmem){console.warn("Caching a JIT function in dynamic memory: "+L.pc)}},act:function(M,L){var L=L||{};this.ui.flush();L.code=M;this.orders.push(L);this.stop=1;this.outputEvent(this.orders)}})})(this);
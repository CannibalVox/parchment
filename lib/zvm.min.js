/*

ZVM - the ifvms.js implementation of the Z-Machine
==================================================

Built: 2011-10-10

Copyright (c) 2011 The ifvms.js team
BSD licenced
http://github.com/curiousdannii/ifvms.js

*/
(function(F,m){if(![].indexOf){Array.prototype.indexOf=function(T,S){for(var R=S||0,Q=array.length;R<Q;R++){if(array[R]==T){return R}}return -1}}var k=function(Q,S){for(var R in S){Q[R]=S[R]}return Q},g=F.console?function(){console.log.apply(console,arguments)}:function(){},M=function(Q){return((Q&32768)?~65535:0)|Q},f=function(Q){return Q&65535},J=F.PARCHMENT_SECURITY_OVERRIDE;var c=F.DataView,I=c?function(R){var Q=new ArrayBuffer(R),R=new DataView(Q);R.buffer=Q;return R}:function(Q){Q=Q.slice();return{data:Q,getUint8:function(R){return Q[R]},getUint16:function(R){return Q[R]<<8|Q[R+1]},getBuffer:function(S,R){return Q.slice(S,S+R)},getBuffer16:function(S,R){return v(Q.slice(S,S+R*2))},setUint8:function(R,S){return Q[R]=S&255},setUint16:function(R,S){Q[R]=(S>>8)&255;Q[R+1]=S&255;return S&65535},setBuffer:function(S,R){return Q=Q.slice(0,S).concat(R,Q.slice(S+R.length))}}},v=function(T){var S=0,R=T.length,Q=[];while(S<R){Q[S/2]=T[S++]<<8|T[S++]}return Q};var O=Object.subClass({init:function(Q,R){this.e=Q;this.v=R},write:function(){return this.v},U2S:function(){return M(this.v)}}),j=O.subClass({write:function(S){var R=this.v,Q=arguments.length,S=S&&S.write?S.write():S,T=this.e.globals+(R-16)*2;if(this.returnval){return"e.variable("+R+","+S+")"}if(R==0){return Q?"s.push("+S+")":"s.pop()"}else{if(R<16){R--;return"l["+R+"]"+(Q?"="+S:"")}else{if(Q){return"m.setUint16("+T+","+S+")"}else{return"m.getUint16("+T+")"}}}},U2S:function(){return"e.U2S("+this.write()+")"}}),i=Object.subClass({init:function(U,S,V,R,T,Q){this.e=U;this.context=S;this.code=V;this.pc=R;this.next=T;this.operands=Q;if(this.post){this.post()}},write:function(){return this.label()+(this.func?this.func.apply(this,this.operands):"")},args:function(R){var Q=0,S=[];while(Q<this.operands.length){S.push(this.operands[Q++].write())}return S.join(R)},label:function(){return"/* "+this.pc+"/"+this.code+" */ "}}),w=i.subClass({stopper:1}),H=i.subClass({brancher:1,keyword:"if",post:function(){var Q,S,R=this.operands.pop(),T=R[1];this.iftrue=R[0];if(T==0||T==1){Q="e.ret("+T+")"}else{T+=this.next-2;this.context.targets.push(T);Q="e.pc="+T}this.result=Q+"; return";this.offset=T;this.ops=[];this.labels=[];if(this.context.ops.length){S=this.context.ops.pop();if(S.offset==T){this.ops=S.ops;this.labels=S.labels}else{this.context.ops.push(S)}}this.ops.push(this);this.labels.push(this.pc+"/"+this.code)},write:function(){var R=0,S,Q=this.result;if(Q instanceof K){Q=Q.write()+(Q.stopper?"; return":"");if(this.result.ops.length>1){Q="\n"+Q+"\n"}}while(R<this.ops.length){S=this.ops[R];this.ops[R++]=(S.iftrue?"":"!(")+S.func.apply(S,S.operands)+(S.iftrue?"":")")}return"/* "+this.labels.join()+" */ "+this.keyword+(this.invert?"(!(":"(")+this.ops.join("||")+(this.invert?")) {":") {")+Q+"}"}}),C=H.subClass({storer:1,post:function(){this._super();this.storer=this.operands.pop();this.storer.returnval=1}}),o=i.subClass({storer:1,post:function(){this.storer=this.operands.pop()},write:function(){var Q=this._super();return this.storer?this.storer.write(Q):Q}}),B=w.subClass({post:function(){this.result={v:-1}},write:function(){var Q=this.operands.shift();return this.label()+"e.call("+Q.write()+","+this.result.v+","+this.next+",["+this.args()+"])"}}),p=B.subClass({storer:1,post:function(){this.result=this.operands.pop()}}),K=Object.subClass({init:function(R,Q){this.e=R;this.pc=Q;this.ops=[];this.targets=[]},write:function(){var S=this.ops,Q=[],R=0;while(R<S.length){Q.push(S[R++].write())}return Q.join(";")}}),E=K.subClass({write:function(){return"var l=e.l,m=e.m,s=e.s;\n"+this._super()}}),P=function(R,S,Q){var Q=Q||{};if(S){Q.func=S}return R.subClass(Q)};var A=IFF.subClass({init:function(R){this._super(R);if(R){if(this.type!="IFZS"){throw new Error("Not a Quetzal savefile")}for(var S=0,Q=this.chunks.length;S<Q;S++){var T=this.chunks[S].type,U=this.chunks[S].data;if(T=="CMem"||T=="UMem"){this.memory=U;this.compressed=(T=="CMem")}else{if(T=="Stks"){this.stacks=U}else{if(T=="IFhd"){this.release=U.slice(0,2);this.serial=U.slice(2,8);this.checksum=U.slice(8,10);this.pc=U[10]<<16|U[11]<<8|U[12]}}}}}},write:function(){this.type="IFZS";var R=this.pc,Q=this.release.concat(this.serial,this.checksum,(R>>16)&255,(R>>8)&255,R&255);this.chunks=[{type:"IFhd",data:Q},{type:(this.compressed?"CMem":"UMem"),data:this.memory},{type:"Stks",data:this.stacks}];return this._super()}});var N=/\n/g,a=/\r/g,q=/"/g,z=/[\x00-\x0C\x0E-\x1F\x7F-\x9A\xFC-\uFFFF]/g,d=/[\x9B-\xFB]/g,L=function(Q){return Q.replace(N,"\\n").replace(q,'\\"')},s=Object.subClass({init:function(Y){var V=Y.m,S=V.getUint16(52),U=Y.extension_table(3),Q=U&&V.getUint8(U++),W,R=[],X=0,T=96;this.e=Y;this.make_alphabet(S?V.getBuffer(S,78):this.text_to_zscii("abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ*\r0123456789.,!?_#'\"/\\-:()"));this.make_unicode(U?V.getBuffer16(U,Q):this.text_to_zscii(unescape("%E4%F6%FC%C4%D6%DC%DF%BB%AB%EB%E2%EA%EE%F4%FB%C2%CA%CE%D4%DB%EF%FF%CB%CF%E1%E9%ED%F3%FA%FD%C1%C9%CD%D3%DA%DD%E0%E8%EC%F2%F9%C0%C8%CC%D2%D9%E5%C5%F8%D8%E3%F1%F5%C3%D1%D5%E6%C6%E7%C7%FE%F0%DE%D0%A3%u0153%u0152%A1%BF"),1));W=V.getUint16(24);if(W){while(X<T){R.push(this.decode(V.getUint16(W+2*X++)*2))}}this.abbr=R;this.dictionaries={};this.dict=V.getUint16(8);this.parse_dict(this.dict)},make_alphabet:function(R){var S=[[],[],[]],Q=0;while(Q<78){S[parseInt(Q/26)][Q%26]=R[Q++]}this.alphabets=S},make_unicode:function(T){var S={},Q={10:13},R=0;while(R<T.length){S[R+155]=T[R];Q[T[R]]=155+R++}this.unicode_table=S;this.reverse_unicode_table=Q},decode:function(X,R){var U=this.e.m,Y=X,Q,T=[],V=0,W,S=0,Z=[];if(this.e.jit[X]){return this.e.jit[X]}R=R||U.getUint16(26)*this.e.packing_multipler;while(X<R){Q=U.getUint16(X);X+=2;T.push(Q>>10&31,Q>>5&31,Q&31);if(Q&32768){break}}while(V<T.length){W=T[V++];if(W==0){Z.push(32)}else{if(W<4){Z=Z.concat(this.abbr[32*(W-1)+T[V++]])}else{if(W<6){S=W}else{if(S==2&&W==6){Z.push(T[V++]<<5|T[V++])}else{Z.push(this.alphabets[S][W-6])}}}}S=S<4?0:S-3}if(this.abbr){Z=new String(this.zscii_to_text(Z));Z.pc=X;this.e.jit[Y]=Z;if(Y<this.e.staticmem){console.warn("Caching a string in dynamic memory: "+Y)}}return Z},zscii_to_text:function(R){var Q=this.unicode_table;return String.fromCharCode.apply(this,R).replace(z,"").replace(a,"\n").replace(d,function(S){return String.fromCharCode(Q[S.charCodeAt(0)]||63)})},text_to_zscii:function(U,T){var V=[],R=0,Q=U.length,S;T=!T;while(R<Q){S=U.charCodeAt(R++);if(T&&S!=13&&(S<32||S>126)){S=this.reverse_unicode_table[S]||63}V.push(S)}return V},parse_dict:function(Y){var W=this.e.m,U=Y,T={},S,Q,X,R,S=W.getUint8(Y++),V=this.zscii_to_text(W.getBuffer(Y,S));T.lexer_pattern=new RegExp("["+V+"]|\\b\\S{1,9}(?=\\S*?(\\b|["+V+"]))","g");Y+=S;Q=W.getUint8(Y++);X=Y+2+Q*W.getUint16(Y);Y+=2;while(Y<X){T[this.decode(Y,Y+6)]=Y;Y+=Q}this.dictionaries[U]=T;return T},tokenise:function(V,R,X){X=X||this.dict;X=this.dictionaries[X]||this.parse_dict(X);var W=this.e.m,S=0,Q=W.getUint8(R),T=X.lexer_pattern,U;T.lastIndex=0;V=V.toLowerCase();while(S<Q&&(U=T.exec(V))){W.setUint16(R+2+S*4,X[U[0]]||0);W.setUint8(R+4+S*4,U[0].length);W.setUint8(R+5+S++*4,U.index)}W.setUint8(R+1,S)}});var y=[-2,65535,0,29,832,957,22944,31775,30624,32767,23254,17969,11627],r=function(Q){var R=Math.round((Q&31)*8.225)<<16|Math.round(((Q&992)>>5)*8.225)<<8|Math.round(((Q&31744)>>10)*8.225);R=R.toString(16);while(R.length<6){R="0"+R}return"#"+R},u=Object.subClass({init:function(Q){this.e=Q;this.buffer="";this.styles={};this.streams=[1,0,[],0];this.fontbit=Q.m.getUint8(17)&2},flush:function(){var Q;if(this.buffer!=""){Q=k({},this.styles);this.e.orders.push({code:"print",css:Q,text:this.buffer});this.buffer=""}},print:function(R){if(this.streams[2].length){this.streams[2][0][1]+=R}else{if(this.streams[0]){var Q=this.e.m.getUint8(17)&2;if(Q!=this.fontbit){this.fontbit=Q;this.flush();this.styles.node=this.fontbit?"tt":m}this.buffer+=R}}},set_colour:function(R,Q){this.set_true_colour(y[R],y[Q])},set_style:function(Q){var R=this.styles;this.flush();if(Q==0){R.reverse=R["font-weight"]=R["font-style"]=m;R.node=this.fontbit?"tt":m}if(Q&1){R.reverse=1}if(Q&2){R["font-weight"]="bold"}if(Q&4){R["font-style"]="italic"}if(Q&8){R.node="tt"}},set_true_colour:function(T,R){var S=this.styles,U=S.color,Q=S["background-color"];this.flush();if(T==65535){U=m}else{if(T<32768){U=r(T)}}if(R==65535){Q=m}else{if(R<32768){Q=r(R)}}S.color=U;S["background-color"]=Q},output_stream:function(S,T){S=this.e.U2S(S);if(S==1){this.streams[0]=1}if(S==-1){this.streams[0]=0}if(S==3){this.streams[2].unshift([T,""])}if(S==-3){var Q=this.streams[2].shift(),R=this.e.text.text_to_zscii(Q[1]);this.e.m.setUint16(Q[0],R.length);this.e.m.setBuffer(Q[0]+2,R)}}});var b=function(Q){return Q.write()},n=P(H,function(){return 1}),D=j.subClass({write:function(S){var Q=arguments.length,R=this.v;if(R.write||R==0){S=S&&S.write?S.write():S;R=R.write?R.write():R;return"e.indirect("+R+(Q?","+S:"")+")"}return this._super(S)}}),t=o.subClass({storer:0,post:function(){var Q=this.operands;Q[0]=new D(this.e,Q[0] instanceof j?Q[0]:Q[0].v);this.storer=this.code==142?Q.pop():Q.shift();if(Q.length==0){Q.push(new j(this.e,0))}},func:b}),G={1:P(H,function(){return arguments.length==2?this.args("=="):"e.jeq("+this.args()+")"}),2:P(H,function(R,Q){return R.U2S()+"<"+Q.U2S()}),3:P(H,function(R,Q){return R.U2S()+">"+Q.U2S()}),4:P(H,function(Q,R){return"e.U2S(e.incdec("+Q.write()+",-1))<"+R.U2S()}),5:P(H,function(Q,R){return"e.U2S(e.incdec("+Q.write()+",1))>"+R.U2S()}),6:P(H,function(){return"e.jin("+this.args()+")"}),7:P(H,function(){return"e.test("+this.args()+")"}),8:P(o,function(){return this.args("|")}),9:P(o,function(){return this.args("&")}),10:P(H,function(){return"e.test_attr("+this.args()+")"}),11:P(i,function(){return"e.set_attr("+this.args()+")"}),12:P(i,function(){return"e.clear_attr("+this.args()+")"}),13:t,14:P(i,function(){return"e.insert_obj("+this.args()+")"}),15:P(o,function(R,Q){return"m.getUint16("+R.write()+"+2*"+Q.U2S()+")"}),16:P(o,function(R,Q){return"m.getUint8("+R.write()+"+"+Q.U2S()+")"}),17:P(o,function(){return"e.get_prop("+this.args()+")"}),18:P(o,function(){return"e.find_prop("+this.args()+")"}),19:P(o,function(){return"e.find_prop("+this.args(",0,")+")"}),20:P(o,function(){return"e.S2U("+this.args("+")+")"}),21:P(o,function(){return"e.S2U("+this.args("-")+")"}),22:P(o,function(){return"e.S2U("+this.args("*")+")"}),23:P(o,function(R,Q){return"e.S2U(parseInt("+R.U2S()+"/"+Q.U2S()+"))"}),24:P(o,function(R,Q){return"e.S2U("+R.U2S()+"%"+Q.U2S()+")"}),25:p,26:B,27:P(i,function(){return"e.ui.set_colour("+this.args()+")"}),128:P(H,function(Q){return Q.write()+"==0"}),129:P(C,function(Q){return this.storer.write("e.get_lilsis("+Q.write()+")")}),130:P(C,function(Q){return this.storer.write("e.get_child("+Q.write()+")")}),131:P(o,function(Q){return"e.get_parent("+Q.write()+")"}),132:P(o,function(Q){return"e.get_prop_len("+Q.write()+")"}),133:P(i,function(Q){return"e.incdec("+Q.write()+",1)"}),134:P(i,function(Q){return"e.incdec("+Q.write()+",-1)"}),135:P(i,function(Q){return"e.print(e.text.decode("+Q.write()+"))"}),136:p,137:P(i,function(Q){return"e.remove_obj("+Q.write()+")"}),138:P(i,function(Q){return"e.print(e.text.decode(m.getUint16(e.objects+14*"+Q.write()+"+13)))"}),139:P(w,function(Q){return"e.ret("+Q.write()+")"}),140:P(w,function(Q){return"e.pc="+Q.U2S()+"+"+(this.next-2)+""}),141:P(i,function(Q){return"e.print(e.text.decode("+Q.write()+"*"+this.e.packing_multipler+"))"}),142:t.subClass({storer:1}),143:B,176:P(w,function(){return"e.ret(1)"}),177:P(w,function(){return"e.ret(0)"}),178:P(i,function(Q){return'e.print("'+Q+'")'},{printer:1}),179:P(w,function(Q){return'e.print("'+Q+'");e.ret(1)'},{printer:1}),180:i,183:P(w,function(){return'e.act("restart")'}),184:P(w,function(Q){return"e.ret("+Q.write()+")"},{post:function(){this.operands.push(new j(this.e,0))}}),186:P(w,function(){return'e.act("quit")'}),187:P(i,function(){return'e.print("\\n")'}),189:n,191:n,224:p,225:P(i,function(S,Q,R){return"m.setUint16("+S.write()+"+2*"+Q.U2S()+","+R.write()+")"}),226:P(i,function(S,Q,R){return"m.setUint8("+S.write()+"+"+Q.U2S()+","+R.write()+")"}),227:P(i,function(){return"e.put_prop("+this.args()+")"}),228:P(w,function(){var Q=this.operands.pop();return"e.read("+this.args()+","+Q.v+");e.pc="+this.next},{storer:1}),229:P(i,function(Q){return"e.print(e.text.zscii_to_text(["+Q.write()+"]))"}),230:P(i,function(Q){return"e.print("+Q.U2S()+")"}),231:P(o,function(Q){return"e.random("+Q.U2S()+")"}),232:P(o,b,{post:function(){this.storer=new j(this.e,0)},storer:0}),233:t,236:p,241:P(i,function(Q){return"e.ui.set_style("+Q.write()+")"}),242:i,243:P(i,function(){return"e.ui.output_stream("+this.args()+")"}),245:i,248:P(o,function(Q){return"e.S2U(~"+Q.write()+")"}),249:B,250:B,255:P(H,function(Q){return Q.write()+"<=e.call_stack[0][4]"}),1002:P(o,function(R,Q){return"e.S2U(e.log_shift("+R.write()+","+Q.U2S()+"))"}),1003:P(o,function(R,Q){return"e.S2U(e.art_shift("+R.U2S()+","+Q.U2S()+"))"}),1009:P(o,function(){return"e.save_undo("+this.next+","+this.storer.v+")"}),1010:P(i,function(){return"if(e.restore_undo())return"},{storer:1}),1011:P(i,function(Q){return"e.print(String.fromCharCode("+Q.write()+"))"}),1012:P(o,function(){return 3}),};var x=function(U,S){var T=0,Q,W,R,V;while(T<U.ops.length-1){if(U.ops[T].offset==S){Q=new K(U.e,U.ops[T+1].pc);Q.ops=U.ops.slice(T+1);W=Q.ops.length-1;U.ops.length=T+1;l(Q.ops,Q);R=U.ops[T];R.result=Q;R.invert=!R.invert;V=Q.ops[W];if(V.code==140&&(M(V.operands[0].v)+V.next-2)==R.pc){R.keyword="while";Q.ops.pop()}else{Q.stopper=V.stopper}return 1}T++}},l=function(S,R){for(var Q=0;Q<S.length;Q++){S[Q].context=R}};var e=function(V){var W,S,T=V.m,Y,R,X,Z,U,Q=new E(V,V.pc);while(1){W=V.pc;S=W;R=T.getUint8(W++);if(R==190){Z=-1;R=T.getUint8(W++)+1000}else{if(R&128){if(R&64){Z=-1;if(!(R&32)){R&=31}}else{Z=[(R&48)>>4];if(Z[0]<3){R&=207}}}else{Z=[R&64?2:1,R&32?2:1];R&=31}}if(!G[R]){g("Missing opcode #"+R+" at pc="+S);V.stop=1;console.log(Q.write());throw Error}X=G[R].prototype;if(Z==-1){Z=[];h(T.getUint8(W++),Z);if(R==236||R==250){h(T.getUint8(W++),Z)}}U=[];Y=0;while(Y<Z.length){if(Z[Y]==0){U.push(new O(V,T.getUint16(W)));W+=2}if(Z[Y]==1){U.push(new O(V,T.getUint8(W++)))}if(Z[Y++]==2){U.push(new j(V,T.getUint8(W++)))}}if(X.storer){U.push(new j(V,T.getUint8(W++)))}if(X.brancher){Y=T.getUint8(W++);U.push([Y&128,Y&64?Y&63:((Y=(Y<<8)|T.getUint8(W++))&8192?~8191:0)|(Y&8191)])}if(X.printer){Y=V.text.decode(W);U.push(L(Y));W=Y.pc}V.pc=W;Q.ops.push(new G[R](V,Q,R,S,W,U));Y=0;if(Q.targets.indexOf(W)>=0){Y=x(Q,W)}if(X.stopper&&Y==0){break}}return Q},h=function(R,S){for(var Q=0;Q<4;Q++){S.push((R&192)>>6);R<<=2}};F.ZVM=Object.subClass({art_shift:function(R,Q){return Q>0?R<<Q:R>>-Q},call:function(W,Q,U,S){var T,R,V=S.length;this.pc=W*this.packing_multipler;R=this.m.getUint8(this.pc++);S=S.slice(0,R);for(T=S.length;T<R;T++){S.push(0)}this.l=S.concat(this.l);this.call_stack.unshift([U,Q,R,this.s.length,V])},clear_attr:function(Q,R){var S=this.objects+14*Q+parseInt(R/8);this.m.setUint8(S,this.m.getUint8(S)&~(128>>R%8))},extension_table:function(R,Q){var S=this.extension;if(!S||R>this.extension_count){return 0}S+=2*R;if(Q==m){return this.m.getUint16(S)}this.e.setUint16(S,Q)},find_prop:function(Q,U,T){var X=this.m,W,V,S=0,R=X.getUint16(this.objects+14*Q+12);R+=X.getUint8(R)*2+1;W=X.getUint8(R);V=W&63;if(T==0){return V}while(1){if(S==T){return V}if(V==U){return R+(W&128?2:1)}if(V<U){return 0}S=V;if(W&128){V=X.getUint8(R+1)&63;R+=V?V+2:66}else{R+=W&64?3:2}W=X.getUint8(R);V=W&63}},get_bigsis:function(S){var R=this.get_child(this.get_parent(S)),Q;if(R==S){return 0}while(1){Q=this.get_lilsis(R);if(Q==S){return R}R=Q}},get_child:function(Q){return this.m.getUint16(this.objects+14*Q+10)},get_family:function(R){var Q=this.get_parent(R);return Q?[Q,this.get_child(Q),this.get_lilsis(R),this.get_bigsis(R)]:[0]},get_lilsis:function(Q){return this.m.getUint16(this.objects+14*Q+8)},get_parent:function(Q){return this.m.getUint16(this.objects+14*Q+6)},get_prop:function(Q,R){var T=this.m,S=this.find_prop(Q,R);if(S){return(T.getUint8(S-1)&64?T.getUint16:T.getUint8)(S)}return T.getUint16(this.properties+2*(R-1))},get_prop_len:function(R){if(R==0){return 0}var Q=this.m.getUint8(R-1);if(Q&128){Q&=63;return Q==0?64:Q}return Q&64?2:1},incdec:function(R,T){var Q,S;if(R==0){Q=this.S2U(this.s.pop()+T);this.s.push(Q);return Q}if(R<16){return this.l[R-1]=this.S2U(this.l[R-1]+T)}else{S=this.globals+(R-16)*2;return this.m.setUint16(S,this.m.getUint16(S)+T)}},indirect:function(Q,R){if(Q==0){if(arguments.length>1){return this.s[this.s.length-1]=R}else{return this.s[this.s.length-1]}}return this.variable(Q,R)},insert_obj:function(R,Q){this.remove_obj(R);this.set_family(R,Q,Q,R,R,this.get_child(Q))},jeq:function(){var Q=1,R;while(Q<arguments.length){if(arguments[Q++]==arguments[0]){R=1}}return R},jin:function(R,Q){return this.get_parent(R)==Q},log_shift:function(R,Q){return Q>0?R<<Q:R>>>-Q},print:function(Q){this.ui.print(Q)},put_prop:function(Q,S,R){var U=this.m,T=this.find_prop(Q,S);(U.getUint8(T-1)&64?U.setUint16:U.setUint8)(T,R)},random:function(Q){var R;if(Q<1){this.random_state=Math.abs(Q);this.random_seq=0;return 0}if(this.random_state==0){return parseInt(Math.random()*Q)+1}else{this.random_seq++;if(this.random_seq>this.random_state){this.random_seq=1}return this.random_seq%Q}},read:function(U,T,S,Q,R){if(arguments.length==3){R=S;S=Q=0}this.act("read",{text:U,parse:T,len:this.m.getUint8(U),initiallen:this.m.getUint8(U+1),time:S,routine:Q,storer:R})},remove_obj:function(R){var Q=this.get_family(R);if(Q[0]==0){return}if(Q[1]==R){this.set_family(R,0,Q[0],Q[2])}else{this.set_family(R,0,0,0,Q[3],Q[2])}},restore_undo:function(){if(this.undo.length==0){return 0}var Q=this.undo.pop();this.pc=Q[0];Q[2][17]=this.m.getUint8(17);this.m.setBuffer(0,Q[2]);this.l=Q[3];this.s=Q[4];this.call_stack=Q[5];this.variable(Q[1],2);return 1},ret:function(Q){var S=this.call_stack.shift(),R=S[1];this.pc=S[0];this.l=this.l.slice(S[2]);this.s.length=S[3];if(R>=0){this.variable(R,Q)}},save_undo:function(R,Q){this.undo.push([R,Q,this.m.getBuffer(0,this.staticmem),this.l.slice(),this.s.slice(),this.call_stack.slice()]);return 1},set_attr:function(Q,R){var S=this.objects+14*Q+parseInt(R/8);this.m.setUint8(S,this.m.getUint8(S)|128>>R%8)},set_family:function(S,T,R,V,Q,U){this.m.setUint16(this.objects+14*S+6,T);if(R){this.m.setUint16(this.objects+14*R+10,V)}if(Q){this.m.setUint16(this.objects+14*Q+8,U)}},test:function(R,Q){return R&Q==Q},test_attr:function(Q,R){return(this.m.getUint8(this.objects+14*Q+parseInt(R/8))<<R%8)&128},variable:function(R,S){var Q=S!==m;if(R==0){if(Q){this.s.push(S)}else{return this.s.pop()}}else{if(R<16){if(Q){this.l[R-1]=S}else{return this.l[R-1]}}else{if(Q){this.m.setUint16(this.globals+(R-16)*2,S)}else{this.m.getUint16(this.globals+(R-16)*2)}}}return S},U2S:M,S2U:f,init:function(){this.jit={}},load:function(Q){this.data=Q},restart:function(){var T=I(this.data),Q=T.getUint8(0),R=T.getUint16(10),S=T.getUint16(54);if(Q!=5&&Q!=8){throw new Error("Unsupported Z-Machine version: "+data[0])}if(this.m){T.setUint8(17,this.m.getUint8(17))}k(this,{m:T,s:[],l:[],call_stack:[],undo:[],random_state:0,orders:[],version:Q,pc:T.getUint16(6),properties:R,objects:R+112,globals:T.getUint16(12),staticmem:T.getUint16(14),extension:S,extension_count:S?T.getUint16(S):0,packing_multipler:Q==5?4:8});k(this,{ui:new u(this),text:new s(this)});T.setUint8(1,29);T.setUint8(17,T.getUint8(17)&87);T.setUint8(50,1);T.setUint8(51,J?2:0);this.extension_table(4,0)},run:function(){var R=Date.now(),Q;this.orders=[];this.stop=0;while(!this.stop){Q=this.pc;if(!this.jit[Q]){this.compile()}this.jit[Q](this);if((Date.now()-R)>5000){this.act("tick");return}}},compile:function(){var Q=e(this),R=Q.write();this.jit[Q.pc]=new Function("e",R);if(Q.pc<this.staticmem){console.warn("Caching a JIT function in dynamic memory: "+Q.pc)}},act:function(R,Q){var Q=Q||{};this.ui.flush();Q.code=R;this.orders.push(Q);this.stop=1},event:function(R){var S=this.m,Q;if(R.code=="read"){this.variable(R.storer,R.terminator);Q=R.response;if(Q.length>R.len){Q=Q.slice(0,R.len)}S.setUint8(R.text+1,Q.length);S.setBuffer(R.text+2,this.text.text_to_zscii(Q));if(R.parse){this.text.tokenise(Q,R.parse)}this.print(Q+"\n")}}})})(this);
/*

ZVM - the ifvms.js implementation of the Z-Machine
==================================================

Built: 2011-10-02

Copyright (c) 2011 The ifvms.js team
BSD licenced
http://github.com/curiousdannii/ifvms.js

*/
(function(C){var o=function(P,O){if([].indexOf){return P.indexOf(O)}for(var N=0,M=P.length;N<M;N++){if(P[N]==O){return N}}return -1},k=function(M,N){for(name in N){M[name]=N[name]}return M},d=Function.prototype.bind?function(N,M){return M.bind(N)}:function(N,M){return function(){M.apply(N,arguments)}},g=C.console?function(){console.log.apply(console,arguments)}:function(){},I=function(M){return((M&32768)?~65535:0)|M},f=function(M){return M&65535},G=C.PARCHMENT_SECURITY_OVERRIDE;var c=C.DataView,F=c?function(N){var M=new ArrayBuffer(N),N=new DataView(M);N.buffer=M;return N}:function(M){M=M.slice();if(ZVM){return{data:M,getUint8:function(N){return M[N]},getUint16:function(N){return M[N]<<8|M[N+1]},getBuffer:function(O,N){return M.slice(O,O+N)},setUint8:function(N,O){M[N]=O&255},setUint16:function(N,O){M[N]=(O>>8)&255;M[N+1]=O&255},setBuffer:function(O,N){for(var P=0;P<N.length;P++){M[O+P]=N[P]&255}}}}if(GVM){}};var K=Object.subClass({init:function(M,N){this.e=M;this.v=N},write:function(){return this.v},U2S:function(){return I(this.v)}}),j=K.subClass({write:function(N){var M=this.v,N=N&&N.write?N.write():N,O=this.e.globals+(M-16)*2;if(M==0){if(N){return"s.push("+N+")"}else{return"s.pop()"}}else{if(M<16){M--;if(N){return"l["+M+"]="+N}else{return"l["+M+"]"}}else{if(N){return"m.setUint16("+O+","+N+")"}else{return"m.getUint16("+O+")"}}}},U2S:function(){return"e.U2S("+this.write()+")"}}),i=Object.subClass({init:function(Q,O,R,N,P,M){this.e=Q;this.context=O;this.code=R;this.pc=N;this.next=P;this.operands=M;this.pre=[];if(this.post){this.post()}},write:function(){return this.label()+(this.func?this.func.apply(this,this.operands):"")},var_args:function(O){var M=0,N=[];while(M<O.length){N.push(O[M++].write())}return N.join()},label:function(){return"/* "+this.pc+"/"+this.code+" */ "}}),w=i.subClass({stopper:1}),E=i.subClass({brancher:1,post:function(){var M,O,N=this.operands.pop(),P=N[1];this.iftrue=N[0];if(P==0||P==1){M="e.ret("+P+")"}else{P+=this.next-2;this.context.targets.push(P);M="e.pc="+P}this.result=M+"; return";this.offset=P;this.ops=[];this.labels=[];if(this.context.ops.length){O=this.context.ops.pop();if(O.offset==P){this.pre=O.pre;this.ops=O.ops;this.labels=O.labels}else{this.context.ops.push(O)}}this.ops.push(this);this.labels.push(this.pc+"/"+this.code)},write:function(){var N=0,O,M=this.result;if(M instanceof H){M=M.write()+(M.stopper?"; return":"");if(this.result.ops.length>1){M="\n"+M+"\n"}}while(N<this.ops.length){O=this.ops[N];this.ops[N++]=(O.iftrue?"":"!(")+O.func.apply(O,O.operands)+(O.iftrue?"":")")}this.pre.push("");return"/* "+this.labels.join()+" */ "+this.pre.join(";")+(this.invert?"if (!(":"if (")+this.ops.join("||")+(this.invert?")) {":") {")+M+"}"}}),n=i.subClass({storer:1,post:function(){this.storer=this.operands.pop()},write:function(){var M=this._super();return this.storer?this.storer.write(M):M}}),y=w.subClass({post:function(){this.result={v:-1}},write:function(){var M=this.operands.shift();return this.label()+"e.call("+M.write()+","+this.result.v+","+this.next+",["+this.var_args(this.operands)+"])"}}),q=y.subClass({storer:1,post:function(){this.result=this.operands.pop()}}),H=Object.subClass({init:function(N,M){this.e=N;this.pc=M;this.ops=[];this.targets=[]},write:function(){var O=this.ops,M=[],N=0;while(N<O.length){M.push(O[N++].write())}return M.join(";")}}),B=H.subClass({write:function(){return"var l=e.l,m=e.m,s=e.s;\n"+this._super()}}),L=function(N,O,M){var M=M||{};if(O){M.func=O}return N.subClass(M)};var J=/\n/g,r=/"/g,A=(function(N){var M=[[],[],[]],O=0;while(O<78){M[parseInt(O/26)][O%26]=N.charCodeAt(O++)}return M})("abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ*\n0123456789.,!?_#'\"/\\-:()"),s=Object.subClass({init:function(O){var Q=O.m,N=Q.getUint16(52),M=0,P;this.e=O;if(N){P=[[],[],[]];while(M<78){P[parseInt(M/26)][M%26]=Q.getUint8(N+M++)}}else{P=A}this.alphabets=P;this.dictionaries={};this.parse_dict(this.e.dictionary)},decode:function(T,N){var Q=this.e.m,U=T,M,P=[],R=0,S,O=0,V=[];if(this.e.jit[T]){return this.e.jit[T]}if(!N){N=Q.getUint16(26)*this.e.packing_multipler}while(T<N){M=Q.getUint16(T);T+=2;P.push(M>>10,M>>5,M);if(M&32768){break}}while(R<P.length){S=P[R++]&31;if(S==0){V.push(32)}else{if(S<4){}else{if(S<6){O=S}else{if(O==2&&S==6){V.push((P[R++]&31)<<5|(P[R++]&31))}else{V.push(this.alphabets[O][S-6])}}}}O=O<4?0:O-3}V=[this.array_to_text(V),T-U];this.e.jit[U]=V;if(U<this.e.staticmem){console.warn("Caching a string in dynamic memory: "+U)}return V},escape:function(M){return M.replace(J,"\\n").replace(r,'\\"')},array_to_text:function(M){return String.fromCharCode.apply(1,M)},text_to_array:function(O){var P=[],N=0,M=O.length;while(N<M){P.push(O.charCodeAt(N++)&255)}return P},parse_dict:function(U){var S=this.e.m,Q=U,P={},O,M,T,N,O=S.getUint8(U++),R=this.array_to_text(S.getBuffer(U,O));P.lexer_pattern=new RegExp("["+R+"]|(^|\\b)\\S+?(?=$|[ "+R+"])","g");U+=O;M=S.getUint8(U++);T=U+2+M*S.getUint16(U);U+=2;while(U<T){P[this.decode(U,U+6)[0]]=U;U+=M}this.dictionaries[Q]=P;return P},tokenise:function(R,N,T){T=T||this.e.dictionary;T=this.dictionaries[T]||this.parse_dict(T);var S=this.e.m,O=0,M=S.getUint8(N),P=T.lexer_pattern,Q;P.lastIndex=0;R=R.toLowerCase();while(O<M&&(Q=P.exec(R))){S.setUint16(N+2+O*4,T[Q[0]]||0);S.setUint8(N+4+O*4,Q[0].length);S.setUint8(N+5+O++*4,Q.index)}S.setUint8(N+1,O)}});var u=Object.subClass({init:function(M){this.e=M;M.buffer=[]},styles:{},set_style:function(N){var O=this.styles,M=this.e.buffer,P;if(M!=""){P=k({},this.styles);this.e.orders.push({code:"print",css:P,text:M});this.e.buffer=""}if(N==0){this.styles={}}if(N&1){O.reverse=1}if(N&2){O["font-weight"]="bold"}if(N&4){O["font-style"]="italic"}if(N&8){O["font-family"]="monospace"}}});var z=c?/^s/:/^[sm]/,a=function(O,M){var N=M.write();if(z.test(N)){O.pre.push("var "+O.temp()+"="+N);N="t"+O.pc}return N},b=function(M){return M.write()},m=L(E,function(){return 1}),t=n.subClass({storer:0,post:function(){var M=this.operands;M[0]=new j(this.e,M[0] instanceof j?M[0]:M[0].v);if(!this.storer){this.storer=M.shift()}if(M.length==0){M.push(new j(this.e,0))}},func:b}),D={1:L(E,function(N,M){return arguments.length==2?N.write()+"=="+M.write():"e.jeq("+this.var_args(arguments)+")"}),2:L(E,function(N,M){return N.U2S()+"<"+M.U2S()}),3:L(E,function(N,M){return N.U2S()+">"+M.U2S()}),6:L(E,function(N,M){return"e.jin("+N.write()+","+M.write()+")"}),7:L(E,function(O,M){var N=a(this,M);return O.write()+"&"+N+"=="+N}),8:L(n,function(N,M){return N.write()+"|"+M.write()}),9:L(n,function(N,M){return N.write()+"&"+M.write()}),10:L(E,function(N,M){return"e.test_attr("+N.write()+","+M.write()+")"}),13:t,15:L(n,function(N,M){return"m.getUint16("+N.write()+"+2*"+M.write()+")"}),16:L(n,function(N,M){return"m.getUint8("+N.write()+"+"+M.write()+")"}),17:L(n,function(M,N){return"e.get_prop("+M.write()+","+N.write()+")"}),18:L(n,function(M,N){return"e.get_prop_addr("+M.write()+","+N.write()+")"}),20:L(n,function(N,M){return"e.S2U("+N.write()+"+"+M.write()+")"}),21:L(n,function(N,M){return"e.S2U("+N.write()+"-("+M.write()+"))"}),22:L(n,function(N,M){return"e.S2U("+N.write()+"*"+M.write()+")"}),23:L(n,function(N,M){return"e.S2U(parseInt("+N.write()+"/"+M.write()+"))"}),24:L(n,function(N,M){return"e.S2U("+N.write()+"%"+M.write()+")"}),25:q,26:y,128:L(E,function(M){return M.write()+"==0"}),132:L(n,function(M){return"e.get_prop_len("+M.write()+")"}),133:L(i,function(M){return"e.incdec("+M.write()+",1)"}),134:L(i,function(M){return"e.incdec("+M.write()+",-1)"}),135:L(i,function(M){return"e.buffer+=e.text.decode("+M.write()+")[0]"}),136:q,138:L(i,function(M){return"e.buffer+=e.text.decode(m.getUint16(e.objects+14*("+M.write()+"-1)+13))[0]"}),139:L(w,function(M){return"e.ret("+M.write()+")"}),140:L(w,function(M){return"e.pc="+M.U2S()+"+"+(this.next-2)+""}),141:L(i,function(M){return"e.buffer+=e.text.decode("+M.write()+"*"+this.e.packing_multipler+")[0]"}),142:t.subClass({storer:1}),143:y,176:L(w,function(){return"e.ret(1)"}),177:L(w,function(){return"e.ret(0)"}),178:L(i,function(M){return'e.buffer+="'+M+'"'},{printer:1}),179:L(w,function(M){return'e.buffer+="'+M+'"'},{printer:1}),180:i,183:L(w,function(){return'e.act("restart")'}),184:L(w,function(M){return"e.ret("+M.write()+")"},{post:function(){this.operands.push(new j(this.e,0))}}),186:L(w,function(){return'e.act("quit")'}),187:L(i,function(){return'e.buffer+="\\n"'}),189:m,191:m,224:q,225:L(i,function(O,M,N){return"m.setUint16("+O.write()+"+2*"+M.write()+","+N.write()+")"}),226:L(i,function(O,M,N){return"m.setUint8("+O.write()+"+"+M.write()+","+N.write()+")"}),228:L(n,function(){var M=this.storer.v;this.storer=0;return"e.read("+this.var_args(arguments)+","+M+")"},{stopper:1}),229:L(i,function(M){return"e.buffer+=String.fromCharCode("+M.write()+")"}),230:L(i,function(M){return"e.buffer+="+M.U2S()}),232:L(n,b,{post:function(){this.storer=new j(this.e,0)},storer:0}),233:t,236:q,241:L(i,function(M){return"e.ui.set_style("+M.write()+")"}),246:L(w,function(){return'e.act("quit")'}),248:L(n,function(M){return"~"+M.write()}),249:y,250:y,255:L(E,function(M){return M.write()+"<=e.call_stack[0][4]"}),1011:L(i,function(M){return"e.buffer+=String.fromCharCode("+M.write()+")"}),1012:L(n,function(){return 3}),1030:L(n,function(){return"e.gestalt("+this.var_args(arguments)+")"}),1031:L(n,function(){return"e.op_parchment("+this.var_args(arguments)+")"})};var x=function(P,N){for(var O=0,M;O<P.ops.length-1;O++){if(P.ops[O].offset==N){M=new H(P.e,P.ops[O+1]);M.ops=P.ops.slice(O+1);P.ops.length=O+1;l(M.ops,M);P.ops[O].result=M;P.ops[O].invert=!P.ops[O].invert;M.stopper=M.ops[M.ops.length-1].stopper;return 1}}},l=function(O,N){for(var M=0;M<O.length;M++){O[M].context=N}};var e=function(R){var S,O,P=R.m,U,N,T,V,Q,M=new B(R,R.pc);while(1){S=R.pc;O=S;N=P.getUint8(S++);if(N==190){V=-1;N=P.getUint8(S++)+1000}else{if(N&128){if(N&64){V=-1;if(!(N&32)){N&=31}}else{V=[(N&48)>>4];if(V[0]<3){N&=207}}}else{V=[N&64?2:1,N&32?2:1];N&=31}}if(!D[N]){g("Missing opcode #"+N+" at pc="+O);R.stop=1;console.log(M.write());throw Error}T=D[N].prototype;if(V==-1){V=[];h(P.getUint8(S++),V);if(N==236||N==250){h(P.getUint8(S++),V)}}Q=[];U=0;while(U<V.length){if(V[U]==0){Q.push(new K(R,P.getUint16(S)));S+=2}if(V[U]==1){Q.push(new K(R,P.getUint8(S++)))}if(V[U++]==2){Q.push(new j(R,P.getUint8(S++)))}}if(T.storer){Q.push(new j(R,P.getUint8(S++)))}if(T.brancher){U=P.getUint8(S++);Q.push([U&128,U&64?U&63:((U=(U<<8)|P.getUint8(S++))&8192?~8191:0)|(U&8191)])}if(T.printer){U=R.text.decode(S);Q.push(R.text.escape(U[0]));S+=U[1]}R.pc=S;M.ops.push(new D[N](R,M,N,O,S,Q));U=0;if(M.targets.indexOf(S)>=0){U=x(M,S)}if(T.stopper&&U==0){break}}return M},h=function(N,O){for(var M=0;M<4;M++){O.push((N&192)>>6);N<<=2}};var p={call:function(S,M,Q,O){var P,N,R=O.length;this.pc=S*this.packing_multipler;N=this.m.getUint8(this.pc++);O=O.slice(0,N);for(P=O.length;P<N;P++){O.push(0)}this.l=O.concat(this.l);this.call_stack.unshift([Q,M,N,this.s.length,R])},get_prop:function(M,N){var P=this.m,O=this.get_prop_addr(M,N);if(O){return(P.getUint8(O-1)&64?P.getUint16:P.getUint8)(O)}return P.getUint16(this.property_defaults+2*(N-1))},get_prop_addr:function(M,O){var Q=this.m,P,N=Q.getUint16(this.objects+14*(M-1)+12);N+=Q.getUint8(N)*2+1;while(1){P=Q.getUint8(N);if((P&63)==O){return N+(P&128?2:1)}if((P&63)<O){return 0}else{if(P&128){P=Q.getUint8(N+1)&63;N+=P?P+2:66}else{N+=P&64?3:2}}}},get_prop_len:function(N){if(N==0){return 0}var M=this.m.getUint8(N-1);if(M&128){M&=63;return M==0?64:M}return M&64?2:1},incdec:function(M,O){if(M==0){this.s.push(this.s.pop()+O)}if(M<16){this.l[M-1]+=O}else{var N=this.globals+(M-16)*2;this.m.setUint16(N,this.m.setUint16(N)+O)}},jeq:function(){var M=1,N;while(M<arguments.length){if(arguments[M++]==arguments[0]){N=1}}return N},jin:function(N,M){return this.m.getUint16(this.objects+14*(N-1)+6)==M},read:function(Q,P,O,M,N){if(arguments.length==3){N=O;O=M=0}this.act("read",{text:Q,parse:P,len:this.m.getUint8(Q),initiallen:this.m.getUint8(Q+1),time:O,routine:M,storer:N})},ret:function(M){var O=this.call_stack.shift(),N=O[1];this.pc=O[0];this.l=this.l.slice(O[2]);this.s.length=O[3];if(N>=0){this.store(N,M)}},store:function(M,N){if(M==0){this.s.push(N)}else{if(M<16){this.l[M-1]=N}else{this.m.setUint16(this.globals+(M-16)*2,N)}}},test_attr:function(M,N){return(this.m.getUint8(this.objects+14*(M-1)+parseInt(N/8))<<(N%8))&128},U2S:I,S2U:f};var v={load:function(M){this.data=M},restart:function(){var O=F(this.data),M=O.getUint8(0),N=O.getUint16(10);k(this,{m:O,s:[],l:[],call_stack:[],jit:{},orders:[],version:M,pc:O.getUint16(6),dictionary:O.getUint16(8),property_defaults:N,objects:N+126,globals:O.getUint16(12),staticmem:O.getUint16(14),packing_multipler:M==5?4:8});k(this,{ui:new u(this),text:new s(this)});O.setUint8(1,29);O.setUint8(16,O.getUint8(16)&87);O.setUint8(50,1);O.setUint8(51,G?2:0)},run:function(){var N=Date.now(),M;this.orders=[];this.stop=0;while(!this.stop){M=this.pc;if(!this.jit[M]){this.compile()}this.jit[M](this);if((Date.now()-N)>5000){this.act("tick");return}}},compile:function(){var M=e(this),N=M.write();this.jit[M.pc]=new Function("e",N);if(M.pc<this.staticmem){console.warn("Caching a JIT function in dynamic memory: "+M.pc)}},act:function(O,N){var P,M=this.buffer,N=N||{};if(M!=""){P=k({},this.ui.styles);this.orders.push({code:"print",css:P,text:M});this.buffer=""}N.code=O;this.orders.push(N);this.stop=1},event:function(N){var O=this.m,M;if(N.code=="read"){this.store(N.storer,N.terminator);M=N.response;if(M.length>N.len){M=M.slice(0,N.len)}O.setUint8(N.text+1,M.length);O.setBuffer(N.text+2,this.text.text_to_array(M));if(N.parse){this.text.tokenise(M,N.parse)}}}};C.ZVM=Object.subClass(k(v,p))})(this);
/*

ZVM - the ifvms.js implementation of the Z-Machine
==================================================

Built: 2011-10-03

Copyright (c) 2011 The ifvms.js team
BSD licenced
http://github.com/curiousdannii/ifvms.js

*/
(function(E){var o=function(R,Q){if([].indexOf){return R.indexOf(Q)}for(var P=0,O=R.length;P<O;P++){if(R[P]==Q){return P}}return -1},k=function(O,P){for(name in P){O[name]=P[name]}return O},d=Function.prototype.bind?function(P,O){return O.bind(P)}:function(P,O){return function(){O.apply(P,arguments)}},g=E.console?function(){console.log.apply(console,arguments)}:function(){},K=function(O){return((O&32768)?~65535:0)|O},f=function(O){return O&65535},I=E.PARCHMENT_SECURITY_OVERRIDE;var c=E.DataView,H=c?function(P){var O=new ArrayBuffer(P),P=new DataView(O);P.buffer=O;return P}:function(O){O=O.slice();return{data:O,getUint8:function(P){return O[P]},getUint16:function(P){return O[P]<<8|O[P+1]},getBuffer:function(Q,P){return O.slice(Q,Q+P)},setUint8:function(P,Q){return O[P]=Q&255},setUint16:function(P,Q){O[P]=(Q>>8)&255;O[P+1]=Q&255;return Q&65535},setBuffer:function(Q,P,S){if(S){return O=O.slice(0,Q).concat(P,O.slice(Q+P.length))}for(var R=0;R<P.length;R++){O[Q+R]=P[R]&255}}}};var M=Object.subClass({init:function(O,P){this.e=O;this.v=P},write:function(){return this.v},U2S:function(){return K(this.v)}}),j=M.subClass({write:function(Q){var P=this.v,O=arguments.length,Q=Q&&Q.write?Q.write():Q,R=this.e.globals+(P-16)*2;if(P==0){return O?"s.push("+Q+")":"s.pop()"}else{if(P<16){P--;return"l["+P+"]"+(O?"="+Q:"")}else{if(O){return"m.setUint16("+R+","+Q+")"}else{return"m.getUint16("+R+")"}}}},U2S:function(){return"e.U2S("+this.write()+")"}}),i=Object.subClass({init:function(S,Q,T,P,R,O){this.e=S;this.context=Q;this.code=T;this.pc=P;this.next=R;this.operands=O;this.pre=[];if(this.post){this.post()}},write:function(){return this.label()+(this.func?this.func.apply(this,this.operands):"")},var_args:function(Q){var O=0,P=[];while(O<Q.length){P.push(Q[O++].write())}return P.join()},label:function(){return"/* "+this.pc+"/"+this.code+" */ "}}),w=i.subClass({stopper:1}),G=i.subClass({brancher:1,post:function(){var O,Q,P=this.operands.pop(),R=P[1];this.iftrue=P[0];if(R==0||R==1){O="e.ret("+R+")"}else{R+=this.next-2;this.context.targets.push(R);O="e.pc="+R}this.result=O+"; return";this.offset=R;this.ops=[];this.labels=[];if(this.context.ops.length){Q=this.context.ops.pop();if(Q.offset==R){this.pre=Q.pre;this.ops=Q.ops;this.labels=Q.labels}else{this.context.ops.push(Q)}}this.ops.push(this);this.labels.push(this.pc+"/"+this.code)},write:function(){var P=0,Q,O=this.result;if(O instanceof J){O=O.write()+(O.stopper?"; return":"");if(this.result.ops.length>1){O="\n"+O+"\n"}}while(P<this.ops.length){Q=this.ops[P];this.ops[P++]=(Q.iftrue?"":"!(")+Q.func.apply(Q,Q.operands)+(Q.iftrue?"":")")}this.pre.push("");return"/* "+this.labels.join()+" */ "+this.pre.join(";")+(this.invert?"if (!(":"if (")+this.ops.join("||")+(this.invert?")) {":") {")+O+"}"}}),n=i.subClass({storer:1,post:function(){this.storer=this.operands.pop()},write:function(){var O=this._super();return this.storer?this.storer.write(O):O}}),z=w.subClass({post:function(){this.result={v:-1}},write:function(){var O=this.operands.shift();return this.label()+"e.call("+O.write()+","+this.result.v+","+this.next+",["+this.var_args(this.operands)+"])"}}),q=z.subClass({storer:1,post:function(){this.result=this.operands.pop()}}),J=Object.subClass({init:function(P,O){this.e=P;this.pc=O;this.ops=[];this.targets=[]},write:function(){var Q=this.ops,O=[],P=0;while(P<Q.length){O.push(Q[P++].write())}return O.join(";")}}),D=J.subClass({write:function(){return"var l=e.l,m=e.m,s=e.s;\n"+this._super()}}),N=function(P,Q,O){var O=O||{};if(Q){O.func=Q}return P.subClass(O)};var y=IFF.subClass({init:function(P){this._super(P);if(P){if(this.type!="IFZS"){throw new Error("Not a Quetzal savefile")}for(var Q=0,O=this.chunks.length;Q<O;Q++){var R=this.chunks[Q].type,S=this.chunks[Q].data;if(R=="CMem"||R=="UMem"){this.memory=S;this.compressed=(R=="CMem")}else{if(R=="Stks"){this.stacks=S}else{if(R=="IFhd"){this.release=S.slice(0,2);this.serial=S.slice(2,8);this.checksum=S.slice(8,10);this.pc=S[10]<<16|S[11]<<8|S[12]}}}}}},write:function(){this.type="IFZS";var P=this.pc,O=this.release.concat(this.serial,this.checksum,(P>>16)&255,(P>>8)&255,P&255);this.chunks=[{type:"IFhd",data:O},{type:(this.compressed?"CMem":"UMem"),data:this.memory},{type:"Stks",data:this.stacks}];return this._super()}});var L=/\n/g,r=/"/g,B=(function(P){var O=[[],[],[]],Q=0;while(Q<78){O[parseInt(Q/26)][Q%26]=P.charCodeAt(Q++)}return O})("abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ*\n0123456789.,!?_#'\"/\\-:()"),s=Object.subClass({init:function(Q){var S=Q.m,P=S.getUint16(52),O=0,R;this.e=Q;if(P){R=[[],[],[]];while(O<78){R[parseInt(O/26)][O%26]=S.getUint8(P+O++)}}else{R=B}this.alphabets=R;this.dictionaries={};this.parse_dict(this.e.dictionary)},decode:function(V,P){var S=this.e.m,W=V,O,R=[],T=0,U,Q=0,X=[];if(this.e.jit[V]){return this.e.jit[V]}if(!P){P=S.getUint16(26)*this.e.packing_multipler}while(V<P){O=S.getUint16(V);V+=2;R.push(O>>10,O>>5,O);if(O&32768){break}}while(T<R.length){U=R[T++]&31;if(U==0){X.push(32)}else{if(U<4){}else{if(U<6){Q=U}else{if(Q==2&&U==6){X.push((R[T++]&31)<<5|(R[T++]&31))}else{X.push(this.alphabets[Q][U-6])}}}}Q=Q<4?0:Q-3}X=[this.array_to_text(X),V-W];this.e.jit[W]=X;if(W<this.e.staticmem){console.warn("Caching a string in dynamic memory: "+W)}return X},escape:function(O){return O.replace(L,"\\n").replace(r,'\\"')},array_to_text:function(O){return String.fromCharCode.apply(1,O)},text_to_array:function(Q){var R=[],P=0,O=Q.length;while(P<O){R.push(Q.charCodeAt(P++)&255)}return R},parse_dict:function(W){var U=this.e.m,S=W,R={},Q,O,V,P,Q=U.getUint8(W++),T=this.array_to_text(U.getBuffer(W,Q));R.lexer_pattern=new RegExp("["+T+"]|(^|\\b)\\S+?(?=$|[ "+T+"])","g");W+=Q;O=U.getUint8(W++);V=W+2+O*U.getUint16(W);W+=2;while(W<V){R[this.decode(W,W+6)[0]]=W;W+=O}this.dictionaries[S]=R;return R},tokenise:function(T,P,V){V=V||this.e.dictionary;V=this.dictionaries[V]||this.parse_dict(V);var U=this.e.m,Q=0,O=U.getUint8(P),R=V.lexer_pattern,S;R.lastIndex=0;T=T.toLowerCase();while(Q<O&&(S=R.exec(T))){U.setUint16(P+2+Q*4,V[S[0]]||0);U.setUint8(P+4+Q*4,S[0].length);U.setUint8(P+5+Q++*4,S.index)}U.setUint8(P+1,Q)}});var u=Object.subClass({init:function(O){this.e=O},buffer:"",styles:{},print:function(O){this.buffer+=O},set_style:function(O){var P=this.styles,Q;if(this.buffer!=""){Q=k({},this.styles);this.e.orders.push({code:"print",css:Q,text:this.buffer});this.buffer=""}if(O==0){this.styles={}}if(O&1){P.reverse=1}if(O&2){P["font-weight"]="bold"}if(O&4){P["font-style"]="italic"}if(O&8){P["font-family"]="monospace"}}});var A=c?/^s/:/^[sm]/,a=function(Q,O){var P=O.write();if(A.test(P)){Q.pre.push("var "+Q.temp()+"="+P);P="t"+Q.pc}return P},b=function(O){return O.write()},m=N(G,function(){return 1}),C=j.subClass({write:function(Q){var O=arguments.length,P=this.v;if(this.v.write||this.v==0){Q=Q&&Q.write?Q.write():Q;P=P.write?P.write():P;return"e.indirect("+P+(O?","+Q:"")+")"}return this._super(Q)}}),t=n.subClass({storer:0,post:function(){var O=this.operands;O[0]=new C(this.e,O[0] instanceof j?O[0]:O[0].v);this.storer=this.code==142?O.pop():O.shift();if(O.length==0){O.push(new j(this.e,0))}},func:b}),F={1:N(G,function(P,O){return arguments.length==2?P.write()+"=="+O.write():"e.jeq("+this.var_args(arguments)+")"}),2:N(G,function(P,O){return P.U2S()+"<"+O.U2S()}),3:N(G,function(P,O){return P.U2S()+">"+O.U2S()}),4:N(G,function(O,P){return"e.U2S(e.incdec("+O.write()+",-1))<"+P.U2S()}),5:N(G,function(O,P){return"e.U2S(e.incdec("+O.write()+",1))>"+P.U2S()}),6:N(G,function(P,O){return"e.jin("+P.write()+","+O.write()+")"}),7:N(G,function(Q,O){var P=a(this,O);return Q.write()+"&"+P+"=="+P}),8:N(n,function(P,O){return P.write()+"|"+O.write()}),9:N(n,function(P,O){return P.write()+"&"+O.write()}),10:N(G,function(P,O){return"e.test_attr("+P.write()+","+O.write()+")"}),13:t,15:N(n,function(P,O){return"m.getUint16("+P.write()+"+2*"+O.U2S()+")"}),16:N(n,function(P,O){return"m.getUint8("+P.write()+"+"+O.U2S()+")"}),17:N(n,function(O,P){return"e.get_prop("+O.write()+","+P.write()+")"}),18:N(n,function(O,P){return"e.get_prop_addr("+O.write()+","+P.write()+")"}),20:N(n,function(P,O){return"e.S2U("+P.write()+"+"+O.write()+")"}),21:N(n,function(P,O){return"e.S2U("+P.write()+"-("+O.write()+"))"}),22:N(n,function(P,O){return"e.S2U("+P.write()+"*"+O.write()+")"}),23:N(n,function(P,O){return"e.S2U(parseInt("+P.U2S()+"/"+O.U2S()+"))"}),24:N(n,function(P,O){return"e.S2U("+P.U2S()+"%"+O.U2S()+")"}),25:q,26:z,128:N(G,function(O){return O.write()+"==0"}),132:N(n,function(O){return"e.get_prop_len("+O.write()+")"}),133:N(i,function(O){return"e.incdec("+O.write()+",1)"}),134:N(i,function(O){return"e.incdec("+O.write()+",-1)"}),135:N(i,function(O){return"e.print(e.text.decode("+O.write()+")[0])"}),136:q,138:N(i,function(O){return"e.print(e.text.decode(m.getUint16(e.objects+14*("+O.write()+"-1)+13))[0])"}),139:N(w,function(O){return"e.ret("+O.write()+")"}),140:N(w,function(O){return"e.pc="+O.U2S()+"+"+(this.next-2)+""}),141:N(i,function(O){return"e.print(e.text.decode("+O.write()+"*"+this.e.packing_multipler+")[0])"}),142:t.subClass({storer:1}),143:z,176:N(w,function(){return"e.ret(1)"}),177:N(w,function(){return"e.ret(0)"}),178:N(i,function(O){return'e.print("'+O+'")'},{printer:1}),179:N(w,function(O){return'e.print("'+O+'");e.ret(1)'},{printer:1}),180:i,183:N(w,function(){return'e.act("restart")'}),184:N(w,function(O){return"e.ret("+O.write()+")"},{post:function(){this.operands.push(new j(this.e,0))}}),186:N(w,function(){return'e.act("quit")'}),187:N(i,function(){return'e.print("\\n")'}),189:m,191:m,224:q,225:N(i,function(Q,O,P){return"m.setUint16("+Q.write()+"+2*"+O.U2S()+","+P.write()+")"}),226:N(i,function(Q,O,P){return"m.setUint8("+Q.write()+"+"+O.U2S()+","+P.write()+")"}),228:N(w,function(){var O=this.operands.pop();return"e.read("+this.var_args(this.operands)+","+O.v+");e.pc="+this.next},{storer:1}),229:N(i,function(O){return"e.print(String.fromCharCode("+O.write()+"))"}),230:N(i,function(O){return"e.print("+O.U2S()+")"}),232:N(n,b,{post:function(){this.storer=new j(this.e,0)},storer:0}),233:t,236:q,241:N(i,function(O){return"e.ui.set_style("+O.write()+")"}),246:N(w,function(){return'e.act("quit")'}),248:N(n,function(O){return"e.S2U(~"+O.write()+")"}),249:z,250:z,255:N(G,function(O){return O.write()+"<=e.call_stack[0][4]"}),1002:N(n,function(P,O){return"e.S2U(e.log_shift("+P.write()+","+O.U2S()+"))"}),1003:N(n,function(P,O){return"e.S2U(e.art_shift("+P.U2S()+","+O.U2S()+"))"}),1009:N(n,function(){return"e.save_undo("+this.next+","+this.storer.v+")"}),1010:N(i,function(O){return"if(e.restore_undo("+O.v+"))return"},{storer:1}),1011:N(i,function(O){return"e.print(String.fromCharCode("+O.write()+"))"}),1012:N(n,function(){return 3}),1030:N(n,function(){return"e.gestalt("+this.var_args(arguments)+")"}),1031:N(n,function(){return"e.op_parchment("+this.var_args(arguments)+")"})};var x=function(R,P){for(var Q=0,O;Q<R.ops.length-1;Q++){if(R.ops[Q].offset==P){O=new J(R.e,R.ops[Q+1]);O.ops=R.ops.slice(Q+1);R.ops.length=Q+1;l(O.ops,O);R.ops[Q].result=O;R.ops[Q].invert=!R.ops[Q].invert;O.stopper=O.ops[O.ops.length-1].stopper;return 1}}},l=function(Q,P){for(var O=0;O<Q.length;O++){Q[O].context=P}};var e=function(T){var U,Q,R=T.m,W,P,V,X,S,O=new D(T,T.pc);while(1){U=T.pc;Q=U;P=R.getUint8(U++);if(P==190){X=-1;P=R.getUint8(U++)+1000}else{if(P&128){if(P&64){X=-1;if(!(P&32)){P&=31}}else{X=[(P&48)>>4];if(X[0]<3){P&=207}}}else{X=[P&64?2:1,P&32?2:1];P&=31}}if(!F[P]){g("Missing opcode #"+P+" at pc="+Q);T.stop=1;console.log(O.write());throw Error}V=F[P].prototype;if(X==-1){X=[];h(R.getUint8(U++),X);if(P==236||P==250){h(R.getUint8(U++),X)}}S=[];W=0;while(W<X.length){if(X[W]==0){S.push(new M(T,R.getUint16(U)));U+=2}if(X[W]==1){S.push(new M(T,R.getUint8(U++)))}if(X[W++]==2){S.push(new j(T,R.getUint8(U++)))}}if(V.storer){S.push(new j(T,R.getUint8(U++)))}if(V.brancher){W=R.getUint8(U++);S.push([W&128,W&64?W&63:((W=(W<<8)|R.getUint8(U++))&8192?~8191:0)|(W&8191)])}if(V.printer){W=T.text.decode(U);S.push(T.text.escape(W[0]));U+=W[1]}T.pc=U;O.ops.push(new F[P](T,O,P,Q,U,S));W=0;if(o(O.targets,U)>=0){W=x(O,U)}if(V.stopper&&W==0){break}}return O},h=function(P,Q){for(var O=0;O<4;O++){Q.push((P&192)>>6);P<<=2}};var p={art_shift:function(P,O){return O>0?P<<O:P>>-O},call:function(U,O,S,Q){var R,P,T=Q.length;this.pc=U*this.packing_multipler;P=this.m.getUint8(this.pc++);Q=Q.slice(0,P);for(R=Q.length;R<P;R++){Q.push(0)}this.l=Q.concat(this.l);this.call_stack.unshift([S,O,P,this.s.length,T])},get_prop:function(O,P){var R=this.m,Q=this.get_prop_addr(O,P);if(Q){return(R.getUint8(Q-1)&64?R.getUint16:R.getUint8)(Q)}return R.getUint16(this.property_defaults+2*(P-1))},get_prop_addr:function(O,Q){var S=this.m,R,P=S.getUint16(this.objects+14*(O-1)+12);P+=S.getUint8(P)*2+1;while(1){R=S.getUint8(P);if((R&63)==Q){return P+(R&128?2:1)}if((R&63)<Q){return 0}else{if(R&128){R=S.getUint8(P+1)&63;P+=R?R+2:66}else{P+=R&64?3:2}}}},get_prop_len:function(P){if(P==0){return 0}var O=this.m.getUint8(P-1);if(O&128){O&=63;return O==0?64:O}return O&64?2:1},incdec:function(P,R){var O,Q;if(P==0){O=this.S2U(this.s.pop()+R);this.s.push(O);return O}if(P<16){return this.l[P-1]=this.S2U(this.l[P-1]+R)}else{Q=this.globals+(P-16)*2;return this.m.setUint16(Q,this.m.getUint16(Q)+R)}},indirect:function(O,P){if(O==0){if(arguments.length>1){return this.s[this.s.length-1]=P}else{return this.s[this.s.length-1]}}return this.variable(O,P)},jeq:function(){var O=1,P;while(O<arguments.length){if(arguments[O++]==arguments[0]){P=1}}return P},jin:function(P,O){return this.m.getUint16(this.objects+14*(P-1)+6)==O},log_shift:function(P,O){return O>0?P<<O:P>>>-O},read:function(S,R,Q,O,P){if(arguments.length==3){P=Q;Q=O=0}this.act("read",{text:S,parse:R,len:this.m.getUint8(S),initiallen:this.m.getUint8(S+1),time:Q,routine:O,storer:P})},restore_undo:function(){if(this.undo.length==0){return 0}var O=this.undo.pop();this.pc=O[0];this.m.setBuffer(0,O[2],1);this.l=O[3];this.s=O[4];this.call_stack=O[5];this.variable(O[1],2);return 1},ret:function(O){var Q=this.call_stack.shift(),P=Q[1];this.pc=Q[0];this.l=this.l.slice(Q[2]);this.s.length=Q[3];if(P>=0){this.variable(P,O)}},print:function(O){this.ui.print(O)},save_undo:function(P,O){this.undo.push([P,O,this.m.getBuffer(0,this.staticmem),this.l.slice(),this.s.slice(),this.call_stack.slice()]);return 1},test_attr:function(O,P){return(this.m.getUint8(this.objects+14*(O-1)+parseInt(P/8))<<(P%8))&128},U2S:K,S2U:f};var v={init:function(){this.jit={}},load:function(O){this.data=O},restart:function(){var Q=H(this.data),O=Q.getUint8(0),P=Q.getUint16(10);k(this,{m:Q,s:[],l:[],call_stack:[],undo:[],orders:[],version:O,pc:Q.getUint16(6),dictionary:Q.getUint16(8),property_defaults:P,objects:P+126,globals:Q.getUint16(12),staticmem:Q.getUint16(14),packing_multipler:O==5?4:8});k(this,{ui:new u(this),text:new s(this)});Q.setUint8(1,29);Q.setUint8(16,Q.getUint8(16)&87);Q.setUint8(50,1);Q.setUint8(51,I?2:0)},run:function(){var P=Date.now(),O;this.orders=[];this.stop=0;while(!this.stop){O=this.pc;if(!this.jit[O]){this.compile()}this.jit[O](this);if((Date.now()-P)>5000){this.act("tick");return}}},compile:function(){var O=e(this),P=O.write();this.jit[O.pc]=new Function("e",P);if(O.pc<this.staticmem){console.warn("Caching a JIT function in dynamic memory: "+O.pc)}},act:function(Q,P){var R,O=this.ui.buffer,P=P||{};if(O!=""){R=k({},this.ui.styles);this.orders.push({code:"print",css:R,text:O});this.ui.buffer=""}P.code=Q;this.orders.push(P);this.stop=1},event:function(P){var Q=this.m,O;if(P.code=="read"){this.variable(P.storer,P.terminator);O=P.response;if(O.length>P.len){O=O.slice(0,P.len)}Q.setUint8(P.text+1,O.length);Q.setBuffer(P.text+2,this.text.text_to_array(O));if(P.parse){this.text.tokenise(O,P.parse)}this.print(O+"\n")}},variable:function(P,Q){var O=typeof Q!="undefined";if(P==0){if(O){this.s.push(Q)}else{return this.s.pop()}}else{if(P<16){if(O){this.l[P-1]=Q}else{return this.l[P-1]}}else{if(O){this.m.setUint16(this.globals+(P-16)*2,Q)}else{this.m.getUint16(this.globals+(P-16)*2)}}}}};E.ZVM=Object.subClass(k(v,p))})(this);
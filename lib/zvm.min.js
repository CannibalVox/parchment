/*

ZVM - the ifvms.js implementation of the Z-Machine
==================================================

Built: 2011-10-04

Copyright (c) 2011 The ifvms.js team
BSD licenced
http://github.com/curiousdannii/ifvms.js

*/
(function(F,m){var p=function(U,T){if(U.indexOf){return U.indexOf(T)}for(var S=0,R=U.length;S<R;S++){if(U[S]==T){return S}}return -1},k=function(R,S){for(name in S){R[name]=S[name]}return R},g=F.console?function(){console.log.apply(console,arguments)}:function(){},N=function(R){return((R&32768)?~65535:0)|R},f=function(R){return R&65535},K=F.PARCHMENT_SECURITY_OVERRIDE;var c=F.DataView,J=c?function(S){var R=new ArrayBuffer(S),S=new DataView(R);S.buffer=R;return S}:function(R){R=R.slice();return{data:R,getUint8:function(S){return R[S]},getUint16:function(S){return R[S]<<8|R[S+1]},getBuffer:function(T,S){return R.slice(T,T+S)},setUint8:function(S,T){return R[S]=T&255},setUint16:function(S,T){R[S]=(T>>8)&255;R[S+1]=T&255;return T&65535},setBuffer:function(T,S,V){if(V){return R=R.slice(0,T).concat(S,R.slice(T+S.length))}for(var U=0;U<S.length;U++){R[T+U]=S[U]&255}}}};var P=Object.subClass({init:function(R,S){this.e=R;this.v=S},write:function(){return this.v},U2S:function(){return N(this.v)}}),j=P.subClass({write:function(T){var S=this.v,R=arguments.length,T=T&&T.write?T.write():T,U=this.e.globals+(S-16)*2;if(S==0){return R?"s.push("+T+")":"s.pop()"}else{if(S<16){S--;return"l["+S+"]"+(R?"="+T:"")}else{if(R){return"m.setUint16("+U+","+T+")"}else{return"m.getUint16("+U+")"}}}},U2S:function(){return"e.U2S("+this.write()+")"}}),i=Object.subClass({init:function(V,T,W,S,U,R){this.e=V;this.context=T;this.code=W;this.pc=S;this.next=U;this.operands=R;if(this.post){this.post()}},write:function(){return this.label()+(this.func?this.func.apply(this,this.operands):"")},var_args:function(){var R=0,S=[];while(R<this.operands.length){S.push(this.operands[R++].write())}return S.join()},label:function(){return"/* "+this.pc+"/"+this.code+" */ "}}),x=i.subClass({stopper:1}),I=i.subClass({brancher:1,post:function(){var R,T,S=this.operands.pop(),U=S[1];this.iftrue=S[0];if(U==0||U==1){R="e.ret("+U+")"}else{U+=this.next-2;this.context.targets.push(U);R="e.pc="+U}this.result=R+"; return";this.offset=U;this.ops=[];this.labels=[];if(this.context.ops.length){T=this.context.ops.pop();if(T.offset==U){this.ops=T.ops;this.labels=T.labels}else{this.context.ops.push(T)}}this.ops.push(this);this.labels.push(this.pc+"/"+this.code)},write:function(){var S=0,T,R=this.result;if(R instanceof L){R=R.write()+(R.stopper?"; return":"");if(this.result.ops.length>1){R="\n"+R+"\n"}}while(S<this.ops.length){T=this.ops[S];this.ops[S++]=(T.iftrue?"":"!(")+T.func.apply(T,T.operands)+(T.iftrue?"":")")}return"/* "+this.labels.join()+" */ "+(this.invert?"if (!(":"if (")+this.ops.join("||")+(this.invert?")) {":") {")+R+"}"}}),o=i.subClass({storer:1,post:function(){this.storer=this.operands.pop()},write:function(){var R=this._super();return this.storer?this.storer.write(R):R}}),B=x.subClass({post:function(){this.result={v:-1}},write:function(){var R=this.operands.shift();return this.label()+"e.call("+R.write()+","+this.result.v+","+this.next+",["+this.var_args(this.operands)+"])"}}),r=B.subClass({storer:1,post:function(){this.result=this.operands.pop()}}),L=Object.subClass({init:function(S,R){this.e=S;this.pc=R;this.ops=[];this.targets=[]},write:function(){var T=this.ops,R=[],S=0;while(S<T.length){R.push(T[S++].write())}return R.join(";")}}),E=L.subClass({write:function(){return"var l=e.l,m=e.m,s=e.s;\n"+this._super()}}),Q=function(S,T,R){var R=R||{};if(T){R.func=T}return S.subClass(R)};var A=IFF.subClass({init:function(S){this._super(S);if(S){if(this.type!="IFZS"){throw new Error("Not a Quetzal savefile")}for(var T=0,R=this.chunks.length;T<R;T++){var U=this.chunks[T].type,V=this.chunks[T].data;if(U=="CMem"||U=="UMem"){this.memory=V;this.compressed=(U=="CMem")}else{if(U=="Stks"){this.stacks=V}else{if(U=="IFhd"){this.release=V.slice(0,2);this.serial=V.slice(2,8);this.checksum=V.slice(8,10);this.pc=V[10]<<16|V[11]<<8|V[12]}}}}}},write:function(){this.type="IFZS";var S=this.pc,R=this.release.concat(this.serial,this.checksum,(S>>16)&255,(S>>8)&255,S&255);this.chunks=[{type:"IFhd",data:R},{type:(this.compressed?"CMem":"UMem"),data:this.memory},{type:"Stks",data:this.stacks}];return this._super()}});var O=/\n/g,a=/\r/g,s=/"/g,z=/[\x00-\x0C\x0E-\x1F\x7F-\x9A\xFC-\uFFFF]/g,d=/[\x9B-\xFB]/g,C=(function(S){var R=[[],[],[]],T=0;while(T<78){R[parseInt(T/26)][T%26]=S.charCodeAt(T++)}return R})("abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ*\r0123456789.,!?_#'\"/\\-:()"),G={10:13},M=(function(U){var T={},R,S=0;while(S<69){T[S+155]=R=U.charCodeAt(S);G[R]=155+S++}return T})(unescape("%E4%F6%FC%C4%D6%DC%DF%BB%AB%EB%E2%EA%EE%F4%FB%C2%CA%CE%D4%DB%EF%FF%CB%CF%E1%E9%ED%F3%FA%FD%C1%C9%CD%D3%DA%DD%E0%E8%EC%F2%F9%C0%C8%CC%D2%D9%E5%C5%F8%D8%E3%F1%F5%C3%D1%D5%E6%C6%E7%C7%FE%F0%DE%D0%A3%u0153%u0152%A1%BF")),t=Object.subClass({init:function(T){var V=T.m,S=V.getUint16(52),R=0,U;this.e=T;if(S){U=[[],[],[]];while(R<78){U[parseInt(R/26)][R%26]=V.getUint8(S+R++)}}else{U=C}this.alphabets=U;this.unicode_table=M;this.reverse_unicode_table=G;this.dictionaries={};this.dict=V.getUint16(8);this.parse_dict(this.dict)},decode:function(Y,S){var V=this.e.m,Z=Y,R,U=[],W=0,X,T=0,aa=[];if(this.e.jit[Y]){return this.e.jit[Y]}if(!S){S=V.getUint16(26)*this.e.packing_multipler}while(Y<S){R=V.getUint16(Y);Y+=2;U.push(R>>10,R>>5,R);if(R&32768){break}}while(W<U.length){X=U[W++]&31;if(X==0){aa.push(32)}else{if(X<4){}else{if(X<6){T=X}else{if(T==2&&X==6){aa.push((U[W++]&31)<<5|(U[W++]&31))}else{aa.push(this.alphabets[T][X-6])}}}}T=T<4?0:T-3}aa=[this.zscii_to_text(aa),Y-Z];this.e.jit[Z]=aa;if(Z<this.e.staticmem){console.warn("Caching a string in dynamic memory: "+Z)}return aa},escape:function(R){return R.replace(O,"\\n").replace(s,'\\"')},zscii_to_text:function(S){var R=this.unicode_table;return String.fromCharCode.apply(this,S).replace(z,"").replace(a,"\n").replace(d,function(T){return String.fromCharCode(R[T.charCodeAt(0)]||63)})},text_to_zscii:function(U){var V=[],S=0,R=U.length,T;while(S<R){T=U.charCodeAt(S++);if(T!=13&&(T<32||T>126)){T=this.reverse_unicode_table[T]||63}V.push(T)}return V},parse_dict:function(Z){var X=this.e.m,V=Z,U={},T,R,Y,S,T=X.getUint8(Z++),W=this.zscii_to_text(X.getBuffer(Z,T));U.lexer_pattern=new RegExp("["+W+"]|\\b\\S{1,9}(?=\\S*?(\\b|["+W+"]))","g");Z+=T;R=X.getUint8(Z++);Y=Z+2+R*X.getUint16(Z);Z+=2;while(Z<Y){U[this.decode(Z,Z+6)[0]]=Z;Z+=R}this.dictionaries[V]=U;return U},tokenise:function(W,S,Y){Y=Y||this.dict;Y=this.dictionaries[Y]||this.parse_dict(Y);var X=this.e.m,T=0,R=X.getUint8(S),U=Y.lexer_pattern,V;U.lastIndex=0;W=W.toLowerCase();while(T<R&&(V=U.exec(W))){X.setUint16(S+2+T*4,Y[V[0]]||0);X.setUint8(S+4+T*4,V[0].length);X.setUint8(S+5+T++*4,V.index)}X.setUint8(S+1,T)}});var v=Object.subClass({init:function(R){this.e=R;this.buffer="";this.styles={};this.streams=[1,0,[],0]},print:function(R){if(this.streams[2].length){this.streams[2][0][1]+=R}else{if(this.streams[0]){this.buffer+=R}}},set_style:function(R){var S=this.styles,T;if(this.buffer!=""){T=k({},this.styles);this.e.orders.push({code:"print",css:T,text:this.buffer});this.buffer=""}if(R==0){this.styles={}}if(R&1){S.reverse=1}if(R&2){S["font-weight"]="bold"}if(R&4){S["font-style"]="italic"}if(R&8){S["font-family"]="monospace"}},output_stream:function(T,U){T=this.e.U2S(T);if(T==1){this.streams[0]=1}if(T==-1){this.streams[0]=0}if(T==3){this.streams[2].unshift([U,""])}if(T==-3){var R=this.streams[2].shift(),S=this.e.text.text_to_zscii(R[1]);this.e.m.setUint16(R[0],S.length);this.e.m.setBuffer(R[0]+2,S)}}});var b=function(R){return R.write()},n=Q(I,function(){return 1}),D=j.subClass({write:function(T){var R=arguments.length,S=this.v;if(this.v.write||this.v==0){T=T&&T.write?T.write():T;S=S.write?S.write():S;return"e.indirect("+S+(R?","+T:"")+")"}return this._super(T)}}),u=o.subClass({storer:0,post:function(){var R=this.operands;R[0]=new D(this.e,R[0] instanceof j?R[0]:R[0].v);this.storer=this.code==142?R.pop():R.shift();if(R.length==0){R.push(new j(this.e,0))}},func:b}),H={1:Q(I,function(S,R){return arguments.length==2?S.write()+"=="+R.write():"e.jeq("+this.var_args()+")"}),2:Q(I,function(S,R){return S.U2S()+"<"+R.U2S()}),3:Q(I,function(S,R){return S.U2S()+">"+R.U2S()}),4:Q(I,function(R,S){return"e.U2S(e.incdec("+R.write()+",-1))<"+S.U2S()}),5:Q(I,function(R,S){return"e.U2S(e.incdec("+R.write()+",1))>"+S.U2S()}),6:Q(I,function(S,R){return"e.jin("+S.write()+","+R.write()+")"}),7:Q(I,function(S,R){return"e.test("+S.write()+","+R.write()+")"}),8:Q(o,function(S,R){return S.write()+"|"+R.write()}),9:Q(o,function(S,R){return S.write()+"&"+R.write()}),10:Q(I,function(S,R){return"e.test_attr("+S.write()+","+R.write()+")"}),13:u,15:Q(o,function(S,R){return"m.getUint16("+S.write()+"+2*"+R.U2S()+")"}),16:Q(o,function(S,R){return"m.getUint8("+S.write()+"+"+R.U2S()+")"}),17:Q(o,function(R,S){return"e.get_prop("+R.write()+","+S.write()+")"}),18:Q(o,function(R,S){return"e.get_prop_addr("+R.write()+","+S.write()+")"}),20:Q(o,function(S,R){return"e.S2U("+S.write()+"+"+R.write()+")"}),21:Q(o,function(S,R){return"e.S2U("+S.write()+"-"+R.write()+")"}),22:Q(o,function(S,R){return"e.S2U("+S.write()+"*"+R.write()+")"}),23:Q(o,function(S,R){return"e.S2U(parseInt("+S.U2S()+"/"+R.U2S()+"))"}),24:Q(o,function(S,R){return"e.S2U("+S.U2S()+"%"+R.U2S()+")"}),25:r,26:B,128:Q(I,function(R){return R.write()+"==0"}),132:Q(o,function(R){return"e.get_prop_len("+R.write()+")"}),133:Q(i,function(R){return"e.incdec("+R.write()+",1)"}),134:Q(i,function(R){return"e.incdec("+R.write()+",-1)"}),135:Q(i,function(R){return"e.print(e.text.decode("+R.write()+")[0])"}),136:r,138:Q(i,function(R){return"e.print(e.text.decode(m.getUint16(e.objects+14*("+R.write()+"-1)+13))[0])"}),139:Q(x,function(R){return"e.ret("+R.write()+")"}),140:Q(x,function(R){return"e.pc="+R.U2S()+"+"+(this.next-2)+""}),141:Q(i,function(R){return"e.print(e.text.decode("+R.write()+"*"+this.e.packing_multipler+")[0])"}),142:u.subClass({storer:1}),143:B,176:Q(x,function(){return"e.ret(1)"}),177:Q(x,function(){return"e.ret(0)"}),178:Q(i,function(R){return'e.print("'+R+'")'},{printer:1}),179:Q(x,function(R){return'e.print("'+R+'");e.ret(1)'},{printer:1}),180:i,183:Q(x,function(){return'e.act("restart")'}),184:Q(x,function(R){return"e.ret("+R.write()+")"},{post:function(){this.operands.push(new j(this.e,0))}}),186:Q(x,function(){return'e.act("quit")'}),187:Q(i,function(){return'e.print("\\n")'}),189:n,191:n,224:r,225:Q(i,function(T,R,S){return"m.setUint16("+T.write()+"+2*"+R.U2S()+","+S.write()+")"}),226:Q(i,function(T,R,S){return"m.setUint8("+T.write()+"+"+R.U2S()+","+S.write()+")"}),228:Q(x,function(){var R=this.operands.pop();return"e.read("+this.var_args()+","+R.v+");e.pc="+this.next},{storer:1}),229:Q(i,function(R){return"e.print(e.text.zscii_to_text(["+R.write()+"]))"}),230:Q(i,function(R){return"e.print("+R.U2S()+")"}),232:Q(o,b,{post:function(){this.storer=new j(this.e,0)},storer:0}),233:u,236:r,241:Q(i,function(R){return"e.ui.set_style("+R.write()+")"}),243:Q(i,function(){return"e.ui.output_stream("+this.var_args()+")"}),246:Q(x,function(){return'e.act("quit")'}),248:Q(o,function(R){return"e.S2U(~"+R.write()+")"}),249:B,250:B,255:Q(I,function(R){return R.write()+"<=e.call_stack[0][4]"}),1002:Q(o,function(S,R){return"e.S2U(e.log_shift("+S.write()+","+R.U2S()+"))"}),1003:Q(o,function(S,R){return"e.S2U(e.art_shift("+S.U2S()+","+R.U2S()+"))"}),1009:Q(o,function(){return"e.save_undo("+this.next+","+this.storer.v+")"}),1010:Q(i,function(R){return"if(e.restore_undo("+R.v+"))return"},{storer:1}),1011:Q(i,function(R){return"e.print(String.fromCharCode("+R.write()+"))"}),1012:Q(o,function(){return 3}),1030:Q(o,function(){return"e.gestalt("+this.var_args()+")"}),1031:Q(o,function(){return"e.op_parchment("+this.var_args()+")"})};var y=function(U,S){for(var T=0,R;T<U.ops.length-1;T++){if(U.ops[T].offset==S){R=new L(U.e,U.ops[T+1]);R.ops=U.ops.slice(T+1);U.ops.length=T+1;l(R.ops,R);U.ops[T].result=R;U.ops[T].invert=!U.ops[T].invert;R.stopper=R.ops[R.ops.length-1].stopper;return 1}}},l=function(T,S){for(var R=0;R<T.length;R++){T[R].context=S}};var e=function(W){var X,T,U=W.m,Z,S,Y,aa,V,R=new E(W,W.pc);while(1){X=W.pc;T=X;S=U.getUint8(X++);if(S==190){aa=-1;S=U.getUint8(X++)+1000}else{if(S&128){if(S&64){aa=-1;if(!(S&32)){S&=31}}else{aa=[(S&48)>>4];if(aa[0]<3){S&=207}}}else{aa=[S&64?2:1,S&32?2:1];S&=31}}if(!H[S]){g("Missing opcode #"+S+" at pc="+T);W.stop=1;console.log(R.write());throw Error}Y=H[S].prototype;if(aa==-1){aa=[];h(U.getUint8(X++),aa);if(S==236||S==250){h(U.getUint8(X++),aa)}}V=[];Z=0;while(Z<aa.length){if(aa[Z]==0){V.push(new P(W,U.getUint16(X)));X+=2}if(aa[Z]==1){V.push(new P(W,U.getUint8(X++)))}if(aa[Z++]==2){V.push(new j(W,U.getUint8(X++)))}}if(Y.storer){V.push(new j(W,U.getUint8(X++)))}if(Y.brancher){Z=U.getUint8(X++);V.push([Z&128,Z&64?Z&63:((Z=(Z<<8)|U.getUint8(X++))&8192?~8191:0)|(Z&8191)])}if(Y.printer){Z=W.text.decode(X);V.push(W.text.escape(Z[0]));X+=Z[1]}W.pc=X;R.ops.push(new H[S](W,R,S,T,X,V));Z=0;if(p(R.targets,X)>=0){Z=y(R,X)}if(Y.stopper&&Z==0){break}}return R},h=function(S,T){for(var R=0;R<4;R++){T.push((S&192)>>6);S<<=2}};var q={art_shift:function(S,R){return R>0?S<<R:S>>-R},call:function(X,R,V,T){var U,S,W=T.length;this.pc=X*this.packing_multipler;S=this.m.getUint8(this.pc++);T=T.slice(0,S);for(U=T.length;U<S;U++){T.push(0)}this.l=T.concat(this.l);this.call_stack.unshift([V,R,S,this.s.length,W])},get_prop:function(R,S){var U=this.m,T=this.get_prop_addr(R,S);if(T){return(U.getUint8(T-1)&64?U.getUint16:U.getUint8)(T)}return U.getUint16(this.property_defaults+2*(S-1))},get_prop_addr:function(R,T){var V=this.m,U,S=V.getUint16(this.objects+14*(R-1)+12);S+=V.getUint8(S)*2+1;while(1){U=V.getUint8(S);if((U&63)==T){return S+(U&128?2:1)}if((U&63)<T){return 0}else{if(U&128){U=V.getUint8(S+1)&63;S+=U?U+2:66}else{S+=U&64?3:2}}}},get_prop_len:function(S){if(S==0){return 0}var R=this.m.getUint8(S-1);if(R&128){R&=63;return R==0?64:R}return R&64?2:1},incdec:function(S,U){var R,T;if(S==0){R=this.S2U(this.s.pop()+U);this.s.push(R);return R}if(S<16){return this.l[S-1]=this.S2U(this.l[S-1]+U)}else{T=this.globals+(S-16)*2;return this.m.setUint16(T,this.m.getUint16(T)+U)}},indirect:function(R,S){if(R==0){if(arguments.length>1){return this.s[this.s.length-1]=S}else{return this.s[this.s.length-1]}}return this.variable(R,S)},jeq:function(){var R=1,S;while(R<arguments.length){if(arguments[R++]==arguments[0]){S=1}}return S},jin:function(S,R){return this.m.getUint16(this.objects+14*(S-1)+6)==R},log_shift:function(S,R){return R>0?S<<R:S>>>-R},print:function(R){this.ui.print(R)},read:function(V,U,T,R,S){if(arguments.length==3){S=T;T=R=0}this.act("read",{text:V,parse:U,len:this.m.getUint8(V),initiallen:this.m.getUint8(V+1),time:T,routine:R,storer:S})},restore_undo:function(){if(this.undo.length==0){return 0}var R=this.undo.pop();this.pc=R[0];this.m.setBuffer(0,R[2],1);this.l=R[3];this.s=R[4];this.call_stack=R[5];this.variable(R[1],2);return 1},ret:function(R){var T=this.call_stack.shift(),S=T[1];this.pc=T[0];this.l=this.l.slice(T[2]);this.s.length=T[3];if(S>=0){this.variable(S,R)}},save_undo:function(S,R){this.undo.push([S,R,this.m.getBuffer(0,this.staticmem),this.l.slice(),this.s.slice(),this.call_stack.slice()]);return 1},test:function(S,R){return S&R==R},test_attr:function(R,S){return(this.m.getUint8(this.objects+14*(R-1)+parseInt(S/8))<<(S%8))&128},variable:function(S,T){var R=T!==m;if(S==0){if(R){this.s.push(T)}else{return this.s.pop()}}else{if(S<16){if(R){this.l[S-1]=T}else{return this.l[S-1]}}else{if(R){this.m.setUint16(this.globals+(S-16)*2,T)}else{this.m.getUint16(this.globals+(S-16)*2)}}}},U2S:N,S2U:f};var w={init:function(){this.jit={}},load:function(R){this.data=R},restart:function(){var T=J(this.data),R=T.getUint8(0),S=T.getUint16(10);k(this,{m:T,s:[],l:[],call_stack:[],undo:[],orders:[],version:R,pc:T.getUint16(6),property_defaults:S,objects:S+126,globals:T.getUint16(12),staticmem:T.getUint16(14),packing_multipler:R==5?4:8});k(this,{ui:new v(this),text:new t(this)});T.setUint8(1,29);T.setUint8(16,T.getUint8(16)&87);T.setUint8(50,1);T.setUint8(51,K?2:0)},run:function(){var S=Date.now(),R;this.orders=[];this.stop=0;while(!this.stop){R=this.pc;if(!this.jit[R]){this.compile()}this.jit[R](this);if((Date.now()-S)>5000){this.act("tick");return}}},compile:function(){var R=e(this),S=R.write();this.jit[R.pc]=new Function("e",S);if(R.pc<this.staticmem){console.warn("Caching a JIT function in dynamic memory: "+R.pc)}},act:function(S,R){var R=R||{};this.ui.set_style(16);R.code=S;this.orders.push(R);this.stop=1},event:function(S){var T=this.m,R;if(S.code=="read"){this.variable(S.storer,S.terminator);R=S.response;if(R.length>S.len){R=R.slice(0,S.len)}T.setUint8(S.text+1,R.length);T.setBuffer(S.text+2,this.text.text_to_zscii(R));if(S.parse){this.text.tokenise(R,S.parse)}this.print(R+"\n")}}};F.ZVM=Object.subClass(k(w,q))})(this);
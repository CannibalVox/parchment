/*

ZVM - the ifvms.js implementation of the Z-Machine
==================================================

Built: 2011-11-27

Copyright (c) 2011 The ifvms.js team
BSD licenced
http://github.com/curiousdannii/ifvms.js

*/
(function(A,j){if(![].indexOf){Array.prototype.indexOf=function(N,M){for(var L=M||0,K=this.length;L<K;L++){if(this[L]==N){return L}}return -1}}var i=function(K,M){for(var L in M){K[L]=M[L]}return K},q=A.console||{log:function(){},info:function(){},warn:function(){}},G=function(K){return((K&32768)?~65535:0)|K},d=function(K){return K&65535},r=function(N){var M=0,L=N.length,K=[];while(M<L){K[M/2]=N[M++]<<8|N[M++]}return K};var b=0,E=b?function(L){var K=new ArrayBuffer(L),L=new DataView(K);L.buffer=K;return L}:function(K){K=K.slice();return i(K,{data:K,getUint8:function(L){return K[L]},getUint16:function(L){return K[L]<<8|K[L+1]},getBuffer:function(M,L){return K.slice(M,M+L)},getBuffer16:function(M,L){return r(K.slice(M,M+L*2))},setUint8:function(L,M){return K[L]=M&255},setUint16:function(L,M){K[L]=(M>>8)&255;K[L+1]=M&255;return M&65535},setBuffer:function(N,M){var O=0,L=M.length;while(O<L){K[O+N]=M[O++]}}})};var I=Object.subClass({init:function(K,L){this.e=K;this.v=L},toString:function(){return this.v},U2S:function(){return G(this.v)}}),g=I.subClass({toString:function(){var K=this.v;if(this.indirect){return"e.indirect("+K+")"}if(K==0){return"s.pop()"}if(--K<15){return"l["+K+"]"}return"m.getUint16("+(this.e.globals+(K-15)*2)+")"},store:function(L){var K=this.v;if(this.indirect){return"e.indirect("+K+","+L+")"}if(this.returnval){return"e.variable("+K+","+L+")"}if(K==0){return"s.push("+L+")"}if(--K<15){return"l["+K+"]="+L}return"m.setUint16("+(this.e.globals+(K-15)*2)+","+L+")"},U2S:function(){return"e.U2S("+this+")"}}),f=Object.subClass({init:function(O,M,P,L,N,K){this.e=O;this.context=M;this.code=P;this.pc=L;this.labels=[this.pc+"/"+this.code];this.next=N;this.operands=K;if(this.post){this.post()}},toString:function(){return this.label()+(this.func?this.func.apply(this,this.operands):"")},args:function(K){return this.operands.join(K)},label:function(){return"/* "+this.labels.join()+" */ "}}),s=f.subClass({stopper:1}),l=s.subClass({storer:1,post:function(){this.storer=this.operands.pop();this.origfunc=this.func;this.func=this.newfunc},newfunc:function(){return"e.pc="+this.next+";"+this.origfunc.apply(this,arguments)}}),C=Object.subClass({init:function(K,L){this.ops=K||[];this.code=L||"||"},toString:function(){var K=0,L=[],M;while(K<this.ops.length){M=this.ops[K++];L.push(M.func?(M.iftrue?"":"!(")+M.func.apply(M,M.operands)+(M.iftrue?"":")"):M)}return(this.invert?"(!(":"(")+L.join(this.code)+(this.invert?"))":")")}}),D=f.subClass({brancher:1,keyword:"if",post:function(){var K,M,L=this.operands.pop(),N=L[1];this.iftrue=L[0];if(N==0||N==1){K="e.ret("+N+")"}else{N+=this.next-2;this.context.targets.push(N);K="e.pc="+N}this.result=K+"; return";this.offset=N;this.cond=new C([this]);if(this.context.ops.length){M=this.context.ops.pop();if(M.offset==N){this.cond.ops.unshift(M.cond);this.labels=M.labels;this.labels.push(this.pc+"/"+this.code)}else{this.context.ops.push(M)}}},toString:function(){var L=0,K=this.result;if(K instanceof F){K=K+(K.stopper?"; return":"");if(this.result.ops.length>1){K="\n"+K+"\n"}}return this.label()+this.keyword+this.cond+" {"+K+"}"}}),y=D.subClass({storer:1,post:function(){this._super();this.storer=this.operands.pop();this.storer.returnval=1;this.origfunc=this.func;this.func=this.newfunc},newfunc:function(){return this.storer.store(this.origfunc.apply(this,arguments))}}),m=f.subClass({storer:1,post:function(){this.storer=this.operands.pop()},toString:function(){var K=this._super();return this.storer?this.storer.store(K):K}}),x=s.subClass({result:{v:-1},toString:function(){return this.label()+"e.call("+this.operands.shift()+","+this.result.v+","+this.next+",["+this.args()+"])"}}),n=x.subClass({storer:1,post:function(){this.result=this.operands.pop()}}),F=Object.subClass({init:function(L,K){this.e=L;this.pc=K;this.pre=[];this.ops=[];this.post=[];this.targets=[]},toString:function(){return this.pre.join("")+this.ops.join(";")+this.post.join("")}}),z=F.subClass({toString:function(){this.pre.unshift("var l=e.l,m=e.m,s=e.s;\n");return this._super()}}),J=function(L,M,K){var K=K||{};if(M){K.func=M}return L.subClass(K)};var w=IFF.subClass({init:function(L){this._super(L);if(L){if(this.type!="IFZS"){throw new Error("Not a Quetzal savefile")}for(var M=0,K=this.chunks.length;M<K;M++){var N=this.chunks[M].type,O=this.chunks[M].data;if(N=="CMem"||N=="UMem"){this.memory=O;this.compressed=(N=="CMem")}else{if(N=="Stks"){this.stacks=O}else{if(N=="IFhd"){this.release=O.slice(0,2);this.serial=O.slice(2,8);this.checksum=O.slice(8,10);this.pc=O[10]<<16|O[11]<<8|O[12]}}}}}},write:function(){this.type="IFZS";var L=this.pc,K=this.release.concat(this.serial,this.checksum,(L>>16)&255,(L>>8)&255,L&255);this.chunks=[{type:"IFhd",data:K},{type:(this.compressed?"CMem":"UMem"),data:this.memory},{type:"Stks",data:this.stacks}];return this._super()}});var H=(function(){var L={8:8,13:13,27:27,37:131,38:129,39:132,40:130},K=96;while(K<106){L[K]=49+K++}K=112;while(K<124){L[K]=21+K++}return L})(),o=Object.subClass({init:function(S){var P=S.m,M=P.getUint16(52),O=S.extension_table(3),K=O&&P.getUint8(O++),Q,L=[],R=0,N=96;this.e=S;this.maxaddr=P.getUint16(26)*S.addr_multipler;this.make_alphabet(M?P.getBuffer(M,78):this.text_to_zscii("abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ \r0123456789.,!?_#'\"/\\-:()"));this.make_unicode(O?P.getBuffer16(O,K):this.text_to_zscii(unescape("%E4%F6%FC%C4%D6%DC%DF%BB%AB%EB%EF%FF%CB%CF%E1%E9%ED%F3%FA%FD%C1%C9%CD%D3%DA%DD%E0%E8%EC%F2%F9%C0%C8%CC%D2%D9%E2%EA%EE%F4%FB%C2%CA%CE%D4%DB%E5%C5%F8%D8%E3%F1%F5%C3%D1%D5%E6%C6%E7%C7%FE%F0%DE%D0%A3%u0153%u0152%A1%BF"),1));Q=P.getUint16(24);if(Q){while(R<N){L.push(this.decode(P.getUint16(Q+2*R++)*2,0,1))}}this.abbr=L;this.dictionaries={};this.dict=P.getUint16(8);this.parse_dict(this.dict)},make_alphabet:function(L){var M=[[],[],[]],K=0;while(K<78){M[parseInt(K/26)][K%26]=L[K++]}this.alphabets=M},make_unicode:function(N){var M={},K={10:13},L=0;while(L<N.length){M[L+155]=N[L];K[N[L]]=155+L++}this.reverse_unicode_table=K;this.unicode_callback=function(O){return String.fromCharCode(M[O.charCodeAt(0)]||63)}},decode:function(R,L,U){var O=this.e.m,S=R,K,N=[],P=0,Q,M=0,T=[];if(this.e.jit[R]){return this.e.jit[R]}L=L?L+R:this.maxaddr;while(R<L){K=O.getUint16(R);R+=2;N.push(K>>10&31,K>>5&31,K&31);if(K&32768){break}}while(P<N.length){Q=N[P++];if(Q==0){T.push(32)}else{if(Q<4){T=T.concat(this.abbr[32*(Q-1)+N[P++]])}else{if(Q<6){M=Q}else{if(M==2&&Q==6){if(P+1<N.length){T.push(N[P++]<<5|N[P++])}}else{T.push(this.alphabets[M][Q-6])}}}}M=M<4?0:M-3}if(!U){T=new String(this.zscii_to_text(T));T.pc=R;this.e.jit[S]=T;if(S<this.e.staticmem){q.warn("Caching a string in dynamic memory: "+S)}}return T},encode:function(P){var Q=this.alphabets,O=[],N=0,M,L,K=[];while(O.length<9){M=P[N++];if(M==32){O.push(0)}else{if((L=Q[0].indexOf(M))>=0){O.push(L+6)}else{if((L=Q[1].indexOf(M))>=0){O.push(4,L+6)}else{if((L=Q[2].indexOf(M))>=0){O.push(5,L+6)}else{if(M>32&&M<127){O.push(5,6,M>>5,M&31)}else{if(L=this.reverse_unicode_table[M]){O.push(5,6,L>>5,L&31)}else{if(M==j){O.push(5)}}}}}}}}O.length=9;N=0;while(N<9){K.push(O[N++]<<2|O[N]>>3,(O[N++]&7)<<5|O[N++])}K[4]|=128;return K},zscii_to_text:function(K){return String.fromCharCode.apply(this,K).replace(/[\x00-\x0C\x0E-\x1F\x7F-\x9A\xFC-\uFFFF]/g,"").replace(/\r/g,"\n").replace(/[\x9B-\xFB]/g,this.unicode_callback)},text_to_zscii:function(O,N){var P=[],L=0,K=O.length,M;N=!N;while(L<K){M=O.charCodeAt(L++);if(N&&M!=13&&(M<32||M>126)){M=this.reverse_unicode_table[M]||63}P.push(M)}return P},parse_dict:function(R){var Q=this.e.m,K=R,P={},O,N,M,L,O=Q.getUint8(R++);P.separators=Q.getBuffer(R,O);R+=O;N=Q.getUint8(R++);M=R+2+N*Q.getUint16(R);R+=2;while(R<M){P[""+Q.getBuffer(R,6)]=R;R+=N}this.dictionaries[K]=P;return P},tokenise:function(X,O,W,U){W=W||this.dict;W=this.dictionaries[W]||this.parse_dict(W);var P=this.e.m,Q=X+2,S=Q+P.getUint8(X+1),M,N=W.separators,K=[],V=[],L=Q,R,T=0;while(Q<S){M=P.getUint8(Q);if(M==32||N.indexOf(M)>=0){if(K.length){V.push([K,L]);K=[];L=Q+1}if(M!=32){V.push([M,Q])}}else{K.push(M)}Q++}if(K.length){V.push([K,L])}R=Math.min(V.length,P.getUint8(O));while(T<R){K=this.encode(V[T][0]);if(!U||W[K]){P.setUint16(O+2+T*4,W[K]||0);P.setUint8(O+4+T*4,V[T][0].length);P.setUint8(O+5+T*4,V[T][1])}T++}P.setUint8(O+1,T)},keyinput:function(L){var K=L.charCode,M=L.keyCode;if(H[M]){return H[M]}if(K>31&&K<127){return K}return this.reverse_unicode_table[K]||63}});var h=(function(M){var N=function(O,Q){for(var P in Q){if(Q[P]!=M){O[P]=Q[P]}}return O},L=[65534,65535,0,29,832,957,22944,31775,30624,32767,23254,17969,11627],K=function(O){var P=Math.round((O&31)*8.226)<<16|Math.round(((O&992)>>5)*8.226)<<8|Math.round(((O&31744)>>10)*8.226);P=P.toString(16);while(P.length<6){P="0"+P}return"#"+P};return Object.subClass({init:function(O,P){this.e=O;this.buffer="";this.styles={};this.mono=P;this.currentwin=0;this.status=[];O.orders.push({code:"stream",name:"status"},{code:"stream",name:"main"},{code:"find",name:"main"})},clear_window:function(){this.e.orders.push({code:"clear",name:"main",css:N({},this.styles)})},erase_line:function(O){if(O==1){this.flush();this.status.push({code:"eraseline"})}},erase_window:function(O){this.flush();if(O<1){this.clear_window()}if(O==-1){this.split_window(0)}if(O==-2||O==1){this.status.push({code:"clear"})}},flush:function(){var O;if(this.buffer!=""){O={code:"stream",css:N({},this.styles),text:this.buffer};if(this.mono){O.node="tt"}(this.currentwin?this.status:this.e.orders).push(O);this.buffer=""}},get_cursor:function(O){this.status.push({code:"get_cursor",addr:O});this.e.act()},set_colour:function(P,O){this.set_true_colour(L[P],L[O])},set_cursor:function(P,O){this.flush();this.status.push({code:"cursor",to:[P-1,O-1]})},set_font:function(O){if(O!=1&&O!=4){return 0}var P=this.mono&4?4:1;if(O!=P){this.flush();this.mono^=4}return P},set_style:function(O){var P=this.styles;this.flush();if(O==0){P.reverse=P["font-weight"]=P["font-style"]=M;this.mono&=254}if(O&1){P.reverse=1}if(O&2){P["font-weight"]="bold"}if(O&4){P["font-style"]="italic"}if(O&8){this.mono|=1}},set_true_colour:function(R,P){var Q=this.styles,S=Q.color,O=Q["background-color"];this.flush();if(R==65535){S=M}else{if(R<32768){S=K(R)}}if(P==65535){O=M}else{if(P<32768){O=K(P)}}Q.color=S;Q["background-color"]=O},set_window:function(O){this.flush();this.currentwin=O;this.e.orders.push({code:"find",name:O?"status":"main"});if(O){this.status.push({code:"cursor",to:[0,0]})}},split_window:function(O){this.flush();this.status.push({code:"height",lines:O})}})})();var a=function(K){return""+K},k=J(D,function(){return 1}),p=m.subClass({storer:0,post:function(){var K=this.operands,M=K[0],L=M instanceof g;K[0]=new g(this.e,L?M:M.v);if(L||M.v==0){K[0].indirect=1}this.storer=this.code==142?K.pop():K.shift();if(K.length==0){K.push(new g(this.e,0))}},func:a}),v=f.subClass({func:function(L){var M=L.v-1,K=this.code%2?1:-1;if(L instanceof g||M>14){return"e.incdec("+L+","+K+")"}return(M<0?"e.s[e.s.length-1]=e.S2U(e.s[e.s.length-1]+":("e.l["+M+"]=e.S2U(e.l["+M+"]+"))+K+")"}}),B={1:J(D,function(){return arguments.length==2?this.args("=="):"e.jeq("+this.args()+")"}),2:J(D,function(L,K){return L.U2S()+"<"+K.U2S()}),3:J(D,function(L,K){return L.U2S()+">"+K.U2S()}),4:J(D,function(K,L){return"e.U2S(e.incdec("+K+",-1))<"+L.U2S()}),5:J(D,function(K,L){return"e.U2S(e.incdec("+K+",1))>"+L.U2S()}),6:J(D,function(){return"e.jin("+this.args()+")"}),7:J(D,function(){return"e.test("+this.args()+")"}),8:J(m,function(){return this.args("|")}),9:J(m,function(){return this.args("&")}),10:J(D,function(){return"e.test_attr("+this.args()+")"}),11:J(f,function(){return"e.set_attr("+this.args()+")"}),12:J(f,function(){return"e.clear_attr("+this.args()+")"}),13:p,14:J(f,function(){return"e.insert_obj("+this.args()+")"}),15:J(m,function(L,K){return"m.getUint16(e.S2U("+L+"+2*"+K.U2S()+"))"}),16:J(m,function(L,K){return"m.getUint8(e.S2U("+L+"+"+K.U2S()+"))"}),17:J(m,function(){return"e.get_prop("+this.args()+")"}),18:J(m,function(){return"e.find_prop("+this.args()+")"}),19:J(m,function(){return"e.find_prop("+this.args(",0,")+")"}),20:J(m,function(){return"e.S2U("+this.args("+")+")"}),21:J(m,function(){return"e.S2U("+this.args("-")+")"}),22:J(m,function(){return"e.S2U("+this.args("*")+")"}),23:J(m,function(L,K){return"e.S2U(parseInt("+L.U2S()+"/"+K.U2S()+"))"}),24:J(m,function(L,K){return"e.S2U("+L.U2S()+"%"+K.U2S()+")"}),25:n,26:x,27:J(f,function(){return"e.ui.set_colour("+this.args()+")"}),28:J(s,function(L,K){return"while(e.call_stack.length>"+K+"){e.call_stack.shift()}e.ret("+L+")"}),128:J(D,function(K){return K+"==0"}),129:J(y,function(K){return"e.get_sibling("+K+")"}),130:J(y,function(K){return"e.get_child("+K+")"}),131:J(m,function(K){return"e.get_parent("+K+")"}),132:J(m,function(K){return"e.get_prop_len("+K+")"}),133:v,134:v,135:J(f,function(K){return"e.print(e.text.decode("+K+"))"}),136:n,137:J(f,function(K){return"e.remove_obj("+K+")"}),138:J(f,function(K){return"e.print_obj("+K+")"}),139:J(s,function(K){return"e.ret("+K+")"}),140:J(s,function(K){return"e.pc="+K.U2S()+"+"+(this.next-2)}),141:J(f,function(K){return"e.print(e.text.decode("+K+"*"+this.e.addr_multipler+"))"}),142:p.subClass({storer:1}),143:x,176:J(s,function(){return"e.ret(1)"}),177:J(s,function(){return"e.ret(0)"}),178:J(f,function(K){return'e.print("'+K+'")'},{printer:1}),179:J(s,function(K){return'e.print("'+K+'\\n");e.ret(1)'},{printer:1}),180:f,183:J(s,function(){return'e.act("restart")'}),184:J(s,function(K){return"e.ret("+K+")"},{post:function(){this.operands.push(new g(this.e,0))}}),185:J(m,function(){return"e.call_stack.length"}),186:J(s,function(){return'e.act("quit")'}),187:J(f,function(){return'e.print("\\n")'}),189:k,191:k,224:n,225:J(f,function(M,K,L){return"m.setUint16(e.S2U("+M+"+2*"+K.U2S()+"),"+L+")"}),226:J(f,function(M,K,L){return"m.setUint8(e.S2U("+M+"+"+K.U2S()+"),"+L+")"}),227:J(f,function(){return"e.put_prop("+this.args()+")"}),228:J(l,function(){return"e.read("+this.args()+","+this.storer.v+")"}),229:J(f,function(K){return"e.print(e.text.zscii_to_text(["+K+"]))"}),230:J(f,function(K){return"e.print("+K.U2S()+")"}),231:J(m,function(K){return"e.random("+K.U2S()+")"}),232:J(m,a,{post:function(){this.storer=new g(this.e,0)},storer:0}),233:p,234:J(f,function(K){return"e.ui.split_window("+K+")"}),235:J(f,function(K){return"e.ui.set_window("+K+")"}),236:n,237:J(f,function(K){return"e.ui.erase_window("+K.U2S()+")"}),238:J(f,function(K){return"e.ui.erase_line("+K+")"}),239:J(f,function(){return"e.ui.set_cursor("+this.args()+")"}),240:J(l,function(K){return"e.ui.get_cursor("+K+")"}),241:J(f,function(K){return"e.ui.set_style("+K+")"}),242:f,243:J(f,function(){return"e.output_stream("+this.args()+")"}),244:f,245:f,246:J(l,function(){return"e.read_char("+this.args()+","+this.storer.v+")"}),247:J(y,function(){return"e.scan_table("+this.args()+")"}),248:J(m,function(K){return"e.S2U(~"+K+")"}),249:x,250:x,251:J(f,function(){return"e.text.tokenise("+this.args()+")"}),252:J(f,function(){return"e.encode_text("+this.args()+")"}),253:J(f,function(){return"e.copy_table("+this.args()+")"}),254:J(f,function(){return"e.print_table("+this.args()+")"}),255:J(D,function(K){return K+"<=e.call_stack[0][4]"}),1000:J(l,function(){return"e.save("+(this.next-1)+","+this.storer.v+")"}),1001:J(l,function(){return'e.act("restore",{storer:'+this.storer.v+"})"}),1002:J(m,function(L,K){return"e.S2U(e.log_shift("+L+","+K.U2S()+"))"}),1003:J(m,function(L,K){return"e.S2U(e.art_shift("+L.U2S()+","+K.U2S()+"))"}),1004:J(m,function(K){return"e.ui.set_font("+K+")"}),1009:J(m,function(){return"e.save_undo("+this.next+","+this.storer.v+")"}),1010:J(f,function(){return"if(e.restore_undo())return"},{storer:1}),1011:J(f,function(K){return"e.print(String.fromCharCode("+K+"))"}),1012:J(m,function(){return 3})};var t=function(O,M){var N=0,K,R,L,Q,P;while(N<O.ops.length-1){if(O.ops[N].offset==M){if(O.ops.length-N==2&&O.ops[N+1].offset){Q=O.ops.pop();P=O.ops.pop();P.cond.invert=!P.cond.invert;Q.cond=new C([P.cond,Q.cond],"&&");Q.labels=P.labels.concat(Q.labels);O.ops.push(Q);return 1}K=new F(O.e,O.ops[N+1].pc);K.ops=O.ops.slice(N+1);R=K.ops.length-1;O.ops.length=N+1;L=O.ops[N];L.result=K;L.cond.invert=!L.cond.invert;Q=K.ops[R];if(Q.code==140&&(G(Q.operands[0].v)+Q.next-2)==L.pc){L.keyword="while";K.ops.pop()}else{K.stopper=Q.stopper}return 1}N++}},u=function(K){};var c=function(P){var Q,M,N=P.m,S,L,R,T,O,K=new z(P,P.pc);while(1){M=Q=P.pc;L=N.getUint8(Q++);if(L==190){T=-1;L=N.getUint8(Q++)+1000}else{if(L&128){if(L&64){T=-1;if(!(L&32)){L&=31}}else{T=[(L&48)>>4];if(T[0]<3){L&=207}}}else{T=[L&64?2:1,L&32?2:1];L&=31}}if(!B[L]){P.stop=1;throw new Error("Unknown opcode #"+L+" at pc="+M)}R=B[L].prototype;if(T==-1){T=[];e(N.getUint8(Q++),T);if(L==236||L==250){e(N.getUint8(Q++),T)}}O=[];S=0;while(S<T.length){if(T[S]==0){O.push(new I(P,N.getUint16(Q)));Q+=2}if(T[S]==1){O.push(new I(P,N.getUint8(Q++)))}if(T[S++]==2){O.push(new g(P,N.getUint8(Q++)))}}if(R.storer){O.push(new g(P,N.getUint8(Q++)))}if(R.brancher){S=N.getUint8(Q++);O.push([S&128,S&64?S&63:((S=(S<<8)|N.getUint8(Q++))&8192?~8191:0)|(S&8191)])}if(R.printer){S=P.text.decode(Q);O.push(S.replace(/\n/g,"\\n").replace(/"/g,'\\"'));Q=S.pc}P.pc=Q;K.ops.push(new B[L](P,K,L,M,Q,O));S=0;if(K.targets.indexOf(Q)>=0){S=t(K,Q)}if(R.stopper&&!S){break}}return K},e=function(L,M){for(var K=0;K<4;K++){M.push((L&192)>>6);L<<=2}};A.ZVM=Object.subClass({art_shift:function(L,K){return K>0?L<<K:L>>-K},call:function(R,K,O,M){var N,L,Q=this.l.length,P=M.length;this.pc=R*this.addr_multipler;L=this.m.getUint8(this.pc++);M=M.slice(0,L);for(N=M.length;N<L;N++){M.push(0)}this.l=M.concat(this.l);this.call_stack.unshift([O,K,L,this.s.length,P,Q])},clear_attr:function(K,L){var M=this.objects+14*K+parseInt(L/8);this.m.setUint8(M,this.m.getUint8(M)&~(128>>L%8))},copy_table:function(O,L,N){N=G(N);var Q=this.m,M=0,P=N<0,K;N=Math.abs(N);if(L==0){while(M<N){Q.setUint8(O+M++,0)}return}if(P){while(M<N){Q.setUint8(L+M,Q.getUint8(O+M++))}}else{K=Q.getBuffer(O,N);Q.setBuffer(L,K);Q.setBuffer(O,K)}},encode_text:function(L,K,N,M){this.m.setBuffer(M,this.text.encode(this.m.getBuffer(L+N,K)))},extension_table:function(L,K){var M=this.extension;if(!M||L>this.extension_count){return 0}M+=2*L;if(K==j){return this.m.getUint16(M)}this.e.setUint16(M,K)},find_prop:function(K,O,N){var R=this.m,Q,P,M=0,L=R.getUint16(this.objects+14*K+12);L+=R.getUint8(L)*2+1;Q=R.getUint8(L);P=Q&63;while(1){if(M==N){return P}if(P==O){return L+(Q&128?2:1)}if(P<O){return 0}M=P;if(Q&128){P=R.getUint8(L+1)&63;L+=P?P+2:66}else{L+=Q&64?3:2}Q=R.getUint8(L);P=Q&63}},get_child:function(K){return this.m.getUint16(this.objects+14*K+10)},get_sibling:function(K){return this.m.getUint16(this.objects+14*K+8)},get_parent:function(K){return this.m.getUint16(this.objects+14*K+6)},get_prop:function(K,L){var N=this.m,M=this.find_prop(K,L);if(M){return(N.getUint8(M-1)&64?N.getUint16:N.getUint8)(M)}return N.getUint16(this.properties+2*(L-1))},get_prop_len:function(L){if(L==0){return 0}var K=this.m.getUint8(L-1);if(K&128){K&=63;return K==0?64:K}return K&64?2:1},incdec:function(L,N){var K,M;if(L==0){K=d(this.s.pop()+N);this.s.push(K);return K}if(L<16){return this.l[L-1]=d(this.l[L-1]+N)}else{M=this.globals+(L-16)*2;return this.m.setUint16(M,this.m.getUint16(M)+N)}},indirect:function(K,L){if(K==0){if(arguments.length>1){return this.s[this.s.length-1]=L}else{return this.s[this.s.length-1]}}return this.variable(K,L)},insert_obj:function(L,K){this.remove_obj(L);this.set_family(L,K,K,L,L,this.get_child(K))},jeq:function(){var K=1,L;while(K<arguments.length){if(arguments[K++]==arguments[0]){L=1}}return L},jin:function(L,K){return this.get_parent(L)==K},log_shift:function(L,K){return K>0?L<<K:L>>>-K},output_stream:function(M,N){M=G(M);if(M==1){this.streams[0]=1}if(M==-1){this.streams[0]=0}if(M==3){this.streams[2].unshift([N,""])}if(M==-3){var K=this.streams[2].shift(),L=this.text.text_to_zscii(K[1]);this.m.setUint16(K[0],L.length);this.m.setBuffer(K[0]+2,L)}},print:function(L){if(this.streams[2].length){this.streams[2][0][1]+=L}else{if(this.streams[0]){var K=this.m.getUint8(17)&2;if(K!=(this.ui.mono&2)){if(!(this.ui.mono&253)){this.ui.flush()}this.ui.mono^=2}this.ui.buffer+=L}}},print_obj:function(L){var K=this.m.getUint16(this.objects+14*L+12);this.print(this.text.decode(K+1,this.m.getUint8(K)*2))},print_table:function(O,M,K,N){K=K||1;N=N||0;var L=0;while(L<K){this.print("\n"+this.text.zscii_to_text(this.m.getBuffer(O,M)));O+=M+N;L++}},put_prop:function(K,M,L){var O=this.m,N=this.find_prop(K,M);(O.getUint8(N-1)&64?O.setUint16:O.setUint8)(N,L)},random:function(K){var L;if(K<1){this.random_state=Math.abs(K);this.random_seq=0;return 0}if(this.random_state==0){return parseInt(Math.random()*K)+1}else{this.random_seq++;if(this.random_seq>this.random_state){this.random_seq=1}return this.random_seq%K}},read:function(O,N,M,K,L){if(arguments.length==3){L=M;M=K=0}this.act("read",{buffer:O,parse:N,len:this.m.getUint8(O),initiallen:this.m.getUint8(O+1),time:M,routine:K,storer:L})},read_char:function(M,N,K,L){if(arguments.length==2){L=N;N=K=0}this.act("char",{time:N,routine:K,storer:L})},remove_obj:function(O){var N=this.get_parent(O),L,M,K;if(N==0){return}L=this.get_child(N);M=this.get_sibling(O);if(L==O){this.set_family(O,0,N,M)}else{while(1){K=this.get_sibling(L);if(K==O){break}L=K}this.set_family(O,0,0,0,L,M)}},restore:function(P){var M=new w(P),N=M.memory,R=M.stacks,T=M.pc,U=this.m.getUint8(17),V,Q=0,O=0,S=[],L=[],K;this.m.setBuffer(0,this.data.slice(0,this.staticmem));if(M.compressed){while(Q<N.length){V=N[Q++];if(V==0){O+=1+N[Q++]}else{this.m.setUint8(O,V^this.data[O++])}}}else{this.m.setBuffer(0,N)}this.m.setUint8(17,U);Q=6;V=R[Q++]<<8|R[Q++];K=r(R.slice(Q,V));while(Q<R.length){S.unshift([R[Q++]<<16|R[Q++]<<8|R[Q++],0,0,K.length,0,L.length]);S[0][1]=R[Q]&16?-1:R[Q+1];S[0][2]=R[Q]&15;Q+=2;V=R[Q++];while(V){S[0][4]++;V>>=1}V=R[Q++]<<8|R[Q++];L=r(R.slice(Q,Q+S[0][2])).concat(L);Q+=S[0][2]*2;K=K.concat(r(R.slice(Q,V)))}this.call_stack=S;this.l=L;this.s=K;this.update_header();this.variable(this.m.getUint8(T++),2);this.pc=T},restore_undo:function(){if(this.undo.length==0){return 0}var K=this.undo.pop();this.pc=K[0];K[2][17]=this.m.getUint8(17);this.m.setBuffer(0,K[2]);this.l=K[3];this.s=K[4];this.call_stack=K[5];this.variable(K[1],2);return 1},ret:function(K){var M=this.call_stack.shift(),L=M[1];this.pc=M[0];this.l=this.l.slice(this.l.length-M[5]);this.s.length=M[3];if(L>=0){this.variable(L,K)}},save:function(V,Y){var R=this.m,W=this.s,M=this.l,O=new w(),Q=[],S,P,T,X=0,U=this.call_stack.reverse(),L,N,K=[0,0,0,0,0,0];O.release=R.getBuffer(2,2);O.serial=R.getBuffer(18,6);O.checksum=R.getBuffer(28,2);O.pc=V;O.compressed=1;for(S=0;S<this.staticmem;S++){T=R.getUint8(S)^this.data[S];if(T==0){if(++X==256){Q.push(0,255);X=0}}else{if(X){Q.push(0,X-1);X=0}Q.push(T)}}O.memory=Q;K.push(U[0][3]>>8,U[0][3]&255);for(P=0;P<U[0][3];P++){K.push(W[P]>>8,W[P]&255)}for(S=0;S<U.length;S++){L=U[S];N=(U[S+1]?U[S+1][3]:W.length)-L[3];K.push(L[0]>>16,L[0]>>8&255,L[0]&255,L[2]|(L[1]<0?16:0),L[1]<0?0:L[1],(1<<L[4])-1,N>>8,N&255);for(P=M.length-L[5]-L[2];P<M.length-L[5];P++){K.push(M[P]>>8,M[P]&255)}for(P=L[3];P<L[3]+N;P++){K.push(W[P]>>8,W[P]&255)}}U.reverse();O.stacks=K;this.act("save",{data:O.write(),storer:Y})},save_undo:function(L,K){this.undo.push([L,K,this.m.getBuffer(0,this.staticmem),this.l.slice(),this.s.slice(),this.call_stack.slice()]);return 1},scan_table:function(K,O,M,L){L=L||130;var N=L&128?this.m.getUint16:this.m.getUint8;L&=127;M=O+M*L;while(O<M){if(N(O)==K){return O}O+=L}return 0},set_attr:function(K,L){var M=this.objects+14*K+parseInt(L/8);this.m.setUint8(M,this.m.getUint8(M)|128>>L%8)},set_family:function(M,N,L,P,K,O){this.m.setUint16(this.objects+14*M+6,N);if(L){this.m.setUint16(this.objects+14*L+10,P)}if(K){this.m.setUint16(this.objects+14*K+8,O)}},test:function(L,K){return L&K==K},test_attr:function(K,L){return(this.m.getUint8(this.objects+14*K+parseInt(L/8))<<L%8)&128},variable:function(L,M){var K=M!==j;if(L==0){if(K){this.s.push(M)}else{return this.s.pop()}}else{if(L<16){if(K){this.l[L-1]=M}else{return this.l[L-1]}}else{if(K){this.m.setUint16(this.globals+(L-16)*2,M)}else{this.m.getUint16(this.globals+(L-16)*2)}}}return M},U2S:G,S2U:d,init:function(){this.jit={};this.env={width:80}},inputEvent:function(M){var N=this.m,L=M.code,K;if(M.env){i(this.env,M.env);if(!L){return}}this.orders=[];if(L=="load"){this.data=M.data;return}if(L=="restart"){this.restart()}if(L=="save"){this.variable(M.storer,M.result||1)}if(L=="restore"){if(!this.m){this.restart()}if(M.data){this.restore(M.data)}else{this.variable(M.storer,0)}}if(L=="read"){this.variable(M.storer,M.terminator);K=M.response;this.print(K+"\n");K=this.text.text_to_zscii(K.toLowerCase());if(K.length>M.len){K=K.slice(0,M.len)}N.setUint8(M.buffer+1,K.length);N.setBuffer(M.buffer+2,K);if(M.parse){this.text.tokenise(M.buffer,M.parse)}}if(L=="char"){this.variable(M.storer,this.text.keyinput(M.response))}if(L=="get_cursor"){N.setUint16(M.addr,M.pos[0]+1);N.setUint16(M.addr+2,M.pos[1]+1)}this.run()},restart:function(){var N=E(this.data),K=N.getUint8(0),L=N.getUint16(10),M=N.getUint16(54);if(K!=5&&K!=8){throw new Error("Unsupported Z-Machine version: "+K)}if(this.m){N.setUint8(17,this.m.getUint8(17))}i(this,{m:N,s:[],l:[],call_stack:[],undo:[],orders:[],streams:[1,0,[],0],version:K,pc:N.getUint16(6),properties:L,objects:L+112,globals:N.getUint16(12),staticmem:N.getUint16(14),extension:M,extension_count:M?N.getUint16(M):0,addr_multipler:K==5?4:8});i(this,{ui:new h(this,N.getUint8(17)&2),text:new o(this)});this.update_header()},update_header:function(){var K=this.m;this.random_state=0;K.setUint8(1,29|(this.env.timed?128:0));K.setUint8(17,K.getUint8(17)&87);K.setUint8(32,255);K.setUint8(33,this.env.width);K.setUint16(34,this.env.width);K.setUint16(36,255);K.setUint16(38,257);K.setUint8(50,1);K.setUint8(51,this.env.PARCHMENT_SECURITY_OVERRIDE?2:0);this.extension_table(4,0)},run:function(){var L=Date.now(),K;this.stop=0;while(!this.stop){K=this.pc;if(!this.jit[K]){this.compile()}this.jit[K](this);if((Date.now()-L)>5000){this.act("tick");return}}},compile:function(){var K=c(this);this.jit[K.pc]=new Function("e",""+K);if(K.pc<this.staticmem){q.warn("Caching a JIT function in dynamic memory: "+K.pc)}},act:function(L,K){var K=K||{};this.ui.flush();if(this.ui.status.length){this.orders.push({code:"stream",to:"status",data:this.ui.status});this.ui.status=[]}K.code=L;this.orders.push(K);this.stop=1;this.outputEvent(this.orders)}})})(this);
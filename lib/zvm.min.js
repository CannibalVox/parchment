/*

ZVM - the ifvms.js implementation of the Z-Machine
==================================================

Built: 2011-11-02

Copyright (c) 2011 The ifvms.js team
BSD licenced
http://github.com/curiousdannii/ifvms.js

*/
(function(B,i){if(![].indexOf){Array.prototype.indexOf=function(O,N){for(var M=N||0,L=this.length;M<L;M++){if(this[M]==O){return M}}return -1}}var h=function(L,N){for(var M in N){L[M]=N[M]}return L},q=B.console||{log:function(){},info:function(){},warn:function(){}},H=function(L){return((L&32768)?~65535:0)|L},d=function(L){return L&65535},s=function(O){var N=0,M=O.length,L=[];while(N<M){L[N/2]=O[N++]<<8|O[N++]}return L};var b=B.DataView,F=b?function(M){var L=new ArrayBuffer(M),M=new DataView(L);M.buffer=L;return M}:function(L){L=L.slice();return{data:L,getUint8:function(M){return L[M]},getUint16:function(M){return L[M]<<8|L[M+1]},getBuffer:function(N,M){return L.slice(N,N+M)},getBuffer16:function(N,M){return s(L.slice(N,N+M*2))},setUint8:function(M,N){return L[M]=N&255},setUint16:function(M,N){L[M]=(N>>8)&255;L[M+1]=N&255;return N&65535},setBuffer:function(N,M){return L=L.slice(0,N).concat(M,L.slice(N+M.length))}}};var J=Object.subClass({init:function(L,M){this.e=L;this.v=M},write:function(){return this.v},U2S:function(){return H(this.v)}}),g=J.subClass({write:function(N){var M=this.v,L=arguments.length,N=N&&N.write?N.write():N,O=this.e.globals+(M-16)*2;if(this.returnval){return"e.variable("+M+","+N+")"}if(M==0){return L?"s.push("+N+")":"s.pop()"}else{if(M<16){M--;return"l["+M+"]"+(L?"="+N:"")}else{if(L){return"m.setUint16("+O+","+N+")"}else{return"m.getUint16("+O+")"}}}},U2S:function(){return"e.U2S("+this.write()+")"}}),f=Object.subClass({init:function(P,N,Q,M,O,L){this.e=P;this.context=N;this.code=Q;this.pc=M;this.next=O;this.operands=L;if(this.post){this.post()}},write:function(){return this.label()+(this.func?this.func.apply(this,this.operands):"")},args:function(M){var L=0,N=[];while(L<this.operands.length){N.push(this.operands[L++].write())}return N.join(M)},label:function(){return"/* "+this.pc+"/"+this.code+" */ "}}),t=f.subClass({stopper:1}),k=t.subClass({storer:1,post:function(){this.storer=this.operands.pop();this.origfunc=this.func;this.func=function(){return"e.pc="+this.next+";"+this.origfunc.apply(this,arguments)}}}),D=Object.subClass({init:function(L,M){this.ops=L||[];this.code=M||"||"},write:function(){var L=0,M=[],N;while(L<this.ops.length){N=this.ops[L++];M.push(N.func?(N.iftrue?"":"!(")+N.func.apply(N,N.operands)+(N.iftrue?"":")"):N.write())}return(this.invert?"(!(":"(")+M.join(this.code)+(this.invert?"))":")")}}),E=f.subClass({brancher:1,keyword:"if",post:function(){var L,N,M=this.operands.pop(),O=M[1];this.iftrue=M[0];if(O==0||O==1){L="e.ret("+O+")"}else{O+=this.next-2;this.context.targets.push(O);L="e.pc="+O}this.result=L+"; return";this.offset=O;this.cond=new D();this.labels=[];if(this.context.ops.length){N=this.context.ops.pop();if(N.offset==O){this.cond=N.cond;this.labels=N.labels}else{this.context.ops.push(N)}}this.cond.ops.push(this);this.labels.push(this.pc+"/"+this.code)},write:function(){var M=0,L=this.result;if(L instanceof G){L=L.write()+(L.stopper?"; return":"");if(this.result.ops.length>1){L="\n"+L+"\n"}}return"/* "+this.labels.join()+" */ "+this.keyword+this.cond.write()+" {"+L+"}"}}),y=E.subClass({storer:1,post:function(){this._super();this.storer=this.operands.pop();this.storer.returnval=1}}),l=f.subClass({storer:1,post:function(){this.storer=this.operands.pop()},write:function(){var L=this._super();return this.storer?this.storer.write(L):L}}),x=t.subClass({post:function(){this.result={v:-1}},write:function(){var L=this.operands.shift();return this.label()+"e.call("+L.write()+","+this.result.v+","+this.next+",["+this.args()+"])"}}),m=x.subClass({storer:1,post:function(){this.result=this.operands.pop()}}),G=Object.subClass({init:function(M,L){this.e=M;this.pc=L;this.ops=[];this.targets=[]},write:function(){var N=this.ops,L=[],M=0;while(M<N.length){L.push(N[M++].write())}return L.join(";")}}),A=G.subClass({write:function(){return"var l=e.l,m=e.m,s=e.s;\n"+this._super()}}),K=function(M,N,L){var L=L||{};if(N){L.func=N}return M.subClass(L)};var w=IFF.subClass({init:function(M){this._super(M);if(M){if(this.type!="IFZS"){throw new Error("Not a Quetzal savefile")}for(var N=0,L=this.chunks.length;N<L;N++){var O=this.chunks[N].type,P=this.chunks[N].data;if(O=="CMem"||O=="UMem"){this.memory=P;this.compressed=(O=="CMem")}else{if(O=="Stks"){this.stacks=P}else{if(O=="IFhd"){this.release=P.slice(0,2);this.serial=P.slice(2,8);this.checksum=P.slice(8,10);this.pc=P[10]<<16|P[11]<<8|P[12]}}}}}},write:function(){this.type="IFZS";var M=this.pc,L=this.release.concat(this.serial,this.checksum,(M>>16)&255,(M>>8)&255,M&255);this.chunks=[{type:"IFhd",data:L},{type:(this.compressed?"CMem":"UMem"),data:this.memory},{type:"Stks",data:this.stacks}];return this._super()}});var I=(function(){var M={8:8,13:13,27:27,37:131,38:129,39:132,40:130},L=96;while(L<106){M[L]=49+L++}L=112;while(L<124){M[L]=21+L++}return M})(),o=Object.subClass({init:function(T){var Q=T.m,N=Q.getUint16(52),P=T.extension_table(3),L=P&&Q.getUint8(P++),R,M=[],S=0,O=96;this.e=T;this.maxaddr=Q.getUint16(26)*T.packing_multipler;this.make_alphabet(N?Q.getBuffer(N,78):this.text_to_zscii("abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ*\r0123456789.,!?_#'\"/\\-:()"));this.make_unicode(P?Q.getBuffer16(P,L):this.text_to_zscii(unescape("%E4%F6%FC%C4%D6%DC%DF%BB%AB%EB%EF%FF%CB%CF%E1%E9%ED%F3%FA%FD%C1%C9%CD%D3%DA%DD%E0%E8%EC%F2%F9%C0%C8%CC%D2%D9%E2%EA%EE%F4%FB%C2%CA%CE%D4%DB%E5%C5%F8%D8%E3%F1%F5%C3%D1%D5%E6%C6%E7%C7%FE%F0%DE%D0%A3%u0153%u0152%A1%BF"),1));R=Q.getUint16(24);if(R){while(S<O){M.push(this.decode(Q.getUint16(R+2*S++)*2,0,1))}}this.abbr=M;this.dictionaries={};this.dict=Q.getUint16(8);this.parse_dict(this.dict)},make_alphabet:function(M){var N=[[],[],[]],L=0;while(L<78){N[parseInt(L/26)][L%26]=M[L++]}this.alphabets=N},make_unicode:function(O){var N={},L={10:13},M=0;while(M<O.length){N[M+155]=O[M];L[O[M]]=155+M++}this.unicode_table=N;this.reverse_unicode_table=L;this.unicode_callback=function(P){return String.fromCharCode(N[P.charCodeAt(0)]||63)}},decode:function(S,M,V){var P=this.e.m,T=S,L,O=[],Q=0,R,N=0,U=[];if(this.e.jit[S]){return this.e.jit[S]}M=M?M+S:this.maxaddr;while(S<M){L=P.getUint16(S);S+=2;O.push(L>>10&31,L>>5&31,L&31);if(L&32768){break}}while(Q<O.length){R=O[Q++];if(R==0){U.push(32)}else{if(R<4){U=U.concat(this.abbr[32*(R-1)+O[Q++]])}else{if(R<6){N=R}else{if(N==2&&R==6){if(Q+1<O.length){U.push(O[Q++]<<5|O[Q++])}}else{U.push(this.alphabets[N][R-6])}}}}N=N<4?0:N-3}if(!V){U=new String(this.zscii_to_text(U));U.pc=S;this.e.jit[T]=U;if(T<this.e.staticmem){q.warn("Caching a string in dynamic memory: "+T)}}return U},encode:function(Q){var R=this.alphabets,P=[],O=0,N,M,L=[];while(P.length<9){N=Q[O++];if(N==32){P.push(0)}M=R[0].indexOf(N);if(M>=0){P.push(M+6)}M=R[1].indexOf(N);if(M>=0){P.push(4,M+6)}M=R[2].indexOf(N);if(M>=0){P.push(5,M+6)}M=this.reverse_unicode_table[N];if(M){P.push(5,6,M>>5,M&31)}if(N==i){P.push(5)}}P.length=9;O=0;while(O<9){L.push(P[O++]<<2|P[O]>>3,(P[O++]&7)<<5|P[O++])}L[4]|=128;return L},zscii_to_text:function(L){return String.fromCharCode.apply(this,L).replace(/[\x00-\x0C\x0E-\x1F\x7F-\x9A\xFC-\uFFFF]/g,"").replace(/\r/g,"\n").replace(/[\x9B-\xFB]/g,this.unicode_callback)},text_to_zscii:function(P,O){var Q=[],M=0,L=P.length,N;O=!O;while(M<L){N=P.charCodeAt(M++);if(O&&N!=13&&(N<32||N>126)){N=this.reverse_unicode_table[N]||63}Q.push(N)}return Q},parse_dict:function(S){var R=this.e.m,L=S,Q={},P,O,N,M,P=R.getUint8(S++);Q.separators=R.getBuffer(S,P);S+=P;O=R.getUint8(S++);N=S+2+O*R.getUint16(S);S+=2;while(S<N){Q[""+R.getBuffer(S,6)]=S;S+=O}this.dictionaries[L]=Q;return Q},tokenise:function(Y,P,X,V){X=X||this.dict;X=this.dictionaries[X]||this.parse_dict(X);var Q=this.e.m,R=Y+2,T=R+Q.getUint8(Y+1),N,O=X.separators,L=[],W=[],M=R,S,U=0;while(R<T){N=Q.getUint8(R);if(N==32||O.indexOf(N)>=0){if(L.length){W.push([L,M]);L=[];M=R+1}if(N!=32){W.push([N,R])}}else{L.push(N)}R++}if(L.length){W.push([L,M])}S=Math.min(W.length,Q.getUint8(P));while(U<S){L=this.encode(W[U][0]);if(V&&!X[L]){continue}Q.setUint16(P+2+U*4,X[L]||0);Q.setUint8(P+4+U*4,W[U][0].length);Q.setUint8(P+5+U*4,W[U++][1])}Q.setUint8(P+1,U)},keyinput:function(M){var L=M.charCode,N=M.keyCode;if(I[N]){return I[N]}if(L>31&&L<127){return L}return this.reverse_unicode_table[L]||63}});var v=[-2,65535,0,29,832,957,22944,31775,30624,32767,23254,17969,11627],n=function(L){var M=Math.round((L&31)*8.226)<<16|Math.round(((L&992)>>5)*8.226)<<8|Math.round(((L&31744)>>10)*8.226);M=M.toString(16);while(M.length<6){M="0"+M}return"#"+M},r=Object.subClass({init:function(L){this.e=L;this.buffer="";this.styles={};this.streams=[1,0,[],0];this.mono=L.m.getUint8(17)&2;this.currentwin=0;this.status=[];this.e.orders.push({code:"stream",name:"status"},{code:"stream",name:"main"},{code:"find",name:"main"})},clear_window:function(L){this.e.orders.push({code:"clear",name:L?"status":"main",css:h({},this.styles)})},erase_window:function(L){this.flush();if(L==-1){this.split_window(0);this.clear_window(0)}if(L==-2){this.clear_window(0);this.clear_window(1)}else{this.clear_window(L)}},flush:function(){var L;if(this.buffer!=""){L={code:"stream",css:h({},this.styles),text:this.buffer};if(this.mono){L.node="tt"}(this.currentwin?this.status:this.e.orders).push(L);this.buffer=""}},output_stream:function(N,O){N=H(N);if(N==1){this.streams[0]=1}if(N==-1){this.streams[0]=0}if(N==3){this.streams[2].unshift([O,""])}if(N==-3){var L=this.streams[2].shift(),M=this.e.text.text_to_zscii(L[1]);this.e.m.setUint16(L[0],M.length);this.e.m.setBuffer(L[0]+2,M)}},print:function(M){if(this.streams[2].length){this.streams[2][0][1]+=M}else{if(this.streams[0]){var L=this.e.m.getUint8(17)&2;if(L!=(this.mono&2)){if(!(this.mono&253)){this.flush()}this.mono^=2}this.buffer+=M}}},set_colour:function(M,L){this.set_true_colour(v[M],v[L])},set_font:function(L){if(L!=1&&L!=4){return 0}var M=this.mono&4?4:1;if(L!=M){this.flush();this.mono^=4}return M},set_style:function(L){var M=this.styles;this.flush();if(L==0){M.reverse=M["font-weight"]=M["font-style"]=i;this.mono&=254}if(L&1){M.reverse=1}if(L&2){M["font-weight"]="bold"}if(L&4){M["font-style"]="italic"}if(L&8){this.mono|=1}},set_true_colour:function(O,M){var N=this.styles,P=N.color,L=N["background-color"];this.flush();if(O==65535){P=i}else{if(O<32768){P=n(O)}}if(M==65535){L=i}else{if(M<32768){L=n(M)}}N.color=P;N["background-color"]=L},set_window:function(L){this.flush();this.currentwin=L;this.e.orders.push({code:"find",name:L?"status":"main"})},split_window:function(L){this.flush();this.status.push({code:"height",lines:L})}});var a=function(L){return L.write()},j=K(E,function(){return 1}),z=g.subClass({write:function(N){var L=arguments.length,M=this.v;if(M.write||M==0){N=N&&N.write?N.write():N;M=M.write?M.write():M;return"e.indirect("+M+(L?","+N:"")+")"}return this._super(N)}}),p=l.subClass({storer:0,post:function(){var L=this.operands;L[0]=new z(this.e,L[0] instanceof g?L[0]:L[0].v);this.storer=this.code==142?L.pop():L.shift();if(L.length==0){L.push(new g(this.e,0))}},func:a}),C={1:K(E,function(){return arguments.length==2?this.args("=="):"e.jeq("+this.args()+")"}),2:K(E,function(M,L){return M.U2S()+"<"+L.U2S()}),3:K(E,function(M,L){return M.U2S()+">"+L.U2S()}),4:K(E,function(L,M){return"e.U2S(e.incdec("+L.write()+",-1))<"+M.U2S()}),5:K(E,function(L,M){return"e.U2S(e.incdec("+L.write()+",1))>"+M.U2S()}),6:K(E,function(){return"e.jin("+this.args()+")"}),7:K(E,function(){return"e.test("+this.args()+")"}),8:K(l,function(){return this.args("|")}),9:K(l,function(){return this.args("&")}),10:K(E,function(){return"e.test_attr("+this.args()+")"}),11:K(f,function(){return"e.set_attr("+this.args()+")"}),12:K(f,function(){return"e.clear_attr("+this.args()+")"}),13:p,14:K(f,function(){return"e.insert_obj("+this.args()+")"}),15:K(l,function(M,L){return"m.getUint16("+M.write()+"+2*"+L.U2S()+")"}),16:K(l,function(M,L){return"m.getUint8("+M.write()+"+"+L.U2S()+")"}),17:K(l,function(){return"e.get_prop("+this.args()+")"}),18:K(l,function(){return"e.find_prop("+this.args()+")"}),19:K(l,function(){return"e.find_prop("+this.args(",0,")+")"}),20:K(l,function(){return"e.S2U("+this.args("+")+")"}),21:K(l,function(){return"e.S2U("+this.args("-")+")"}),22:K(l,function(){return"e.S2U("+this.args("*")+")"}),23:K(l,function(M,L){return"e.S2U(parseInt("+M.U2S()+"/"+L.U2S()+"))"}),24:K(l,function(M,L){return"e.S2U("+M.U2S()+"%"+L.U2S()+")"}),25:m,26:x,27:K(f,function(){return"e.ui.set_colour("+this.args()+")"}),128:K(E,function(L){return L.write()+"==0"}),129:K(y,function(L){return this.storer.write("e.get_sibling("+L.write()+")")}),130:K(y,function(L){return this.storer.write("e.get_child("+L.write()+")")}),131:K(l,function(L){return"e.get_parent("+L.write()+")"}),132:K(l,function(L){return"e.get_prop_len("+L.write()+")"}),133:K(f,function(L){return"e.incdec("+L.write()+",1)"}),134:K(f,function(L){return"e.incdec("+L.write()+",-1)"}),135:K(f,function(L){return"e.print(e.text.decode("+L.write()+"))"}),136:m,137:K(f,function(L){return"e.remove_obj("+L.write()+")"}),138:K(f,function(){return"e.print_obj("+this.args()+")"}),139:K(t,function(L){return"e.ret("+L.write()+")"}),140:K(t,function(L){return"e.pc="+L.U2S()+"+"+(this.next-2)}),141:K(f,function(L){return"e.print(e.text.decode("+L.write()+"*"+this.e.packing_multipler+"))"}),142:p.subClass({storer:1}),143:x,176:K(t,function(){return"e.ret(1)"}),177:K(t,function(){return"e.ret(0)"}),178:K(f,function(L){return'e.print("'+L+'")'},{printer:1}),179:K(t,function(L){return'e.print("'+L+'");e.ret(1)'},{printer:1}),180:f,183:K(t,function(){return'e.act("restart")'}),184:K(t,function(L){return"e.ret("+L.write()+")"},{post:function(){this.operands.push(new g(this.e,0))}}),186:K(t,function(){return'e.act("quit")'}),187:K(f,function(){return'e.print("\\n")'}),189:j,191:j,224:m,225:K(f,function(N,L,M){return"m.setUint16("+N.write()+"+2*"+L.U2S()+","+M.write()+")"}),226:K(f,function(N,L,M){return"m.setUint8("+N.write()+"+"+L.U2S()+","+M.write()+")"}),227:K(f,function(){return"e.put_prop("+this.args()+")"}),228:K(k,function(){return"e.read("+this.args()+","+this.storer.v+")"}),229:K(f,function(L){return"e.print(e.text.zscii_to_text(["+L.write()+"]))"}),230:K(f,function(L){return"e.print("+L.U2S()+")"}),231:K(l,function(L){return"e.random("+L.U2S()+")"}),232:K(l,a,{post:function(){this.storer=new g(this.e,0)},storer:0}),233:p,234:K(f,function(){return"e.ui.split_window("+this.args()+")"}),235:K(f,function(){return"e.ui.set_window("+this.args()+")"}),236:m,237:K(f,function(L){return"e.ui.erase_window("+L.U2S()+")"}),238:K(f,function(){return"if("+this.args()+'){e.ui.flush();e.ui.status.push({code:"eraseline"})}'}),239:K(f,function(){return'e.ui.flush();e.ui.status.push({code:"cursor",to:['+this.args()+"]})"}),241:K(f,function(L){return"e.ui.set_style("+L.write()+")"}),242:f,243:K(f,function(){return"e.ui.output_stream("+this.args()+")"}),244:f,245:f,246:K(k,function(){return"e.read_char("+this.args()+","+this.storer.v+")"}),247:K(y,function(){return this.storer.write("e.scan_table("+this.args()+")")}),248:K(l,function(L){return"e.S2U(~"+L.write()+")"}),249:x,250:x,251:K(f,function(){return"e.text.tokenise("+this.args()+")"}),252:K(f,function(){return"e.encode_text("+this.args()+")"}),253:K(f,function(){return"e.copy_table("+this.args()+")"}),254:K(f,function(){return"e.print_table("+this.args()+")"}),255:K(E,function(L){return L.write()+"<=e.call_stack[0][4]"}),1000:K(k,function(){return"e.save("+(this.next-1)+","+this.storer.v+")"}),1001:K(k,function(){return'e.act("restore",{storer:'+this.storer.v+"})"}),1002:K(l,function(M,L){return"e.S2U(e.log_shift("+M.write()+","+L.U2S()+"))"}),1003:K(l,function(M,L){return"e.S2U(e.art_shift("+M.U2S()+","+L.U2S()+"))"}),1004:K(l,function(){return"e.ui.set_font("+this.args()+")"}),1009:K(l,function(){return"e.save_undo("+this.next+","+this.storer.v+")"}),1010:K(f,function(){return"if(e.restore_undo())return"},{storer:1}),1011:K(f,function(L){return"e.print(String.fromCharCode("+L.write()+"))"}),1012:K(l,function(){return 3})};var u=function(P,N){var O=0,L,S,M,R,Q;while(O<P.ops.length-1){if(P.ops[O].offset==N){if(P.ops.length-O==2&&P.ops[O+1].offset){R=P.ops.pop();Q=P.ops.pop();Q.cond.invert=!Q.cond.invert;R.cond=new D([Q.cond,R.cond],"&&");R.labels=Q.labels.concat(R.labels);P.ops.push(R);return 1}L=new G(P.e,P.ops[O+1].pc);L.ops=P.ops.slice(O+1);S=L.ops.length-1;P.ops.length=O+1;M=P.ops[O];M.result=L;M.cond.invert=!M.cond.invert;R=L.ops[S];if(R.code==140&&(H(R.operands[0].v)+R.next-2)==M.pc){M.keyword="while";L.ops.pop()}else{L.stopper=R.stopper}return 1}O++}};var c=function(Q){var R,N,O=Q.m,T,M,S,U,P,L=new A(Q,Q.pc);while(1){N=R=Q.pc;M=O.getUint8(R++);if(M==190){U=-1;M=O.getUint8(R++)+1000}else{if(M&128){if(M&64){U=-1;if(!(M&32)){M&=31}}else{U=[(M&48)>>4];if(U[0]<3){M&=207}}}else{U=[M&64?2:1,M&32?2:1];M&=31}}if(!C[M]){q.log("Missing opcode #"+M+" at pc="+N);q.log(L.write());Q.stop=1;throw Error}S=C[M].prototype;if(U==-1){U=[];e(O.getUint8(R++),U);if(M==236||M==250){e(O.getUint8(R++),U)}}P=[];T=0;while(T<U.length){if(U[T]==0){P.push(new J(Q,O.getUint16(R)));R+=2}if(U[T]==1){P.push(new J(Q,O.getUint8(R++)))}if(U[T++]==2){P.push(new g(Q,O.getUint8(R++)))}}if(S.storer){P.push(new g(Q,O.getUint8(R++)))}if(S.brancher){T=O.getUint8(R++);P.push([T&128,T&64?T&63:((T=(T<<8)|O.getUint8(R++))&8192?~8191:0)|(T&8191)])}if(S.printer){T=Q.text.decode(R);P.push(T.replace(/\n/g,"\\n").replace(/"/g,'\\"'));R=T.pc}Q.pc=R;L.ops.push(new C[M](Q,L,M,N,R,P));T=0;if(L.targets.indexOf(R)>=0){T=u(L,R)}if(S.stopper&&!T){break}}return L},e=function(M,N){for(var L=0;L<4;L++){N.push((M&192)>>6);M<<=2}};B.ZVM=Object.subClass({art_shift:function(M,L){return L>0?M<<L:M>>-L},call:function(S,L,P,N){var O,M,R=this.l.length,Q=N.length;this.pc=S*this.packing_multipler;M=this.m.getUint8(this.pc++);N=N.slice(0,M);for(O=N.length;O<M;O++){N.push(0)}this.l=N.concat(this.l);this.call_stack.unshift([P,L,M,this.s.length,Q,R])},clear_attr:function(L,M){var N=this.objects+14*L+parseInt(M/8);this.m.setUint8(N,this.m.getUint8(N)&~(128>>M%8))},copy_table:function(P,M,O){var R=this.m,N=0,Q=O<0,L;O=Math.abs(O);if(M==0){while(N<O){R.setUint8(P+N++,0)}return}L=R.getBuffer(P,O);R.setBuffer(M,L);if(!Q){R.setBuffer(P,L)}},encode_text:function(M,L,O,N){this.m.setBuffer(N,this.text.encode(this.m.getBuffer(M+O,L)))},extension_table:function(M,L){var N=this.extension;if(!N||M>this.extension_count){return 0}N+=2*M;if(L==i){return this.m.getUint16(N)}this.e.setUint16(N,L)},find_prop:function(L,P,O){var S=this.m,R,Q,N=0,M=S.getUint16(this.objects+14*L+12);M+=S.getUint8(M)*2+1;R=S.getUint8(M);Q=R&63;while(1){if(N==O){return Q}if(Q==P){return M+(R&128?2:1)}if(Q<P){return 0}N=Q;if(R&128){Q=S.getUint8(M+1)&63;M+=Q?Q+2:66}else{M+=R&64?3:2}R=S.getUint8(M);Q=R&63}},get_child:function(L){return this.m.getUint16(this.objects+14*L+10)},get_sibling:function(L){return this.m.getUint16(this.objects+14*L+8)},get_parent:function(L){return this.m.getUint16(this.objects+14*L+6)},get_prop:function(L,M){var O=this.m,N=this.find_prop(L,M);if(N){return(O.getUint8(N-1)&64?O.getUint16:O.getUint8)(N)}return O.getUint16(this.properties+2*(M-1))},get_prop_len:function(M){if(M==0){return 0}var L=this.m.getUint8(M-1);if(L&128){L&=63;return L==0?64:L}return L&64?2:1},incdec:function(M,O){var L,N;if(M==0){L=d(this.s.pop()+O);this.s.push(L);return L}if(M<16){return this.l[M-1]=d(this.l[M-1]+O)}else{N=this.globals+(M-16)*2;return this.m.setUint16(N,this.m.getUint16(N)+O)}},indirect:function(L,M){if(L==0){if(arguments.length>1){return this.s[this.s.length-1]=M}else{return this.s[this.s.length-1]}}return this.variable(L,M)},insert_obj:function(M,L){this.remove_obj(M);this.set_family(M,L,L,M,M,this.get_child(L))},jeq:function(){var L=1,M;while(L<arguments.length){if(arguments[L++]==arguments[0]){M=1}}return M},jin:function(M,L){return this.get_parent(M)==L},log_shift:function(M,L){return L>0?M<<L:M>>>-L},print:function(L){this.ui.print(L)},print_obj:function(M){var L=this.m.getUint16(this.objects+14*M+12);this.print(this.text.decode(L+1,this.m.getUint8(L)*2))},print_table:function(P,N,L,O){L=L||1;O=O||0;var M=0;while(M<L){this.print("\n"+this.text.zscii_to_text(this.m.getBuffer(P,N)));P+=N+O;M++}},put_prop:function(L,N,M){var P=this.m,O=this.find_prop(L,N);(P.getUint8(O-1)&64?P.setUint16:P.setUint8)(O,M)},random:function(L){var M;if(L<1){this.random_state=Math.abs(L);this.random_seq=0;return 0}if(this.random_state==0){return parseInt(Math.random()*L)+1}else{this.random_seq++;if(this.random_seq>this.random_state){this.random_seq=1}return this.random_seq%L}},read:function(P,O,N,L,M){if(arguments.length==3){M=N;N=L=0}this.act("read",{buffer:P,parse:O,len:this.m.getUint8(P),initiallen:this.m.getUint8(P+1),time:N,routine:L,storer:M})},read_char:function(N,O,L,M){if(arguments.length==2){M=O;O=L=0}this.act("char",{time:O,routine:L,storer:M})},remove_obj:function(P){var O=this.get_parent(P),M,N,L;if(O==0){return}M=this.get_child(O);N=this.get_sibling(P);if(M==P){this.set_family(P,0,O,N)}else{while(1){L=this.get_sibling(M);if(L==P){break}M=L}this.set_family(P,0,0,0,M,N)}},restore:function(Q){var N=new w(Q),O=N.memory,S=N.stacks,U=N.pc,V=this.m.getUint8(17),W,R=0,P=0,T=[],M=[],L;this.m.setBuffer(0,this.data.slice(0,this.staticmem));if(N.compressed){while(R<O.length){W=O[R++];if(W==0){P+=1+O[R++]}else{this.m.setUint8(P,W^this.data[P++])}}}else{this.m.setBuffer(0,N.memory)}this.m.setUint8(17,V);R=6;W=S[R++]<<8|S[R++];L=s(S.slice(R,W));while(R<S.length){T.unshift([S[R++]<<16|S[R++]<<8|S[R++],0,0,L.length,0,M.length]);T[0][1]=S[R]&16?-1:S[R+1];T[0][2]=S[R]&15;R+=2;W=S[R++];while(W){T[0][4]++;W>>=1}W=S[R++]<<8|S[R++];M=s(S.slice(R,R+T[0][2])).concat(M);R+=T[0][2]*2;L=L.concat(s(S.slice(R,W)))}this.call_stack=T;this.l=M;this.s=L;this.update_header();this.variable(this.m.getUint8(U++),2);this.pc=U},restore_undo:function(){if(this.undo.length==0){return 0}var L=this.undo.pop();this.pc=L[0];L[2][17]=this.m.getUint8(17);this.m.setBuffer(0,L[2]);this.l=L[3];this.s=L[4];this.call_stack=L[5];this.variable(L[1],2);return 1},ret:function(L){var N=this.call_stack.shift(),M=N[1];this.pc=N[0];this.l=this.l.slice(N[2]);this.s.length=N[3];if(M>=0){this.variable(M,L)}},save:function(W,Z){var S=this.m,X=this.s,N=this.l,P=new w(),R=[],T,Q,U,Y=0,V=this.call_stack.reverse(),M,O,L=[0,0,0,0,0,0];P.release=S.getBuffer(2,2);P.serial=S.getBuffer(18,6);P.checksum=S.getBuffer(28,2);P.pc=W;P.compressed=1;for(T=0;T<this.staticmem;T++){U=S.getUint8(T)^this.data[T];if(U==0){if(++Y==256){R.push(0,255);Y=0}}else{if(Y){R.push(0,Y-1);Y=0}R.push(U)}}P.memory=R;L.push(V[0][3]>>8,V[0][3]&255);for(Q=0;Q<V[0][3];Q++){L.push(X[Q]>>8,X[Q]&255)}for(T=0;T<V.length;T++){M=V[T];O=(V[T+1]?V[T+1][3]:X.length)-M[3];L.push(M[0]>>16,M[0]>>8&255,M[0]&255,M[2]|(M[1]<0?16:0),M[1]<0?0:M[1],(1<<M[4])-1,O>>8,O&255);for(Q=N.length-M[5]-M[2];Q<N.length-M[5];Q++){L.push(N[Q]>>8,N[Q]&255)}for(Q=M[3];Q<M[3]+O;Q++){L.push(X[Q]>>8,X[Q]&255)}}V.reverse();P.stacks=L;this.variable(Z,1);this.act("save",{data:P.write()})},save_undo:function(M,L){this.undo.push([M,L,this.m.getBuffer(0,this.staticmem),this.l.slice(),this.s.slice(),this.call_stack.slice()]);return 1},scan_table:function(L,P,N,M){M=M||130;var O=M&128?this.m.getUint16:this.m.getUint8;M&=127;N=P+N*M;while(P<N){if(O(P)==L){return P}P+=M}return 0},set_attr:function(L,M){var N=this.objects+14*L+parseInt(M/8);this.m.setUint8(N,this.m.getUint8(N)|128>>M%8)},set_family:function(N,O,M,Q,L,P){this.m.setUint16(this.objects+14*N+6,O);if(M){this.m.setUint16(this.objects+14*M+10,Q)}if(L){this.m.setUint16(this.objects+14*L+8,P)}},test:function(M,L){return M&L==L},test_attr:function(L,M){return(this.m.getUint8(this.objects+14*L+parseInt(M/8))<<M%8)&128},variable:function(M,N){var L=N!==i;if(M==0){if(L){this.s.push(N)}else{return this.s.pop()}}else{if(M<16){if(L){this.l[M-1]=N}else{return this.l[M-1]}}else{if(L){this.m.setUint16(this.globals+(M-16)*2,N)}else{this.m.getUint16(this.globals+(M-16)*2)}}}return N},U2S:H,S2U:d,init:function(){this.jit={};this.env={width:80}},inputEvent:function(N){var O=this.m,M=N.code,L;if(N.env){h(this.env,N.env);if(!M){return}}this.orders=[];if(M=="load"){this.data=N.data;return}if(M=="restart"){this.restart()}if(M=="restore"){if(N.data){this.restore(N.data)}else{this.variable(N.storer,0)}}if(M=="read"){this.variable(N.storer,N.terminator);L=N.response;this.print(L+"\n");L=this.text.text_to_zscii(L.toLowerCase());if(L.length>N.len){L=L.slice(0,N.len)}O.setUint8(N.buffer+1,L.length);O.setBuffer(N.buffer+2,L);if(N.parse){this.text.tokenise(N.buffer,N.parse)}}if(M=="char"){this.variable(N.storer,this.text.keyinput(N.response))}this.run()},restart:function(){var O=F(this.data),L=O.getUint8(0),M=O.getUint16(10),N=O.getUint16(54);if(L!=5&&L!=8){throw new Error("Unsupported Z-Machine version: "+L)}if(this.m){O.setUint8(17,this.m.getUint8(17))}h(this,{m:O,s:[],l:[],call_stack:[],undo:[],orders:[],version:L,pc:O.getUint16(6),properties:M,objects:M+112,globals:O.getUint16(12),staticmem:O.getUint16(14),extension:N,extension_count:N?O.getUint16(N):0,packing_multipler:L==5?4:8});h(this,{ui:new r(this),text:new o(this)});this.update_header()},update_header:function(){var L=this.m;this.random_state=0;L.setUint8(1,29|(this.env.timed?128:0));L.setUint8(17,L.getUint8(17)&87);L.setUint8(32,255);L.setUint8(33,this.env.width);L.setUint16(34,this.env.width);L.setUint16(36,255);L.setUint16(38,257);L.setUint8(50,1);L.setUint8(51,this.env.PARCHMENT_SECURITY_OVERRIDE?2:0);this.extension_table(4,0)},run:function(){var M=Date.now(),L;this.stop=0;while(!this.stop){L=this.pc;if(!this.jit[L]){this.compile()}this.jit[L](this);if((Date.now()-M)>5000){this.act("tick");return}}},compile:function(){var L=c(this),M=L.write();this.jit[L.pc]=new Function("e",M);if(L.pc<this.staticmem){q.warn("Caching a JIT function in dynamic memory: "+L.pc)}},act:function(M,L){var L=L||{};this.ui.flush();if(this.ui.status.length){this.orders.push({code:"stream",to:"status",data:this.ui.status});this.ui.status=[]}L.code=M;this.orders.push(L);this.stop=1;this.outputEvent(this.orders)}})})(this);
/*

ZVM - the ifvms.js implementation of the Z-Machine
==================================================

Built: 2011-10-08

Copyright (c) 2011 The ifvms.js team
BSD licenced
http://github.com/curiousdannii/ifvms.js

*/
(function(D,m){if(![].indexOf){Array.prototype.indexOf=function(Q,P){for(var O=P||0,N=array.length;O<N;O++){if(array[O]==Q){return O}}return -1}}var k=function(N,P){for(var O in P){N[O]=P[O]}return N},g=D.console?function(){console.log.apply(console,arguments)}:function(){},J=function(N){return((N&32768)?~65535:0)|N},f=function(N){return N&65535},H=D.PARCHMENT_SECURITY_OVERRIDE;var c=D.DataView,G=c?function(O){var N=new ArrayBuffer(O),O=new DataView(N);O.buffer=N;return O}:function(N){N=N.slice();return{data:N,getUint8:function(O){return N[O]},getUint16:function(O){return N[O]<<8|N[O+1]},getBuffer:function(P,O){return N.slice(P,P+O)},getBuffer16:function(P,O){return u(N.slice(P,P+O*2))},setUint8:function(O,P){return N[O]=P&255},setUint16:function(O,P){N[O]=(P>>8)&255;N[O+1]=P&255;return P&65535},setBuffer:function(P,O){return N=N.slice(0,P).concat(O,N.slice(P+O.length))}}},u=function(Q){var P=0,O=Q.length,N=[];while(P<O){N[P/2]=Q[P++]<<8|Q[P++]}return N};var L=Object.subClass({init:function(N,O){this.e=N;this.v=O},write:function(){return this.v},U2S:function(){return J(this.v)}}),j=L.subClass({write:function(P){var O=this.v,N=arguments.length,P=P&&P.write?P.write():P,Q=this.e.globals+(O-16)*2;if(this.returnval){return"e.variable("+O+","+P+")"}if(O==0){return N?"s.push("+P+")":"s.pop()"}else{if(O<16){O--;return"l["+O+"]"+(N?"="+P:"")}else{if(N){return"m.setUint16("+Q+","+P+")"}else{return"m.getUint16("+Q+")"}}}},U2S:function(){return"e.U2S("+this.write()+")"}}),i=Object.subClass({init:function(R,P,S,O,Q,N){this.e=R;this.context=P;this.code=S;this.pc=O;this.next=Q;this.operands=N;if(this.post){this.post()}},write:function(){return this.label()+(this.func?this.func.apply(this,this.operands):"")},args:function(O){var N=0,P=[];while(N<this.operands.length){P.push(this.operands[N++].write())}return P.join(O)},label:function(){return"/* "+this.pc+"/"+this.code+" */ "}}),v=i.subClass({stopper:1}),F=i.subClass({brancher:1,post:function(){var N,P,O=this.operands.pop(),Q=O[1];this.iftrue=O[0];if(Q==0||Q==1){N="e.ret("+Q+")"}else{Q+=this.next-2;this.context.targets.push(Q);N="e.pc="+Q}this.result=N+"; return";this.offset=Q;this.ops=[];this.labels=[];if(this.context.ops.length){P=this.context.ops.pop();if(P.offset==Q){this.ops=P.ops;this.labels=P.labels}else{this.context.ops.push(P)}}this.ops.push(this);this.labels.push(this.pc+"/"+this.code)},write:function(){var O=0,P,N=this.result;if(N instanceof I){N=N.write()+(N.stopper?"; return":"");if(this.result.ops.length>1){N="\n"+N+"\n"}}while(O<this.ops.length){P=this.ops[O];this.ops[O++]=(P.iftrue?"":"!(")+P.func.apply(P,P.operands)+(P.iftrue?"":")")}return"/* "+this.labels.join()+" */ "+(this.invert?"if (!(":"if (")+this.ops.join("||")+(this.invert?")) {":") {")+N+"}"}}),A=F.subClass({storer:1,post:function(){this._super();this.storer=this.operands.pop();this.storer.returnval=1}}),o=i.subClass({storer:1,post:function(){this.storer=this.operands.pop()},write:function(){var N=this._super();return this.storer?this.storer.write(N):N}}),z=v.subClass({post:function(){this.result={v:-1}},write:function(){var N=this.operands.shift();return this.label()+"e.call("+N.write()+","+this.result.v+","+this.next+",["+this.args()+"])"}}),p=z.subClass({storer:1,post:function(){this.result=this.operands.pop()}}),I=Object.subClass({init:function(O,N){this.e=O;this.pc=N;this.ops=[];this.targets=[]},write:function(){var P=this.ops,N=[],O=0;while(O<P.length){N.push(P[O++].write())}return N.join(";")}}),C=I.subClass({write:function(){return"var l=e.l,m=e.m,s=e.s;\n"+this._super()}}),M=function(O,P,N){var N=N||{};if(P){N.func=P}return O.subClass(N)};var y=IFF.subClass({init:function(O){this._super(O);if(O){if(this.type!="IFZS"){throw new Error("Not a Quetzal savefile")}for(var P=0,N=this.chunks.length;P<N;P++){var Q=this.chunks[P].type,R=this.chunks[P].data;if(Q=="CMem"||Q=="UMem"){this.memory=R;this.compressed=(Q=="CMem")}else{if(Q=="Stks"){this.stacks=R}else{if(Q=="IFhd"){this.release=R.slice(0,2);this.serial=R.slice(2,8);this.checksum=R.slice(8,10);this.pc=R[10]<<16|R[11]<<8|R[12]}}}}}},write:function(){this.type="IFZS";var O=this.pc,N=this.release.concat(this.serial,this.checksum,(O>>16)&255,(O>>8)&255,O&255);this.chunks=[{type:"IFhd",data:N},{type:(this.compressed?"CMem":"UMem"),data:this.memory},{type:"Stks",data:this.stacks}];return this._super()}});var K=/\n/g,a=/\r/g,q=/"/g,x=/[\x00-\x0C\x0E-\x1F\x7F-\x9A\xFC-\uFFFF]/g,d=/[\x9B-\xFB]/g,r=Object.subClass({init:function(V){var S=V.m,P=S.getUint16(52),R=V.extension_table(3),N=R&&S.getUint8(R++),T,O=[],U=0,Q=96;this.e=V;this.make_alphabet(P?S.getBuffer(P,78):this.text_to_zscii("abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ*\r0123456789.,!?_#'\"/\\-:()"));this.make_unicode(R?S.getBuffer16(R,N):this.text_to_zscii(unescape("%E4%F6%FC%C4%D6%DC%DF%BB%AB%EB%E2%EA%EE%F4%FB%C2%CA%CE%D4%DB%EF%FF%CB%CF%E1%E9%ED%F3%FA%FD%C1%C9%CD%D3%DA%DD%E0%E8%EC%F2%F9%C0%C8%CC%D2%D9%E5%C5%F8%D8%E3%F1%F5%C3%D1%D5%E6%C6%E7%C7%FE%F0%DE%D0%A3%u0153%u0152%A1%BF"),1));T=S.getUint16(24);if(T){while(U<Q){O.push(this.decode(S.getUint16(T+2*U++)*2))}}this.abbr=O;this.dictionaries={};this.dict=S.getUint16(8);this.parse_dict(this.dict)},make_alphabet:function(O){var P=[[],[],[]],N=0;while(N<78){P[parseInt(N/26)][N%26]=O[N++]}this.alphabets=P},make_unicode:function(Q){var P={},N={10:13},O=0;while(O<Q.length){P[O+155]=Q[O];N[Q[O]]=155+O++}this.unicode_table=P;this.reverse_unicode_table=N},decode:function(U,O){var R=this.e.m,V=U,N,Q=[],S=0,T,P=0,W=[];if(this.e.jit[U]){return this.e.jit[U]}O=O||R.getUint16(26)*this.e.packing_multipler;while(U<O){N=R.getUint16(U);U+=2;Q.push(N>>10&31,N>>5&31,N&31);if(N&32768){break}}while(S<Q.length){T=Q[S++];if(T==0){W.push(32)}else{if(T<4){W=W.concat(this.abbr[32*(T-1)+Q[S++]])}else{if(T<6){P=T}else{if(P==2&&T==6){W.push(Q[S++]<<5|Q[S++])}else{W.push(this.alphabets[P][T-6])}}}}P=P<4?0:P-3}if(this.abbr){W=new String(this.zscii_to_text(W));W.pc=U;this.e.jit[V]=W;if(V<this.e.staticmem){console.warn("Caching a string in dynamic memory: "+V)}}return W},escape:function(N){return N.replace(K,"\\n").replace(q,'\\"')},zscii_to_text:function(O){var N=this.unicode_table;return String.fromCharCode.apply(this,O).replace(x,"").replace(a,"\n").replace(d,function(P){return String.fromCharCode(N[P.charCodeAt(0)]||63)})},text_to_zscii:function(R,Q){var S=[],O=0,N=R.length,P;Q=!Q;while(O<N){P=R.charCodeAt(O++);if(Q&&P!=13&&(P<32||P>126)){P=this.reverse_unicode_table[P]||63}S.push(P)}return S},parse_dict:function(V){var T=this.e.m,R=V,Q={},P,N,U,O,P=T.getUint8(V++),S=this.zscii_to_text(T.getBuffer(V,P));Q.lexer_pattern=new RegExp("["+S+"]|\\b\\S{1,9}(?=\\S*?(\\b|["+S+"]))","g");V+=P;N=T.getUint8(V++);U=V+2+N*T.getUint16(V);V+=2;while(V<U){Q[this.decode(V,V+6)]=V;V+=N}this.dictionaries[R]=Q;return Q},tokenise:function(S,O,U){U=U||this.dict;U=this.dictionaries[U]||this.parse_dict(U);var T=this.e.m,P=0,N=T.getUint8(O),Q=U.lexer_pattern,R;Q.lastIndex=0;S=S.toLowerCase();while(P<N&&(R=Q.exec(S))){T.setUint16(O+2+P*4,U[R[0]]||0);T.setUint8(O+4+P*4,R[0].length);T.setUint8(O+5+P++*4,R.index)}T.setUint8(O+1,P)}});var t=Object.subClass({init:function(N){this.e=N;this.buffer="";this.styles={};this.streams=[1,0,[],0]},flush:function(){var N;if(this.buffer!=""){N=k({},this.styles);this.e.orders.push({code:"print",css:N,text:this.buffer});this.buffer=""}},print:function(N){if(this.streams[2].length){this.streams[2][0][1]+=N}else{if(this.streams[0]){this.buffer+=N}}},set_style:function(N){var O=this.styles;this.flush();if(N==0){O.reverse=O["font-weight"]=O["font-style"]=O["font-family"]=""}if(N&1){O.reverse=1}if(N&2){O["font-weight"]="bold"}if(N&4){O["font-style"]="italic"}if(N&8){O["font-family"]="monospace"}},output_stream:function(P,Q){P=this.e.U2S(P);if(P==1){this.streams[0]=1}if(P==-1){this.streams[0]=0}if(P==3){this.streams[2].unshift([Q,""])}if(P==-3){var N=this.streams[2].shift(),O=this.e.text.text_to_zscii(N[1]);this.e.m.setUint16(N[0],O.length);this.e.m.setBuffer(N[0]+2,O)}}});var b=function(N){return N.write()},n=M(F,function(){return 1}),B=j.subClass({write:function(P){var N=arguments.length,O=this.v;if(O.write||O==0){P=P&&P.write?P.write():P;O=O.write?O.write():O;return"e.indirect("+O+(N?","+P:"")+")"}return this._super(P)}}),s=o.subClass({storer:0,post:function(){var N=this.operands;N[0]=new B(this.e,N[0] instanceof j?N[0]:N[0].v);this.storer=this.code==142?N.pop():N.shift();if(N.length==0){N.push(new j(this.e,0))}},func:b}),E={1:M(F,function(){return arguments.length==2?this.args("=="):"e.jeq("+this.args()+")"}),2:M(F,function(O,N){return O.U2S()+"<"+N.U2S()}),3:M(F,function(O,N){return O.U2S()+">"+N.U2S()}),4:M(F,function(N,O){return"e.U2S(e.incdec("+N.write()+",-1))<"+O.U2S()}),5:M(F,function(N,O){return"e.U2S(e.incdec("+N.write()+",1))>"+O.U2S()}),6:M(F,function(){return"e.jin("+this.args()+")"}),7:M(F,function(){return"e.test("+this.args()+")"}),8:M(o,function(){return this.args("|")}),9:M(o,function(){return this.args("&")}),10:M(F,function(){return"e.test_attr("+this.args()+")"}),11:M(i,function(){return"e.set_attr("+this.args()+")"}),12:M(i,function(){return"e.clear_attr("+this.args()+")"}),13:s,14:M(i,function(){return"e.insert_obj("+this.args()+")"}),15:M(o,function(O,N){return"m.getUint16("+O.write()+"+2*"+N.U2S()+")"}),16:M(o,function(O,N){return"m.getUint8("+O.write()+"+"+N.U2S()+")"}),17:M(o,function(){return"e.get_prop("+this.args()+")"}),18:M(o,function(){return"e.find_prop("+this.args()+")"}),19:M(o,function(){return"e.find_prop("+this.args(",0,")+")"}),20:M(o,function(){return"e.S2U("+this.args("+")+")"}),21:M(o,function(){return"e.S2U("+this.args("-")+")"}),22:M(o,function(){return"e.S2U("+this.args("*")+")"}),23:M(o,function(O,N){return"e.S2U(parseInt("+O.U2S()+"/"+N.U2S()+"))"}),24:M(o,function(O,N){return"e.S2U("+O.U2S()+"%"+N.U2S()+")"}),25:p,26:z,128:M(F,function(N){return N.write()+"==0"}),129:M(A,function(N){return this.storer.write("e.get_lilsis("+N.write()+")")}),130:M(A,function(N){return this.storer.write("e.get_child("+N.write()+")")}),131:M(o,function(N){return"e.get_parent("+N.write()+")"}),132:M(o,function(N){return"e.get_prop_len("+N.write()+")"}),133:M(i,function(N){return"e.incdec("+N.write()+",1)"}),134:M(i,function(N){return"e.incdec("+N.write()+",-1)"}),135:M(i,function(N){return"e.print(e.text.decode("+N.write()+"))"}),136:p,137:M(i,function(N){return"e.remove_obj("+N.write()+")"}),138:M(i,function(N){return"e.print(e.text.decode(m.getUint16(e.objects+14*"+N.write()+"+13)))"}),139:M(v,function(N){return"e.ret("+N.write()+")"}),140:M(v,function(N){return"e.pc="+N.U2S()+"+"+(this.next-2)+""}),141:M(i,function(N){return"e.print(e.text.decode("+N.write()+"*"+this.e.packing_multipler+"))"}),142:s.subClass({storer:1}),143:z,176:M(v,function(){return"e.ret(1)"}),177:M(v,function(){return"e.ret(0)"}),178:M(i,function(N){return'e.print("'+N+'")'},{printer:1}),179:M(v,function(N){return'e.print("'+N+'");e.ret(1)'},{printer:1}),180:i,183:M(v,function(){return'e.act("restart")'}),184:M(v,function(N){return"e.ret("+N.write()+")"},{post:function(){this.operands.push(new j(this.e,0))}}),186:M(v,function(){return'e.act("quit")'}),187:M(i,function(){return'e.print("\\n")'}),189:n,191:n,224:p,225:M(i,function(P,N,O){return"m.setUint16("+P.write()+"+2*"+N.U2S()+","+O.write()+")"}),226:M(i,function(P,N,O){return"m.setUint8("+P.write()+"+"+N.U2S()+","+O.write()+")"}),227:M(i,function(){return"e.put_prop("+this.args()+")"}),228:M(v,function(){var N=this.operands.pop();return"e.read("+this.args()+","+N.v+");e.pc="+this.next},{storer:1}),229:M(i,function(N){return"e.print(e.text.zscii_to_text(["+N.write()+"]))"}),230:M(i,function(N){return"e.print("+N.U2S()+")"}),231:M(o,function(N){return"e.random("+N.U2S()+")"}),232:M(o,b,{post:function(){this.storer=new j(this.e,0)},storer:0}),233:s,236:p,241:M(i,function(N){return"e.ui.set_style("+N.write()+")"}),243:M(i,function(){return"e.ui.output_stream("+this.args()+")"}),246:M(v,function(){return'e.act("quit")'}),248:M(o,function(N){return"e.S2U(~"+N.write()+")"}),249:z,250:z,255:M(F,function(N){return N.write()+"<=e.call_stack[0][4]"}),1002:M(o,function(O,N){return"e.S2U(e.log_shift("+O.write()+","+N.U2S()+"))"}),1003:M(o,function(O,N){return"e.S2U(e.art_shift("+O.U2S()+","+N.U2S()+"))"}),1009:M(o,function(){return"e.save_undo("+this.next+","+this.storer.v+")"}),1010:M(i,function(){return"if(e.restore_undo())return"},{storer:1}),1011:M(i,function(N){return"e.print(String.fromCharCode("+N.write()+"))"}),1012:M(o,function(){return 3}),1030:M(o,function(){return"e.gestalt("+this.args()+")"}),1031:M(o,function(){return"e.op_parchment("+this.args()+")"})};var w=function(Q,O){for(var P=0,N;P<Q.ops.length-1;P++){if(Q.ops[P].offset==O){N=new I(Q.e,Q.ops[P+1]);N.ops=Q.ops.slice(P+1);Q.ops.length=P+1;l(N.ops,N);Q.ops[P].result=N;Q.ops[P].invert=!Q.ops[P].invert;N.stopper=N.ops[N.ops.length-1].stopper;return 1}}},l=function(P,O){for(var N=0;N<P.length;N++){P[N].context=O}};var e=function(S){var T,P,Q=S.m,V,O,U,W,R,N=new C(S,S.pc);while(1){T=S.pc;P=T;O=Q.getUint8(T++);if(O==190){W=-1;O=Q.getUint8(T++)+1000}else{if(O&128){if(O&64){W=-1;if(!(O&32)){O&=31}}else{W=[(O&48)>>4];if(W[0]<3){O&=207}}}else{W=[O&64?2:1,O&32?2:1];O&=31}}if(!E[O]){g("Missing opcode #"+O+" at pc="+P);S.stop=1;console.log(N.write());throw Error}U=E[O].prototype;if(W==-1){W=[];h(Q.getUint8(T++),W);if(O==236||O==250){h(Q.getUint8(T++),W)}}R=[];V=0;while(V<W.length){if(W[V]==0){R.push(new L(S,Q.getUint16(T)));T+=2}if(W[V]==1){R.push(new L(S,Q.getUint8(T++)))}if(W[V++]==2){R.push(new j(S,Q.getUint8(T++)))}}if(U.storer){R.push(new j(S,Q.getUint8(T++)))}if(U.brancher){V=Q.getUint8(T++);R.push([V&128,V&64?V&63:((V=(V<<8)|Q.getUint8(T++))&8192?~8191:0)|(V&8191)])}if(U.printer){V=S.text.decode(T);R.push(S.text.escape(V));T=V.pc}S.pc=T;N.ops.push(new E[O](S,N,O,P,T,R));V=0;if(N.targets.indexOf(T)>=0){V=w(N,T)}if(U.stopper&&V==0){break}}return N},h=function(O,P){for(var N=0;N<4;N++){P.push((O&192)>>6);O<<=2}};D.ZVM=Object.subClass({art_shift:function(O,N){return N>0?O<<N:O>>-N},call:function(T,N,R,P){var Q,O,S=P.length;this.pc=T*this.packing_multipler;O=this.m.getUint8(this.pc++);P=P.slice(0,O);for(Q=P.length;Q<O;Q++){P.push(0)}this.l=P.concat(this.l);this.call_stack.unshift([R,N,O,this.s.length,S])},clear_attr:function(N,O){var P=this.objects+14*N+parseInt(O/8);this.m.setUint8(P,this.m.getUint8(P)&~(128>>O%8))},extension_table:function(O,N){var P=this.extension;if(!P||O>this.extension_count){return 0}P+=2*O;if(N==m){return this.m.getUint16(P)}this.e.setUint16(P,N)},find_prop:function(N,R,Q){var U=this.m,T,S,P=0,O=U.getUint16(this.objects+14*N+12);O+=U.getUint8(O)*2+1;T=U.getUint8(O);S=T&63;if(Q==0){return S}while(1){if(P==Q){return S}if(S==R){return O+(T&128?2:1)}if(S<R){return 0}P=S;if(T&128){S=U.getUint8(O+1)&63;O+=S?S+2:66}else{O+=T&64?3:2}T=U.getUint8(O);S=T&63}},get_bigsis:function(P){var O=this.get_child(this.get_parent(P)),N;if(O==P){return 0}while(1){N=this.get_lilsis(O);if(N==P){return O}}},get_child:function(N){return this.m.getUint16(this.objects+14*N+10)},get_family:function(O){var N=this.get_parent(O);return N?[N,this.get_child(N),this.get_lilsis(O),this.get_bigsis(O)]:[0]},get_lilsis:function(N){return this.m.getUint16(this.objects+14*N+8)},get_parent:function(N){return this.m.getUint16(this.objects+14*N+6)},get_prop:function(N,O){var Q=this.m,P=this.find_prop(N,O);if(P){return(Q.getUint8(P-1)&64?Q.getUint16:Q.getUint8)(P)}return Q.getUint16(this.properties+2*(O-1))},get_prop_len:function(O){if(O==0){return 0}var N=this.m.getUint8(O-1);if(N&128){N&=63;return N==0?64:N}return N&64?2:1},incdec:function(O,Q){var N,P;if(O==0){N=this.S2U(this.s.pop()+Q);this.s.push(N);return N}if(O<16){return this.l[O-1]=this.S2U(this.l[O-1]+Q)}else{P=this.globals+(O-16)*2;return this.m.setUint16(P,this.m.getUint16(P)+Q)}},indirect:function(N,O){if(N==0){if(arguments.length>1){return this.s[this.s.length-1]=O}else{return this.s[this.s.length-1]}}return this.variable(N,O)},insert_obj:function(O,N){this.remove_obj(O);this.set_family(O,N,N,O,O,this.get_child(N))},jeq:function(){var N=1,O;while(N<arguments.length){if(arguments[N++]==arguments[0]){O=1}}return O},jin:function(O,N){return this.get_parent(O)==N},log_shift:function(O,N){return N>0?O<<N:O>>>-N},print:function(N){this.ui.print(N)},put_prop:function(N,P,O){var R=this.m,Q=this.find_prop(N,P);(R.getUint8(Q-1)&64?R.setUint16:R.setUint8)(Q,O)},random:function(N){var O;if(N<1){this.random_state=Math.abs(N);this.random_seq=0;return 0}if(this.random_state==0){return parseInt(Math.random()*N)+1}else{this.random_seq++;if(this.random_seq>this.random_state){this.random_seq=1}return this.random_seq%N}},read:function(R,Q,P,N,O){if(arguments.length==3){O=P;P=N=0}this.act("read",{text:R,parse:Q,len:this.m.getUint8(R),initiallen:this.m.getUint8(R+1),time:P,routine:N,storer:O})},remove_obj:function(O){var N=this.get_family(O);if(N[0]==0){return}if(N[1]==O){this.set_family(O,0,N[0],N[2])}else{this.set_family(O,0,0,0,N[3],N[2])}},restore_undo:function(){if(this.undo.length==0){return 0}var N=this.undo.pop();this.pc=N[0];this.m.setBuffer(0,N[2]);this.l=N[3];this.s=N[4];this.call_stack=N[5];this.variable(N[1],2);return 1},ret:function(N){var P=this.call_stack.shift(),O=P[1];this.pc=P[0];this.l=this.l.slice(P[2]);this.s.length=P[3];if(O>=0){this.variable(O,N)}},save_undo:function(O,N){this.undo.push([O,N,this.m.getBuffer(0,this.staticmem),this.l.slice(),this.s.slice(),this.call_stack.slice()]);return 1},set_attr:function(N,O){var P=this.objects+14*N+parseInt(O/8);this.m.setUint8(P,this.m.getUint8(P)|128>>O%8)},set_family:function(P,Q,O,S,N,R){this.m.setUint16(this.objects+14*P+6,Q);if(O){this.m.setUint16(this.objects+14*O+10,S)}if(N){this.m.setUint16(this.objects+14*N+8,R)}},test:function(O,N){return O&N==N},test_attr:function(N,O){return(this.m.getUint8(this.objects+14*N+parseInt(O/8))<<O%8)&128},variable:function(O,P){var N=P!==m;if(O==0){if(N){this.s.push(P)}else{return this.s.pop()}}else{if(O<16){if(N){this.l[O-1]=P}else{return this.l[O-1]}}else{if(N){this.m.setUint16(this.globals+(O-16)*2,P)}else{this.m.getUint16(this.globals+(O-16)*2)}}}return P},U2S:J,S2U:f,init:function(){this.jit={}},load:function(N){this.data=N},restart:function(){var Q=G(this.data),N=Q.getUint8(0),O=Q.getUint16(10),P=Q.getUint16(54);if(N!=5&&N!=8){throw new Error("Unsupported Z-Machine version: "+data[0])}k(this,{m:Q,s:[],l:[],call_stack:[],undo:[],random_state:0,orders:[],version:N,pc:Q.getUint16(6),properties:O,objects:O+112,globals:Q.getUint16(12),staticmem:Q.getUint16(14),extension:P,extension_count:P?Q.getUint16(P):0,packing_multipler:N==5?4:8});k(this,{ui:new t(this),text:new r(this)});Q.setUint8(1,29);Q.setUint8(16,Q.getUint8(16)&87);Q.setUint8(50,1);Q.setUint8(51,H?2:0)},run:function(){var O=Date.now(),N;this.orders=[];this.stop=0;while(!this.stop){N=this.pc;if(!this.jit[N]){this.compile()}this.jit[N](this);if((Date.now()-O)>5000){this.act("tick");return}}},compile:function(){var N=e(this),O=N.write();this.jit[N.pc]=new Function("e",O);if(N.pc<this.staticmem){console.warn("Caching a JIT function in dynamic memory: "+N.pc)}},act:function(O,N){var N=N||{};this.ui.flush();N.code=O;this.orders.push(N);this.stop=1},event:function(O){var P=this.m,N;if(O.code=="read"){this.variable(O.storer,O.terminator);N=O.response;if(N.length>O.len){N=N.slice(0,O.len)}P.setUint8(O.text+1,N.length);P.setBuffer(O.text+2,this.text.text_to_zscii(N));if(O.parse){this.text.tokenise(N,O.parse)}this.print(N+"\n")}}})})(this);
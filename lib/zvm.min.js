/*

ZVM - the ifvms.js implementation of the Z-Machine
==================================================

Built: 2013-04-04

Copyright (c) 2011-2013 The ifvms.js team
BSD licenced
http://github.com/curiousdannii/ifvms.js

*/
(function(e,t){"use strict";[].indexOf||(Array.prototype.indexOf=function(e,t){for(var r=t||0,n=this.length;n>r;r++)if(this[r]===e)return r;return-1});var r=function(e,t){for(var r in t)e[r]=t[r];return e},n=e.console||{log:function(){},info:function(){},warn:function(){}},i=function(e){return e<<16>>16},s=function(e){return 65535&e},a=function(e){for(var t=0,r=e.length,n=[];r>t;)n[t/2]=e[t++]<<8|e[t++];return n},o=function(e){return e.replace(/(e\.)?U2S\(([^(]+?)\)/g,"(($2)<<16>>16)").replace(/(e\.)?S2U\(([^(]+?)\)/g,"(($2)&65535)").replace(/([\w.]+)\.getUint8\(([^(]+?)\)/g,"$1[$2]").replace(/([\w.]+)\.getUint16\(([^(]+?)\)/g,"($1[$2]<<8|$1[$2+1])")},_=function(t,n){var i,s,a=[];for(i in t)n.indexOf(i)>=0&&(s=/function\s*\(([^(]*)\)\s*\{([\s\S]+)\}/.exec(""+t[i]),a.push(i+":function("+s[1]+"){"+o(s[2])+"}"));r(t,e.eval("({"+a.join()+"})"))},l,u,c=0,f=c?function(e){var t=new ArrayBuffer(e);return e=new DataView(t),e.buffer=t,e}:function(e){return e=e.slice(),r(e,{data:e,getUint8:function(t){return e[t]},getUint16:function(t){return e[t]<<8|e[t+1]},getBuffer:function(t,r){return e.slice(t,t+r)},getBuffer16:function(t,r){return a(e.slice(t,t+2*r))},setUint8:function(t,r){return e[t]=255&r},setUint16:function(t,r){return e[t]=255&r>>8,e[t+1]=255&r,65535&r},setBuffer:function(t,r){for(var n=0,i=r.length;i>n;)e[n+t]=r[n++]}})},d,h=Object.subClass({init:function(e,t){this.e=e,this.v=t},toString:function(){return this.v},U2S:function(){return i(this.v)}}),p=h.subClass({toString:function(){var e=this.v;return this.indirect?"e.indirect("+e+")":0===e?"s.pop()":15>--e?"l["+e+"]":"m.getUint16("+(this.e.globals+2*(e-15))+")"},store:function(e){var t=this.v;return this.indirect?"e.indirect("+t+","+e+")":this.returnval?"e.variable("+t+","+e+")":0===t?"s.push("+e+")":15>--t?"l["+t+"]="+e:"m.setUint16("+(this.e.globals+2*(t-15))+","+e+")"},U2S:function(){return"e.U2S("+this+")"}}),g=Object.subClass({init:function(e,t,r,n,i,s){this.e=e,this.context=t,this.code=r,this.pc=n,this.labels=[this.pc+"/"+this.code],this.next=i,this.operands=s,this.post&&this.post()},toString:function(){return this.label()+(this.func?this.func.apply(this,this.operands):"")},args:function(e){return this.operands.join(e)},label:function(){return"/* "+this.labels.join()+" */ "}}),m=g.subClass({stopper:1}),v=m.subClass({storer:1,post:function(){this.storer=this.operands.pop(),this.origfunc=this.func,this.func=this.newfunc},newfunc:function(){return"e.pc="+this.next+";"+this.origfunc.apply(this,arguments)}}),w=Object.subClass({init:function(e,t){this.ops=e||[],this.code=t||"||"},toString:function(){for(var e,t=0,r=[];this.ops.length>t;)e=this.ops[t++],r.push(e.func?(e.iftrue?"":"!(")+e.func.apply(e,e.operands)+(e.iftrue?"":")"):e);return(this.invert?"(!(":"(")+r.join(this.code)+(this.invert?"))":")")}}),y=g.subClass({brancher:1,keyword:"if",post:function(){var e,t,r=this.operands.pop(),n=r[1];this.iftrue=r[0],0===n||1===n?e="e.ret("+n+")":(n+=this.next-2,this.context.targets.push(n),e="e.pc="+n),this.result=e+"; return",this.offset=n,this.cond=new w([this]),this.context.ops.length&&(t=this.context.ops.pop(),t.offset===n?(this.cond.ops.unshift(t.cond),this.labels=t.labels,this.labels.push(this.pc+"/"+this.code)):this.context.ops.push(t))},toString:function(){var e=this.result;return e instanceof F&&(e+=e.stopper?"; return":"",this.result.ops.length>1&&(e="\n"+e+"\n")),this.label()+this.keyword+this.cond+" {"+e+"}"}}),b=y.subClass({storer:1,post:function(){this._super(),this.storer=this.operands.pop(),this.storer.returnval=1,this.origfunc=this.func,this.func=this.newfunc},newfunc:function(){return this.storer.store(this.origfunc.apply(this,arguments))}}),k=g.subClass({storer:1,post:function(){this.storer=this.operands.pop()},toString:function(){var e=this._super();return this.storer?this.storer.store(e):e}}),x=m.subClass({result:{v:-1},toString:function(){return this.label()+"e.call("+this.operands.shift()+","+this.result.v+","+this.next+",["+this.args()+"])"}}),S=x.subClass({storer:1,post:function(){this.result=this.operands.pop()}}),F=Object.subClass({init:function(e,t){this.e=e,this.pc=t,this.pre=[],this.ops=[],this.post=[],this.targets=[]},toString:function(){return this.pre.join("")+this.ops.join(";")+this.post.join("")}}),C=F.subClass({toString:function(){return this.pre.unshift("var l=e.l,m=e.m,s=e.s;\n"),this._super()}}),M=function(e,t,r){return r=r||{},t&&(r.func=t),e.subClass(r)},T=IFF.subClass({init:function(e){if(this._super(e),e){if("IFZS"!==this.type)throw Error("Not a Quetzal savefile");for(var t=0,r=this.chunks.length;r>t;t++){var n=this.chunks[t].type,i=this.chunks[t].data;"CMem"===n||"UMem"===n?(this.memory=i,this.compressed="CMem"===n):"Stks"===n?this.stacks=i:"IFhd"===n&&(this.release=i.slice(0,2),this.serial=i.slice(2,8),this.checksum=i.slice(8,10),this.pc=i[10]<<16|i[11]<<8|i[12])}}},write:function(){this.type="IFZS";var e=this.pc,t=this.release.concat(this.serial,this.checksum,255&e>>16,255&e>>8,255&e);return this.chunks=[{type:"IFhd",data:t},{type:this.compressed?"CMem":"UMem",data:this.memory},{type:"Stks",data:this.stacks}],this._super()}}),E=function(){for(var e={8:8,13:13,27:27,37:131,38:129,39:132,40:130},t=96;106>t;)e[t]=49+t++;for(t=112;124>t;)e[t]=21+t++;return e}(),A=Object.subClass({init:function(e){var t,r=e.m,n=r.getUint16(52),i=e.extension_table(3),s=i&&r.getUint8(i++),a=[],o=0,_=96;if(this.e=e,this.maxaddr=r.getUint16(26)*e.addr_multipler,this.make_alphabet(n?r.getBuffer(n,78):this.text_to_zscii("abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ \r0123456789.,!?_#'\"/\\-:()",1)),this.make_unicode(i?r.getBuffer16(i,s):this.text_to_zscii(unescape("%E4%F6%FC%C4%D6%DC%DF%BB%AB%EB%EF%FF%CB%CF%E1%E9%ED%F3%FA%FD%C1%C9%CD%D3%DA%DD%E0%E8%EC%F2%F9%C0%C8%CC%D2%D9%E2%EA%EE%F4%FB%C2%CA%CE%D4%DB%E5%C5%F8%D8%E3%F1%F5%C3%D1%D5%E6%C6%E7%C7%FE%F0%DE%D0%A3%u0153%u0152%A1%BF"),1)),t=r.getUint16(24))for(;_>o;)a.push(this.decode(2*r.getUint16(t+2*o++),0,1));this.abbr=a,this.dictionaries={},this.dict=r.getUint16(8),this.parse_dict(this.dict)},make_alphabet:function(e){for(var t=[[],[],[]],r=0;78>r;)t[0|r/26][r%26]=e[r++];t[2][1]=13,this.alphabets=t},make_unicode:function(e){for(var t={13:"\n"},r={10:13},n=0;e.length>n;)t[155+n]=String.fromCharCode(e[n]),r[e[n]]=155+n++;for(n=32;127>n;)t[n]=String.fromCharCode(n),r[n]=n++;this.unicode_table=t,this.reverse_unicode_table=r},decode:function(e,t,r){var i,s,a,o,_=this.e.m,l=e,u=[],c=0,f=0,d=[],h=[],p=0;if(this.e.jit[e])return this.e.jit[e];for(t=t?t+e:this.maxaddr;t>e&&(i=_.getUint16(e),e+=2,u.push(31&i>>10,31&i>>5,31&i),!(32768&i)););for(;u.length>c;){if(s=u[c++],0===s)d.push(32);else if(4>s)d.push(-1),h.push(this.abbr[32*(s-1)+u[c++]]);else if(6>s)f=s;else if(2===f&&6===s){if(u.length>c+1)if(a=u[c++]<<5|u[c++],768>a)d.push(a);else{for(a-=767,p+=a,o=c,c=c%3+3;a--;)d.push(-1),h.push(String.fromCharCode(u[c]<<10|u[c+1]<<5|u[c+2])),u[c++]=u[c++]=u[c++]=32;c=o}}else 32>s&&d.push(this.alphabets[f][s-6]);f=4>f?0:f-3,0===c%3&&(c+=p,p=0)}return d=new String(this.zscii_to_text(d,h)),d.pc=e,this.e.jit[l]=d,!r&&this.e.staticmem>l&&n.warn("Caching a string in dynamic memory: "+l),d},encode:function(e){for(var r,n,i=this.alphabets,s=[],a=0,o=[];9>s.length;)r=e[a++],32===r?s.push(0):(n=i[0].indexOf(r))>=0?s.push(n+6):(n=i[1].indexOf(r))>=0?s.push(4,n+6):(n=i[2].indexOf(r))>=0?s.push(5,n+6):(n=this.reverse_unicode_table[r])?s.push(5,6,n>>5,31&n):r===t&&s.push(5);for(s.length=9,a=0;9>a;)o.push(s[a++]<<2|s[a]>>3,(7&s[a++])<<5|s[a++]);return o[4]|=128,o},zscii_to_text:function(e,t){for(var r,n=0,i=e.length,s=0,a="";i>n;)r=e[n++],-1===r&&(a+=t[s++]),(r=this.unicode_table[r])&&(a+=r);return a},text_to_zscii:function(e,t){for(var r,n=[],i=0,s=e.length;s>i;)r=e.charCodeAt(i++),t||(r=this.reverse_unicode_table[r]||63),n.push(r);return n},parse_dict:function(e){var t,r,n=this.e.m,i=e,s={},a=n.getUint8(e++);for(s.separators=n.getBuffer(e,a),e+=a,t=n.getUint8(e++),r=e+2+t*n.getUint16(e),e+=2;r>e;)s[""+n.getBuffer(e,6)]=e,e+=t;return this.dictionaries[i]=s,s},tokenise:function(e,t,r,n){r=r||this.dict,r=this.dictionaries[r]||this.parse_dict(r);for(var i,s,a=this.e.m,o=2,_=o+a.getUint8(e+1),l=r.separators,u=[],c=[],f=o,d=0;_>o;)i=a.getUint8(e+o++),32===i||l.indexOf(i)>=0?(u.length&&(c.push([u,f]),f+=u.length,u=[]),32!==i&&c.push([[i],f]),f++):u.push(i);for(u.length&&c.push([u,f]),s=Math.min(c.length,a.getUint8(t));s>d;)u=r[""+this.encode(c[d][0])],(!n||u)&&(a.setUint16(t+2+4*d,u||0),a.setUint8(t+4+4*d,c[d][0].length),a.setUint8(t+5+4*d,c[d][1])),d++;a.setUint8(t+1,d)},keyinput:function(e){var t=e.charCode,r=e.keyCode;return E[r]?E[r]:this.reverse_unicode_table[t]||63}}),U=function(e){var t=function(t,r){for(var n in r)r[n]!==e&&(t[n]=r[n]);return t},r=[65534,65535,0,29,832,957,22944,31775,30624,32767,23254,17969,11627],n=function(e){var t=Math.round(8.226*(31&e))<<16|Math.round(8.226*((992&e)>>5))<<8|Math.round(8.226*((31744&e)>>10));for(t=t.toString(16);6>t.length;)t="0"+t;return"#"+t};return Object.subClass({colours:r,init:function(e,t){this.e=e,this.buffer="",this.styles={},this.env={fgcolour:e.env.fgcolour||"#000",bgcolour:e.env.bgcolour||"#fff"},this.mono=t,this.currentwin=0,this.status=[],e.orders.push({code:"stream",name:"status"},{code:"stream",name:"main"},{code:"find",name:"main"})},clear_window:function(){this.e.orders.push({code:"clear",name:"main",css:t({},this.styles)})},convert_RGB:function(e){var t,r=Math.round,n=/(\d+),\s*(\d+),\s*(\d+)|#(\w{1,2})(\w{1,2})(\w{1,2})/.exec(e);return n[1]?t=[n[1],n[2],n[3]]:(t=[parseInt(n[4],16),parseInt(n[5],16),parseInt(n[6],16)],4===e.length&&(t=[t[0]<<4|t[0],t[1]<<4|t[1],t[2]<<4|t[2]])),r(t[2]/8.226)<<10|r(t[1]/8.226)<<5|r(t[0]/8.226)},erase_line:function(e){1===e&&(this.flush(),this.status.push({code:"eraseline"}))},erase_window:function(e){this.flush(),1>e&&this.clear_window(),-1===e&&this.split_window(0),(-2===e||1===e)&&this.status.push({code:"clear"})},flush:function(){var e;""!==this.buffer&&(e={code:"stream",css:t({},this.styles),text:this.buffer},this.mono&&(e.node="tt"),(this.currentwin?this.status:this.e.orders).push(e),this.buffer="")},get_cursor:function(e){this.status.push({code:"get_cursor",addr:e}),this.e.act()},set_colour:function(e,t){this.set_true_colour(r[e],r[t])},set_cursor:function(e,t){this.flush(),this.status.push({code:"cursor",to:[e-1,t-1]})},set_font:function(e){if(1!==e&&4!==e)return 0;var t=4&this.mono?4:1;return e!==t&&(this.flush(),this.mono^=4),t},set_style:function(t){var r,n,i=this.styles;this.flush(),0===t&&(r=this.reverse,this.reverse=i["font-weight"]=i["font-style"]=e,this.mono&=254),1&t&&(r=!this.reverse,this.reverse=1),2&t&&(i["font-weight"]="bold"),4&t&&(i["font-style"]="italic"),8&t&&(this.mono|=1),r&&(n=i.color||this.env.fgcolour,i.color=i["background-color"]||this.env.bgcolour,i["background-color"]=n)},set_true_colour:function(t,r){var i,s=this.styles,a=s.color,o=s["background-color"];this.flush(),this.reverse&&(i=t,t=r,r=i),65535===t?a=e:32768>t&&(a=n(t)),65535===r?o=e:32768>r&&(o=n(r)),this.reverse&&(a=a||this.env.bgcolour,o=o||this.env.fgcolour),s.color=a,s["background-color"]=o},set_window:function(e){this.flush(),this.currentwin=e,this.e.orders.push({code:"find",name:e?"status":"main"}),e&&this.status.push({code:"cursor",to:[0,0]})},split_window:function(e){this.flush(),this.status.push({code:"height",lines:e})}})}(),R=function(e){return""+e},j=M(y,function(){return 1}),P=k.subClass({storer:0,post:function(){var e=this.operands,t=e[0],r=t instanceof p;e[0]=new p(this.e,r?t:t.v),(r||0===t.v)&&(e[0].indirect=1),this.storer=142===this.code?e.pop():e.shift(),0===e.length&&e.push(new p(this.e,0))},func:R}),N=g.subClass({func:function(e){var t=e.v-1,r=this.code%2?1:-1;return e instanceof p||t>14?"e.incdec("+e+","+r+")":(0>t?"e.s[e.s.length-1]=e.S2U(e.s[e.s.length-1]+":"e.l["+t+"]=e.S2U(e.l["+t+"]+")+r+")"}}),Z={1:M(y,function(){return 2===arguments.length?this.args("==="):"e.jeq("+this.args()+")"}),2:M(y,function(e,t){return e.U2S()+"<"+t.U2S()}),3:M(y,function(e,t){return e.U2S()+">"+t.U2S()}),4:M(y,function(e,t){return"e.U2S(e.incdec("+e+",-1))<"+t.U2S()}),5:M(y,function(e,t){return"e.U2S(e.incdec("+e+",1))>"+t.U2S()}),6:M(y,function(){return"e.jin("+this.args()+")"}),7:M(y,function(){return"e.test("+this.args()+")"}),8:M(k,function(){return this.args("|")}),9:M(k,function(){return this.args("&")}),10:M(y,function(){return"e.test_attr("+this.args()+")"}),11:M(g,function(){return"e.set_attr("+this.args()+")"}),12:M(g,function(){return"e.clear_attr("+this.args()+")"}),13:P,14:M(g,function(){return"e.insert_obj("+this.args()+")"}),15:M(k,function(e,t){return"m.getUint16(e.S2U("+e+"+2*"+t.U2S()+"))"}),16:M(k,function(e,t){return"m.getUint8(e.S2U("+e+"+"+t.U2S()+"))"}),17:M(k,function(){return"e.get_prop("+this.args()+")"}),18:M(k,function(){return"e.find_prop("+this.args()+")"}),19:M(k,function(){return"e.find_prop("+this.args(",0,")+")"}),20:M(k,function(){return"e.S2U("+this.args("+")+")"}),21:M(k,function(){return"e.S2U("+this.args("-")+")"}),22:M(k,function(){return"e.S2U("+this.args("*")+")"}),23:M(k,function(e,t){return"e.S2U(parseInt("+e.U2S()+"/"+t.U2S()+"))"}),24:M(k,function(e,t){return"e.S2U("+e.U2S()+"%"+t.U2S()+")"}),25:S,26:x,27:M(g,function(){return"e.ui.set_colour("+this.args()+")"}),28:M(m,function(e,t){return"while(e.call_stack.length>"+t+"){e.call_stack.shift()}e.ret("+e+")"}),128:M(y,function(e){return e+"===0"}),129:M(b,function(e){return"e.get_sibling("+e+")"}),130:M(b,function(e){return"e.get_child("+e+")"}),131:M(k,function(e){return"e.get_parent("+e+")"}),132:M(k,function(e){return"e.get_prop_len("+e+")"}),133:N,134:N,135:M(g,function(e){return"e.print(e.text.decode("+e+"))"}),136:S,137:M(g,function(e){return"e.remove_obj("+e+")"}),138:M(g,function(e){return"e.print_obj("+e+")"}),139:M(m,function(e){return"return "+e}),140:M(m,function(e){return"e.pc="+e.U2S()+"+"+(this.next-2)}),141:M(g,function(e){return"e.print(e.text.decode("+e+"*"+this.e.addr_multipler+"))"}),142:P.subClass({storer:1}),143:x,176:M(m,function(){return"return 1"}),177:M(m,function(){return"return 0"}),178:M(g,function(e){return'e.print("'+e+'")'},{printer:1}),179:M(m,function(e){return'e.print("'+e+'\\n");return 1'},{printer:1}),180:g,183:M(m,function(){return'e.act("restart")'}),184:M(m,function(e){return"return "+e},{post:function(){this.operands.push(new p(this.e,0))}}),185:M(k,function(){return"e.call_stack.length"}),186:M(m,function(){return'e.act("quit")'}),187:M(g,function(){return'e.print("\\n")'}),189:j,191:j,224:S,225:M(g,function(e,t,r){return"m.setUint16(e.S2U("+e+"+2*"+t.U2S()+"),"+r+")"}),226:M(g,function(e,t,r){return"m.setUint8(e.S2U("+e+"+"+t.U2S()+"),"+r+")"}),227:M(g,function(){return"e.put_prop("+this.args()+")"}),228:M(v,function(){return"e.read("+this.args()+","+this.storer.v+")"}),229:M(g,function(e){return"e.print(e.text.zscii_to_text(["+e+"]))"}),230:M(g,function(e){return"e.print("+e.U2S()+")"}),231:M(k,function(e){return"e.random("+e.U2S()+")"}),232:M(k,R,{post:function(){this.storer=new p(this.e,0)},storer:0}),233:P,234:M(g,function(e){return"e.ui.split_window("+e+")"}),235:M(g,function(e){return"e.ui.set_window("+e+")"}),236:S,237:M(g,function(e){return"e.ui.erase_window("+e.U2S()+")"}),238:M(g,function(e){return"e.ui.erase_line("+e+")"}),239:M(g,function(){return"e.ui.set_cursor("+this.args()+")"}),240:M(v,function(e){return"e.ui.get_cursor("+e+")"}),241:M(g,function(e){return"e.ui.set_style("+e+")"}),242:g,243:M(g,function(){return"e.output_stream("+this.args()+")"}),244:g,245:g,246:M(v,function(){return"e.read_char("+(this.args()||"1")+","+this.storer.v+")"}),247:M(b,function(){return"e.scan_table("+this.args()+")"}),248:M(k,function(e){return"e.S2U(~"+e+")"}),249:x,250:x,251:M(g,function(){return"e.text.tokenise("+this.args()+")"}),252:M(g,function(){return"e.encode_text("+this.args()+")"}),253:M(g,function(){return"e.copy_table("+this.args()+")"}),254:M(g,function(){return"e.print_table("+this.args()+")"}),255:M(y,function(e){return e+"<=e.call_stack[0][4]"}),1e3:M(v,function(){return"e.save("+(this.next-1)+","+this.storer.v+")"}),1001:M(v,function(){return'e.act("restore",{storer:'+this.storer.v+"})"}),1002:M(k,function(e,t){return"e.S2U(e.log_shift("+e+","+t.U2S()+"))"}),1003:M(k,function(e,t){return"e.S2U(e.art_shift("+e.U2S()+","+t.U2S()+"))"}),1004:M(k,function(e){return"e.ui.set_font("+e+")"}),1009:M(k,function(){return"e.save_undo("+this.next+","+this.storer.v+")"}),1010:M(g,function(){return"if(e.restore_undo())return"},{storer:1}),1011:M(g,function(e){return"e.print(String.fromCharCode("+e+"))"}),1012:M(k,function(){return 3}),1013:M(g,function(){return"e.ui.set_true_colour("+this.args()+")"}),1014:g.subClass({brancher:1}),1030:M(k,function(){return"e.gestalt("+this.args()+")"})},G=function(e,t){for(var r,n,s,a,o,_=0;e.ops.length-1>_;){if(e.ops[_].offset===t){if(2===e.ops.length-_&&e.ops[_+1].offset)return a=e.ops.pop(),o=e.ops.pop(),o.cond.invert=!o.cond.invert,a.cond=new w([o.cond,a.cond],"&&"),a.labels=o.labels.concat(a.labels),e.ops.push(a),1;r=new F(e.e,e.ops[_+1].pc),r.ops=e.ops.slice(_+1),n=r.ops.length-1,e.ops.length=_+1,s=e.ops[_],s.result=r,s.cond.invert=!s.cond.invert,a=r.ops[n],140===a.code&&i(a.operands[0].v)+a.next-2===s.pc?(s.keyword="while",r.ops.pop()):r.stopper=a.stopper;return 1}_++}},q,B=function(e){for(var t,r,n,i,s,a,o,_=e.m,l=new C(e,e.pc);;){if(r=t=e.pc,i=_.getUint8(t++),190===i?(a=-1,i=_.getUint8(t++)+1e3):128&i?64&i?(a=-1,32&i||(i&=31)):(a=[(48&i)>>4],3>a[0]&&(i&=207)):(a=[64&i?2:1,32&i?2:1],i&=31),!Z[i])throw e.stop=1,Error("Unknown opcode #"+i+" at pc="+r);for(s=Z[i].prototype,-1===a&&(a=[],z(_.getUint8(t++),a),(236===i||250===i)&&z(_.getUint8(t++),a)),o=[],n=0;a.length>n;)0===a[n]&&(o.push(new h(e,_.getUint16(t))),t+=2),1===a[n]&&o.push(new h(e,_.getUint8(t++))),2===a[n++]&&o.push(new p(e,_.getUint8(t++)));if(s.storer&&o.push(new p(e,_.getUint8(t++))),s.brancher&&(n=_.getUint8(t++),o.push([128&n,64&n?63&n:(n<<8|_.getUint8(t++))<<18>>18])),s.printer&&(n=e.text.decode(t),o.push(n.replace(/\\/g,"\\\\").replace(/\n/g,"\\n").replace(/"/g,'\\"')),t=n.pc),e.pc=t,l.ops.push(new Z[i](e,l,i,r,t,o)),n=0,l.targets.indexOf(t)>=0&&(n=G(l,t)),s.stopper&&!n)break}return l},z=function(e,t){for(var r=0;4>r;r++)t.push((192&e)>>6),e<<=2};e.ZVM=Object.subClass({art_shift:function(e,t){return t>0?e<<t:e>>-t},call:function(e,t,r,n){var i,s,a=this.l.length,o=n.length;for(this.pc=e*this.addr_multipler,s=this.m.getUint8(this.pc++),n=n.slice(0,s),i=n.length;s>i;i++)n.push(0);this.l=n.concat(this.l),this.call_stack.unshift([r,t,s,this.s.length,o,a])},clear_attr:function(e,t){var r=0|this.objects+14*e+t/8;this.m.setUint8(r,this.m.getUint8(r)&~(128>>t%8))},copy_table:function(e,t,r){r=i(r);var n=this.m,s=0,a=0>r;if(r=Math.abs(r),0!==t)if(a)for(;r>s;)n.setUint8(t+s,n.getUint8(e+s++));else n.setBuffer(t,n.getBuffer(e,r));else for(;r>s;)n.setUint8(e+s++,0)},encode_text:function(e,t,r,n){this.m.setBuffer(n,this.text.encode(this.m.getBuffer(e+r,t)))},extension_table:function(e,r){var n=this.extension;return!n||e>this.extension_count?0:(n+=2*e,r===t?this.m.getUint16(n):(this.e.setUint16(n,r),t))},find_prop:function(e,t,r){var n,i,s=this.m,a=0,o=s.getUint16(this.objects+14*e+12);for(o+=2*s.getUint8(o)+1;;){if(n=s.getUint8(o),i=63&n,a===r)return i;if(i===t)return o+(128&n?2:1);if(t>i)return 0;a=i,128&n?(i=63&s.getUint8(o+1),o+=i?i+2:66):o+=64&n?3:2}},gestalt:function(e){switch(e){case 1:return 258;case 8192:return 1;case 8193:case 8194:return 2}return 0},get_child:function(e){return this.m.getUint16(this.objects+14*e+10)},get_sibling:function(e){return this.m.getUint16(this.objects+14*e+8)},get_parent:function(e){return this.m.getUint16(this.objects+14*e+6)},get_prop:function(e,t){var r=this.m,n=this.find_prop(e,t);return n?(64&r.getUint8(n-1)?r.getUint16:r.getUint8)(n):r.getUint16(this.properties+2*(t-1))},get_prop_len:function(e){if(0===e)return 0;var t=this.m.getUint8(e-1);return 128&t?(t&=63,0===t?64:t):64&t?2:1},incdec:function(e,t){var r,n;return 0===e?(r=s(this.s.pop()+t),this.s.push(r),r):15>--e?this.l[e]=s(this.l[e]+t):(n=this.globals+2*(e-15),this.m.setUint16(n,this.m.getUint16(n)+t))},indirect:function(e,t){return 0===e?arguments.length>1?this.s[this.s.length-1]=t:this.s[this.s.length-1]:this.variable(e,t)},insert_obj:function(e,t){this.remove_obj(e),this.set_family(e,t,t,e,e,this.get_child(t))},jeq:function(){for(var e,t=1;arguments.length>t;)arguments[t++]===arguments[0]&&(e=1);return e},jin:function(e,t){return this.get_parent(e)===t},log_shift:function(e,t){return t>0?e<<t:e>>>-t},output_stream:function(e,t){if(e=i(e),1===e&&(this.streams[0]=1),-1===e&&(this.streams[0]=0),3===e&&this.streams[2].unshift([t,""]),-3===e){var r=this.streams[2].shift(),n=this.text.text_to_zscii(r[1]);this.m.setUint16(r[0],n.length),this.m.setBuffer(r[0]+2,n)}},print:function(e){if(this.streams[2].length)this.streams[2][0][1]+=e;else if(this.streams[0]){var t=2&this.m.getUint8(17);t!==(2&this.ui.mono)&&(253&this.ui.mono||this.ui.flush(),this.ui.mono^=2),this.ui.buffer+=e}},print_obj:function(e){var t=this.m.getUint16(this.objects+14*e+12);this.print(this.text.decode(t+1,2*this.m.getUint8(t)))},print_table:function(e,t,r,n){r=r||1,n=n||0;for(var i=0;r>i;)this.print("\n"+this.text.zscii_to_text(this.m.getBuffer(e,t))),e+=t+n,i++},put_prop:function(e,t,r){var n=this.m,i=this.find_prop(e,t);(64&n.getUint8(i-1)?n.setUint16:n.setUint8)(i,r)},random:function(e){return 1>e?(this.random_state=Math.abs(e),this.random_seq=0,0):0===this.random_state?1|Math.random()*e:(this.random_seq++,this.random_seq>this.random_state&&(this.random_seq=1),this.random_seq%e)},read:function(e,t,r,n,i){3===arguments.length&&(i=r,r=n=0),this.act("read",{buffer:e,parse:t,len:this.m.getUint8(e),initiallen:this.m.getUint8(e+1),time:r,routine:n,storer:i})},read_char:function(e,t,r,n){2===arguments.length&&(n=t,t=r=0),this.act("char",{time:t,routine:r,storer:n})},remove_obj:function(e){var t,r,n,i=this.get_parent(e);if(0!==i)if(t=this.get_child(i),r=this.get_sibling(e),t===e)this.set_family(e,0,i,r);else{for(;;){if(n=this.get_sibling(t),n===e)break;t=n}this.set_family(e,0,0,0,t,r)}},restore:function(e){var t,r,n=new T(e),i=n.memory,s=n.stacks,o=n.pc,_=this.m.getUint8(17),l=0,u=0,c=[],f=[];if(this.m.setBuffer(0,this.data.slice(0,this.staticmem)),n.compressed)for(;i.length>l;)t=i[l++],0===t?u+=1+i[l++]:this.m.setUint8(u,t^this.data[u++]);else this.m.setBuffer(0,i);for(this.m.setUint8(17,_),l=6,t=s[l++]<<8|s[l++],r=a(s.slice(l,t));s.length>l;){for(c.unshift([s[l++]<<16|s[l++]<<8|s[l++],0,0,r.length,0,f.length]),c[0][1]=16&s[l]?-1:s[l+1],c[0][2]=15&s[l],l+=2,t=s[l++];t;)c[0][4]++,t>>=1;t=s[l++]<<8|s[l++],f=a(s.slice(l,l+c[0][2])).concat(f),l+=2*c[0][2],r=r.concat(a(s.slice(l,t)))}this.call_stack=c,this.l=f,this.s=r,this.update_header(),this.variable(this.m.getUint8(o++),2),this.pc=o},restore_undo:function(){if(0===this.undo.length)return 0;var e=this.undo.pop();return this.pc=e[0],e[2][17]=this.m.getUint8(17),this.m.setBuffer(0,e[2]),this.l=e[3],this.s=e[4],this.call_stack=e[5],this.variable(e[1],2),1},ret:function(e){var t=this.call_stack.shift(),r=t[1];this.pc=t[0],this.l=this.l.slice(this.l.length-t[5]),this.s.length=t[3],r>=0&&this.variable(r,e)},save:function(e,t){var r,n,i,s,a,o=this.m,_=this.s,l=this.l,u=new T,c=[],f=0,d=this.call_stack.reverse(),h=[0,0,0,0,0,0];for(u.release=o.getBuffer(2,2),u.serial=o.getBuffer(18,6),u.checksum=o.getBuffer(28,2),u.pc=e,u.compressed=1,r=0;this.staticmem>r;r++)i=o.getUint8(r)^this.data[r],0===i?256===++f&&(c.push(0,255),f=0):(f&&(c.push(0,f-1),f=0),c.push(i));for(u.memory=c,h.push(d[0][3]>>8,255&d[0][3]),n=0;d[0][3]>n;n++)h.push(_[n]>>8,255&_[n]);for(r=0;d.length>r;r++){for(s=d[r],a=(d[r+1]?d[r+1][3]:_.length)-s[3],h.push(s[0]>>16,255&s[0]>>8,255&s[0],s[2]|(0>s[1]?16:0),0>s[1]?0:s[1],(1<<s[4])-1,a>>8,255&a),n=l.length-s[5]-s[2];l.length-s[5]>n;n++)h.push(l[n]>>8,255&l[n]);for(n=s[3];s[3]+a>n;n++)h.push(_[n]>>8,255&_[n])}d.reverse(),u.stacks=h,this.act("save",{data:u.write(),storer:t})},save_undo:function(e,t){return this.undo.push([e,t,this.m.getBuffer(0,this.staticmem),this.l.slice(),this.s.slice(),this.call_stack.slice()]),1},scan_table:function(e,t,r,n){n=n||130;var i=128&n?this.m.getUint16:this.m.getUint8;for(n&=127,r=t+r*n;r>t;){if(i(t)===e)return t;t+=n}return 0},set_attr:function(e,t){var r=0|this.objects+14*e+t/8;this.m.setUint8(r,this.m.getUint8(r)|128>>t%8)},set_family:function(e,t,r,n,i,s){this.m.setUint16(this.objects+14*e+6,t),r&&this.m.setUint16(this.objects+14*r+10,n),i&&this.m.setUint16(this.objects+14*i+8,s)},test:function(e,t){return e&t===t},test_attr:function(e,t){return 128&this.m.getUint8(0|this.objects+14*e+t/8)<<t%8},variable:function(e,r){var n,i=r!==t;if(0===e){if(!i)return this.s.pop();this.s.push(r)}else if(15>--e){if(!i)return this.l[e];this.l[e]=r}else{if(n=this.globals+2*(e-15),!i)return this.m.getUint16(n);this.m.setUint16(n,r)}return r},U2S:i,S2U:s,init:function(){this.jit={},this.env={width:80},_(this,["find_prop"])},inputEvent:function(e){var n,i=this.m,s=e.code;if(!e.env||(r(this.env,e.env),s)){if(this.orders=[],"load"===s)return this.data=e.data,t;"restart"===s&&this.restart(),"save"===s&&this.variable(e.storer,e.result||1),"restore"===s&&(this.m||this.restart(),e.data?this.restore(e.data):this.variable(e.storer,0)),"read"===s&&(this.variable(e.storer,e.terminator),n=e.response,this.print(n+"\n"),n=this.text.text_to_zscii(n.toLowerCase()),n.length>e.len&&(n=n.slice(0,e.len)),i.setUint8(e.buffer+1,n.length),i.setBuffer(e.buffer+2,n),e.parse&&this.text.tokenise(e.buffer,e.parse)),"char"===s&&this.variable(e.storer,this.text.keyinput(e.response)),"get_cursor"===s&&(i.setUint16(e.addr,e.pos[0]+1),i.setUint16(e.addr+2,e.pos[1]+1)),this.run()}},restart:function(){var e=f(this.data),t=e.getUint8(0),n=e.getUint16(10),i=e.getUint16(54);if(5!==t&&8!==t)throw Error("Unsupported Z-Machine version: "+t);this.m&&e.setUint8(17,this.m.getUint8(17)),r(this,{m:e,s:[],l:[],call_stack:[],undo:[],orders:[],streams:[1,0,[],0],version:t,pc:e.getUint16(6),properties:n,objects:n+112,globals:e.getUint16(12),staticmem:e.getUint16(14),extension:i,extension_count:i?e.getUint16(i):0,addr_multipler:5===t?4:8}),r(this,{ui:new U(this,2&e.getUint8(17)),text:new A(this)}),this.update_header()},update_header:function(){var e=this.m,t=this.env.fgcolour?this.ui.convert_RGB(this.env.fgcolour):65535,r=this.env.bgcolour?this.ui.convert_RGB(this.env.bgcolour):65535;this.random_state=0,e.setUint8(1,29|(this.env.timed?128:0)),e.setUint8(17,87&e.getUint8(17)),e.setUint8(32,255),e.setUint8(33,this.env.width),e.setUint16(34,this.env.width),e.setUint16(36,255),e.setUint16(38,257),e.setUint8(44,Math.abs(this.ui.colours.indexOf(r))),e.setUint8(45,Math.abs(this.ui.colours.indexOf(t))),e.setUint16(50,258),this.extension_table(4,0),this.extension_table(5,t),this.extension_table(6,r)},run:function(){var e,r,n=new Date,i=0;for(this.stop=0;!this.stop;)if(e=this.pc,this.jit[e]||this.compile(),r=this.jit[e](this),isNaN(r)||this.ret(r),0===++i%5e4&&new Date-n>5e3)return this.act("tick"),t},compile:function(){var e=B(this),t,r;this.jit[e.pc]=Function("e",o(""+e)),e.pc<this.staticmem&&n.warn("Caching a JIT function in dynamic memory: "+e.pc)},act:function(e,t){t=t||{},this.ui.flush(),this.ui.status.length&&(this.orders.push({code:"stream",to:"status",data:this.ui.status}),this.ui.status=[]),t.code=e,this.orders.push(t),this.stop=1,this.outputEvent(this.orders)}})})(this);
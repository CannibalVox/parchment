/*

ZVM - the ifvms.js implementation of the Z-Machine
==================================================

Built: 2013-03-24

Copyright (c) 2011-2013 The ifvms.js team
BSD licenced
http://github.com/curiousdannii/ifvms.js

*/
(function(t,e){"use strict";[].indexOf||(Array.prototype.indexOf=function(t,e){for(var s=e||0,i=this.length;i>s;s++)if(this[s]==t)return s;return-1});var s=function(t,e){for(var s in e)t[s]=e[s];return t},i=t.console||{log:function(){},info:function(){},warn:function(){}},n=function(t){return t<<16>>16},r=function(t){return 65535&t},o=function(t){for(var e=0,s=t.length,i=[];s>e;)i[e/2]=t[e++]<<8|t[e++];return i},u=function(t){return t.replace(/(e\.)?U2S\(([^(]+?)\)/g,"(($2)<<16>>16)").replace(/(e\.)?S2U\(([^(]+?)\)/g,"(($2)&65535)").replace(/([\w.]+)\.getUint8\(([^(]+?)\)/g,"$1[$2]").replace(/([\w.]+)\.getUint16\(([^(]+?)\)/g,"($1[$2]<<8|$1[$2+1])")},h=function(e,i){var n,r,o=[];for(n in e)i.indexOf(n)>=0&&(r=/function\s*\(([^(]*)\)\s*\{([\s\S]+)\}/.exec(""+e[n]),o.push(n+":function("+r[1]+"){"+u(r[2])+"}"));s(e,t.eval("({"+o.join()+"})"))},c,a,f=0,l=f?function(t){var e=new ArrayBuffer(t);return t=new DataView(e),t.buffer=e,t}:function(t){return t=t.slice(),s(t,{data:t,getUint8:function(e){return t[e]},getUint16:function(e){return t[e]<<8|t[e+1]},getBuffer:function(e,s){return t.slice(e,e+s)},getBuffer16:function(e,s){return o(t.slice(e,e+2*s))},setUint8:function(e,s){return t[e]=255&s},setUint16:function(e,s){return t[e]=255&s>>8,t[e+1]=255&s,65535&s},setBuffer:function(e,s){for(var i=0,n=s.length;n>i;)t[i+e]=s[i++]}})},p,g=Object.subClass({init:function(t,e){this.e=t,this.v=e},toString:function(){return this.v},U2S:function(){return n(this.v)}}),d=g.subClass({toString:function(){var t=this.v;return this.indirect?"e.indirect("+t+")":0==t?"s.pop()":15>--t?"l["+t+"]":"m.getUint16("+(this.e.globals+2*(t-15))+")"},store:function(t){var e=this.v;return this.indirect?"e.indirect("+e+","+t+")":this.returnval?"e.variable("+e+","+t+")":0==e?"s.push("+t+")":15>--e?"l["+e+"]="+t:"m.setUint16("+(this.e.globals+2*(e-15))+","+t+")"},U2S:function(){return"e.U2S("+this+")"}}),m=Object.subClass({init:function(t,e,s,i,n,r){this.e=t,this.context=e,this.code=s,this.pc=i,this.labels=[this.pc+"/"+this.code],this.next=n,this.operands=r,this.post&&this.post()},toString:function(){return this.label()+(this.func?this.func.apply(this,this.operands):"")},args:function(t){return this.operands.join(t)},label:function(){return"/* "+this.labels.join()+" */ "}}),_=m.subClass({stopper:1}),U=_.subClass({storer:1,post:function(){this.storer=this.operands.pop(),this.origfunc=this.func,this.func=this.newfunc},newfunc:function(){return"e.pc="+this.next+";"+this.origfunc.apply(this,arguments)}}),v=Object.subClass({init:function(t,e){this.ops=t||[],this.code=e||"||"},toString:function(){for(var t,e=0,s=[];this.ops.length>e;)t=this.ops[e++],s.push(t.func?(t.iftrue?"":"!(")+t.func.apply(t,t.operands)+(t.iftrue?"":")"):t);return(this.invert?"(!(":"(")+s.join(this.code)+(this.invert?"))":")")}}),b=m.subClass({brancher:1,keyword:"if",post:function(){var t,e,s=this.operands.pop(),i=s[1];this.iftrue=s[0],0==i||1==i?t="e.ret("+i+")":(i+=this.next-2,this.context.targets.push(i),t="e.pc="+i),this.result=t+"; return",this.offset=i,this.cond=new v([this]),this.context.ops.length&&(e=this.context.ops.pop(),e.offset==i?(this.cond.ops.unshift(e.cond),this.labels=e.labels,this.labels.push(this.pc+"/"+this.code)):this.context.ops.push(e))},toString:function(){var t=this.result;return t instanceof k&&(t+=t.stopper?"; return":"",this.result.ops.length>1&&(t="\n"+t+"\n")),this.label()+this.keyword+this.cond+" {"+t+"}"}}),w=b.subClass({storer:1,post:function(){this._super(),this.storer=this.operands.pop(),this.storer.returnval=1,this.origfunc=this.func,this.func=this.newfunc},newfunc:function(){return this.storer.store(this.origfunc.apply(this,arguments))}}),S=m.subClass({storer:1,post:function(){this.storer=this.operands.pop()},toString:function(){var t=this._super();return this.storer?this.storer.store(t):t}}),x=_.subClass({result:{v:-1},toString:function(){return this.label()+"e.call("+this.operands.shift()+","+this.result.v+","+this.next+",["+this.args()+"])"}}),C=x.subClass({storer:1,post:function(){this.result=this.operands.pop()}}),k=Object.subClass({init:function(t,e){this.e=t,this.pc=e,this.pre=[],this.ops=[],this.post=[],this.targets=[]},toString:function(){return this.pre.join("")+this.ops.join(";")+this.post.join("")}}),j=k.subClass({toString:function(){return this.pre.unshift("var l=e.l,m=e.m,s=e.s;\n"),this._super()}}),y=function(t,e,s){return s=s||{},e&&(s.func=e),t.subClass(s)},B=IFF.subClass({init:function(t){if(this._super(t),t){if("IFZS"!=this.type)throw Error("Not a Quetzal savefile");for(var e=0,s=this.chunks.length;s>e;e++){var i=this.chunks[e].type,n=this.chunks[e].data;"CMem"==i||"UMem"==i?(this.memory=n,this.compressed="CMem"==i):"Stks"==i?this.stacks=n:"IFhd"==i&&(this.release=n.slice(0,2),this.serial=n.slice(2,8),this.checksum=n.slice(8,10),this.pc=n[10]<<16|n[11]<<8|n[12])}}},write:function(){this.type="IFZS";var t=this.pc,e=this.release.concat(this.serial,this.checksum,255&t>>16,255&t>>8,255&t);return this.chunks=[{type:"IFhd",data:e},{type:this.compressed?"CMem":"UMem",data:this.memory},{type:"Stks",data:this.stacks}],this._super()}}),F=function(){for(var t={8:8,13:13,27:27,37:131,38:129,39:132,40:130},e=96;106>e;)t[e]=49+e++;for(e=112;124>e;)t[e]=21+e++;return t}(),E=Object.subClass({init:function(t){var e,s=t.m,i=s.getUint16(52),n=t.extension_table(3),r=n&&s.getUint8(n++),o=[],u=0,h=96;if(this.e=t,this.maxaddr=s.getUint16(26)*t.addr_multipler,this.make_alphabet(i?s.getBuffer(i,78):this.text_to_zscii("abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ \r0123456789.,!?_#'\"/\\-:()",1)),this.make_unicode(n?s.getBuffer16(n,r):this.text_to_zscii(unescape("%E4%F6%FC%C4%D6%DC%DF%BB%AB%EB%EF%FF%CB%CF%E1%E9%ED%F3%FA%FD%C1%C9%CD%D3%DA%DD%E0%E8%EC%F2%F9%C0%C8%CC%D2%D9%E2%EA%EE%F4%FB%C2%CA%CE%D4%DB%E5%C5%F8%D8%E3%F1%F5%C3%D1%D5%E6%C6%E7%C7%FE%F0%DE%D0%A3%u0153%u0152%A1%BF"),1)),e=s.getUint16(24))for(;h>u;)o.push(this.decode(2*s.getUint16(e+2*u++),0,1));this.abbr=o,this.dictionaries={},this.dict=s.getUint16(8),this.parse_dict(this.dict)},make_alphabet:function(t){for(var e=[[],[],[]],s=0;78>s;)e[parseInt(s/26)][s%26]=t[s++];e[2][1]=13,this.alphabets=e},make_unicode:function(t){for(var e={13:"\n"},s={10:13},i=0;t.length>i;)e[155+i]=String.fromCharCode(t[i]),s[t[i]]=155+i++;for(i=32;127>i;)e[i]=String.fromCharCode(i),s[i]=i++;this.unicode_table=e,this.reverse_unicode_table=s},decode:function(t,e,s){var n,r,o,u,h=this.e.m,c=t,a=[],f=0,l=0,p=[],g=[],d=0;if(this.e.jit[t])return this.e.jit[t];for(e=e?e+t:this.maxaddr;e>t&&(n=h.getUint16(t),t+=2,a.push(31&n>>10,31&n>>5,31&n),!(32768&n)););for(;a.length>f;){if(r=a[f++],0==r)p.push(32);else if(4>r)p.push(-1),g.push(this.abbr[32*(r-1)+a[f++]]);else if(6>r)l=r;else if(2==l&&6==r){if(a.length>f+1)if(o=a[f++]<<5|a[f++],768>o)p.push(o);else{for(o-=767,d+=o,u=f,f=f%3+3;o--;)p.push(-1),g.push(String.fromCharCode(a[f]<<10|a[f+1]<<5|a[f+2])),a[f++]=a[f++]=a[f++]=32;f=u}}else 32>r&&p.push(this.alphabets[l][r-6]);l=4>l?0:l-3,0==f%3&&(f+=d,d=0)}return p=this.zscii_to_text(p,g)+"",p.pc=t,this.e.jit[c]=p,!s&&this.e.staticmem>c&&i.warn("Caching a string in dynamic memory: "+c),p},encode:function(t){for(var s,i,n=this.alphabets,r=[],o=0,u=[];9>r.length;)s=t[o++],32==s?r.push(0):(i=n[0].indexOf(s))>=0?r.push(i+6):(i=n[1].indexOf(s))>=0?r.push(4,i+6):(i=n[2].indexOf(s))>=0?r.push(5,i+6):(i=this.reverse_unicode_table[s])?r.push(5,6,i>>5,31&i):s==e&&r.push(5);for(r.length=9,o=0;9>o;)u.push(r[o++]<<2|r[o]>>3,(7&r[o++])<<5|r[o++]);return u[4]|=128,u},zscii_to_text:function(t,e){for(var s,i=0,n=t.length,r=0,o="";n>i;)s=t[i++],-1==s&&(o+=e[r++]),(s=this.unicode_table[s])&&(o+=s);return o},text_to_zscii:function(t,e){for(var s,i=[],n=0,r=t.length;r>n;)s=t.charCodeAt(n++),e||(s=this.reverse_unicode_table[s]||63),i.push(s);return i},parse_dict:function(t){var e,s,i=this.e.m,n=t,r={},o=i.getUint8(t++);for(r.separators=i.getBuffer(t,o),t+=o,e=i.getUint8(t++),s=t+2+e*i.getUint16(t),t+=2;s>t;)r[""+i.getBuffer(t,6)]=t,t+=e;return this.dictionaries[n]=r,r},tokenise:function(t,e,s,i){s=s||this.dict,s=this.dictionaries[s]||this.parse_dict(s);for(var n,r,o=this.e.m,u=2,h=u+o.getUint8(t+1),c=s.separators,a=[],f=[],l=u,p=0;h>u;)n=o.getUint8(t+u++),32==n||c.indexOf(n)>=0?(a.length&&(f.push([a,l]),l+=a.length,a=[]),32!=n&&f.push([[n],l]),l++):a.push(n);for(a.length&&f.push([a,l]),r=Math.min(f.length,o.getUint8(e));r>p;)a=s[""+this.encode(f[p][0])],(!i||a)&&(o.setUint16(e+2+4*p,a||0),o.setUint8(e+4+4*p,f[p][0].length),o.setUint8(e+5+4*p,f[p][1])),p++;o.setUint8(e+1,p)},keyinput:function(t){var e=t.charCode,s=t.keyCode;return F[s]?F[s]:this.reverse_unicode_table[e]||63}}),D=function(t){var e=function(e,s){for(var i in s)s[i]!=t&&(e[i]=s[i]);return e},s=[65534,65535,0,29,832,957,22944,31775,30624,32767,23254,17969,11627],i=function(t){var e=Math.round(8.226*(31&t))<<16|Math.round(8.226*((992&t)>>5))<<8|Math.round(8.226*((31744&t)>>10));for(e=e.toString(16);6>e.length;)e="0"+e;return"#"+e};return Object.subClass({colours:s,init:function(t,e){this.e=t,this.buffer="",this.styles={},this.env={fgcolour:t.env.fgcolour||"#000",bgcolour:t.env.bgcolour||"#fff"},this.mono=e,this.currentwin=0,this.status=[],t.orders.push({code:"stream",name:"status"},{code:"stream",name:"main"},{code:"find",name:"main"})},clear_window:function(){this.e.orders.push({code:"clear",name:"main",css:e({},this.styles)})},convert_RGB:function(t){var e,s=Math.round,i=/(\d+),\s*(\d+),\s*(\d+)|#(\w{1,2})(\w{1,2})(\w{1,2})/.exec(t);return i[1]?e=[i[1],i[2],i[3]]:(e=[parseInt(i[4],16),parseInt(i[5],16),parseInt(i[6],16)],4==t.length&&(e=[e[0]<<4|e[0],e[1]<<4|e[1],e[2]<<4|e[2]])),s(e[2]/8.226)<<10|s(e[1]/8.226)<<5|s(e[0]/8.226)},erase_line:function(t){1==t&&(this.flush(),this.status.push({code:"eraseline"}))},erase_window:function(t){this.flush(),1>t&&this.clear_window(),-1==t&&this.split_window(0),(-2==t||1==t)&&this.status.push({code:"clear"})},flush:function(){var t;""!=this.buffer&&(t={code:"stream",css:e({},this.styles),text:this.buffer},this.mono&&(t.node="tt"),(this.currentwin?this.status:this.e.orders).push(t),this.buffer="")},get_cursor:function(t){this.status.push({code:"get_cursor",addr:t}),this.e.act()},set_colour:function(t,e){this.set_true_colour(s[t],s[e])},set_cursor:function(t,e){this.flush(),this.status.push({code:"cursor",to:[t-1,e-1]})},set_font:function(t){if(1!=t&&4!=t)return 0;var e=4&this.mono?4:1;return t!=e&&(this.flush(),this.mono^=4),e},set_style:function(e){var s,i,n=this.styles;this.flush(),0==e&&(s=this.reverse,this.reverse=n["font-weight"]=n["font-style"]=t,this.mono&=254),1&e&&(s=!this.reverse,this.reverse=1),2&e&&(n["font-weight"]="bold"),4&e&&(n["font-style"]="italic"),8&e&&(this.mono|=1),s&&(i=n.color||this.env.fgcolour,n.color=n["background-color"]||this.env.bgcolour,n["background-color"]=i)},set_true_colour:function(e,s){var n,r=this.styles,o=r.color,u=r["background-color"];this.flush(),this.reverse&&(n=e,e=s,s=n),65535==e?o=t:32768>e&&(o=i(e)),65535==s?u=t:32768>s&&(u=i(s)),this.reverse&&(o=o||this.env.bgcolour,u=u||this.env.fgcolour),r.color=o,r["background-color"]=u},set_window:function(t){this.flush(),this.currentwin=t,this.e.orders.push({code:"find",name:t?"status":"main"}),t&&this.status.push({code:"cursor",to:[0,0]})},split_window:function(t){this.flush(),this.status.push({code:"height",lines:t})}})}(),M=function(t){return""+t},O=y(b,function(){return 1}),I=S.subClass({storer:0,post:function(){var t=this.operands,e=t[0],s=e instanceof d;t[0]=new d(this.e,s?e:e.v),(s||0==e.v)&&(t[0].indirect=1),this.storer=142==this.code?t.pop():t.shift(),0==t.length&&t.push(new d(this.e,0))},func:M}),z=m.subClass({func:function(t){var e=t.v-1,s=this.code%2?1:-1;return t instanceof d||e>14?"e.incdec("+t+","+s+")":(0>e?"e.s[e.s.length-1]=e.S2U(e.s[e.s.length-1]+":"e.l["+e+"]=e.S2U(e.l["+e+"]+")+s+")"}}),A={1:y(b,function(){return 2==arguments.length?this.args("=="):"e.jeq("+this.args()+")"}),2:y(b,function(t,e){return t.U2S()+"<"+e.U2S()}),3:y(b,function(t,e){return t.U2S()+">"+e.U2S()}),4:y(b,function(t,e){return"e.U2S(e.incdec("+t+",-1))<"+e.U2S()}),5:y(b,function(t,e){return"e.U2S(e.incdec("+t+",1))>"+e.U2S()}),6:y(b,function(){return"e.jin("+this.args()+")"}),7:y(b,function(){return"e.test("+this.args()+")"}),8:y(S,function(){return this.args("|")}),9:y(S,function(){return this.args("&")}),10:y(b,function(){return"e.test_attr("+this.args()+")"}),11:y(m,function(){return"e.set_attr("+this.args()+")"}),12:y(m,function(){return"e.clear_attr("+this.args()+")"}),13:I,14:y(m,function(){return"e.insert_obj("+this.args()+")"}),15:y(S,function(t,e){return"m.getUint16(e.S2U("+t+"+2*"+e.U2S()+"))"}),16:y(S,function(t,e){return"m.getUint8(e.S2U("+t+"+"+e.U2S()+"))"}),17:y(S,function(){return"e.get_prop("+this.args()+")"}),18:y(S,function(){return"e.find_prop("+this.args()+")"}),19:y(S,function(){return"e.find_prop("+this.args(",0,")+")"}),20:y(S,function(){return"e.S2U("+this.args("+")+")"}),21:y(S,function(){return"e.S2U("+this.args("-")+")"}),22:y(S,function(){return"e.S2U("+this.args("*")+")"}),23:y(S,function(t,e){return"e.S2U(parseInt("+t.U2S()+"/"+e.U2S()+"))"}),24:y(S,function(t,e){return"e.S2U("+t.U2S()+"%"+e.U2S()+")"}),25:C,26:x,27:y(m,function(){return"e.ui.set_colour("+this.args()+")"}),28:y(_,function(t,e){return"while(e.call_stack.length>"+e+"){e.call_stack.shift()}e.ret("+t+")"}),128:y(b,function(t){return t+"==0"}),129:y(w,function(t){return"e.get_sibling("+t+")"}),130:y(w,function(t){return"e.get_child("+t+")"}),131:y(S,function(t){return"e.get_parent("+t+")"}),132:y(S,function(t){return"e.get_prop_len("+t+")"}),133:z,134:z,135:y(m,function(t){return"e.print(e.text.decode("+t+"))"}),136:C,137:y(m,function(t){return"e.remove_obj("+t+")"}),138:y(m,function(t){return"e.print_obj("+t+")"}),139:y(_,function(t){return"e.ret("+t+")"}),140:y(_,function(t){return"e.pc="+t.U2S()+"+"+(this.next-2)}),141:y(m,function(t){return"e.print(e.text.decode("+t+"*"+this.e.addr_multipler+"))"}),142:I.subClass({storer:1}),143:x,176:y(_,function(){return"e.ret(1)"}),177:y(_,function(){return"e.ret(0)"}),178:y(m,function(t){return'e.print("'+t+'")'},{printer:1}),179:y(_,function(t){return'e.print("'+t+'\\n");e.ret(1)'},{printer:1}),180:m,183:y(_,function(){return'e.act("restart")'}),184:y(_,function(t){return"e.ret("+t+")"},{post:function(){this.operands.push(new d(this.e,0))}}),185:y(S,function(){return"e.call_stack.length"}),186:y(_,function(){return'e.act("quit")'}),187:y(m,function(){return'e.print("\\n")'}),189:O,191:O,224:C,225:y(m,function(t,e,s){return"m.setUint16(e.S2U("+t+"+2*"+e.U2S()+"),"+s+")"}),226:y(m,function(t,e,s){return"m.setUint8(e.S2U("+t+"+"+e.U2S()+"),"+s+")"}),227:y(m,function(){return"e.put_prop("+this.args()+")"}),228:y(U,function(){return"e.read("+this.args()+","+this.storer.v+")"}),229:y(m,function(t){return"e.print(e.text.zscii_to_text(["+t+"]))"}),230:y(m,function(t){return"e.print("+t.U2S()+")"}),231:y(S,function(t){return"e.random("+t.U2S()+")"}),232:y(S,M,{post:function(){this.storer=new d(this.e,0)},storer:0}),233:I,234:y(m,function(t){return"e.ui.split_window("+t+")"}),235:y(m,function(t){return"e.ui.set_window("+t+")"}),236:C,237:y(m,function(t){return"e.ui.erase_window("+t.U2S()+")"}),238:y(m,function(t){return"e.ui.erase_line("+t+")"}),239:y(m,function(){return"e.ui.set_cursor("+this.args()+")"}),240:y(U,function(t){return"e.ui.get_cursor("+t+")"}),241:y(m,function(t){return"e.ui.set_style("+t+")"}),242:m,243:y(m,function(){return"e.output_stream("+this.args()+")"}),244:m,245:m,246:y(U,function(){return"e.read_char("+(this.args()||"1")+","+this.storer.v+")"}),247:y(w,function(){return"e.scan_table("+this.args()+")"}),248:y(S,function(t){return"e.S2U(~"+t+")"}),249:x,250:x,251:y(m,function(){return"e.text.tokenise("+this.args()+")"}),252:y(m,function(){return"e.encode_text("+this.args()+")"}),253:y(m,function(){return"e.copy_table("+this.args()+")"}),254:y(m,function(){return"e.print_table("+this.args()+")"}),255:y(b,function(t){return t+"<=e.call_stack[0][4]"}),1e3:y(U,function(){return"e.save("+(this.next-1)+","+this.storer.v+")"}),1001:y(U,function(){return'e.act("restore",{storer:'+this.storer.v+"})"}),1002:y(S,function(t,e){return"e.S2U(e.log_shift("+t+","+e.U2S()+"))"}),1003:y(S,function(t,e){return"e.S2U(e.art_shift("+t.U2S()+","+e.U2S()+"))"}),1004:y(S,function(t){return"e.ui.set_font("+t+")"}),1009:y(S,function(){return"e.save_undo("+this.next+","+this.storer.v+")"}),1010:y(m,function(){return"if(e.restore_undo())return"},{storer:1}),1011:y(m,function(t){return"e.print(String.fromCharCode("+t+"))"}),1012:y(S,function(){return 3}),1013:y(m,function(){return"e.ui.set_true_colour("+this.args()+")"}),1014:m.subClass({brancher:1}),1030:y(S,function(){return"e.gestalt("+this.args()+")"})},q=function(t,e){for(var s,i,r,o,u,h=0;t.ops.length-1>h;){if(t.ops[h].offset==e){if(2==t.ops.length-h&&t.ops[h+1].offset)return o=t.ops.pop(),u=t.ops.pop(),u.cond.invert=!u.cond.invert,o.cond=new v([u.cond,o.cond],"&&"),o.labels=u.labels.concat(o.labels),t.ops.push(o),1;s=new k(t.e,t.ops[h+1].pc),s.ops=t.ops.slice(h+1),i=s.ops.length-1,t.ops.length=h+1,r=t.ops[h],r.result=s,r.cond.invert=!r.cond.invert,o=s.ops[i],140==o.code&&n(o.operands[0].v)+o.next-2==r.pc?(r.keyword="while",s.ops.pop()):s.stopper=o.stopper;return 1}h++}},$,Z=function(t){for(var e,s,i,n,r,o,u,h=t.m,c=new j(t,t.pc);;){if(s=e=t.pc,n=h.getUint8(e++),190==n?(o=-1,n=h.getUint8(e++)+1e3):128&n?64&n?(o=-1,32&n||(n&=31)):(o=[(48&n)>>4],3>o[0]&&(n&=207)):(o=[64&n?2:1,32&n?2:1],n&=31),!A[n])throw t.stop=1,Error("Unknown opcode #"+n+" at pc="+s);for(r=A[n].prototype,-1==o&&(o=[],G(h.getUint8(e++),o),(236==n||250==n)&&G(h.getUint8(e++),o)),u=[],i=0;o.length>i;)0==o[i]&&(u.push(new g(t,h.getUint16(e))),e+=2),1==o[i]&&u.push(new g(t,h.getUint8(e++))),2==o[i++]&&u.push(new d(t,h.getUint8(e++)));if(r.storer&&u.push(new d(t,h.getUint8(e++))),r.brancher&&(i=h.getUint8(e++),u.push([128&i,64&i?63&i:(i<<8|h.getUint8(e++))<<18>>18])),r.printer&&(i=t.text.decode(e),u.push(i.replace(/\\/g,"\\\\").replace(/\n/g,"\\n").replace(/"/g,'\\"')),e=i.pc),t.pc=e,c.ops.push(new A[n](t,c,n,s,e,u)),i=0,c.targets.indexOf(e)>=0&&(i=q(c,e)),r.stopper&&!i)break}return c},G=function(t,e){for(var s=0;4>s;s++)e.push((192&t)>>6),t<<=2};t.ZVM=Object.subClass({art_shift:function(t,e){return e>0?t<<e:t>>-e},call:function(t,e,s,i){var n,r,o=this.l.length,u=i.length;for(this.pc=t*this.addr_multipler,r=this.m.getUint8(this.pc++),i=i.slice(0,r),n=i.length;r>n;n++)i.push(0);this.l=i.concat(this.l),this.call_stack.unshift([s,e,r,this.s.length,u,o])},clear_attr:function(t,e){var s=this.objects+14*t+parseInt(e/8);this.m.setUint8(s,this.m.getUint8(s)&~(128>>e%8))},copy_table:function(t,e,s){s=n(s);var i=this.m,r=0,o=0>s;if(s=Math.abs(s),0!=e)if(o)for(;s>r;)i.setUint8(e+r,i.getUint8(t+r++));else i.setBuffer(e,i.getBuffer(t,s));else for(;s>r;)i.setUint8(t+r++,0)},encode_text:function(t,e,s,i){this.m.setBuffer(i,this.text.encode(this.m.getBuffer(t+s,e)))},extension_table:function(t,s){var i=this.extension;return!i||t>this.extension_count?0:(i+=2*t,s==e?this.m.getUint16(i):(this.e.setUint16(i,s),e))},find_prop:function(t,e,s){var i,n,r=this.m,o=0,u=r.getUint16(this.objects+14*t+12);for(u+=2*r.getUint8(u)+1;;){if(i=r.getUint8(u),n=63&i,o==s)return n;if(n==e)return u+(128&i?2:1);if(e>n)return 0;o=n,128&i?(n=63&r.getUint8(u+1),u+=n?n+2:66):u+=64&i?3:2}},gestalt:function(t){switch(t){case 1:return 258;case 8192:return 1;case 8193:case 8194:return 2}return 0},get_child:function(t){return this.m.getUint16(this.objects+14*t+10)},get_sibling:function(t){return this.m.getUint16(this.objects+14*t+8)},get_parent:function(t){return this.m.getUint16(this.objects+14*t+6)},get_prop:function(t,e){var s=this.m,i=this.find_prop(t,e);return i?(64&s.getUint8(i-1)?s.getUint16:s.getUint8)(i):s.getUint16(this.properties+2*(e-1))},get_prop_len:function(t){if(0==t)return 0;var e=this.m.getUint8(t-1);return 128&e?(e&=63,0==e?64:e):64&e?2:1},incdec:function(t,e){var s,i;return 0==t?(s=r(this.s.pop()+e),this.s.push(s),s):16>t?this.l[t-1]=r(this.l[t-1]+e):(i=this.globals+2*(t-16),this.m.setUint16(i,this.m.getUint16(i)+e))},indirect:function(t,e){return 0==t?arguments.length>1?this.s[this.s.length-1]=e:this.s[this.s.length-1]:this.variable(t,e)},insert_obj:function(t,e){this.remove_obj(t),this.set_family(t,e,e,t,t,this.get_child(e))},jeq:function(){for(var t,e=1;arguments.length>e;)arguments[e++]==arguments[0]&&(t=1);return t},jin:function(t,e){return this.get_parent(t)==e},log_shift:function(t,e){return e>0?t<<e:t>>>-e},output_stream:function(t,e){if(t=n(t),1==t&&(this.streams[0]=1),-1==t&&(this.streams[0]=0),3==t&&this.streams[2].unshift([e,""]),-3==t){var s=this.streams[2].shift(),i=this.text.text_to_zscii(s[1]);this.m.setUint16(s[0],i.length),this.m.setBuffer(s[0]+2,i)}},print:function(t){if(this.streams[2].length)this.streams[2][0][1]+=t;else if(this.streams[0]){var e=2&this.m.getUint8(17);e!=(2&this.ui.mono)&&(253&this.ui.mono||this.ui.flush(),this.ui.mono^=2),this.ui.buffer+=t}},print_obj:function(t){var e=this.m.getUint16(this.objects+14*t+12);this.print(this.text.decode(e+1,2*this.m.getUint8(e)))},print_table:function(t,e,s,i){s=s||1,i=i||0;for(var n=0;s>n;)this.print("\n"+this.text.zscii_to_text(this.m.getBuffer(t,e))),t+=e+i,n++},put_prop:function(t,e,s){var i=this.m,n=this.find_prop(t,e);(64&i.getUint8(n-1)?i.setUint16:i.setUint8)(n,s)},random:function(t){return 1>t?(this.random_state=Math.abs(t),this.random_seq=0,0):0==this.random_state?parseInt(Math.random()*t)+1:(this.random_seq++,this.random_seq>this.random_state&&(this.random_seq=1),this.random_seq%t)},read:function(t,e,s,i,n){3==arguments.length&&(n=s,s=i=0),this.act("read",{buffer:t,parse:e,len:this.m.getUint8(t),initiallen:this.m.getUint8(t+1),time:s,routine:i,storer:n})},read_char:function(t,e,s,i){2==arguments.length&&(i=e,e=s=0),this.act("char",{time:e,routine:s,storer:i})},remove_obj:function(t){var e,s,i,n=this.get_parent(t);if(0!=n)if(e=this.get_child(n),s=this.get_sibling(t),e==t)this.set_family(t,0,n,s);else{for(;;){if(i=this.get_sibling(e),i==t)break;e=i}this.set_family(t,0,0,0,e,s)}},restore:function(t){var e,s,i=new B(t),n=i.memory,r=i.stacks,u=i.pc,h=this.m.getUint8(17),c=0,a=0,f=[],l=[];if(this.m.setBuffer(0,this.data.slice(0,this.staticmem)),i.compressed)for(;n.length>c;)e=n[c++],0==e?a+=1+n[c++]:this.m.setUint8(a,e^this.data[a++]);else this.m.setBuffer(0,n);for(this.m.setUint8(17,h),c=6,e=r[c++]<<8|r[c++],s=o(r.slice(c,e));r.length>c;){for(f.unshift([r[c++]<<16|r[c++]<<8|r[c++],0,0,s.length,0,l.length]),f[0][1]=16&r[c]?-1:r[c+1],f[0][2]=15&r[c],c+=2,e=r[c++];e;)f[0][4]++,e>>=1;e=r[c++]<<8|r[c++],l=o(r.slice(c,c+f[0][2])).concat(l),c+=2*f[0][2],s=s.concat(o(r.slice(c,e)))}this.call_stack=f,this.l=l,this.s=s,this.update_header(),this.variable(this.m.getUint8(u++),2),this.pc=u},restore_undo:function(){if(0==this.undo.length)return 0;var t=this.undo.pop();return this.pc=t[0],t[2][17]=this.m.getUint8(17),this.m.setBuffer(0,t[2]),this.l=t[3],this.s=t[4],this.call_stack=t[5],this.variable(t[1],2),1},ret:function(t){var e=this.call_stack.shift(),s=e[1];this.pc=e[0],this.l=this.l.slice(this.l.length-e[5]),this.s.length=e[3],s>=0&&this.variable(s,t)},save:function(t,e){var s,i,n,r,o,u=this.m,h=this.s,c=this.l,a=new B,f=[],l=0,p=this.call_stack.reverse(),g=[0,0,0,0,0,0];for(a.release=u.getBuffer(2,2),a.serial=u.getBuffer(18,6),a.checksum=u.getBuffer(28,2),a.pc=t,a.compressed=1,s=0;this.staticmem>s;s++)n=u.getUint8(s)^this.data[s],0==n?256==++l&&(f.push(0,255),l=0):(l&&(f.push(0,l-1),l=0),f.push(n));for(a.memory=f,g.push(p[0][3]>>8,255&p[0][3]),i=0;p[0][3]>i;i++)g.push(h[i]>>8,255&h[i]);for(s=0;p.length>s;s++){for(r=p[s],o=(p[s+1]?p[s+1][3]:h.length)-r[3],g.push(r[0]>>16,255&r[0]>>8,255&r[0],r[2]|(0>r[1]?16:0),0>r[1]?0:r[1],(1<<r[4])-1,o>>8,255&o),i=c.length-r[5]-r[2];c.length-r[5]>i;i++)g.push(c[i]>>8,255&c[i]);for(i=r[3];r[3]+o>i;i++)g.push(h[i]>>8,255&h[i])}p.reverse(),a.stacks=g,this.act("save",{data:a.write(),storer:e})},save_undo:function(t,e){return this.undo.push([t,e,this.m.getBuffer(0,this.staticmem),this.l.slice(),this.s.slice(),this.call_stack.slice()]),1},scan_table:function(t,e,s,i){i=i||130;var n=128&i?this.m.getUint16:this.m.getUint8;for(i&=127,s=e+s*i;s>e;){if(n(e)==t)return e;e+=i}return 0},set_attr:function(t,e){var s=this.objects+14*t+parseInt(e/8);this.m.setUint8(s,this.m.getUint8(s)|128>>e%8)},set_family:function(t,e,s,i,n,r){this.m.setUint16(this.objects+14*t+6,e),s&&this.m.setUint16(this.objects+14*s+10,i),n&&this.m.setUint16(this.objects+14*n+8,r)},test:function(t,e){return t&e==e},test_attr:function(t,e){return 128&this.m.getUint8(this.objects+14*t+parseInt(e/8))<<e%8},variable:function(t,s){var i=s!==e;if(0==t){if(!i)return this.s.pop();this.s.push(s)}else if(16>t){if(!i)return this.l[t-1];this.l[t-1]=s}else i?this.m.setUint16(this.globals+2*(t-16),s):this.m.getUint16(this.globals+2*(t-16));return s},U2S:n,S2U:r,init:function(){this.jit={},this.env={width:80},h(this,["find_prop"])},inputEvent:function(t){var i,n=this.m,r=t.code;if(!t.env||(s(this.env,t.env),r)){if(this.orders=[],"load"==r)return this.data=t.data,e;"restart"==r&&this.restart(),"save"==r&&this.variable(t.storer,t.result||1),"restore"==r&&(this.m||this.restart(),t.data?this.restore(t.data):this.variable(t.storer,0)),"read"==r&&(this.variable(t.storer,t.terminator),i=t.response,this.print(i+"\n"),i=this.text.text_to_zscii(i.toLowerCase()),i.length>t.len&&(i=i.slice(0,t.len)),n.setUint8(t.buffer+1,i.length),n.setBuffer(t.buffer+2,i),t.parse&&this.text.tokenise(t.buffer,t.parse)),"char"==r&&this.variable(t.storer,this.text.keyinput(t.response)),"get_cursor"==r&&(n.setUint16(t.addr,t.pos[0]+1),n.setUint16(t.addr+2,t.pos[1]+1)),this.run()}},restart:function(){var t=l(this.data),e=t.getUint8(0),i=t.getUint16(10),n=t.getUint16(54);if(5!=e&&8!=e)throw Error("Unsupported Z-Machine version: "+e);this.m&&t.setUint8(17,this.m.getUint8(17)),s(this,{m:t,s:[],l:[],call_stack:[],undo:[],orders:[],streams:[1,0,[],0],version:e,pc:t.getUint16(6),properties:i,objects:i+112,globals:t.getUint16(12),staticmem:t.getUint16(14),extension:n,extension_count:n?t.getUint16(n):0,addr_multipler:5==e?4:8}),s(this,{ui:new D(this,2&t.getUint8(17)),text:new E(this)}),this.update_header()},update_header:function(){var t=this.m,e=this.env.fgcolour?this.ui.convert_RGB(this.env.fgcolour):65535,s=this.env.bgcolour?this.ui.convert_RGB(this.env.bgcolour):65535;this.random_state=0,t.setUint8(1,29|(this.env.timed?128:0)),t.setUint8(17,87&t.getUint8(17)),t.setUint8(32,255),t.setUint8(33,this.env.width),t.setUint16(34,this.env.width),t.setUint16(36,255),t.setUint16(38,257),t.setUint8(44,Math.abs(this.ui.colours.indexOf(s))),t.setUint8(45,Math.abs(this.ui.colours.indexOf(e))),t.setUint16(50,258),this.extension_table(4,0),this.extension_table(5,e),this.extension_table(6,s)},run:function(){var t,s=new Date,i=0;for(this.stop=0;!this.stop;)if(t=this.pc,this.jit[t]||this.compile(),this.jit[t](this),0==++i%5e4&&new Date-s>5e3)return this.act("tick"),e},compile:function(){var t=Z(this),e,s;this.jit[t.pc]=Function("e",u(""+t)),t.pc<this.staticmem&&i.warn("Caching a JIT function in dynamic memory: "+t.pc)},act:function(t,e){e=e||{},this.ui.flush(),this.ui.status.length&&(this.orders.push({code:"stream",to:"status",data:this.ui.status}),this.ui.status=[]),e.code=t,this.orders.push(e),this.stop=1,this.outputEvent(this.orders)}})})(this);
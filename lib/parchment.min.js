/*

Parchment
=========

Built: 2011-12-17

Copyright (c) 2008-2011 The Parchment Contributors
BSD licenced
http://code.google.com/p/parchment

*/
(function(){var a=false,b=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;Object.subClass=function(g){var f=this.prototype,e=f,d,c;a=true;e=new this();a=false;for(d in g){e[d]=typeof g[d]=="function"&&typeof f[d]=="function"&&b.test(g[d])?(function(h,i){return function(){var k=this._super,j;this._super=f[h];j=i.apply(this,arguments);this._super=k;return j}})(d,g[d]):g[d]}c=e.init?function(){if(!a){this.init.apply(this,arguments)}}:function(){};c.prototype=e;c.constructor=c;c.subClass=Object.subClass;return c}})();(function(){function b(h,i){return h[i]<<24|h[i+1]<<16|h[i+2]<<8|h[i+3]}function c(h){return[(h>>24)&255,(h>>16)&255,(h>>8)&255,h&255]}function e(h,i){return String.fromCharCode(h[i],h[i+1],h[i+2],h[i+3])}function g(h){return[h.charCodeAt(0),h.charCodeAt(1),h.charCodeAt(2),h.charCodeAt(3)]}var f=Object.subClass({init:function a(k){this.type="";this.chunks=[];if(k){if(e(k,0)!="FORM"){throw new Error("Not an IFF file")}this.type=e(k,8);var j=12,h=k.length;while(j<h){var m=b(k,j+4);if(m<0||(m+j)>h){throw new Error("IFF: Chunk out of range")}this.chunks.push({type:e(k,j),offset:j,data:k.slice(j+8,j+8+m)});j+=8+m;if(m%2){j++}}}},write:function d(){var m=g(this.type);for(var n=0,j=this.chunks.length;n<j;n++){var k=this.chunks[n],o=k.data,h=o.length;m=m.concat(g(k.type),c(h),o);if(h%2){m.push(0)}}return g("FORM").concat(c(m.length),m)}});f.num_from=b;f.num_to_word=c;f.text_from=e;f.text_to_word=g;window.IFF=f})();(function(k,n,e){var d=n,v=function(C,E){for(var D in E){C[D]=E[D]}return C},c=d.ajaxSetup({cache:1,converters:{"* binary":true}}).isLocal,s={},r=function(E){var D,C=s[E];if(!C){D=d.Callbacks();C=s[E]=D.fire;C.sub=D.add;C.unsub=D.remove}return C},o,q,j,A,g=(function(E){var F=0,C={},D;if(E[0]==""){F++}while(F<E.length){D=/([^=]+)(=(.*))?/.exec(E[F++]);C[D[1]]=D[3]?unescape(D[3]):true}return C})(location.search.slice(1).split(/[&;]/g));parchment=k.parchment={options:{container:"#parchment",lib_path:"lib/",page_title:1,panels:["search","url","about"],proxy_url:"http://zcode.appspot.com/proxy/"},topic:r,vms:[]},load_vm=function(){var E=this,G=0,F,C=[],D;if(this.loaded){return this.loaded}D=this.loaded=d.Deferred();while(G<this.files.length){F=parchment.options.lib_path+this.files[G++];if(/\.js$/.test(F)){C.push(d.getScript(F))}else{o.stylesheet_add(this.id,F)}}d.when.apply(this,C).done(function(){D.resolve(E)});return D};v(parchment.vms,{add:function(C){this.push(C);this[C.id]=C;C.load=load_vm},match:function(E,C){if(this[E]){return this[E]}for(var D=0;D<this.length;D++){if(this[D].match.test(C)){return this[D]}}}});if(c){n.ajaxPrefilter("script",function(C){C.crossDomain=1})}(function(J,E,G){var P=function(U,W){for(var V in W){U[V]=W[V]}return U},M=function(U){U.css({color:U.css("bgcolor"),"background-color":U.css("color")})},L=/inh|tra|(\d+, ?){3}0/,K=E(J),I=E(document),N,R;E(function(){N=E("body");R=parseFloat(N.css("line-height"))});P(E.cssHooks,{bgcolor:{get:function(W){var U=E(W),V=U.css("background-color");if(L.test(V)){return U.parent().css("bgcolor")}return V},set:function(W,X){var U=E(W),V=U.parent();U.css("background-color",X);if(L.test(V.css("background-color"))){V.css("bgcolor",X)}}}});var H=J.scrollByPages||function(V){var U=document.documentElement.clientHeight,W=U-Math.min(U/10,R*2);scrollBy(0,W*V)},T=J.getSelection||function(){return document.selection?document.selection.createRange().text:""},D=Object.subClass({init:function(U){var W=this,V=E("<input>",{"class":"TextInput",autocapitalize:"off",keydown:function(Y){var Z=W.keyCode=Y.which,X;if(W.mode!="line"){return}if(Z==38){W.prev_next(1);X=1}if(Z==40){W.prev_next(-1);X=1}if(Z==33){H(-1);X=1}if(Z==34){H(1);X=1}if(Z==13){W.submitLine();X=1}if(X){return false}},keypress:function(X){if(W.mode=="char"){W.charCode=X.which;W.submitChar();return false}},keyup:function(){if(W.mode=="char"){W.submitChar()}}});W.lastinput=E('<span class="lastinput"/>').appendTo(U);I.on("click.TextInput keydown.TextInput",function(X){if(X.target.nodeName!="INPUT"&&T()==""){if(K.scrollTop()+K.height()-V.offset().top>-60){J.scrollTo(0,9000000000);X.target=V[0];V.focus().trigger(X);X.stopPropagation()}else{if(X.type=="keydown"&&X.which==8){return false}}}});W.history=[];W.input=V;W.container=U;W.statuswin=E("<div>");W.scrollParent=E.browser.webkit?N:E("html");W.msg=parchment.topic("TextInput")},die:function(){I.off(".TextInput")},scroll:function(){this.scrollParent.scrollTop(this.lastinput.offset().top-this.statuswin.height()-R)},getLine:function(V){var X=V.target.children().last(),W=this.input,U;this.order=V;this.mode="line";this.current=0;this.mutable_history=this.history.slice();this.mutable_history.unshift("");U=/^([\s\S]+<br>)(.+?)$/.exec(X.html());if(U){X.html(U[1]);U=X.clone().html(U[2]).appendTo(X)}else{U=X}W.width(20).val("").appendTo(U).width(V.target.offset().left+V.target.width()-W.offset().left);this.scroll()},submitLine:function(){var U=this.input.val();this.lastinput.appendTo(this.input.parent());this.input.detach();if(U!=this.history[0]&&/\S/.test(U)){this.history.unshift(U)}this.msg({mode:"line",input:U});this.mode=0;this.order.response=U;this.order.terminator=13;this.callback(this.order)},prev_next:function(Y){var U=this.input,V=this.mutable_history,W=this.current,X=W+Y;if(X<V.length&&X>=0){V[W]=U.val();U.val(V[X]);this.current=X}},getChar:function(U){this.order=U;this.mode="char";this.keyCode=this.charCode=0;this.input.addClass("CharInput").appendTo(this.container);this.scroll()},submitChar:function(){var W=this.keyCode,U=this.charCode,V={keyCode:W,charCode:U};if(!W&&!U){return}this.input.detach().removeClass("CharInput");this.msg({mode:"char",input:V});this.mode=0;this.order.response=V;this.callback(this.order)}});var C=Object.subClass({init:function(V,W){var U=this;this.elem=V.addClass("TextGrid").on("stream",function(X){U.stream(X.order.data);return false}).css("bgcolor","inherit");this.lineheight=W.env.charheight;this.io=W;W.TextInput.statuswin=this.elem;this.lines=[];this.styles=[];this.cursor=[0,0]},stream:function(Z){var Y,V,ab,aa,X=this.elem,ak=this.cursor[0],W=this.cursor[1],aj=this.lines,ah=this.styles,ac=this.io.env,ai,af,ae,U,ag,ad=this.lines.length;for(ab=0;ab<Z.length;ab++){Y=Z[ab];V=Y.code;if(V=="height"){while(Y.lines>aj.length){ai=[];aa=0;while(aa++<ac.width){ai.push(" ")}aj.push(ai);ah.push(Array(ac.width))}if(Y.lines<this.lines.length){if(Y.lines!=0){ae=E("<div>").addClass("box").prependTo(this.io.target);J.scrollTo(0,J.scrollMaxY);ae.css({top:K.scrollTop()+this.lineheight*Y.lines,left:ae.offset().left-1});this.write(ae,aj.slice(Y.lines),ah.slice(Y.lines))}aj.length=Y.lines;ah.length=Y.lines;if(ak>Y.lines-1){ak=0;W=0}}}if(V=="clear"){aa=0;while(aa<aj.length){ae=0;while(ae<ac.width){aj[aa][ae++]=" "}ah[aa++]=Array(ac.width)}ak=0;W=0}if(V=="cursor"){ak=Y.to[0];W=Y.to[1]}if(V=="get_cursor"){Y.pos=[ak,W];this.io.input(Y)}if(V=="stream"){U=E("<tt>").appendTo(X).css(Y.css||{});if(Y.css&&Y.css.reverse){M(U)}ag=U.attr("style");if(ag){ag=' style="'+ag+'"'}af=Y.text;aa=0;while(aa<af.length){ae=af.charAt(aa++);if(ae!="\n"){aj[ak][W]=ae;ah[ak][W++]=ag}if(ae=="\n"||W==ac.width){ak++;W=0}}}if(V=="eraseline"){for(aa=W;aa<ac.width;aa++){aj[ak][aa]=" ";ah[ak][aa]=G}}}this.cursor=[ak,W];this.write(X,aj,ah);if(aj.length!=ad){E(".main").css("padding-top",X.height())}},write:function(aa,V,Z){var U="",X=0,W,ab,Y;while(X<V.length){ab="";Y=Z[X][0];for(W=0;W<V[X].length;W++){if(Z[X][W]==Y){ab+=V[X][W]}else{U+="<tt"+(Y||"")+">"+ab+"</tt>";Y=Z[X][W];ab=V[X][W]}}U+="<tt"+(Y||"")+">"+ab+"</tt>";if(++X<V.length){U+="<br>"}}aa.html(U)}});var Q=function(U){return"\n"+Array(U.length).join("&ensp;")},O=function(Y){var U=Y.order,X=Y.io.structures[U.name]||{node:"span"},W=U.node||X.node,Z=U.text,V=E("<"+W+">").appendTo(Y.target).addClass(U.name).css(U.css||{});if(U.css&&U.css.reverse){M(V)}if(Z){Z=W=="tt"?Z.replace(/( +)/g,'<span class="space">$1</span>'):Z.replace(/\n +(?=\S)/g,Q);V.html(Z.replace(/\n/g,"<br>"))}if(X.func){X.func(V,Y.io)}return false},S=/(\d+),\s*(\d+),\s*(\d+)/,F=Object.subClass({init:function(X){X=P({},X);this.env=X;var V=this.container=this.target=E(X.container),U=E("<tt>00000</tt>").appendTo(V),Z=U.height(),W=U.width()/5,Y=Math.min(Math.floor(V.width()/W),X.width||80);U.remove();P(X,{charheight:Z,charwidth:W,width:Y,fgcolour:S.exec(V.css("color")).slice(1),bgcolour:S.exec(V.css("bgcolor")).slice(1)});V.on("stream",O).width(Y*W+2);this.TextInput=new D(V);this.structures={main:{node:"div"},status:{node:"div",func:function(aa,ab){new C(aa,ab)}}}},event:function(X){var U,Y,W,Z=this.target,V;for(W=0;W<X.length;W++){U=X[W];Y=U.code;if(Y=="structures"){U.code=G;E.extend(this.structures,U)}if(Y=="find"){this.target=Z=E("."+U.name)}if(Y=="stream"){(U.to?E("."+U.to):Z).trigger({type:"stream",io:this,order:U})}if(Y=="clear"){V=U.name?E("."+U.name):Z;V.empty();if(U.css&&U.css["background-color"]){(U.name=="main"?N:V).css("background-color",U.css["background-color"])}}if(Y=="read"){U.target=Z;this.TextInput.getLine(U)}if(Y=="char"){this.TextInput.getChar(U)}}}});J.StructIO=F;F.TextInput=D})(k,n);var f=Object.subClass({init:function(D,E){var C=this;A=parchment.engine=this.e=new k[E]();this.io=new StructIO(D);this.toEngine=this.io.TextInput.callback=function(F){A.inputEvent(F)};A.outputEvent=function(F){C.fromEngine(F)}},fromParchment:function(D){var C=D.code;if(C=="load"){D.env=this.io.env}this.toEngine(D)},fromEngine:function(G){var F=this.e,E=0,C,H,D;this.io.event(G);for(;E<G.length;E++){C=G[E];H=C.code;if(H=="quit"){return}if(H=="save"||H=="restore"){this.toParchment(C)}if(H=="restart"){this.io.target=this.io.container.empty();D=1}if(H=="tick"){D=1}}if(D){this.toEngine(C)}}});(function(C){k.FatalError=function(D){this.message=D;this.traceback=this._makeTraceback(arguments.callee);this.onError(this);if(C(".load").length>0){C(".load").detach()}};FatalError.prototype={onError:function(E){var D=E.message;C("#parchment").append('<div class="error">An error occurred:<br/><pre>'+D+"\n\n"+E.traceback+"</pre></div>");if(k.console){console.error(D)}},_makeTraceback:function(D){var G="";var F=0;var E=100;while(D!=null&&F<E){var H=D.toString();if(!H){G="\n  (anonymous function)"+G}else{var I=H.match(/function (\w*)/);if(!I||!I[1]){G="\n  (anonymous function)"+G}else{G="\n  "+I[1]+G}}try{D=D.caller}catch(J){D=null}F++}if(F==E){G="..."+G}return"Traceback (most recent call last):\n"+G}}})(n);var w=(function(K,H){var I={},C=JSON?JSON.parse:H.parseJSON,D=JSON?JSON.stringify:function(P){var O=0,N=[],M;switch(typeof P){case"string":return E(P);case"number":case"boolean":return String(P);case"object":if(!P){return"null"}if(Object.prototype.toString.apply(P)=="[object Array]"){while(O<P.length){N.push(D(P[O++])||"null")}return"["+N.join()+"]"}for(O in P){if(M=D(P[O])){N.push(E(O)+":"+M)}}return"{"+N.join()+"}"}},E=function(M){return'"'+M.replace(/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\uffff]/g,function(N){return"\\u"+("0000"+N.charCodeAt(0).toString(16)).slice(-4)})+'"'},L=K.localStorage,J,G,F=function(){if(L){J=!c||!H.browser.mozilla}else{L={}}v(I,{persist:J,get:function(M,O){var N=L["parchment"+M];return/^[[{]/.test(N)?C(N):N},set:function(M,N){L["parchment"+M]=typeof N=="string"?N:D(N)}})};F();return I})(this,n);var m=Object.subClass({init:function(E){v(this,E);var D=this._has,C;if(D){for(C in D){this[C]=new B(m.models[C],this);this[C].fetch(D[C])}}if(this._init_data){this.data()}this._id=this._id||this._id_prop&&this[this._id_prop]||m.id++},save:function(C){var G={},F,D=this._has,E={},H;for(F in this){if(this[F]!=e&&F.charAt(0)!="_"&&!m.models[F]&&typeof this[F]!="function"){G[F]=this[F]}}if(D){for(F in D){if(this[F].length){E[F]=this[F].save(C);H=1}}G._has=H&&E}w.set(this._Class+this._id,G)},set:function(D,C){this[D]=C;this.save()},data:function(C){var D="DATA"+this._Class+this._id;if(C!=e){w.set(D,C)}else{return this._data=this._data||w.get(D)}}}),B=Object.subClass.call(Array,{init:function(C,D){this.Class=C;this._parent=D},fetch:function(C){var F,E,D=this.length=0;C=C||w.get("INDEX"+this.Class.Class);if(C){while(D<C.length){F=C[D++];E=w.get(this.Class.Class+F);if(E){E._id=F;this.add(new this.Class(E))}}}},save:function(C){var F=[],D=0,E;while(D<this.length){E=this[D++];F.push(E._id);if(C){E.save()}}if(this._parent){return F}w.set("INDEX"+this.Class.Class,F)},add:function(C){this.push(C);C._parent=this;C.save();(this._parent||this).save()},find:function(H,F){var G=new B(this.Class,this._parent),E,D,C=0;while(C<this.length){D=this[C++];if(D[H]==F){G.push(D)}}return G}});v(m,{subClass:function(C,D){D=D||{};D._Class=C;var E=Object.subClass.call(this,D);v(E,{Class:C,subClass:m.subClass});m.models[C]=E;return E},models:{},id:(new Date()).getTime(),});var y=(function(I,F){if(I.execScript){execScript("Function VBCStr(x)\nVBCStr=CStr(x)\nEnd Function\nFunction VBLastAsc(x)\nDim l\nl=LenB(x)\nIf l mod 2 Then\nVBLastAsc=AscB(MidB(x,l,1))\nElse\nVBLastAsc=-1\nEnd If\nEnd Function","VBScript")}var G=/chrome/i.test(navigator.userAgent),H=function(Q){return Q.replace(/\u20ac/g,"\x80").replace(/\u201a/g,"\x82").replace(/\u0192/g,"\x83").replace(/\u201e/g,"\x84").replace(/\u2026/g,"\x85").replace(/\u2020/g,"\x86").replace(/\u2021/g,"\x87").replace(/\u02c6/g,"\x88").replace(/\u2030/g,"\x89").replace(/\u0160/g,"\x8a").replace(/\u2039/g,"\x8b").replace(/\u0152/g,"\x8c").replace(/\u017d/g,"\x8e").replace(/\u2018/g,"\x91").replace(/\u2019/g,"\x92").replace(/\u201c/g,"\x93").replace(/\u201d/g,"\x94").replace(/\u2022/g,"\x95").replace(/\u2013/g,"\x96").replace(/\u2014/g,"\x97").replace(/\u02dc/g,"\x98").replace(/\u2122/g,"\x99").replace(/\u0161/g,"\x9a").replace(/\u203a/g,"\x9b").replace(/\u0153/g,"\x9c").replace(/\u017e/g,"\x9e").replace(/\u0178/g,"\x9f")},C=function(S){var T=[],R=0,Q=S.length%8;while(R<Q){T.push(S.charCodeAt(R++))}for(Q=S.length;R<Q;){T.push(S.charCodeAt(R++),S.charCodeAt(R++),S.charCodeAt(R++),S.charCodeAt(R++),S.charCodeAt(R++),S.charCodeAt(R++),S.charCodeAt(R++),S.charCodeAt(R++))}return T},N=function(Q){return String.fromCharCode.apply(this,Q)},J=[],E=(function(T){var Q=[],R=0,S;while(R<65){J.push(S=T.charAt(R));Q[S]=R++}return Q})("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="),D=function(T,R){if(I.atob){return C(atob(T),R)}var R=R||[],V,U,S=0,Q=T.length;while(S<Q){V=E[T.charAt(S++)]<<18|E[T.charAt(S++)]<<12|E[T.charAt(S++)]<<6|E[T.charAt(S++)];R.push(V>>16,(V>>8)&255,V&255)}V=R.pop();U=R.pop();if(U!=64){R.push(U)}if(V!=64){R.push(V)}return R},K=function(V,T){if(I.btoa){return btoa(N(V,T))}var T=T||"",W,S,R,aa,Z,Y,X,U=0,Q=V.length;while(U<Q){W=V[U++];S=V[U++];R=V[U++];aa=W>>2;Z=((W&3)<<4)+(S>>4);Y=((S&15)<<2)+(R>>6);X=R&63;T+=J[aa]+J[Z]+J[Y]+J[X]}if(isNaN(S)){T=T.slice(0,-2)+"=="}else{if(isNaN(R)){T=T.slice(0,-1)+"="}}return T},L=function(V){var W=VBCStr(V),U=VBLastAsc(V),Q=[],S=0,R=W.length%4,T;while(S<R){Q.push((T=W.charCodeAt(S++))&255,T>>8)}R=W.length;while(S<R){Q.push((T=W.charCodeAt(S++))&255,T>>8,(T=W.charCodeAt(S++))&255,T>>8,(T=W.charCodeAt(S++))&255,T>>8,(T=W.charCodeAt(S++))&255,T>>8)}if(U>-1){Q.push(U)}return Q},O=n.ajaxSettings.xhr(),M={binary:O.overrideMimeType&&!(F.browser.opera&&parseFloat(F.browser.version)<10.5)?"charset":"responseBody" in O?"responseBody":0},P=function(S,V,R){var U,Q,T;S=F.trim(S);if(R.mode=="base64"){if(I.atob){T=atob(S);U=C(T)}else{U=D(S);T=N(U)}}else{if(R.mode=="charset"){T=H(S);U=C(T)}else{U=L(R.xhr.responseBody);T=N(U)}}R.responseArray=U;R.responseText=T};O=e;F.ajaxPrefilter("binary",function(R,U,S){var T=c&&!R.crossDomain&&G?0:M.binary,Q=R.xhr;R.xhr=function(){return S.xhr=Q.apply(R)};R.binary=T;S.done(P);R.jsonp=false;R.jsonpCallback="processBase64Zcode";S.mode="base64";if(R.url.slice(-3).toLowerCase()==".js"){return"jsonp"}if(T&&!R.crossDomain){return"text"}if(R.legacy){R.url=R.legacy;return"jsonp"}R.data="url="+R.url;R.url=parchment.options.proxy_url;if(T&&F.support.cors){return"text"}R.data+="&encode=base64&callback=pproxy";R.jsonpCallback="pproxy";return"jsonp"});F.ajaxPrefilter("text",function(Q,S,R){R.mode=Q.binary;if(R.mode=="charset"){Q.mimeType="text/plain; charset=windows-1252"}});return parchment.file={text_to_array:C,array_to_text:N,base64_decode:D,base64_encode:K,support:M}})(k,n);var u='<p><a href="'+location.href+"?story=http://mirror.ifarchive.org/",a=function(C){return u+C.path+'">'+C.desc.entityify()+"</a></p>"},i=Object.subClass({init:function(){this.container=d(parchment.options.container);this.panels={};this.load_indicator=d('<div class="dialog load"><p>Parchment is loading.<p>&gt; <blink>_</blink></div>')},stylesheet_add:function(){var C=arguments,D;for(D=1;D<C.length;D++){if(document.createStyleSheet){document.createStyleSheet(C[D])}else{d("<link>",{rel:"alternate stylesheet",href:C[D],title:C[0],type:"text/css"}).appendTo("head")[0].disabled=true}}},stylesheet_switch:function(D,C){d('link[rel*="stylesheet"][title="'+D+'"]').each(function(){this.disabled=!C})},load_panels:function(){var C=parchment.options.panels,G,F,E,D=function(){var I=RegExp(F.val().replace(" ","( )?"),"i"),H=d.grep(G,function(J){return I.test(J.path+J.desc)});H=H.slice(0,30);E.html(d.map(H,a).join(""))};if(d.inArray("search",C)!=-1){this.panels.search=d('<div class="panel search"><label for="panel_search">Search the IF Archive for games you can play with Parchment. You might also like to search the <a href="http://ifdb.tads.org">IFDB</a> or the <a href="http://ifwiki.org">IF Wiki</a>.</label><input id="panel_search"><div></div></div>');F=this.panels.search.find("input");E=F.next();F.keydown(function(){F.unbind("keydown");d.getJSON("stories/if-archive.json").done(function(H){G=H;F.keyup(D);D()})})}if(d.inArray("url",C)!=-1){this.panels.url=d('<form class="panel url"><label for="panel_url">You may use Parchment to play any story file on the internet, simply copy its address here:</label><input id="panel_url" name="story"></form>')}this.container.append(this.panels[C[0]]);this.panels.active=C[0]}});var h=m.subClass("Savefile",{_init_data:1}),b=m.subClass("Story",{_has:{Savefile:[]},launch:function(C){C=parchment.vms.match(C||this.vm,this.url);if(!C){throw new FatalError("File type is not supported!")}d.when(this.load(),C.load()).done(p);this.set("lastplay",(new Date()).getTime());this.set("playcount",(this.playcount||0)+1)},load:function(){var D=this,E=this.data(),C=d.Deferred();if(E){C.resolve({responseText:E,responseArray:this._array||(this._array=y.text_to_array(E))})}else{d.ajax(this.url,{dataType:"binary",legacy:this.backup}).done(function(G,H,F){C.resolve(F);D.data(F.responseText)}).fail(l)}return C}}),l=function(){throw new FatalError("Parchment could not load the story. Check your connection, and that the URL is correct.")},p=function(E,D){d(".load").detach();j=parchment.runner=new (k[D.runner]||f)(parchment.options,D.engine);var C=location.hash;j.toParchment=function(F){q.fromRunner(j,F)};j.fromParchment({code:"load",data:(new z(E.responseArray)).data});if(C&&C!="#"){j.fromParchment({code:"restore",data:y.base64_decode(C.slice(1))})}else{j.fromParchment({code:"restart"})}},z=IFF.subClass({init:function x(H,D){this.title=D;if(H[0]<9){this._super();this.chunks.push({type:"ZCOD",data:H});this.data=H}else{if(IFF.text_from(H,0)=="Glul"){this._super();this.chunks.push({type:"GLUL",data:H});this.data=H}else{if(IFF.text_from(H,0)=="FORM"){this._super(H);if(this.type=="IFRS"){for(var F=0,C=this.chunks.length;F<C;F++){var G=this.chunks[F].type;if(G=="ZCOD"&&!this.zcode){this.data=this.chunks[F].data}else{if(G=="GLUL"&&!this.glulx){this.data=this.chunks[F].data}else{if(G=="IFmd"){this.metadata=y.array_to_text(this.chunks[F].data);var E=d(this.metadata);if(E){if(d("title",E)){this.title=d("title",E).text()}if(d("ifid",E)){this.ifid=d("ifid",E).text()}if(d("release",E)){this.release=d("release",E).text()}}}}}}}}}}}}),t=B.subClass({load:function(){this.fetch();var D=g.vm,C=this.get_story();if(!C){return o.load_panels()}d("#about").remove();d("body").append(o.load_indicator);if(D){C.set("vm",D)}try{C.launch(D)}catch(E){throw new FatalError(E)}},get_story:function(){var D=parchment.options,F=g.story,C,E;if(D.lock_story){F=D.default_story;if(!F){throw"Story file not specified"}}else{if(D.default_story||F){F=F||D.default_story}else{return}}if(d.isArray(F)){C=F[1];F=F[0]}E=this.find("url",F)[0];if(!E){this.add(E=new b({url:F,backup:C}))}return E},fromRunner:function(F,E){var D=E.code,C=location.hash;if(D=="save"){location.hash=y.base64_encode(E.data)}if(D=="restore"){if(C&&C!="#"){E.data=y.base64_decode(C.slice(1))}}F.fromParchment(E)}});parchment.vms.add({id:"quixe",match:/(ulx|glb|(g|glulx.+)(blorb|blb))(.js)?$/i,files:["prototype.min.js","glkote.min.js","quixe.min.js","glkote.min.css"],runner:"QuixeRunner"});parchment.vms.add({id:"zvm",match:/(z[58]|zlb|(z|zcode.+)(blorb|blb))(.js)?$/i,files:["zvm.min.js"],engine:"ZVM"});parchment.vms.add({id:"gnusto",match:/(z[1-8]|zlb|(z|zcode.+)(blorb|blb))(.js)?$/i,files:["gnusto.min.js"],runner:"GnustoRunner"});d(function(){var C;if(k.parchment_options){d.extend(parchment.options,parchment_options)}if(!parchment.options.lock_options&&g.options){d.extend(parchment.options,d.parseJSON(g.options))}o=parchment.ui=new i();C=parchment.library=new t(b);C.load();if(/iplayif.com/.test(location.host)){d.getScript("http://google-analytics.com/ga.js",function(){_gat._getTracker("UA-7949545-3")._trackPageview()})}})})(this,jQuery);
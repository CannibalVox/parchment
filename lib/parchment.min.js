/*

Parchment
=========

Built: 2011-11-24

Copyright (c) 2008-2011 The Parchment Contributors
BSD licenced
http://code.google.com/p/parchment

*/
(function(){var a=false,b=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;Object.subClass=function(g){var f=this.prototype,e=f,d,c;a=true;e=new this();a=false;for(d in g){e[d]=typeof g[d]=="function"&&typeof f[d]=="function"&&b.test(g[d])?(function(h,i){return function(){var k=this._super,j;this._super=f[h];j=i.apply(this,arguments);this._super=k;return j}})(d,g[d]):g[d]}c=e.init?function(){if(!a){this.init.apply(this,arguments)}}:function(){};c.prototype=e;c.constructor=c;c.subClass=Object.subClass;return c}})();(function(){function b(h,i){return h[i]<<24|h[i+1]<<16|h[i+2]<<8|h[i+3]}function c(h){return[(h>>24)&255,(h>>16)&255,(h>>8)&255,h&255]}function e(h,i){return String.fromCharCode(h[i],h[i+1],h[i+2],h[i+3])}function g(h){return[h.charCodeAt(0),h.charCodeAt(1),h.charCodeAt(2),h.charCodeAt(3)]}var f=Object.subClass({init:function a(k){this.type="";this.chunks=[];if(k){if(e(k,0)!="FORM"){throw new Error("Not an IFF file")}this.type=e(k,8);var j=12,h=k.length;while(j<h){var m=b(k,j+4);if(m<0||(m+j)>h){throw new Error("IFF: Chunk out of range")}this.chunks.push({type:e(k,j),offset:j,data:k.slice(j+8,j+8+m)});j+=8+m;if(m%2){j++}}}},write:function d(){var m=g(this.type);for(var n=0,j=this.chunks.length;n<j;n++){var k=this.chunks[n],o=k.data,h=o.length;m=m.concat(g(k.type),c(h),o);if(h%2){m.push(0)}}return g("FORM").concat(c(m.length),m)}});f.num_from=b;f.num_to_word=c;f.text_from=e;f.text_to_word=g;window.IFF=f})();(function(l,o,e){var d=o,w=function(D,F){for(var E in F){D[E]=F[E]}return D},c=d.ajaxSetup({cache:1,converters:{"* binary":true}}).isLocal,t={},s=function(F){var E,D=t[F];if(!D){E=d.Callbacks();D=t[F]=E.fire;D.sub=E.add;D.unsub=E.remove}return D},p,r,k,B,h=l.parchment={options:{container:"#parchment",lib_path:"lib/",page_title:1,panels:["search","url","about"],proxy_url:"http://zcode.appspot.com/proxy/"},topic:s,vms:[]},f=function(){var F=this,H=0,G,D=[],E;if(this.loaded){return this.loaded}E=this.loaded=d.Deferred();while(H<this.files.length){G=h.options.lib_path+this.files[H++];if(/\.js$/.test(G)){D.push(d.getScript(G))}else{p.stylesheet_add(this.id,G)}}d.when.apply(this,D).done(function(){E.resolve(F)});return E};w(h.vms,{add:function(D){this.push(D);this[D.id]=D;D.load=f},match:function(F,D){if(this[F]){return this[F]}for(var E=0;E<this.length;E++){if(this[E].match.test(D)){return this[E]}}}});if(c){o.ajaxPrefilter("script",function(D){D.crossDomain=1})}(function(N,J,E){var R=/inh|tra|(\d+, ?){3}0/,D=J(N),I=J(document),H;J(function(){H=J("body")});w(J.cssHooks,{bgcolor:{get:function(U){var S=J(U),T=S.css("background-color");if(R.test(T)){return S.parent().css("bgcolor")}return T},set:function(U,V){var S=J(U),T=S.parent();S.css("background-color",V);if(R.test(T.css("background-color"))){T.css("bgcolor",V)}}},reverse:{set:function(T,U){if(U){var S=J(T);S.css({color:S.css("bgcolor"),"background-color":S.css("color")})}}}});var M=N.scrollByPages,G,Q=N.getSelection||function(){return document.selection?document.selection.createRange().text:""};if(!M){J(function(){G=parseInt(H.css("line-height"))*2});M=function(T){var S=document.documentElement.clientHeight,U=S-Math.min(S/10,G);scrollBy(0,U*T)}}var K=Object.subClass({init:function(S){var U=this,T=J("<input>",{"class":"TextInput",autocapitalize:"off",keydown:function(W){var X=U.keyCode=W.which,V;if(U.mode!="line"){return}if(X==38){U.prev_next(1);V=1}if(X==40){U.prev_next(-1);V=1}if(X==33){M(-1);V=1}if(X==34){M(1);V=1}if(X==13){U.submitLine();V=1}if(V){return false}},keypress:function(V){if(U.mode=="char"){U.charCode=V.which;U.submitChar();return false}},keyup:function(){if(U.mode=="char"){U.submitChar()}}});U.lastinput=J('<span class="lastinput"/>').appendTo(S);I.on("click.TextInput keydown.TextInput",function(V){if(V.target.nodeName!="INPUT"&&Q()==""&&D.scrollTop()+D.height()-T.offset().top>-60){V.stopPropagation();N.scrollTo(0,N.scrollMaxY);T.focus().trigger(V)}});U.history=[];U.input=T;U.container=S;U.statuswin=J("<div>");U.scrollParent=J.browser.webkit?H:J("html");U.msg=h.topic("TextInput")},die:function(){I.off(".TextInput")},getLine:function(T){var V=T.target.children().last(),U=this.input,W=this.scrollParent,S;this.order=T;this.mode="line";this.current=0;this.mutable_history=this.history.slice();this.mutable_history.unshift("");S=/^([\s\S]+<br>)(.+?)$/.exec(V.html());if(S){V.html(S[1]);S=V.clone().html(S[2]).appendTo(V)}else{S=V}U.width(20).val("").appendTo(S).width(T.target.offset().left+T.target.width()-U.offset().left);W.scrollTop(this.lastinput.offset().top-this.statuswin.height()-S.height())},submitLine:function(){var S=this.input.val();this.lastinput.appendTo(this.input.parent());this.input.detach();if(S!=this.history[0]&&/\S/.test(S)){this.history.unshift(S)}this.msg({mode:"line",input:S});this.mode=0;this.order.response=S;this.order.terminator=13;this.callback(this.order)},prev_next:function(W){var S=this.input,T=this.mutable_history,U=this.current,V=U+W;if(V<T.length&&V>=0){T[U]=S.val();S.val(T[V]);this.current=V}},getChar:function(S){this.order=S;this.mode="char";this.keyCode=this.charCode=0;this.input.addClass("CharInput").appendTo(this.container)},submitChar:function(){var U=this.keyCode,S=this.charCode,T={keyCode:U,charCode:S};if(!U&&!S){return}this.input.detach().removeClass("CharInput");this.msg({mode:"char",input:T});this.mode=0;this.order.response=T;this.callback(this.order)}});var P=Object.subClass({init:function(T,U){var S=this;this.elem=T.addClass("TextGrid").on("stream",function(V){S.stream(V.order.data);return false}).css("bgcolor","inherit");this.lineheight=U.env.charheight;this.io=U;U.TextInput.statuswin=this.elem;this.lines=[];this.styles=[];this.cursor=[0,0]},stream:function(W){var V,S,Y,X,U=this.elem,ah=this.cursor[0],T=this.cursor[1],ag=this.lines,ae=this.styles,Z=this.io.env,af,ac,ab,ad,aa=this.lines.length;for(Y=0;Y<W.length;Y++){V=W[Y];S=V.code;if(S=="height"){while(V.lines>ag.length){af=[];X=0;while(X++<Z.width){af.push(" ")}ag.push(af);ae.push(Array(Z.width))}if(V.lines<this.lines.length){if(V.lines!=0){ab=J("<div>").addClass("box").prependTo(this.io.target);N.scrollTo(0,N.scrollMaxY);ab.css({top:D.scrollTop()+this.lineheight*V.lines,left:ab.offset().left-1});this.write(ab,ag.slice(V.lines),ae.slice(V.lines))}ag.length=V.lines;ae.length=V.lines;if(ah>V.lines-1){ah=0;T=0}}}if(S=="clear"){X=0;while(X<ag.length){ab=0;while(ab<Z.width){ag[X][ab++]=" "}ae[X++]=Array(Z.width)}ah=0;T=0}if(S=="cursor"){ah=V.to[0];T=V.to[1]}if(S=="get_cursor"){V.pos=[ah,T];this.io.input(V)}if(S=="stream"){ad=J("<tt>").appendTo(U).css(V.css||{}).attr("style");if(ad){ad=' style="'+ad+'"'}ac=V.text;X=0;while(X<ac.length){ab=ac.charAt(X++);if(ab!="\n"){ag[ah][T]=ab;ae[ah][T++]=ad}if(ab=="\n"||T==Z.width){ah++;T=0}}}if(S=="eraseline"){for(X=T;X<Z.width;X++){ag[ah][X]=" ";ae[ah][X]=E}}}this.cursor=[ah,T];this.write(U,ag,ae);if(ag.length!=aa){J(".main").css("padding-top",U.height())}},write:function(Y,T,X){var S="",V=0,U,Z,W;while(V<T.length){Z="";W=X[V][0];for(U=0;U<T[V].length;U++){if(X[V][U]==W){Z+=T[V][U]}else{S+="<tt"+(W||"")+">"+Z+"</tt>";W=X[V][U];Z=T[V][U]}}S+="<tt"+(W||"")+">"+Z+"</tt>";if(++V<T.length){S+="<br>"}}Y.html(S)}});var L=function(S){return"\n"+Array(S.length).join("&ensp;")},O=function(W){var S=W.order,V=W.io.structures[S.name]||{node:"span"},U=S.node||V.node,X=S.text,T=J("<"+U+">").appendTo(W.target).addClass(S.name).css(S.css||{});if(X){if(U!="tt"){X=X.replace(/\n +(?=\S)/g,L)}T.html(X.replace(/\n/g,"<br>"))}if(V.func){V.func(T,W.io)}return false},F=Object.subClass({init:function(V){V=w({},V);this.env=V;var T=this.container=this.target=J(V.container),S=J("<tt>00000</tt>").appendTo(T),X=S.height(),U=S.width()/5,W=Math.min(Math.floor(T.width()/U),V.width||80);S.remove();w(V,{charheight:X,charwidth:U,width:W});T.on("stream",O).width(W*U);this.TextInput=new K(T);this.structures={main:{node:"div"},status:{node:"div",func:function(Y,Z){new P(Y,Z)}}}},event:function(V){var S,W,U,X=this.target,T;for(U=0;U<V.length;U++){S=V[U];W=S.code;if(W=="structures"){S.code=E;J.extend(this.structures,S)}if(W=="find"){this.target=X=J("."+S.name)}if(W=="stream"){(S.to?J("."+S.to):X).trigger({type:"stream",io:this,order:S})}if(W=="clear"){T=S.name?J("."+S.name):X;T.empty();if(S.css&&S.css["background-color"]){(S.name=="main"?T:H).css("background-color",S.css["background-color"])}}if(W=="read"){S.target=X;this.TextInput.getLine(S)}if(W=="char"){this.TextInput.getChar(S)}}}});N.StructIO=F;F.TextInput=K})(l,o);var g=Object.subClass({init:function(F,E){var D=this;E=l.engine=this.e=new l[E]();this.io=new StructIO(F);this.toEngine=this.io.TextInput.callback=function(G){E.inputEvent(G)};E.outputEvent=function(G){D.fromEngine(G)}},fromParchment:function(E){var D=E.code;if(D=="load"){E.env=this.io.env}this.toEngine(E)},fromEngine:function(H){var G=this.e,F=0,D,I,E;this.io.event(H);for(;F<H.length;F++){D=H[F];I=D.code;if(I=="quit"){return}if(I=="save"||I=="restore"){this.toParchment(D)}if(I=="restart"){this.io.target=this.io.container.empty();E=1}if(I=="tick"){E=1}}if(E){this.toEngine(D)}}});(function(D){l.FatalError=function(E){this.message=E;this.traceback=this._makeTraceback(arguments.callee);this.onError(this);if(D(".load").length>0){D(".load").detach()}};FatalError.prototype={onError:function(F){var E=F.message;D("#parchment").append('<div class="error">An error occurred:<br/><pre>'+E+"\n\n"+F.traceback+"</pre></div>");if(l.console){console.error(E)}},_makeTraceback:function(E){var H="";var G=0;var F=100;while(E!=null&&G<F){var I=E.toString();if(!I){H="\n  (anonymous function)"+H}else{var J=I.match(/function (\w*)/);if(!J||!J[1]){H="\n  (anonymous function)"+H}else{H="\n  "+J[1]+H}}try{E=E.caller}catch(K){E=null}G++}if(G==F){H="..."+H}return"Traceback (most recent call last):\n"+H}}})(o);var x=(function(L,I){var J={},D=JSON?JSON.parse:I.parseJSON,E=JSON?JSON.stringify:function(Q){var P=0,O=[],N;switch(typeof Q){case"string":return F(Q);case"number":case"boolean":return String(Q);case"object":if(!Q){return"null"}if(Object.prototype.toString.apply(Q)=="[object Array]"){while(P<Q.length){O.push(E(Q[P++])||"null")}return"["+O.join()+"]"}for(P in Q){if(N=E(Q[P])){O.push(F(P)+":"+N)}}return"{"+O.join()+"}"}},F=function(N){return'"'+N.replace(/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\uffff]/g,function(O){return"\\u"+("0000"+O.charCodeAt(0).toString(16)).slice(-4)})+'"'},M=L.localStorage,K,H,G=function(){if(M){K=!c||!I.browser.mozilla}else{M={}}w(J,{persist:K,get:function(N,P){var O=M["parchment"+N];return/^[[{]/.test(O)?D(O):O},set:function(N,O){M["parchment"+N]=typeof O=="string"?O:E(O)}})};G();return J})(this,o);var n=Object.subClass({init:function(F){w(this,F);var E=this._has,D;if(E){for(D in E){this[D]=new C(n.models[D],this);this[D].fetch(E[D])}}if(this._init_data){this.data()}this._id=this._id||this._id_prop&&this[this._id_prop]||n.id++},save:function(D){var H={},G,E=this._has,F={},I;for(G in this){if(this[G]!=e&&G.charAt(0)!="_"&&!n.models[G]&&typeof this[G]!="function"){H[G]=this[G]}}if(E){for(G in E){if(this[G].length){F[G]=this[G].save(D);I=1}}H._has=I&&F}x.set(this._Class+this._id,H)},set:function(E,D){this[E]=D;this.save()},data:function(D){var E="DATA"+this._Class+this._id;if(D!=e){x.set(E,D)}else{return this._data=this._data||x.get(E)}}}),C=Object.subClass.call(Array,{init:function(D,E){this.Class=D;this._parent=E},fetch:function(D){var G,F,E=this.length=0;D=D||x.get("INDEX"+this.Class.Class);if(D){while(E<D.length){G=D[E++];F=x.get(this.Class.Class+G);if(F){F._id=G;this.add(new this.Class(F))}}}},save:function(D){var G=[],E=0,F;while(E<this.length){F=this[E++];G.push(F._id);if(D){F.save()}}if(this._parent){return G}x.set("INDEX"+this.Class.Class,G)},add:function(D){this.push(D);D._parent=this;D.save();(this._parent||this).save()},find:function(I,G){var H=new C(this.Class,this._parent),F,E,D=0;while(D<this.length){E=this[D++];if(E[I]==G){H.push(E)}}return H}});w(n,{subClass:function(D,E){E=E||{};E._Class=D;var F=Object.subClass.call(this,E);w(F,{Class:D,subClass:n.subClass});n.models[D]=F;return F},models:{},id:(new Date()).getTime(),});var z=(function(J,G){if(J.execScript){execScript("Function VBCStr(x)\nVBCStr=CStr(x)\nEnd Function\nFunction VBLastAsc(x)\nDim l\nl=LenB(x)\nIf l mod 2 Then\nVBLastAsc=AscB(MidB(x,l,1))\nElse\nVBLastAsc=-1\nEnd If\nEnd Function","VBScript")}var H=/chrome/i.test(navigator.userAgent),I=function(R){return R.replace(/\u20ac/g,"\x80").replace(/\u201a/g,"\x82").replace(/\u0192/g,"\x83").replace(/\u201e/g,"\x84").replace(/\u2026/g,"\x85").replace(/\u2020/g,"\x86").replace(/\u2021/g,"\x87").replace(/\u02c6/g,"\x88").replace(/\u2030/g,"\x89").replace(/\u0160/g,"\x8a").replace(/\u2039/g,"\x8b").replace(/\u0152/g,"\x8c").replace(/\u017d/g,"\x8e").replace(/\u2018/g,"\x91").replace(/\u2019/g,"\x92").replace(/\u201c/g,"\x93").replace(/\u201d/g,"\x94").replace(/\u2022/g,"\x95").replace(/\u2013/g,"\x96").replace(/\u2014/g,"\x97").replace(/\u02dc/g,"\x98").replace(/\u2122/g,"\x99").replace(/\u0161/g,"\x9a").replace(/\u203a/g,"\x9b").replace(/\u0153/g,"\x9c").replace(/\u017e/g,"\x9e").replace(/\u0178/g,"\x9f")},D=function(T){var U=[],S=0,R=T.length%8;while(S<R){U.push(T.charCodeAt(S++))}for(R=T.length;S<R;){U.push(T.charCodeAt(S++),T.charCodeAt(S++),T.charCodeAt(S++),T.charCodeAt(S++),T.charCodeAt(S++),T.charCodeAt(S++),T.charCodeAt(S++),T.charCodeAt(S++))}return U},O=function(R){return String.fromCharCode.apply(this,R)},K=[],F=(function(U){var R=[],S=0,T;while(S<65){K.push(T=U.charAt(S));R[T]=S++}return R})("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="),E=function(U,S){if(J.atob){return D(atob(U),S)}var S=S||[],W,V,T=0,R=U.length;while(T<R){W=F[U.charAt(T++)]<<18|F[U.charAt(T++)]<<12|F[U.charAt(T++)]<<6|F[U.charAt(T++)];S.push(W>>16,(W>>8)&255,W&255)}W=S.pop();V=S.pop();if(V!=64){S.push(V)}if(W!=64){S.push(W)}return S},L=function(W,U){if(J.btoa){return btoa(O(W,U))}var U=U||"",X,T,S,ab,aa,Z,Y,V=0,R=W.length;while(V<R){X=W[V++];T=W[V++];S=W[V++];ab=X>>2;aa=((X&3)<<4)+(T>>4);Z=((T&15)<<2)+(S>>6);Y=S&63;U+=K[ab]+K[aa]+K[Z]+K[Y]}if(isNaN(T)){U=U.slice(0,-2)+"=="}else{if(isNaN(S)){U=U.slice(0,-1)+"="}}return U},M=function(W){var X=VBCStr(W),V=VBLastAsc(W),R=[],T=0,S=X.length%4,U;while(T<S){R.push((U=X.charCodeAt(T++))&255,U>>8)}S=X.length;while(T<S){R.push((U=X.charCodeAt(T++))&255,U>>8,(U=X.charCodeAt(T++))&255,U>>8,(U=X.charCodeAt(T++))&255,U>>8,(U=X.charCodeAt(T++))&255,U>>8)}if(V>-1){R.push(V)}return R},P=o.ajaxSettings.xhr(),N={binary:P.overrideMimeType&&!(G.browser.opera&&parseFloat(G.browser.version)<10.5)?"charset":"responseBody" in P?"responseBody":0},Q=function(T,W,S){var V,R,U;T=G.trim(T);if(S.mode=="base64"){if(J.atob){U=atob(T);V=D(U)}else{V=E(T);U=O(V)}}else{if(S.mode=="charset"){U=I(T);V=D(U)}else{V=M(S.xhr.responseBody);U=O(V)}}S.responseArray=V;S.responseText=U};P=e;G.ajaxPrefilter("binary",function(S,V,T){var U=c&&!S.crossDomain&&H?0:N.binary,R=S.xhr;S.xhr=function(){return T.xhr=R.apply(S)};S.binary=U;T.done(Q);S.jsonp=false;S.jsonpCallback="processBase64Zcode";T.mode="base64";if(S.url.slice(-3).toLowerCase()==".js"){return"jsonp"}if(U&&!S.crossDomain){return"text"}if(S.legacy){S.url=S.legacy;return"jsonp"}S.data="url="+S.url;S.url=h.options.proxy_url;if(U&&G.support.cors){return"text"}S.data+="&encode=base64&callback=pproxy";S.jsonpCallback="pproxy";return"jsonp"});G.ajaxPrefilter("text",function(R,T,S){S.mode=R.binary;if(S.mode=="charset"){R.mimeType="text/plain; charset=windows-1252"}});return h.file={text_to_array:D,array_to_text:O,base64_decode:E,base64_encode:L,support:N}})(l,o);var v='<p><a href="'+location.href+"?story=http://mirror.ifarchive.org/",a=function(D){return v+D.path+'">'+D.desc.entityify()+"</a></p>"},j=Object.subClass({init:function(){this.container=d(h.options.container);this.panels={};this.load_indicator=d('<div class="dialog load"><p>Parchment is loading.<p>&gt; <blink>_</blink></div>')},stylesheet_add:function(){var D=arguments,E;for(E=1;E<D.length;E++){if(document.createStyleSheet){document.createStyleSheet(D[E])}else{d("<link>",{rel:"alternate stylesheet",href:D[E],title:D[0],type:"text/css"}).appendTo("head")[0].disabled=true}}},stylesheet_switch:function(E,D){d('link[rel*="stylesheet"][title="'+E+'"]').each(function(){this.disabled=!D})},load_panels:function(){var D=h.options.panels,H,G,F,E=function(){var J=RegExp(G.val().replace(" ","( )?"),"i"),I=d.grep(H,function(K){return J.test(K.path+K.desc)});I=I.slice(0,30);F.html(d.map(I,a).join(""))};if(d.inArray("search",D)!=-1){this.panels.search=d('<div class="panel search"><label for="panel_search">Search the IF Archive for games you can play with Parchment. You might also like to search the <a href="http://ifdb.tads.org">IFDB</a> or the <a href="http://ifwiki.org">IF Wiki</a>.</label><input id="panel_search"><div></div></div>');G=this.panels.search.find("input");F=G.next();G.keydown(function(){G.unbind("keydown");d.getJSON("stories/if-archive.json").done(function(I){H=I;G.keyup(E);E()})})}if(d.inArray("url",D)!=-1){this.panels.url=d('<form class="panel url"><label for="panel_url">You may use Parchment to play any story file on the internet, simply copy its address here:</label><input id="panel_url" name="story"></form>')}this.container.append(this.panels[D[0]]);this.panels.active=D[0]}});var i=n.subClass("Savefile",{_init_data:1}),b=n.subClass("Story",{_has:{Savefile:[]},launch:function(D){D=h.vms.match(D||this.vm,this.url);if(!D){throw new FatalError("File type is not supported!")}d.when(this.load(),D.load()).done(q);this.set("lastplay",(new Date()).getTime());this.set("playcount",(this.playcount||0)+1)},load:function(){var E=this,F=this.data(),D=d.Deferred();if(F){D.resolve({responseText:F,responseArray:this._array||(this._array=z.text_to_array(F))})}else{d.ajax(this.url,{dataType:"binary",legacy:this.backup}).done(function(H,I,G){D.resolve(G);E.data(G.responseText)}).fail(m)}return D}}),m=function(){throw new FatalError("Parchment could not load the story. Check your connection, and that the URL is correct.")},q=function(F,E){d(".load").detach();k=h.runner=new (l[E.runner]||g)(h.options,E.engine);var D=location.hash;k.toParchment=function(G){r.fromRunner(k,G)};k.fromParchment({code:"load",data:(new A(F.responseArray)).data});if(D&&D!="#"){k.fromParchment({code:"restore",data:z.base64_decode(D.slice(1))})}else{k.fromParchment({code:"restart"})}},A=IFF.subClass({init:function y(I,E){this.title=E;if(I[0]<9){this._super();this.chunks.push({type:"ZCOD",data:I});this.data=I}else{if(IFF.text_from(I,0)=="Glul"){this._super();this.chunks.push({type:"GLUL",data:I});this.data=I}else{if(IFF.text_from(I,0)=="FORM"){this._super(I);if(this.type=="IFRS"){for(var G=0,D=this.chunks.length;G<D;G++){var H=this.chunks[G].type;if(H=="ZCOD"&&!this.zcode){this.data=this.chunks[G].data}else{if(H=="GLUL"&&!this.glulx){this.data=this.chunks[G].data}else{if(H=="IFmd"){this.metadata=z.array_to_text(this.chunks[G].data);var F=d(this.metadata);if(F){if(d("title",F)){this.title=d("title",F).text()}if(d("ifid",F)){this.ifid=d("ifid",F).text()}if(d("release",F)){this.release=d("release",F).text()}}}}}}}}}}}}),u=C.subClass({load:function(){this.fetch();var E=/vm=(\w+)/.exec(location.search),D=this.get_story();if(!D){return p.load_panels()}d("#about").remove();d("body").append(p.load_indicator);if(E){D.set("vm",E=E[1])}try{D.launch(E)}catch(F){throw new FatalError(F)}},get_story:function(){var E=h.options,G=/story=([^;&]+)/.exec(location.search),D,F;if(E.lock_story){G=E.default_story;if(!G){throw"Story file not specified"}}else{if(E.default_story||G){G=G&&unescape(G[1])||E.default_story}else{return}}if(d.isArray(G)){D=G[1];G=G[0]}F=this.find("url",G)[0];if(!F){this.add(F=new b({url:G,backup:D}))}return F},fromRunner:function(G,F){var E=F.code,D=location.hash;if(E=="save"){location.hash=z.base64_encode(F.data)}if(E=="restore"){if(D&&D!="#"){F.data=z.base64_decode(D.slice(1))}}G.fromParchment(F)}});h.vms.add({id:"quixe",match:/(ulx|glb|(g|glulx.+)(blorb|blb))(.js)?$/i,files:["prototype.min.js","glkote.min.js","quixe.min.js","glkote.min.css"],runner:"QuixeRunner"});h.vms.add({id:"zvm",match:/(z[58]|zlb|(z|zcode.+)(blorb|blb))(.js)?$/i,files:["zvm.min.js"],engine:"ZVM"});h.vms.add({id:"gnusto",match:/(z[1-8]|zlb|(z|zcode.+)(blorb|blb))(.js)?$/i,files:["gnusto.min.js"],runner:"GnustoRunner"});d(function(){var D=/options=([^;&]+)/.exec(location.search);if(l.parchment_options){d.extend(h.options,parchment_options)}if(!h.options.lock_options&&D){d.extend(h.options,d.parseJSON(unescape(D[1])))}p=h.ui=new j();r=h.library=new u(b);r.load();if(/iplayif.com/.test(location.host)){d.getScript("http://google-analytics.com/ga.js",function(){_gat._getTracker("UA-7949545-3")._trackPageview()})}})})(this,jQuery);
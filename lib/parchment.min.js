/*

Parchment
=========

Built: 2011-12-18

Copyright (c) 2008-2011 The Parchment Contributors
BSD licenced
http://code.google.com/p/parchment

*/
(function(){var a=false,b=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;Object.subClass=function(g){var f=this.prototype,e=f,d,c;a=true;e=new this();a=false;for(d in g){e[d]=typeof g[d]=="function"&&typeof f[d]=="function"&&b.test(g[d])?(function(h,i){return function(){var k=this._super,j;this._super=f[h];j=i.apply(this,arguments);this._super=k;return j}})(d,g[d]):g[d]}c=e.init?function(){if(!a){this.init.apply(this,arguments)}}:function(){};c.prototype=e;c.constructor=c;c.subClass=Object.subClass;return c}})();(function(){function b(h,i){return h[i]<<24|h[i+1]<<16|h[i+2]<<8|h[i+3]}function c(h){return[(h>>24)&255,(h>>16)&255,(h>>8)&255,h&255]}function e(h,i){return String.fromCharCode(h[i],h[i+1],h[i+2],h[i+3])}function g(h){return[h.charCodeAt(0),h.charCodeAt(1),h.charCodeAt(2),h.charCodeAt(3)]}var f=Object.subClass({init:function a(k){this.type="";this.chunks=[];if(k){if(e(k,0)!="FORM"){throw new Error("Not an IFF file")}this.type=e(k,8);var j=12,h=k.length;while(j<h){var m=b(k,j+4);if(m<0||(m+j)>h){throw new Error("IFF: Chunk out of range")}this.chunks.push({type:e(k,j),offset:j,data:k.slice(j+8,j+8+m)});j+=8+m;if(m%2){j++}}}},write:function d(){var m=g(this.type);for(var n=0,j=this.chunks.length;n<j;n++){var k=this.chunks[n],o=k.data,h=o.length;m=m.concat(g(k.type),c(h),o);if(h%2){m.push(0)}}return g("FORM").concat(c(m.length),m)}});f.num_from=b;f.num_to_word=c;f.text_from=e;f.text_to_word=g;window.IFF=f})();(function(h,c,e){var n=function(s,u){for(var t in u){s[t]=u[t]}return s},k=function(s){s.css({color:s.css("bgcolor"),"background-color":s.css("color")})},j=/inh|tra|(\d+, ?){3}0/,i=c(h),g=c(document),l,p;c(function(){l=c("body");p=parseFloat(l.css("line-height"))});n(c.cssHooks,{bgcolor:{get:function(u){var s=c(u),t=s.css("background-color");if(j.test(t)){return s.parent().css("bgcolor")}return t},set:function(u,v){var s=c(u),t=s.parent();s.css("background-color",v);if(j.test(t.css("background-color"))){t.css("bgcolor",v)}}}});var f=h.scrollByPages||function(t){var s=document.documentElement.clientHeight,u=s-Math.min(s/10,p*2);scrollBy(0,u*t)},r=h.getSelection||function(){return document.selection?document.selection.createRange().text:""},b=Object.subClass({init:function(s){var u=this,t=c("<input>",{"class":"TextInput",autocapitalize:"off",keydown:function(w){var x=u.keyCode=w.which,v;if(u.mode!="line"){return}if(x==38){u.prev_next(1);v=1}if(x==40){u.prev_next(-1);v=1}if(x==33){f(-1);v=1}if(x==34){f(1);v=1}if(x==13){u.submitLine();v=1}if(v){return false}},keypress:function(v){if(u.mode=="char"){u.charCode=v.which;u.submitChar();return false}},keyup:function(){if(u.mode=="char"){u.submitChar()}}});u.lastinput=c('<span class="lastinput"/>').appendTo(s);g.on("click.TextInput keydown.TextInput",function(v){if(!ui.modal&&v.target.nodeName!="INPUT"&&r()==""){if(i.scrollTop()+i.height()-t.offset().top>-60){h.scrollTo(0,9000000000);v.target=t[0];t.focus().trigger(v);v.stopPropagation()}else{if(v.type=="keydown"&&v.which==8){return false}}}});u.history=[];u.input=t;u.container=s;u.statuswin=c("<div>");u.scrollParent=c.browser.webkit?l:c("html");u.msg=parchment.topic("TextInput")},die:function(){g.off(".TextInput")},scroll:function(){this.scrollParent.scrollTop(this.lastinput.offset().top-this.statuswin.height()-p)},getLine:function(t){var v=t.target.children().last(),u=this.input,s;this.order=t;this.mode="line";this.current=0;this.mutable_history=this.history.slice();this.mutable_history.unshift("");s=/^([\s\S]+<br>)(.+?)$/.exec(v.html());if(s){v.html(s[1]);s=v.clone().html(s[2]).appendTo(v)}else{s=v}u.width(20).val("").appendTo(s).width(t.target.offset().left+t.target.width()-u.offset().left);this.scroll()},submitLine:function(){var s=this.input.val();this.lastinput.appendTo(this.input.parent());this.input.detach();if(s!=this.history[0]&&/\S/.test(s)){this.history.unshift(s)}this.msg({mode:"line",input:s});this.mode=0;this.order.response=s;this.order.terminator=13;this.callback(this.order)},prev_next:function(w){var s=this.input,t=this.mutable_history,u=this.current,v=u+w;if(v<t.length&&v>=0){t[u]=s.val();s.val(t[v]);this.current=v}},getChar:function(s){this.order=s;this.mode="char";this.keyCode=this.charCode=0;this.input.addClass("CharInput").appendTo(this.container);this.scroll()},submitChar:function(){var u=this.keyCode,s=this.charCode,t={keyCode:u,charCode:s};if(!u&&!s){return}this.input.detach().removeClass("CharInput");this.msg({mode:"char",input:t});this.mode=0;this.order.response=t;this.callback(this.order)}});var a=Object.subClass({init:function(t,u){var s=this;this.elem=t.addClass("TextGrid").on("stream",function(v){s.stream(v.order.data);return false}).css("bgcolor","inherit");this.lineheight=u.env.charheight;this.io=u;u.TextInput.statuswin=this.elem;this.lines=[];this.styles=[];this.cursor=[0,0]},stream:function(x){var w,t,z,y,v=this.elem,I=this.cursor[0],u=this.cursor[1],H=this.lines,F=this.styles,A=this.io.env,G,D,C,s,E,B=this.lines.length;for(z=0;z<x.length;z++){w=x[z];t=w.code;if(t=="height"){while(w.lines>H.length){G=[];y=0;while(y++<A.width){G.push(" ")}H.push(G);F.push(Array(A.width))}if(w.lines<this.lines.length){if(w.lines!=0){C=c("<div>").addClass("box").prependTo(this.io.target);h.scrollTo(0,h.scrollMaxY);C.css({top:i.scrollTop()+this.lineheight*w.lines,left:C.offset().left-1});this.write(C,H.slice(w.lines),F.slice(w.lines))}H.length=w.lines;F.length=w.lines;if(I>w.lines-1){I=0;u=0}}}if(t=="clear"){y=0;while(y<H.length){C=0;while(C<A.width){H[y][C++]=" "}F[y++]=Array(A.width)}I=0;u=0}if(t=="cursor"){I=w.to[0];u=w.to[1]}if(t=="get_cursor"){w.pos=[I,u];this.io.input(w)}if(t=="stream"){s=c("<tt>").appendTo(v).css(w.css||{});if(w.css&&w.css.reverse){k(s)}E=s.attr("style");if(E){E=' style="'+E+'"'}D=w.text;y=0;while(y<D.length){C=D.charAt(y++);if(C!="\n"){H[I][u]=C;F[I][u++]=E}if(C=="\n"||u==A.width){I++;u=0}}}if(t=="eraseline"){for(y=u;y<A.width;y++){H[I][y]=" ";F[I][y]=e}}}this.cursor=[I,u];this.write(v,H,F);if(H.length!=B){c(".main").css("padding-top",v.height())}},write:function(y,t,x){var s="",v=0,u,z,w;while(v<t.length){z="";w=x[v][0];for(u=0;u<t[v].length;u++){if(x[v][u]==w){z+=t[v][u]}else{s+="<tt"+(w||"")+">"+z+"</tt>";w=x[v][u];z=t[v][u]}}s+="<tt"+(w||"")+">"+z+"</tt>";if(++v<t.length){s+="<br>"}}y.html(s)}});var o=function(s){return"\n"+Array(s.length).join("&ensp;")},m=function(w){var s=w.order,v=w.io.structures[s.name]||{node:"span"},u=s.node||v.node,x=s.text,t=c("<"+u+">").appendTo(w.target).addClass(s.name).css(s.css||{});if(s.css&&s.css.reverse){k(t)}if(x){x=u=="tt"?x.replace(/( +)/g,'<span class="space">$1</span>'):x.replace(/\n +(?=\S)/g,o);t.html(x.replace(/\n/g,"<br>"))}if(v.func){v.func(t,w.io)}return false},q=/(\d+),\s*(\d+),\s*(\d+)/,d=Object.subClass({init:function(v){v=n({},v);this.env=v;var t=this.container=this.target=c(v.container),s=c("<tt>00000</tt>").appendTo(t),x=s.height(),u=s.width()/5,w=Math.min(Math.floor(t.width()/u),v.width||80);s.remove();n(v,{charheight:x,charwidth:u,width:w,fgcolour:q.exec(t.css("color")).slice(1),bgcolour:q.exec(t.css("bgcolor")).slice(1)});t.on("stream",m).width(w*u+2);this.TextInput=new b(t);this.structures={main:{node:"div"},status:{node:"div",func:function(y,z){new a(y,z)}}}},event:function(v){var s,w,u,x=this.target,t;for(u=0;u<v.length;u++){s=v[u];w=s.code;if(w=="structures"){s.code=e;c.extend(this.structures,s)}if(w=="find"){this.target=x=c("."+s.name)}if(w=="stream"){(s.to?c("."+s.to):x).trigger({type:"stream",io:this,order:s})}if(w=="clear"){t=s.name?c("."+s.name):x;t.empty();if(s.css&&s.css["background-color"]){(s.name=="main"?l:t).css("background-color",s.css["background-color"])}}if(w=="read"){s.target=x;this.TextInput.getLine(s)}if(w=="char"){this.TextInput.getChar(s)}}}});h.StructIO=d;d.TextInput=b})(window,jQuery);var Runner=Object.subClass({init:function(b,c){var a=this;engine=parchment.engine=this.e=new window[c]();this.io=new StructIO(b);this.toEngine=this.io.TextInput.callback=function(d){try{engine.inputEvent(d)}catch(f){ui.error(f)}};engine.outputEvent=function(d){a.fromEngine(d)}},fromParchment:function(b){var a=b.code;if(a=="load"){b.env=this.io.env}this.toEngine(b)},fromEngine:function(e){var d=this.e,c=0,a,f,b;this.io.event(e);for(;c<e.length;c++){a=e[c];f=a.code;if(f=="quit"){return}if(f=="save"||f=="restore"){this.toParchment(a)}if(f=="restart"){this.io.target=this.io.container.empty();b=1}if(f=="tick"){b=1}}if(b){this.toEngine(a)}}});(function(k,m,f){var d=m,v=function(C,E){for(var D in E){C[D]=E[D]}return C},c=d.ajaxSetup({cache:1,converters:{"* binary":true}}).isLocal,s={},r=function(E){var D,C=s[E];if(!C){D=d.Callbacks();C=s[E]=D.fire;C.sub=D.add;C.unsub=D.remove}return C},n,q,j,A,g=(function(E){var F=0,C={},D;if(E[0]==""){F++}while(F<E.length){D=/([^=]+)(=(.*))?/.exec(E[F++]);C[D[1]]=D[3]?unescape(D[3]):true}return C})(location.search.slice(1).split(/[&;]/g));parchment=k.parchment={options:{container:"#parchment",lib_path:"lib/",page_title:1,panels:["search","url","about"],proxy_url:"http://zcode.appspot.com/proxy/"},topic:r,vms:[]},load_vm=function(){var E=this,G=0,F,C=[],D;if(this.loaded){return this.loaded}D=this.loaded=d.Deferred();while(G<this.files.length){F=parchment.options.lib_path+this.files[G++];if(/\.js$/.test(F)){C.push(d.getScript(F))}else{n.stylesheet_add(this.id,F)}}d.when.apply(this,C).done(function(){D.resolve(E)});return D};v(parchment.vms,{add:function(C){this.push(C);this[C.id]=C;C.load=load_vm},match:function(E,C){if(this[E]){return this[E]}for(var D=0;D<this.length;D++){if(this[D].match.test(C)){return this[D]}}}});if(c){m.ajaxPrefilter("script",function(C){C.crossDomain=1})}var w=(function(K,H){var I={},C=JSON?JSON.parse:H.parseJSON,D=JSON?JSON.stringify:function(P){var O=0,N=[],M;switch(typeof P){case"string":return E(P);case"number":case"boolean":return String(P);case"object":if(!P){return"null"}if(Object.prototype.toString.apply(P)=="[object Array]"){while(O<P.length){N.push(D(P[O++])||"null")}return"["+N.join()+"]"}for(O in P){if(M=D(P[O])){N.push(E(O)+":"+M)}}return"{"+N.join()+"}"}},E=function(M){return'"'+M.replace(/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\uffff]/g,function(N){return"\\u"+("0000"+N.charCodeAt(0).toString(16)).slice(-4)})+'"'},L=K.localStorage,J,G,F=function(){if(L){J=!c||!H.browser.mozilla}else{L={}}v(I,{persist:J,get:function(M,O){var N=L["parchment"+M];return/^[[{]/.test(N)?C(N):N},set:function(M,N){L["parchment"+M]=typeof N=="string"?N:D(N)}})};F();return I})(this,m);var l=Object.subClass({init:function(E){v(this,E);var D=this._has,C;if(D){for(C in D){this[C]=new B(l.models[C],this);this[C].fetch(D[C])}}if(this._init_data){this.data()}this._id=this._id||l.id++},save:function(C){var G={},F,D=this._has,E={},H;for(F in this){if(this[F]!=f&&F.charAt(0)!="_"&&!l.models[F]&&typeof this[F]!="function"){G[F]=this[F]}}if(D){for(F in D){if(this[F].length){E[F]=this[F].save(C);H=1}}G._has=H&&E}w.set(this._Class+this._id,G)},set:function(D,C){this[D]=C;this.save()},data:function(C){var D="DATA"+this._Class+this._id;if(C!=f){w.set(D,C)}else{return this._data=this._data||w.get(D)}}}),B=Object.subClass.call(Array,{init:function(C,D){this.Class=C;this._parent=D},fetch:function(C){var F,E,D=this.length=0;C=C||w.get("INDEX"+this.Class.Class);if(C){while(D<C.length){F=C[D++];E=w.get(this.Class.Class+F);if(E){E._id=F;this.add(new this.Class(E))}}}},save:function(C){var F=[],D=0,E;while(D<this.length){E=this[D++];F.push(E._id);if(C){E.save()}}if(this._parent){return F}w.set("INDEX"+this.Class.Class,F)},add:function(C){this.push(C);C._parent=this;C.save();(this._parent||this).save()},find:function(H,F){var G=new B(this.Class,this._parent),E,D,C=0;while(C<this.length){D=this[C++];if(D[H]==F){G.push(D)}}return G}});v(l,{subClass:function(C,D){D=D||{};D._Class=C;var E=Object.subClass.call(this,D);v(E,{Class:C,subClass:l.subClass});l.models[C]=E;return E},models:{},id:(new Date()).getTime(),});var y=(function(I,F){if(I.execScript){execScript("Function VBCStr(x)\nVBCStr=CStr(x)\nEnd Function\nFunction VBLastAsc(x)\nDim l\nl=LenB(x)\nIf l mod 2 Then\nVBLastAsc=AscB(MidB(x,l,1))\nElse\nVBLastAsc=-1\nEnd If\nEnd Function","VBScript")}var G=/chrome/i.test(navigator.userAgent),H=function(Q){return Q.replace(/\u20ac/g,"\x80").replace(/\u201a/g,"\x82").replace(/\u0192/g,"\x83").replace(/\u201e/g,"\x84").replace(/\u2026/g,"\x85").replace(/\u2020/g,"\x86").replace(/\u2021/g,"\x87").replace(/\u02c6/g,"\x88").replace(/\u2030/g,"\x89").replace(/\u0160/g,"\x8a").replace(/\u2039/g,"\x8b").replace(/\u0152/g,"\x8c").replace(/\u017d/g,"\x8e").replace(/\u2018/g,"\x91").replace(/\u2019/g,"\x92").replace(/\u201c/g,"\x93").replace(/\u201d/g,"\x94").replace(/\u2022/g,"\x95").replace(/\u2013/g,"\x96").replace(/\u2014/g,"\x97").replace(/\u02dc/g,"\x98").replace(/\u2122/g,"\x99").replace(/\u0161/g,"\x9a").replace(/\u203a/g,"\x9b").replace(/\u0153/g,"\x9c").replace(/\u017e/g,"\x9e").replace(/\u0178/g,"\x9f")},C=function(S){var T=[],R=0,Q=S.length%8;while(R<Q){T.push(S.charCodeAt(R++))}for(Q=S.length;R<Q;){T.push(S.charCodeAt(R++),S.charCodeAt(R++),S.charCodeAt(R++),S.charCodeAt(R++),S.charCodeAt(R++),S.charCodeAt(R++),S.charCodeAt(R++),S.charCodeAt(R++))}return T},N=function(Q){return String.fromCharCode.apply(this,Q)},J=[],E=(function(T){var Q=[],R=0,S;while(R<65){J.push(S=T.charAt(R));Q[S]=R++}return Q})("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="),D=function(T,R){if(I.atob){return C(atob(T),R)}var R=R||[],V,U,S=0,Q=T.length;while(S<Q){V=E[T.charAt(S++)]<<18|E[T.charAt(S++)]<<12|E[T.charAt(S++)]<<6|E[T.charAt(S++)];R.push(V>>16,(V>>8)&255,V&255)}V=R.pop();U=R.pop();if(U!=64){R.push(U)}if(V!=64){R.push(V)}return R},K=function(V,T){if(I.btoa){return btoa(N(V,T))}var T=T||"",W,S,R,aa,Z,Y,X,U=0,Q=V.length;while(U<Q){W=V[U++];S=V[U++];R=V[U++];aa=W>>2;Z=((W&3)<<4)+(S>>4);Y=((S&15)<<2)+(R>>6);X=R&63;T+=J[aa]+J[Z]+J[Y]+J[X]}if(isNaN(S)){T=T.slice(0,-2)+"=="}else{if(isNaN(R)){T=T.slice(0,-1)+"="}}return T},L=function(V){var W=VBCStr(V),U=VBLastAsc(V),Q=[],S=0,R=W.length%4,T;while(S<R){Q.push((T=W.charCodeAt(S++))&255,T>>8)}R=W.length;while(S<R){Q.push((T=W.charCodeAt(S++))&255,T>>8,(T=W.charCodeAt(S++))&255,T>>8,(T=W.charCodeAt(S++))&255,T>>8,(T=W.charCodeAt(S++))&255,T>>8)}if(U>-1){Q.push(U)}return Q},O=m.ajaxSettings.xhr(),M={binary:O.overrideMimeType&&!(F.browser.opera&&parseFloat(F.browser.version)<10.5)?"charset":"responseBody" in O?"responseBody":0},P=function(S,V,R){var U,Q,T;S=F.trim(S);if(R.mode=="base64"){if(I.atob){T=atob(S);U=C(T)}else{U=D(S);T=N(U)}}else{if(R.mode=="charset"){T=H(S);U=C(T)}else{U=L(R.xhr.responseBody);T=N(U)}}R.responseArray=U;R.responseText=T};O=f;F.ajaxPrefilter("binary",function(R,U,S){var T=c&&!R.crossDomain&&G?0:M.binary,Q=R.xhr;R.xhr=function(){return S.xhr=Q.apply(R)};R.binary=T;S.done(P);R.jsonp=false;R.jsonpCallback="processBase64Zcode";S.mode="base64";if(R.url.slice(-3).toLowerCase()==".js"){return"jsonp"}if(T&&!R.crossDomain){return"text"}if(R.legacy){R.url=R.legacy;return"jsonp"}R.data="url="+R.url;R.url=parchment.options.proxy_url;if(T&&F.support.cors){return"text"}R.data+="&encode=base64&callback=pproxy";R.jsonpCallback="pproxy";return"jsonp"});F.ajaxPrefilter("text",function(Q,S,R){R.mode=Q.binary;if(R.mode=="charset"){Q.mimeType="text/plain; charset=windows-1252"}});return parchment.file={text_to_array:C,array_to_text:N,base64_decode:D,base64_encode:K,support:M}})(k,m);var p=d("body"),u='<p><a href="'+location.href+"?story=http://mirror.ifarchive.org/",a=function(C){return u+C.path+'">'+C.desc.entityify()+"</a></p>"},e=Object.subClass({init:function(H){n.modal=1;d(".modal").remove();var F,E,D,C,G=this.modal=d('<div class="modal">'),I=d('<form class="dialog">').addClass(H.type).submit(function(){n.endmodal();H.callback(this);return false}).appendTo(G);if(H.title){I.append('<p class="title">'+H.title+"</p>")}for(F in H.content){D=H.content[F];if(typeof D=="string"){d("<p>").html(D).appendTo(I)}else{if(D.type=="actions"){E=0;C=d("<p>").appendTo(I);while(E<D.labels.length){d("<input>",{type:"submit",value:D.labels[E++],click:function(){I.data("action",d(this).val())}}).appendTo(C)}}else{if(D.type=="link"){D.type=f;I.append(d("<p>").append(d("<a>",D)))}}}}p.append(G)},show:function(){n.modal=1;d(".modal").remove();p.append(this.modal)}}),i=Object.subClass({init:function(){this.container=d(parchment.options.container);this.panels={}},error:function(E,C,F,G){var D={type:"error",title:E,content:[]};if(C){D.content.push(C)}if(F){D.content.push({type:"actions",labels:[F]})}if(G){D.callback=G}new e(D)},endmodal:function(){d(".modal").remove();this.modal=0},stylesheet_add:function(){var C=arguments,D;for(D=1;D<C.length;D++){if(document.createStyleSheet){document.createStyleSheet(C[D])}else{d("<link>",{rel:"alternate stylesheet",href:C[D],title:C[0],type:"text/css"}).appendTo("head")[0].disabled=true}}},stylesheet_switch:function(D,C){d('link[rel*="stylesheet"][title="'+D+'"]').each(function(){this.disabled=!C})},load_panels:function(){var C=parchment.options.panels,G,F,E,D=function(){var I=RegExp(F.val().replace(" ","( )?"),"i"),H=d.grep(G,function(J){return I.test(J.path+J.desc)});H=H.slice(0,30);E.html(d.map(H,a).join(""))};if(d.inArray("search",C)!=-1){this.panels.search=d('<div class="panel search"><label for="panel_search">Search the IF Archive for games you can play with Parchment. You might also like to search the <a href="http://ifdb.tads.org">IFDB</a> or the <a href="http://ifwiki.org">IF Wiki</a>.</label><input id="panel_search"><div></div></div>');F=this.panels.search.find("input");E=F.next();F.keydown(function(){F.unbind("keydown");d.getJSON("stories/if-archive.json").done(function(H){G=H;F.keyup(D);D()})})}if(d.inArray("url",C)!=-1){this.panels.url=d('<form class="panel url"><label for="panel_url">You may use Parchment to play any story file on the internet, simply copy its address here:</label><input id="panel_url" name="story"></form>')}this.container.append(this.panels[C[0]]);this.panels.active=C[0]}});var h=l.subClass("Savefile",{_init_data:1}),b=l.subClass("Story",{_has:{Savefile:[]},launch:function(C){C=parchment.vms.match(C||this.vm,this.url);if(!C){return n.error("Story type is not supported","Unfortunately Parchment can't run this story. Please try a desktop interpreter instead.")}d.when(this.load(),C.load()).done(o);this.set("lastplay",(new Date()).getTime());this.set("playcount",(this.playcount||0)+1)},load:function(){var D=this.data(),C=this.deferred=d.Deferred();if(D){C.resolve({responseText:D,responseArray:this._array||(this._array=y.text_to_array(D))})}else{this.download()}return C},download:function(){if(!n.modal){q.indicator.show()}var C=this;d.ajax(this.url,{dataType:"binary",legacy:this.backup}).done(function(E,F,D){C.deferred.resolve(D);C.data(D.responseText)}).fail(function(){n.error("Parchment could not load the story","Please check your connection, and that the URL is correct","Retry",function(){C.download()})})}}),o=function(E,D){n.endmodal();j=parchment.runner=new (k[D.runner]||Runner)(parchment.options,D.engine);var C=location.hash;j.toParchment=function(F){q.fromRunner(j,F)};j.fromParchment({code:"load",data:(new z(E.responseArray)).data});if(C&&C!="#"){j.fromParchment({code:"restore",data:y.base64_decode(C.slice(1))})}else{j.fromParchment({code:"restart"})}},z=IFF.subClass({init:function x(H,D){this.title=D;if(H[0]<9){this._super();this.chunks.push({type:"ZCOD",data:H});this.data=H}else{if(IFF.text_from(H,0)=="Glul"){this._super();this.chunks.push({type:"GLUL",data:H});this.data=H}else{if(IFF.text_from(H,0)=="FORM"){this._super(H);if(this.type=="IFRS"){for(var F=0,C=this.chunks.length;F<C;F++){var G=this.chunks[F].type;if(G=="ZCOD"&&!this.zcode){this.data=this.chunks[F].data}else{if(G=="GLUL"&&!this.glulx){this.data=this.chunks[F].data}else{if(G=="IFmd"){this.metadata=y.array_to_text(this.chunks[F].data);var E=d(this.metadata);if(E){if(d("title",E)){this.title=d("title",E).text()}if(d("ifid",E)){this.ifid=d("ifid",E).text()}if(d("release",E)){this.release=d("release",E).text()}}}}}}}}}}}}),t=B.subClass({load:function(){this.fetch();var D=g.vm,C=this.get_story();if(!C){return n.load_panels()}d("#about").remove();this.indicator=new e({content:["Parchment is loading.","> <blink>_</blink>"]});if(D){C.set("vm",D)}try{C.launch(D)}catch(E){return n.error(E)}},get_story:function(){var D=parchment.options,F=g.story,C,E;if(D.lock_story){F=D.default_story;if(!F){return n.error("Story file not specified")}}else{if(D.default_story||F){F=F||D.default_story}else{return}}if(d.isArray(F)){C=F[1];F=F[0]}E=this.find("url",F)[0];if(!E){this.add(E=new b({url:F,backup:C}))}return E},fromRunner:function(F,E){var D=E.code,C=location.hash;if(D=="save"){new e({title:"Save",content:[{type:"actions",labels:["Save","Cancel"]},{type:"link",text:"Bookmark",href:"#"+y.base64_encode(E.data),target:"_blank",click:function(){d(".modal input[value=Cancel]").off("click")}}],callback:function(G){E.result=d(G).data("action")!="Cancel";F.fromParchment(E)}})}if(D=="restore"){if(C&&C!="#"){E.data=y.base64_decode(C.slice(1))}F.fromParchment(E)}}});parchment.vms.add({id:"quixe",match:/(ulx|glb|(g|glulx.+)(blorb|blb))(.js)?$/i,files:["prototype.min.js","glkote.min.js","quixe.min.js","glkote.min.css"],runner:"QuixeRunner"});parchment.vms.add({id:"zvm",match:/(z[58]|zlb|(z|zcode.+)(blorb|blb))(.js)?$/i,files:["zvm.min.js"],engine:"ZVM"});parchment.vms.add({id:"gnusto",match:/(z[1-8]|zlb|(z|zcode.+)(blorb|blb))(.js)?$/i,files:["gnusto.min.js"],runner:"GnustoRunner"});d(function(){if(k.parchment_options){d.extend(parchment.options,parchment_options)}if(!parchment.options.lock_options&&g.options){d.extend(parchment.options,d.parseJSON(g.options))}n=parchment.ui=new i();q=parchment.library=new t(b);q.load();if(/iplayif.com/.test(location.host)){d.getScript("http://google-analytics.com/ga.js",function(){_gat._getTracker("UA-7949545-3")._trackPageview()})}})})(this,jQuery);